<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>ServingXML Examples</title><meta name="generator" content="DocBook XSL Stylesheets V1.74.0"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="article" lang="en"><div class="titlepage"><div><div><h1 class="title"><a name="consoleapp-egs"></a>ServingXML Examples</h1></div><div><div class="author"><h3 class="author"><span class="firstname">Daniel</span> <span class="surname">Parker</span></h3></div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Shaun</span> <span class="surname">Woodrow</span></h3><span class="contrib">Contributor of "trades" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Dimitrios</span> <span class="surname">Varsos</span></h3><span class="contrib">Contributor of "tasks" and "timesheets" examples</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Pedro</span> <span class="surname">Mendoza</span></h3><span class="contrib">Contributor of "hot" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Pierre-Alexandre</span> <span class="surname">Losson</span></h3><span class="contrib">Contributor of "invoices" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Aswin</span> <span class="surname">Majjiga</span></h3><span class="contrib">Contributor of "books-csv" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Dudley</span></h3><span class="contrib">Contributor of Java properties "nested tags" examples</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">alexbena</span></h3><span class="contrib">Contributor of "CONV" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Zach</span></h3><span class="contrib">Contributor of "ars" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Sapna</span></h3><span class="contrib">Contributor of "BNF like flat file" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Bill</span> <span class="surname">Donovan</span></h3><span class="contrib">Contributor of edifact example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Ahmadin</span></h3><span class="contrib">Contributor of abtest example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Scott</span></h3><span class="contrib">Contributor of swath example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Peter</span> <span class="surname">Scholz</span></h3><span class="contrib">Contributor of "segments" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Wonne</span> <span class="surname">Keysers</span></h3><span class="contrib">Contributor of "persons" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Ken</span> <span class="surname">Brewer</span></h3><span class="contrib">Contributor of "students" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Bala</span> <span class="surname">Murali</span></h3><span class="contrib">Contributor of "book orders" and "checked books" examples</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname"></span> <span class="surname">etdwh </span></h3><span class="contrib">Contributor of "opdef" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">David</span> <span class="surname">Leal Valma</span></h3><span class="contrib">Contributor of "field has max width" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Anton</span> <span class="surname">Melumad</span></h3><span class="contrib">Contributor of "optional elements" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Lance</span> <span class="surname">Zant</span></h3><span class="contrib">Contributor of "XML-flat header-detail" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">dealogic</span></h3><span class="contrib">Contributor of XML to flat "sequence" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Jim</span> <span class="surname">Williams</span></h3><span class="contrib">Contributor of XML to flat "multiple summaries" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Alvin</span> <span class="surname"></span></h3><span class="contrib">Contributor of XML to flat "book-listing" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Jim</span> <span class="surname">Nurii</span></h3><span class="contrib">Contributor of flat to XML and XML to flat "special char" examples</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Jose Ignacio Santa Cruz</span></h3><span class="contrib">Contributor of flat to XML "invoice" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Valentine</span></h3><span class="contrib">Contributor of XML to flat "ungrouping" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Ravikumar</span> <span class="surname">Tadysetty</span></h3><span class="contrib">Contributor of XML to flat "all" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Jos&eacute;</span> <span class="surname">Santos</span></h3><span class="contrib">Contributor of XML to flat "formating distinct record lines" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Ramesh</span> <span class="surname">Ramasamy</span></h3><span class="contrib">Contributor of XML to flat "book hierarchy" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Gordon</span> <span class="surname">Zhang</span></h3><span class="contrib">Contributed additions to "exotics" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Roopashree</span> <span class="surname">Hirasave</span></h3><span class="contrib">Contributed "X12 XML to Flat File" example</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Ralph</span> <span class="surname">Kutzner</span></h3><span class="contrib">Contributed Flat-to-XML example "Computing an Aggregate Value over 
    Multiple Records"</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Randal</span> <span class="surname">Cobb</span></h3><span class="contrib">Contributed Flat-to-XML example "Mapping Two Records at the Top of a 
  File to a Header Element in the XML Output"
  </span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Nicolas</span> <span class="surname">Denis</span></h3><span class="contrib">Contributed Flat-to-XML example "A UTF-8 positional flat file with double byte characters"
  </span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Johan</span> <span class="surname">Hammar</span></h3><span class="contrib">Contributed Flat-to-XML example "Converting a positional flat file with variable field widths to 
  XML"
  </span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Asanga</span> <span class="surname">Porage</span></h3><span class="contrib">Contributed the "eobclaims" examples, the flat-to-XML "Flat File to Summary and Detail XML Documents", and the 
    XML-to-flat "Summary and Detail XML Documents to a Flat File"
  </span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Luca</span> <span class="surname">Buraggi</span></h3><span class="contrib">Contributed the XML-to-Database "Load Master Detail" example.
  </span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Graham</span> <span class="surname">Hannington</span></h3><span class="contrib">Contributed the Flat-File-to-XML "SMF" example.
  </span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Sajeev</span> <span class="surname">Nair</span></h3><span class="contrib">Contributed the Flat-File-to-XML "Record Concatenation" example.
  </span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Gabriele</span> <span class="surname">Siviero</span></h3><span class="contrib">Contributed the Flat-File-to-XML "Invoic96A" example.
  </span>&nbsp;</div></div></div><hr></div><div class="toc"><dl><dt><span class="section"><a href="#d4e163">Flat File to XML</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e165">Delimited Fields, Single Record Type</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e167">Converting a CSV File to XML Using Default Record Mapping (countries-default)</a></span></dt><dt><span class="section"><a href="#d4e210">Converting a CSV File to XML Using Custom Record Mapping (countries-custom)</a></span></dt><dt><span class="section"><a href="#d4e228">Converting a CSV file to XML with Record Validation (countries-validated)</a></span></dt><dt><span class="section"><a href="#d4e255">Converting flat files with fields that end either with a delimiter or a maximum width (field has max width)</a></span></dt><dt><span class="section"><a href="#tasks-eg">Converting a flat file to XML with one level of grouping (tasks)</a></span></dt><dt><span class="section"><a href="#timesheets-eg">Converting a flat file to XML with many levels of grouping (timesheets)</a></span></dt><dt><span class="section"><a href="#d4e325">Converting a flat file with multi-valued fields to XML (family_data)</a></span></dt><dt><span class="section"><a href="#ars-eg">Search and Replace with Regular Expressions in Field Mappings (ars)</a></span></dt><dt><span class="section"><a href="#tab-delimited">Converting a Tab Delimited Flat File to XML (tab-delimited)</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e436">Delimited Fields, Multiple Record Types</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e438">Converting a flat file with multiple record formats to XML with grouping (exotics)</a></span></dt><dt><span class="section"><a href="#d4e465">Converting flat files with record mappings that have optional elements (optional elements)</a></span></dt><dt><span class="section"><a href="#d4e486">Converting a Java properties file to XML (messages)</a></span></dt><dt><span class="section"><a href="#d4e532">Transforming a Java properties file with extra name field delimiters to produce nested tags (nested tags 1)</a></span></dt><dt><span class="section"><a href="#d4e582">Transforming a Java properties file with name subfield delimiters to produce nested tags (nested tags 2)</a></span></dt><dt><span class="section"><a href="#d4e609">Reordering a group of records before mapping to XML (multiple summaries)</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e626">Delimited Fields, Multiple Record Types, Repeating Groups</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e628">Mapping multiple repeating groups to XML (students-delim)</a></span></dt><dt><span class="section"><a href="#d4e665">Mapping a sequence of nested repeating groups to XML (invoice)</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e692">EDI Examples</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e694">EDI to XML (comptest)</a></span></dt><dt><span class="section"><a href="#d4e732">EDI to XML with Escaped Delimiters (Invoic96A)</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e780">FpML Examples</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e782">FRA to FpML</a></span></dt><dt><span class="section"><a href="#d4e813">Swap to FpML</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e862">Fixed Width Fields, Single Record Type, Line Delimited</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e864">A flat file to XML mapping with field substitutions (abtest)</a></span></dt><dt><span class="section"><a href="#d4e888">Mapping a record to separate top level sections in the XML (persons)</a></span></dt><dt><span class="section"><a href="#d4e921">Converting a directory of books positional files to XML files (all books)</a></span></dt><dt><span class="section"><a href="#d4e951">Converting a flat file to multiple XML book files (multiple books)</a></span></dt><dt><span class="section"><a href="#d4e972">Converting a flat file to multiple XML documents with default namespace
  prefixes (multiple default ns)
      </a></span></dt></dl></dd><dt><span class="section"><a href="#d4e1013">Flat Files with Multibyte Characters</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e1015">A UTF-8 positional flat file with double byte characters
      </a></span></dt></dl></dd><dt><span class="section"><a href="#d4e1037">Fixed Width Fields, Multiple Record Types, Line Delimited</a></span></dt><dd><dl><dt><span class="section"><a href="#trades-eg">Converting a flat file with multiple record formats to XML (trades)</a></span></dt><dt><span class="section"><a href="#CONV-eg">Converting a flat file to XML with header, detail, and summary records (CONV)</a></span></dt><dt><span class="section"><a href="#d4e1108">Converting a positional file to XML using a record filter (hot 1)</a></span></dt><dt><span class="section"><a href="#hot2-eg">Converting a positional file to XML with outer and inner grouping (hot 2)</a></span></dt><dt><span class="section"><a href="#variable-field-widths">Converting a positional flat file with variable field widths to
  XML</a></span></dt><dt><span class="section"><a href="#repeat-header-info-eg">Repeat Header Information in the XML</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e1256">Fixed Width Fields, Multiple Record Types, Repeating Groups, Line Delimited</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e1258">Converting fixed position records with repeating groups to XML (segments)</a></span></dt><dt><span class="section"><a href="#d4e1282">Mapping multiple repeating groups to XML (students-fix)</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e1319">Fixed Width Fields, Single Record Type, No End-of-Line Delimiters</a></span></dt><dd><dl><dt><span class="section"><a href="#non_delimited_book_orders">Converting a flat file with a single record type, but no end-of-line delimiters, to XML (non-delimited book orders)</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e1351">Fixed Width Fields, Multiple Record Types, No End-of-Line Delimiters</a></span></dt><dd><dl><dt><span class="section"><a href="#non_delimited_variant_trades">Converting a flat file with multiple record formats, but no end-of-line delimiters, to XML (non-delimited trades)</a></span></dt><dt><span class="section"><a href="#special-char-eg">Converting a flat file with special characters to XML (special char)</a></span></dt><dt><span class="section"><a href="#packed-decimal-to-xml">Converting a flat file containing Cobol packed decimal data to XML (packed decimal to XML)</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e1434">Logical Record Consists of Multiple Physical Records</a></span></dt><dd><dl><dt><span class="section"><a href="#smf">Converting a System Management Facilities (SMF) file to XML (Segment Concatenation)
      </a></span></dt><dt><span class="section"><a href="#recordComposition">Aggregating Multiple Physical Records into a Composite Record (Record Composition)
      </a></span></dt><dt><span class="section"><a href="#d4e1513">Computing an Aggregate Value over Multiple Records</a></span></dt><dt><span class="section"><a href="#d4e1545">Mapping Two Records at the Top of a File to a Header Element in the
  XML Output</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e1583">Start/End Delimited Records.</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e1585">Converting flat files with start/end record delimiters (opdef)</a></span></dt><dt><span class="section"><a href="#d4e1625">Converting flat files with nested start/end record and segment delimiters and name/value pairs (transaction)</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e1671">Custom Record Reader</a></span></dt><dd><dl><dt><span class="section"><a href="#custom_record_reader">Converting the output of a custom record reader to XML (custom record reader)</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e1742">Batching XML Output</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e1744">Serializing XML in Batches</a></span></dt><dt><span class="section"><a href="#d4e1763">Writing Records to Batch Files, and Converting the Batches to Separate
  XML Files
      </a></span></dt></dl></dd><dt><span class="section"><a href="#d4e1791">Many XML Documents</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e1793">Flat File to Summary and Detail XML Documents (eobclaims)</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e1825">Many Flat Input Files</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e1827">Multiple XML Readers</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#d4e1848">XML to Flat File</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e1850">Converting an XML document to a positional flat file with record count in trailer (books-positional)</a></span></dt><dt><span class="section"><a href="#d4e1884">Converting an XML document with multiple occurances of an element to a CSV file (books-csv)</a></span></dt><dt><span class="section"><a href="#d4e1907">Converting an XML document with multiple occurances of an element to a flat file with subfield delimiters (books-pipe)</a></span></dt><dt><span class="section"><a href="#d4e1939">Converting each book entry in books.xml to a list of three records (book-listing)</a></span></dt><dt><span class="section"><a href="#d4e1975">Converting an XML document into flat file records with multi-valued fields (swath)</a></span></dt><dt><span class="section"><a href="#d4e2001">Converting an XML document into a flat file with header and multiple detail records (XML-flat header-detail)</a></span></dt><dt><span class="section"><a href="#d4e2027">Breaking up a sequence of elements into flat file records ("sequence")</a></span></dt><dt><span class="section"><a href="#special-char-eg">Converting an XML file with hexidecimal encoded values to a flat file with special characters</a></span></dt><dt><span class="section"><a href="#d4e2075">Converting an XML document to a positional flat file and ungrouping an XML element (ungrouping)</a></span></dt><dt><span class="section"><a href="#d4e2107">XML to Flat Repeating Group (all)</a></span></dt><dt><span class="section"><a href="#d4e2132">Formating Distinct Record Lines (blocks)</a></span></dt><dt><span class="section"><a href="#d4e2154">Block Subsequences in XML to One Line</a></span></dt><dt><span class="section"><a href="#d4e2178">Ungrouping Elements with Multiple Levels (book hierarchy)</a></span></dt><dt><span class="section"><a href="#d4e2200">X12 XML to Flat File using XSLT</a></span></dt><dt><span class="section"><a href="#d4e2221">A Directory of XML Documents to a Flat File</a></span></dt><dt><span class="section"><a href="#d4e2242">Summary and Detail XML Documents to a Flat File (eobclaims)</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e2261">Flat File to Flat File</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2263">Converting a positional file to a pipe delimited file with header (positional to delimited)</a></span></dt><dt><span class="section"><a href="#d4e2286">Converting a positional file to a new positional file with default field values (positional defaults)</a></span></dt><dt><span class="section"><a href="#d4e2310">Converting an ASCII Positional File to an EBCDIC Delimited File, and Vice Versa (ASCII-EBCDIC)</a></span></dt><dt><span class="section"><a href="#d4e2326">Converting an ASCII Positional File to an EBCDIC Positional File with a Cobol Packed Decimal Field, and Vice Versa (ASCII-Packed)</a></span></dt><dt><span class="section"><a href="#d4e2342">Converting a positional file to a pipe delimited file with record filtering (book orders)</a></span></dt><dt><span class="section"><a href="#d4e2377">Checking the Integrity of a Flat File ("checked books")</a></span></dt><dt><span class="section"><a href="#d4e2426">Converting a directory of book positional files to pipe delimited files (new format)</a></span></dt><dt><span class="section"><a href="#multiple_output_files">Generated records to multiple files (multiple_output_files)</a></span></dt><dt><span class="section"><a href="#d4e2573">Reading remote directories</a></span></dt><dt><span class="section"><a href="#d4e2593">Converting a sequential stream of records into multiple batch files</a></span></dt><dt><span class="section"><a href="#d4e2610">Batched Flat Files</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2612">Batched sequences of records</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#d4e2626">XML to XML</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2628">Extracting subtrees and wrapping them in containing tags</a></span></dt><dt><span class="section"><a href="#d4e2643">Unwrapping subtrees in an XML document</a></span></dt><dt><span class="section"><a href="#d4e2655">Streaming a file through a pipeline</a></span></dt><dt><span class="section"><a href="#d4e2681">Streaming dynamically generated SAX events through a pipeline</a></span></dt><dt><span class="section"><a href="#invoices-eg">Processing document subtrees and serializing them to separate files (invoices.)</a></span></dt><dt><span class="section"><a href="#mailInvoices">Processing document subtrees and serializing them as mail attachments ("mail invoices")</a></span></dt><dt><span class="section"><a href="#d4e2746">Reading dynamic content</a></span></dt><dt><span class="section"><a href="#d4e2775">XML to Mail</a></span></dt><dt><span class="section"><a href="#d4e2795">Writing an XML file to an FTP sink</a></span></dt><dt><span class="section"><a href="#d4e2813">Comparing Two XML Documents with fn:deep-equal</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e2820">SQL Examples</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2822"></a></span></dt><dt><span class="section"><a href="#d4e2826">SQL Query to Flat File</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2828">Writing the results of a SQL query to a CSV file (employees-csv)</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e2851">SQL Query to XML</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2853">Mapping the results of a parameterized SQL query into XML (analysts)</a></span></dt><dt><span class="section"><a href="#d4e2867">Mapping the results of an ad hoc SQL query into XML (employees)</a></span></dt><dt><span class="section"><a href="#d4e2885">Using multiple readers to join data across different data sources (chained readers)</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e2903">XML to Database</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2905">Load Master Detail</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e2929">SQL Query to Database</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2931">SQL inserts</a></span></dt><dt><span class="section"><a href="#d4e2949">Batched SQL inserts</a></span></dt><dt><span class="section"><a href="#d4e2970">Prepared SQL inserts</a></span></dt><dt><span class="section"><a href="#d4e2991">Batched prepared SQL inserts</a></span></dt><dt><span class="section"><a href="#d4e3015">Updating an employee record using command-line parameters (employee update)</a></span></dt><dt><span class="section"><a href="#d4e3023">Insert if record does not exist, update otherwise (insert/update).</a></span></dt><dt><span class="section"><a href="#d4e3038">Writing rows to a database table as they pass through a pipe, to an XML file (employees-tee)</a></span></dt></dl></dd></dl></dd><dt><span class="index"><a href="#d4e3063">Index</a></span></dt></dl></div>

<p>
The source for console app examples may be found in the distribution under the <code class="filename">samples</code> 
directory.
</p>
<p>
Before running the sample console applications, be sure to build the servingxml project.
Note that the examples will be deployed under the <code class="filename">target/servingxml/samples</code>
directory.  See <a class="ulink" href="../gettingstarted.html" target="_top">Getting Started</a> for details.  
</p>

<div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d4e163"></a>Flat File to XML</h2></div></div></div>
  
  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e165"></a>Delimited Fields, Single Record Type</h3></div></div></div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e167"></a>Converting a CSV File to XML Using Default Record Mapping (countries-default)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e170"></a>
      <a class="indexterm" name="d4e173"></a>
      <a class="indexterm" name="d4e176"></a>
      <p>This example shows a simple resources script that will map a CSV file to XML using default record mapping.
      </p>
      <p>
The input file is a CSV file.
      </p>
      <div class="figure"><a name="countires.csv"></a><p class="title"><b>Figure&nbsp;1.&nbsp;Input flat file countries.csv</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
code,name
#ABW,ARUBA
ATF,"FRENCH SOUTHERN TERRITORIES, D.R. OF"
VUT,VANUATU
WLF,WALLIS &amp; FUTUNA ISLANDS

        </pre>
      </div></div><br class="figure-break">
      <p>
This file has a number of properties.
        </p><div class="itemizedlist"><ul type="disc"><li>
            <p>The first row is a header with comma-separated column
            labels.</p>
          </li><li>
            <p>The second row is commented out.</p>
          </li><li>
            <p>The third row has a field value, enclosed in quotes, that
contains an embedded comma.
            </p>
          </li><li>
            <p>The fifth row has a field value that contains a '&amp;'
symbol, which is a special character in XML, and must therefore be escaped in
XML output as the entity '&amp;amp;'.
            </p>
          </li></ul></div><p>
      </p>
      <p>Shown below is the simplest possible resources script that will read
    this data and output it as XML.
      </p>
      <pre class="programlisting">
        
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="countries"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="countries-doc"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="countries-doc" name="countries"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:commentStarter value="#"/&gt;
      &lt;sx:fieldDelimiter value=","/&gt;
      &lt;sx:urlSource url="data/countries.csv"/&gt;
    &lt;/sx:flatFileReader&gt;
  &lt;/sx:recordContent&gt;

&lt;/sx:resources&gt;

      </pre>
      <p>This resources script produces the following output.
      </p>
      <pre class="programlisting">
        
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;countries&gt;
  &lt;record&gt;
    &lt;code&gt;ATF&lt;/code&gt;
    &lt;name&gt;FRENCH SOUTHERN TERRITORIES, D.R. OF&lt;/name&gt;
  &lt;/record&gt;
  &lt;record&gt;
    &lt;code&gt;VUT&lt;/code&gt;
    &lt;name&gt;VANUATU&lt;/name&gt;
  &lt;/record&gt;
  &lt;record&gt;
    &lt;code&gt;WLF&lt;/code&gt;
    &lt;name&gt;WALLIS &amp;amp; FUTUNA ISLANDS&lt;/name&gt;
  &lt;/record&gt;
&lt;/countries&gt;

      </pre>
      <p>Note the following properties of the XML output.
      </p>
      <div class="itemizedlist"><ul type="disc"><li>
          <p>The root element name comes from the
            <a class="link" href="../guide/index.html#sx:recordContent" target="_top">sx:recordContent</a>
                element's
            <code class="sgmltag-attribute">name</code>
attribute, if it has one, and if not
  it defaults to
            <code class="sgmltag-element">document</code>
.
          </p>
        </li><li>
          <p>The record element name defaults to
            <code class="sgmltag-element">record</code>
.
          </p>
        </li><li>
          <p>Each field is mapped to an element, and the name of the
              element defaults to the column label.
          </p>
        </li></ul></div>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e210"></a>Converting a CSV File to XML Using Custom Record Mapping (countries-custom)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e213"></a>
      <p>
An
        <a class="link" href="../guide/index.html#sx:recordMapping" target="_top">sx:recordMapping</a>
element positioned inside an
        <a class="link" href="../guide/index.html#sx:recordContent" target="_top">sx:recordContent</a>
element allows for custom record mapping to XML.  This is optional, since there is a default mapping that emits
the canonical XML representation of records.  But typically the XML you want
is different from the canonical representation, you may want a field mapped to an attribute rather
than an element, for example, or perhaps some additional literal elements around the field mappings.
      </p>
      <p>
Continuing with the previous example, suppose you want the following output.
      </p>
      <pre class="programlisting">
        
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;countries&gt;
  &lt;country countryCode="ATF"&gt;
    &lt;countryName&gt;FRENCH SOUTHERN TERRITORIES, D.R. OF&lt;/countryName&gt;
  &lt;/country&gt;
  &lt;country countryCode="VUT"&gt;
    &lt;countryName&gt;VANUATU&lt;/countryName&gt;
  &lt;/country&gt;
  &lt;country countryCode="WLF"&gt;
    &lt;countryName&gt;WALLIS &amp;amp; FUTUNA ISLANDS&lt;/countryName&gt;
  &lt;/country&gt;
&lt;/countries&gt;

      </pre>
      <p>
The following resources script does the job.
      </p>
      <pre class="programlisting">
        
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;
   
  &lt;sx:service id="countries"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="countries"/&gt; 
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="countries"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:urlSource url="data/countries.csv"/&gt;
      &lt;sx:flatFile ref="countriesFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="countriesToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;
  
  &lt;sx:flatFile id="countriesFile"&gt;
    &lt;sx:flatFileHeader lineCount="1"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType name="country"&gt;
        &lt;sx:fieldDelimiter value=","/&gt;
        &lt;sx:delimitedField name="code"/&gt;
        &lt;sx:delimitedField name="name"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;      
  
  &lt;sx:recordMapping id="countriesToXmlMapping"&gt;
    &lt;countries&gt;
      &lt;sx:onRecord&gt;
        &lt;country&gt;
          &lt;sx:fieldElementMap field="name" element="countryName"/&gt;  
          &lt;sx:fieldAttributeMap field="code" attribute="countryCode"/&gt;
        &lt;/country&gt;  
      &lt;/sx:onRecord&gt;
    &lt;/countries&gt;
  &lt;/sx:recordMapping&gt;  
  
&lt;/sx:resources&gt;

      </pre>
      <p>
You can also take the default mappings for some fields and map others explicitly.  For example,
      </p>
      <pre class="programlisting">
        
&lt;sx:recordMapping id="countries2xml"&gt;
  &lt;countries&gt;
    &lt;sx:onRecord&gt;
      &lt;country&gt;
        &lt;sx:defaultFieldElementMap fields="*" except="code"/&gt;
        &lt;sx:fieldAttributeMap field="code" attribute="countryCode"/&gt;
      &lt;/country&gt;
    &lt;/sx:onRecord&gt;
  &lt;/countries&gt;
&lt;/sx:recordMapping&gt;

      </pre>
      <p>
Here, the
        <a class="link" href="../guide/index.html#sx:defaultFieldElementMap" target="_top">sx:defaultFieldElementMap</a>
element maps all the fields in the record
to elements with the same names, except the field name "code". This field is handled
separately, with the
        <a class="link" href="../guide/index.html#sx:fieldAttributeMap" target="_top">sx:fieldAttributeMap</a>
element.
      </p>
    </div>

    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e228"></a>Converting a CSV file to XML with Record Validation (countries-validated)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e231"></a>
      <a class="indexterm" name="d4e234"></a>
      <p>
The example below shows how to convert a flat file to XML. Each row in the flat 
file is validated with Sun's multi schema validator (MSV), and if an error is
encountered, the row is discarded, but processing continues.  In addition, the
output XML is also validated with Sun's MSV, and if that should fail, processing is stopped.
      </p>
      <p>
This time the input file has an invalid country code in the first record.
      </p>
      <pre class="programlisting">
        
code,name
ATFX,"FRENCH SOUTHERN TERRITORIES, D.R. OF"
VUT,VANUATU
WLF,WALLIS &amp; FUTUNA ISLANDS

      </pre>
      <p>
The desired output is
      </p>
      <pre class="programlisting">
        
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;countries&gt;
  &lt;country countryCode="ATF"&gt;
    &lt;countryName&gt;FRENCH SOUTHERN TERRITORIES, D.R. OF&lt;/countryName&gt;
  &lt;/country&gt;
  &lt;country countryCode="VUT"&gt;
    &lt;countryName&gt;VANUATU&lt;/countryName&gt;
  &lt;/country&gt;
  &lt;country countryCode="WLF"&gt;
    &lt;countryName&gt;WALLIS &amp;amp; FUTUNA ISLANDS&lt;/countryName&gt;
  &lt;/country&gt;
&lt;/countries&gt;

      </pre>
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-countries.xml"></a><p class="title"><b>Figure&nbsp;2.&nbsp;Resources script resources-countries.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:msv="http://www.servingxml.com/extensions/msv"&gt;

  &lt;sx:service id="countries"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="countries"/&gt;
        &lt;msv:schemaValidator&gt;
          &lt;sx:urlSource url="data/countries.xsd"/&gt;
        &lt;/msv:schemaValidator&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="countriesFile"&gt;
    &lt;sx:commentStarter value="#"/&gt;
    &lt;sx:flatFileHeader lineCount="1"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="country"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatRecordType id="country" name="country"&gt;
    &lt;sx:fieldDelimiter value=","/&gt;
    &lt;sx:delimitedField name="code"/&gt;
    &lt;sx:delimitedField name="name"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatFile id="discardFile"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType name="countryDiscard"&gt;
        &lt;sx:fieldDelimiter value=","/&gt;
        &lt;sx:delimitedField name="message"/&gt;
        &lt;sx:flatRecordType ref="country"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="countriesToXmlMapping"&gt;
    &lt;countries&gt;
      &lt;sx:onRecord&gt;
        &lt;country&gt;
          &lt;sx:fieldElementMap field="name" element="countryName"/&gt;
          &lt;sx:fieldAttributeMap field="code" attribute="countryCode"/&gt;
        &lt;/country&gt;
      &lt;/sx:onRecord&gt;
    &lt;/countries&gt;
  &lt;/sx:recordMapping&gt;

  &lt;sx:recordContent id="countries"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:urlSource url="data/countriesWithDiscards.csv"/&gt;
        &lt;sx:flatFile ref="countriesFile"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;msv:recordValidator&gt;
        &lt;sx:urlSource url="data/country-record.xsd"/&gt;
      &lt;/msv:recordValidator&gt;
      &lt;sx:discardHandler&gt;
        &lt;sx:log message="{$sx:message}"/&gt;
        &lt;sx:modifyRecord&gt;
          &lt;sx:newField name="message" value="{$sx:message}"/&gt;
        &lt;/sx:modifyRecord&gt;
        &lt;sx:flatFileWriter&gt;
          &lt;sx:fileSink file="output/countryDiscards.csv"/&gt;
          &lt;sx:flatFile ref="discardFile"/&gt;
        &lt;/sx:flatFileWriter&gt;
      &lt;/sx:discardHandler&gt;
    &lt;/sx:recordStream&gt;
    &lt;sx:recordMapping ref="countriesToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>The schema to validate an individual country record is shown below.
      </p>
      <div class="figure"><a name="country-record.xsd"></a><p class="title"><b>Figure&nbsp;3.&nbsp;XML Schema file country-record.xsd</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;

 &lt;!-- This element's name matches the value of the name attribute in the sx:flatRecordType element. --&gt;
 &lt;xs:element name="country" type="CountryType"/&gt;

 &lt;xs:complexType name="CountryType"&gt;
  &lt;xs:sequence&gt;
   &lt;xs:element name="code" type="CountryCode"/&gt;
   &lt;xs:element name="name" type="xs:string"/&gt;
  &lt;/xs:sequence&gt;
 &lt;/xs:complexType&gt;

  &lt;xs:simpleType name='CountryCode'&gt;
    &lt;xs:restriction base='xs:string'&gt;
      &lt;xs:length value='3' fixed='true'/&gt;
    &lt;/xs:restriction&gt;
  &lt;/xs:simpleType&gt;
&lt;/xs:schema&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
You run this example on the command line by entering
      </p>
      <pre class="programlisting">
        
servingxml -r resources-countries.xml -o output/countries.xml countries

      </pre>
      <p>The following error message will be written to the log:
      </p>
      <pre class="programlisting">
        
Error in record "country" on line 1.  the length of the value is 4, but the required length is 3.

      </pre>
      <p>The remaining two rows will be written to the output file.
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e255"></a>Converting flat files with fields that end either with a delimiter or a maximum width (field has max width)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e258"></a>
      <p>
The example below shows how to convert a flat file with start/end record 
delimiters to XML.
      </p>
      <p>
The input file is shown below.
      </p>
      <pre class="programlisting">
        
1231234
1 123
12 12

      </pre>
      <p>
This file has the following structure.
      </p>
      <div class="itemizedlist"><ul type="disc"><li>
          <p>The first record consists of a field of length 3 ("123") followed by a field of length 4 ("1234")
          </p>
        </li><li>
          <p>The second line consists of a field of length 1 ("1") followed by a field of length 3 ("123")
          </p>
        </li></ul></div>
      <p>Each field has a maximum width, but the field may be terminated by a delimiter (here whitespace) before it attains that width.
      </p>
      <p>
The desired output is shown below.
      </p>
      <pre class="programlisting">
        
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;document&gt;
  &lt;record&gt;
    &lt;field1&gt;123&lt;/field1&gt;
    &lt;field2&gt;1234&lt;/field2&gt;
  &lt;/record&gt;
  &lt;record&gt;
    &lt;field1&gt;1&lt;/field1&gt;
    &lt;field2&gt;123&lt;/field2&gt;
  &lt;/record&gt;
  &lt;record&gt;
    &lt;field1&gt;12&lt;/field1&gt;
    &lt;field2&gt;12&lt;/field2&gt;
  &lt;/record&gt;
&lt;/document&gt;

      </pre>
      <p>
The following resources script does the transformation.
      </p>
      <pre class="programlisting">
        
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="fieldHasMaxWidth"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="fieldHasMaxWidthDoc"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="fieldHasMaxWidthDoc" name="document"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:urlSource url="data/fieldHasMaxWidth.txt"/&gt;
      &lt;sx:flatFile ref="fieldHasMaxWidthFile"/&gt;
    &lt;/sx:flatFileReader&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="fieldHasMaxWidthFile"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType name="record"&gt;
        &lt;sx:fieldDelimiter&gt;
          &lt;sx:whitespaceSeparator/&gt;
        &lt;/sx:fieldDelimiter&gt;
        &lt;sx:delimitedField name="field1" maxWidth="3"/&gt;
        &lt;sx:delimitedField name="field2" maxWidth="4"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

&lt;/sx:resources&gt;

      </pre>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-fieldHasMaxWidth.xml  
  -o output/fieldHasMaxWidth.xml fieldHasMaxWidth

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="tasks-eg"></a>Converting a flat file to XML with one level of grouping (tasks)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e280"></a>
      <a class="indexterm" name="d4e283"></a>
      <p>
The example below shows how to convert a flat file to XML with grouping levels.
      </p>
      <p>
The input file is a CSV file.
      </p>
      <div class="figure"><a name="tasks.csv"></a><p class="title"><b>Figure&nbsp;4.&nbsp;Input flat file tasks.csv</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
project_id, task_name, task_start, task_finish
4001,task1,01/01/2003,01/31/2003
4001,task2,02/01/2003,02/28/2003
4001,task3,03/01/2003,03/31/2003
4002,task1,04/01/2003,04/30/2003
4002,task2,05/01/2003,05/31/2003

        </pre>
      </div></div><br class="figure-break">
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="tasks.xml"></a><p class="title"><b>Figure&nbsp;5.&nbsp;Output XML file tasks.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
 &lt;?xml version="1.0" encoding="utf-8" ?&gt; 
&lt;Projects&gt;
  &lt;Project projectID="4001"&gt;
    &lt;Tasks&gt;
      &lt;Task name="task1" start="01/01/2003" finish="01/31/2003" /&gt; 
      &lt;Task name="task2" start="02/01/2003" finish="02/28/2003" /&gt; 
      &lt;Task name="task3" start="03/01/2003" finish="03/31/2003" /&gt; 
    &lt;/Tasks&gt;
  &lt;/Project&gt;
  &lt;Project projectID="4002"&gt;
    &lt;Tasks&gt;
      &lt;Task name="task1" start="04/01/2003" finish="04/30/2003" /&gt; 
      &lt;Task name="task2" start="05/01/2003" finish="05/31/2003" /&gt; 
    &lt;/Tasks&gt;
  &lt;/Project&gt;
&lt;/Projects&gt;
</pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-tasks.xml"></a><p class="title"><b>Figure&nbsp;6.&nbsp;Resources script resources-tasks.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="tasks"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="tasks"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="tasks"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:urlSource url="data/tasks.csv"/&gt;
      &lt;sx:flatFile ref="tasksFlatFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="tasksToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="tasksFlatFile"&gt;
    &lt;sx:flatFileHeader lineCount="1"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType name="task"&gt;
        &lt;sx:fieldDelimiter value=","/&gt;
        &lt;sx:delimitedField name="project_id"/&gt;
        &lt;sx:delimitedField name="task_name"/&gt;
        &lt;sx:delimitedField name="task_start"/&gt;
        &lt;sx:delimitedField name="task_finish"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="tasksToXmlMapping"&gt;
    &lt;Projects&gt;
      &lt;sx:groupBy fields="project_id"&gt;
        &lt;Project&gt;
          &lt;sx:fieldAttributeMap field="project_id" attribute="projectID"/&gt;
          &lt;Tasks&gt;
            &lt;sx:onRecord&gt;
              &lt;Task&gt;
                &lt;sx:fieldAttributeMap field="task_name" attribute="name"/&gt;
                &lt;sx:fieldAttributeMap field="task_start" attribute="start"/&gt;
                &lt;sx:fieldAttributeMap field="task_finish" attribute="finish"/&gt;
              &lt;/Task&gt;
            &lt;/sx:onRecord&gt;
          &lt;/Tasks&gt;
        &lt;/Project&gt;
      &lt;/sx:groupBy&gt;
    &lt;/Projects&gt;
  &lt;/sx:recordMapping&gt;
  
&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-tasks.xml -o output/tasks.xml tasks

        </pre><p>
      </p>
    </div>

    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="timesheets-eg"></a>Converting a flat file to XML with many levels of grouping (timesheets)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e304"></a>
      <a class="indexterm" name="d4e307"></a>
      <p>
The example below shows how to convert a flat file to XML with many grouping 
levels.
      </p>
      <p>
The input file is a CSV file.
      </p>
      <div class="figure"><a name="timesheets.csv"></a><p class="title"><b>Figure&nbsp;7.&nbsp;Input flat file timesheets.csv</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
TimePeriod,Start,Finish,Resource,Task,ActualDate,Amount
1,2/9/2004,2/15/2004,Joe_100,1001,2/9/2004,8
1,2/9/2004,2/15/2004,Joe_100,1001,2/10/2004,4
1,2/9/2004,2/15/2004,Joe_100,1002,2/11/2004,8
1,2/9/2004,2/15/2004,Joe_100,1003,2/10/2004,4
1,2/9/2004,2/15/2004,Joe_100,1003,2/12/2004,8
1,2/9/2004,2/15/2004,Mark_101,1001,2/10/2004,8
1,2/9/2004,2/15/2004,Mark_101,1001,2/14/2004,8
1,2/9/2004,2/15/2004,Mark_101,1006,2/9/2004,8
1,2/9/2004,2/15/2004,Mark_101,1008,2/12/2004,4
1,2/9/2004,2/15/2004,Mark_101,1008,2/13/2004,4
2,2/16/2004,2/22/2004,Joe_100,1001,2/16/2004,8
2,2/16/2004,2/22/2004,Joe_100,1001,2/17/2004,4
2,2/16/2004,2/22/2004,Joe_100,1002,2/17/2004,4

        </pre>
      </div></div><br class="figure-break">
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="timesheets.xml"></a><p class="title"><b>Figure&nbsp;8.&nbsp;Output XML file timesheets.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;TimePeriods&gt;
  &lt;TimePeriod start="2/9/2004" finish="2/15/2004"&gt;
    &lt;Timesheets&gt;
      &lt;Timesheet resource="Joe_100"&gt;
        &lt;TimesheetEntries&gt;
          &lt;TimesheetEntry task="1001"&gt;
            &lt;DailyActuals&gt;
              &lt;Actual actualDate="2/9/2004" amount="8"/&gt;
              &lt;Actual actualDate="2/10/2004" amount="4"/&gt;
            &lt;/DailyActuals&gt;
          &lt;/TimesheetEntry&gt;
          &lt;TimesheetEntry task="1002"&gt;
            &lt;DailyActuals&gt;
              &lt;Actual actualDate="2/11/2004" amount="8"/&gt;
            &lt;/DailyActuals&gt;
          &lt;/TimesheetEntry&gt;
          &lt;TimesheetEntry task="1003"&gt;
            &lt;DailyActuals&gt;
              &lt;Actual actualDate="2/10/2004" amount="4"/&gt;
              &lt;Actual actualDate="2/12/2004" amount="8"/&gt;
            &lt;/DailyActuals&gt;
          &lt;/TimesheetEntry&gt;
        &lt;/TimesheetEntries&gt;
      &lt;/Timesheet&gt;
      &lt;Timesheet resource="Mark_101"&gt;
        &lt;TimesheetEntries&gt;
          &lt;TimesheetEntry task="1001"&gt;
            &lt;DailyActuals&gt;
              &lt;Actual actualDate="2/10/2004" amount="8"/&gt;
              &lt;Actual actualDate="2/14/2004" amount="8"/&gt;
            &lt;/DailyActuals&gt;
          &lt;/TimesheetEntry&gt;
          &lt;TimesheetEntry task="1006"&gt;
            &lt;DailyActuals&gt;
              &lt;Actual actualDate="2/9/2004" amount="8"/&gt;
            &lt;/DailyActuals&gt;
          &lt;/TimesheetEntry&gt;
          &lt;TimesheetEntry task="1008"&gt;
            &lt;DailyActuals&gt;
              &lt;Actual actualDate="2/12/2004" amount="4"/&gt;
              &lt;Actual actualDate="2/13/2004" amount="4"/&gt;
            &lt;/DailyActuals&gt;
          &lt;/TimesheetEntry&gt;
        &lt;/TimesheetEntries&gt;
      &lt;/Timesheet&gt;
    &lt;/Timesheets&gt;
  &lt;/TimePeriod&gt;
  &lt;TimePeriod start="2/16/2004" finish="2/22/2004"&gt;
    &lt;Timesheets&gt;
      &lt;Timesheet resource="Joe_100"&gt;
        &lt;TimesheetEntries&gt;
          &lt;TimesheetEntry task="1001"&gt;
            &lt;DailyActuals&gt;
              &lt;Actual actualDate="2/16/2004" amount="8"/&gt;
              &lt;Actual actualDate="2/17/2004" amount="4"/&gt;
            &lt;/DailyActuals&gt;
          &lt;/TimesheetEntry&gt;
          &lt;TimesheetEntry task="1002"&gt;
            &lt;DailyActuals&gt;
              &lt;Actual actualDate="2/17/2004" amount="4"/&gt;
            &lt;/DailyActuals&gt;
          &lt;/TimesheetEntry&gt;
        &lt;/TimesheetEntries&gt;
      &lt;/Timesheet&gt;
    &lt;/Timesheets&gt;
  &lt;/TimePeriod&gt;
&lt;/TimePeriods&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-timesheets.xml"></a><p class="title"><b>Figure&nbsp;9.&nbsp;Resources script resources-timesheets.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;
   
  &lt;sx:service id="timesheets"&gt; 
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="timesheets"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;
  
  &lt;sx:recordContent id="timesheets"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:urlSource url="data/timesheets.csv"/&gt;
      &lt;sx:flatFile ref="timesheetsFlatFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="timesheetsToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;
  
  &lt;sx:flatFile id="timesheetsFlatFile"&gt;
    &lt;sx:commentStarter value="#"/&gt;
    &lt;sx:flatFileHeader lineCount="1"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType name="task"&gt;
        &lt;sx:fieldDelimiter value=","/&gt;
        &lt;sx:delimitedField name="TimePeriod"/&gt;
        &lt;sx:delimitedField name="Start"/&gt;
        &lt;sx:delimitedField name="Finish"/&gt;
        &lt;sx:delimitedField name="Resource"/&gt;
        &lt;sx:delimitedField name="Task"/&gt;
        &lt;sx:delimitedField name="ActualDate"/&gt;
        &lt;sx:delimitedField name="Amount"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;      
  
  &lt;sx:recordMapping id="timesheetsToXmlMapping"&gt;
    &lt;TimePeriods&gt;
      &lt;sx:groupBy fields="Start"&gt;
        &lt;TimePeriod&gt;
          &lt;sx:fieldAttributeMap field="Start" attribute="start"/&gt;
          &lt;sx:fieldAttributeMap field="Finish" attribute="finish"/&gt;
          &lt;Timesheets&gt;
            &lt;sx:groupBy fields="Start Resource"&gt;
              &lt;Timesheet&gt;
                &lt;sx:fieldAttributeMap field="Resource" attribute="resource"/&gt;
                &lt;TimesheetEntries&gt;
                  &lt;sx:groupBy fields="Start Resource Task"&gt;
                    &lt;TimesheetEntry&gt;
                      &lt;sx:fieldAttributeMap field="Task" attribute="task"/&gt;
                      &lt;DailyActuals&gt;
                        &lt;sx:onRecord&gt;
                          &lt;Actual&gt;
                            &lt;sx:fieldAttributeMap field="ActualDate" attribute="actualDate"/&gt;
                            &lt;sx:fieldAttributeMap field="Amount" attribute="amount"/&gt;
                          &lt;/Actual&gt;
                        &lt;/sx:onRecord&gt;
                      &lt;/DailyActuals&gt;
                    &lt;/TimesheetEntry&gt;
                  &lt;/sx:groupBy&gt;
                &lt;/TimesheetEntries&gt;
              &lt;/Timesheet&gt;
            &lt;/sx:groupBy&gt;
          &lt;/Timesheets&gt;
        &lt;/TimePeriod&gt;
      &lt;/sx:groupBy&gt;
    &lt;/TimePeriods&gt;
  &lt;/sx:recordMapping&gt;  
  
&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-timesheets.xml -o output/timesheets.xml timesheets

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e325"></a>Converting a flat file with multi-valued fields to XML (family_data)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e328"></a>
      <a class="indexterm" name="d4e331"></a>
      <a class="indexterm" name="d4e334"></a>
      <p>
The example below shows how to convert a flat file with multi-valued fields to 
XML.
      </p>
      <p>
The input file is a pipe delimited flat file with semicolon sub-delimiters.
      </p>
      <div class="figure"><a name="family_data.txt"></a><p class="title"><b>Figure&nbsp;10.&nbsp;Input flat file employees.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
father_name|mother_name|children
Matthew|Sarah|
Scott||Damian;Janet;Paul

        </pre>
      </div></div><br class="figure-break">
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="family_data.xml"></a><p class="title"><b>Figure&nbsp;11.&nbsp;Output XML file multivalued.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;eg:families xmlns:eg="http://examples.com/"&gt;
  &lt;eg:family&gt;
    &lt;eg:father-name&gt;Matthew&lt;/eg:father-name&gt;
    &lt;eg:mother-name&gt;Sarah&lt;/eg:mother-name&gt;
    &lt;eg:children/&gt;
  &lt;/eg:family&gt;
  &lt;eg:family&gt;
    &lt;eg:father-name&gt;Scott&lt;/eg:father-name&gt;
    &lt;eg:mother-name/&gt;
    &lt;eg:children&gt;
      &lt;eg:child&gt;Damian&lt;/eg:child&gt;
      &lt;eg:child&gt;Janet&lt;/eg:child&gt;
      &lt;eg:child&gt;Paul&lt;/eg:child&gt;
    &lt;/eg:children&gt;
  &lt;/eg:family&gt;
&lt;/eg:families&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-family_data.xml"></a><p class="title"><b>Figure&nbsp;12.&nbsp;Resources script resources-multivalued.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0"?&gt;
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
                    xmlns:eg="http://examples.com/"&gt;

  &lt;sx:service id="families"&gt;                               
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="families"/&gt;
        &lt;!-- sx:removeEmptyElements elements="eg:children"/ --&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="families"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile ref="family-records"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="families-to-xml-mapping"/&gt;
  &lt;/sx:recordContent&gt;
  
  &lt;sx:flatFile id="family-records"&gt;
    &lt;sx:flatFileHeader lineCount="1"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType name="family"&gt;
        &lt;sx:fieldDelimiter value="|"/&gt;
        &lt;sx:delimitedField name="father_name"/&gt;
        &lt;sx:delimitedField name="mother_name"/&gt;
        &lt;sx:delimitedField name="children"&gt;
          &lt;sx:subfieldDelimiter value=";"/&gt;
        &lt;/sx:delimitedField&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;
  
  &lt;sx:recordMapping id="families-to-xml-mapping"&gt;
    &lt;eg:families xmlns:eg="http://examples.com/"&gt;
      &lt;sx:onRecord&gt;
        &lt;eg:family&gt;
          &lt;sx:fieldElementMap field="father_name" element="eg:father-name"/&gt;
          &lt;sx:fieldElementMap field="mother_name" element="eg:mother-name"/&gt;
          &lt;eg:children&gt;
            &lt;sx:fieldElementSequenceMap field="children" element="eg:child"/&gt;
          &lt;/eg:children&gt;
        &lt;/eg:family&gt;
      &lt;/sx:onRecord&gt;
    &lt;/eg:families&gt;
  &lt;/sx:recordMapping&gt;
  
&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="d4e350"></a>Remarks</h5></div></div></div>
        
        <div class="itemizedlist"><ul type="disc"><li>
            <p>
Note that Matthew and Sarah have no children.  If you wanted to remove the empty
              <code class="sgmltag-element">myns:children</code>
element, uncomment the
              <a class="link" href="../guide/index.html#sx:removeEmptyElements" target="_top">sx:removeEmptyElements</a>
element in the
              <a class="link" href="../guide/index.html#sx:transform" target="_top">sx:transform</a>
block of the resources script,
            </p>
          </li></ul></div>
      </div>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-family_data.xml 
    -i data/family_data.txt -o output/family_data.xml families

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="ars-eg"></a>Search and Replace with Regular Expressions in Field Mappings (ars)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e363"></a>
      <a class="indexterm" name="d4e366"></a>
      <a class="indexterm" name="d4e369"></a>
      <a class="indexterm" name="d4e372"></a>
      <p>
The example below shows how to convert a flat file to XML using search and 
replace with regular expressions in field mappings.
      </p>
      <p>
The input file is a carot (^) delimited flat file with a header.
      </p>
      <div class="figure"><a name="ars.txt"></a><p class="title"><b>Figure&nbsp;13.&nbsp;Input flat file ars.dat</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
ProjectID^Project_Name^Description^PLAN_IT_RESC_DAYS^PLAN_IT_COST^ANNUAL_EBIT^ACTUAL_NPV^ACTUAL_IRR 
1234-00-0005^XOG new project insert^This is to test and verify the XOG'ing of new Project data from the ARS database.^430^59,627^100,351^3^9.2 

        </pre>
      </div></div><br class="figure-break">
      <p>
Note the following features of this data.
        </p><div class="itemizedlist"><ul type="disc"><li>
            <p>The first row is a header row.</p>
          </li><li>
            <p>The fourth and fifth fields contain embedded commas in numbers, which we want to strip out.</p>
          </li></ul></div><p>
      </p>
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="tasks.xml"></a><p class="title"><b>Figure&nbsp;14.&nbsp;Output XML file ars.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;NikuDataBus xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;
  &lt;Header action="write" externalSource="NIKU" objectType="project" version="6.0.11"/&gt;
  &lt;Projects&gt;
    &lt;Project name="XOG new project insert" projectID="1234-00-0005" description="This is to test and verify the XOG'ing of new Project data from the ARS database."&gt;
      &lt;CustomInformation&gt;
        &lt;PLAN_IT_RESOURCE_DAYS&gt;430&lt;/PLAN_IT_RESOURCE_DAYS&gt;
        &lt;PLAN_IT_COST&gt;59627&lt;/PLAN_IT_COST&gt;
        &lt;ANNUAL_EBIT&gt;100351&lt;/ANNUAL_EBIT&gt;
        &lt;ACTUAL_NPV&gt;3&lt;/ACTUAL_NPV&gt;
        &lt;ACTUAL_IRR&gt;9.2&lt;/ACTUAL_IRR&gt;
      &lt;/CustomInformation&gt;
      &lt;General addedBy="XOG" addedDate="03/26/2005 8:10:09 PM"/&gt;
    &lt;/Project&gt;
  &lt;/Projects&gt;
&lt;/NikuDataBus&gt;
</pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-ars.xml"></a><p class="title"><b>Figure&nbsp;15.&nbsp;Resources script resources-ars.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:msv="http://www.servingxml.com/extensions/msv"&gt;

  &lt;sx:service id="ars"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="ars"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="ars"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile ref="arsFlatFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="arsToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="arsFlatFile"&gt;
    &lt;sx:flatFileHeader lineCount="1"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType name="detail"&gt;
        &lt;sx:fieldDelimiter value="^"/&gt;
        &lt;sx:delimitedField name="ProjectID"/&gt;
        &lt;sx:delimitedField name="Project_Name"/&gt;
        &lt;sx:delimitedField name="Description"/&gt;
        &lt;sx:delimitedField name="PLAN_IT_RESC_DAYS"/&gt;
        &lt;sx:delimitedField name="PLAN_IT_COST"/&gt;
        &lt;sx:delimitedField name="ANNUAL_EBIT"/&gt;
        &lt;sx:delimitedField name="ACTUAL_NPV"/&gt;
        &lt;sx:delimitedField name="ACTUAL_IRR"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="arsToXmlMapping"&gt;
    &lt;NikuDataBus xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;

      &lt;Header version="6.0.11" action="write" objectType="project" externalSource="NIKU"/&gt;
      &lt;Projects&gt;
        &lt;sx:groupBy fields="ProjectID"&gt;
          &lt;Project&gt;
            &lt;sx:fieldAttributeMap field="Project_Name" attribute="name"/&gt;
            &lt;sx:fieldAttributeMap field="ProjectID" attribute="projectID"/&gt;
            &lt;sx:fieldAttributeMap field="Description" attribute="description"/&gt;
            &lt;sx:onRecord&gt;
              &lt;CustomInformation&gt;
                &lt;sx:fieldElementMap field="PLAN_IT_RESC_DAYS" element="PLAN_IT_RESOURCE_DAYS"/&gt;
                &lt;sx:elementMap element="PLAN_IT_COST"&gt;
                  &lt;sx:findAndReplace searchFor ="," replaceWith =""&gt;
                    &lt;sx:toString value="{PLAN_IT_COST}"/&gt;
                  &lt;/sx:findAndReplace&gt;
                &lt;/sx:elementMap&gt;
                &lt;sx:elementMap element="ANNUAL_EBIT"&gt;
                  &lt;sx:findAndReplace searchFor ="," replaceWith =""&gt;
                    &lt;sx:toString value="{ANNUAL_EBIT}"/&gt;
                  &lt;/sx:findAndReplace&gt;
                &lt;/sx:elementMap&gt;
                &lt;sx:fieldElementMap field="ACTUAL_NPV" element="ACTUAL_NPV"/&gt;
                &lt;sx:fieldElementMap field="ACTUAL_IRR" element="ACTUAL_IRR"/&gt;
              &lt;/CustomInformation&gt;
              &lt;General addedBy="XOG"&gt;
                &lt;sx:fieldAttributeMap attribute="addedDate"&gt;
                  &lt;sx:formatDateTime format="MM/dd/yyyy h:mm:ss a"&gt;
                    &lt;sx:currentDateTime/&gt;
                  &lt;/sx:formatDateTime&gt;
                &lt;/sx:fieldAttributeMap&gt;
              &lt;/General&gt;
            &lt;/sx:onRecord&gt;
          &lt;/Project&gt;
        &lt;/sx:groupBy&gt;
      &lt;/Projects&gt;
    &lt;/NikuDataBus&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
Note the following points about this script.
        </p><div class="itemizedlist"><ul type="disc"><li>
            <p>
The
              <a class="link" href="../guide/index.html#sx:currentDateTime" target="_top">sx:currentDateTime</a>
element evaluates to the current date with a lexical representation as defined for
              <a class="ulink" href="http://www.w3.org/TR/xmlschema-2/#dateTime" target="_top">xs:dateTime</a>
of
              <a class="ulink" href="http://www.w3.org/TR/xmlschema-2/" target="_top">XML Schema Part 2: Datatypes</a>
.
            </p>
          </li><li>
            <p>
The
              <a class="link" href="../guide/index.html#sx:formatDateTime" target="_top">sx:formatDateTime</a>
formats the XML Schema lexical representation of a date using a format string
which must must follow the syntax specified for the
              <a class="ulink" href="http://java.sun.com/j2se/1.3/docs/api/java/text/SimpleDateFormat.html" target="_top">JDK SimpleDateFormat</a>
class..
            </p>
          </li></ul></div><p>
      </p>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-ars.xml -i data/ars.txt -o output/ars.xml ars 

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="tab-delimited"></a>Converting a Tab Delimited Flat File to XML (tab-delimited)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e410"></a>
      <a class="indexterm" name="d4e413"></a>
      <p>
The example below shows how to convert a
flat file with tab delimiters to XML.</p>
      <p>
The input file is a tab (0x09) delimited flat file with a header.
      </p>
      <div class="figure"><a name="tab_delimited_employees.txt"></a><p class="title"><b>Figure&nbsp;16.&nbsp;Input flat file tab_delimited_employees.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
employee-no	employee-name	dept	salary
00000001	Smith, Matthew	sales	150,000.00
00000002	Brown, Sarah	sales	89,000.00
00000003	Oberc, Scott	finance	110,000.00
00000004	Scott, Colette	sales	75,000.00

        </pre>
      </div></div><br class="figure-break">
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="employees.xml"></a><p class="title"><b>Figure&nbsp;17.&nbsp;Output XML file employees.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;employees&gt;
  &lt;employee&gt;
    &lt;employee-no&gt;00000001&lt;/employee-no&gt;
    &lt;employee-name&gt;Smith, Matthew&lt;/employee-name&gt;
    &lt;department&gt;sales&lt;/department&gt;
    &lt;salary&gt;150,000.00&lt;/salary&gt;
  &lt;/employee&gt;
  &lt;employee&gt;
    &lt;employee-no&gt;00000002&lt;/employee-no&gt;
    &lt;employee-name&gt;Brown, Sarah&lt;/employee-name&gt;
    &lt;department&gt;sales&lt;/department&gt;
    &lt;salary&gt;89,000.00&lt;/salary&gt;
  &lt;/employee&gt;
  &lt;employee&gt;
    &lt;employee-no&gt;00000003&lt;/employee-no&gt;
    &lt;employee-name&gt;Oberc, Scott&lt;/employee-name&gt;
    &lt;department&gt;finance&lt;/department&gt;
    &lt;salary&gt;110,000.00&lt;/salary&gt;
  &lt;/employee&gt;
  &lt;employee&gt;
    &lt;employee-no&gt;00000004&lt;/employee-no&gt;
    &lt;employee-name&gt;Scott, Colette&lt;/employee-name&gt;
    &lt;department&gt;sales&lt;/department&gt;
    &lt;salary&gt;75,000.00&lt;/salary&gt;
  &lt;/employee&gt;
&lt;/employees&gt;
</pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-tab_delimited_employees.xml"></a><p class="title"><b>Figure&nbsp;18.&nbsp;Resources script resources-tab_delimited_employees.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="employees"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="employee-data"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="employee-data" name="employees"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:urlSource url="data/tab_delimited_employees.txt"/&gt;
      &lt;sx:flatFile ref="employee-file"/&gt;
    &lt;/sx:flatFileReader&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="employee-file"&gt;
    &lt;sx:flatFileHeader lineCount="1"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:fieldDelimiter value="\t"/&gt;
      &lt;!-- Another way of specifying a horizontal tab character --&gt;
      &lt;!-- &lt;sx:fieldDelimiter value="&amp;#x09;"/&gt; --&gt;
      &lt;sx:flatRecordType name="employee"&gt;
        &lt;sx:delimitedField name="employee-no"/&gt;
        &lt;sx:delimitedField name="employee-name"/&gt;
        &lt;sx:delimitedField name="department"/&gt;
        &lt;sx:delimitedField name="salary"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
Note the following points about this script.
        </p><div class="itemizedlist"><ul type="disc"><li>
            <p>
The tab delimiter may be specified either with the
              <code class="code">\t</code>
symbol, or, alternatively, with the numerical entity reference
              &amp;#x09;
numerical entity
            </p>
          </li></ul></div><p>
      </p>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -o output/employees.xml 
    -r resources-tab_delimited_employees.xml employees 

        </pre><p>
      </p>
    </div>
  </div>
  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e436"></a>Delimited Fields, Multiple Record Types</h3></div></div></div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e438"></a>Converting a flat file with multiple record formats to XML with grouping (exotics)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e441"></a>
      <a class="indexterm" name="d4e444"></a>
      <a class="indexterm" name="d4e447"></a>
      <p>
The example below shows how to convert a
pipe delimited flat file with multiple record formats to XM with grouping.
      </p>
      <p>
The input file is a pipe delimited file.
      </p>
      <div class="figure"><a name="exotics.txt"></a><p class="title"><b>Figure&nbsp;19.&nbsp;Input flat file exotics.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
SWAP|1234567|FLOAT|PAY|CAD|BA|2010/04/28|10000000.00
Cap|1234567||CAD|SELL|2010/04/28|0.03
SWAP|1234567|FIX|REC|CAD
Cap|1234568||CAD|SELL|2010/04/28|0.05

        </pre>
      </div></div><br class="figure-break">
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="exotics.xml"></a><p class="title"><b>Figure&nbsp;20.&nbsp;Output XML file exotics.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;exotics&gt;
  &lt;trade tradeId="1234567"&gt;
    &lt;option&gt;SWAP&lt;/option&gt;
    &lt;swapLeg style="FLOAT"&gt;
      &lt;side&gt;PAY&lt;/side&gt;
      &lt;maturityDate original="2010/04/28"&gt;2001/04/29&lt;/maturityDate&gt;
      &lt;currency&gt;CAD&lt;/currency&gt;
      &lt;index&gt;BA&lt;/index&gt;
      &lt;notional&gt;10000000.00&lt;/notional&gt;
    &lt;/swapLeg&gt;
    &lt;capSell&gt;
      &lt;buySell&gt;SELL&lt;/buySell&gt;
      &lt;maturityDate original="2010/04/28"&gt;2001/04/28&lt;/maturityDate&gt;
      &lt;strike&gt;0.03&lt;/strike&gt;
    &lt;/capSell&gt;
    &lt;swapLeg style="FIX"&gt;
      &lt;side&gt;REC&lt;/side&gt;
    &lt;/swapLeg&gt;
  &lt;/trade&gt;
  &lt;trade tradeId="1234568"&gt;
    &lt;option&gt;Cap&lt;/option&gt;
    &lt;capBuy&gt;
      &lt;buySell&gt;BUY&lt;/buySell&gt;
      &lt;maturityDate original="2010/04/28"&gt;2001/04/28&lt;/maturityDate&gt;
      &lt;strike&gt;0.05&lt;/strike&gt;
    &lt;/capBuy&gt;
  &lt;/trade&gt;
&lt;/exotics&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-exotics.xml"></a><p class="title"><b>Figure&nbsp;21.&nbsp;Resources script resources-exotics.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0"?&gt;

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="exotics"&gt;
	&lt;sx:serialize&gt;
	  &lt;sx:transform&gt;
		&lt;sx:content ref="exotics"/&gt;
	  &lt;/sx:transform&gt;
	&lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="exotics"&gt;
	&lt;sx:flatFileReader&gt;
	  &lt;sx:fileSource file="data/exotics.txt"/&gt;
	  &lt;sx:flatFile ref="exoticsFlatFile"/&gt;
	&lt;/sx:flatFileReader&gt;
	&lt;sx:recordMapping ref="exoticsToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="exoticsFlatFile"&gt;
	&lt;sx:flatFileBody&gt;
	  &lt;sx:flatRecordTypeChoice&gt;
		&lt;sx:fieldDelimiter value="|"/&gt;
		&lt;sx:delimitedField name="recordType"/&gt;
		&lt;sx:delimitedField name="tradeId"/&gt;
		&lt;sx:delimitedField name="style"/&gt;
		&lt;sx:when test="recordType='Cap'"&gt;
		  &lt;sx:flatRecordType name='Cap'&gt;
			&lt;sx:fieldDelimiter value="|"/&gt;
			&lt;sx:delimitedField name="recordType"/&gt;
			&lt;sx:delimitedField name="tradeId"/&gt;
			&lt;sx:delimitedField name="placeholder1"/&gt;
			&lt;sx:delimitedField name="currency"/&gt;
			&lt;sx:delimitedField name="buySell"/&gt;
			&lt;sx:delimitedField name="maturityDate"/&gt;
			&lt;sx:delimitedField name="strike"/&gt;
		  &lt;/sx:flatRecordType&gt;
		&lt;/sx:when&gt;
		&lt;sx:when test="recordType='SWAP' and style='FLOAT'"&gt;
		  &lt;sx:flatRecordType name='SwapFloatingLeg'&gt;
			&lt;sx:fieldDelimiter value="|"/&gt;
			&lt;sx:delimitedField name="recordType"/&gt;
			&lt;sx:delimitedField name="tradeId"/&gt;
			&lt;sx:delimitedField name="style"/&gt;
			&lt;sx:delimitedField name="side"/&gt;
			&lt;sx:delimitedField name="currency"/&gt;
			&lt;sx:delimitedField name="index"/&gt;
			&lt;sx:delimitedField name="maturityDate"/&gt;
			&lt;sx:delimitedField name="notional"/&gt;
		  &lt;/sx:flatRecordType&gt;
		&lt;/sx:when&gt;
		&lt;sx:when test="recordType='SWAP' and style='FIX'"&gt;
		  &lt;sx:flatRecordType name='SwapFixedLeg'&gt;
			&lt;sx:fieldDelimiter value="|"/&gt;
			&lt;sx:delimitedField name="recordType"/&gt;
			&lt;sx:delimitedField name="tradeId"/&gt;
			&lt;sx:delimitedField name="style"/&gt;
			&lt;sx:delimitedField name="side"/&gt;
			&lt;sx:delimitedField name="placeholder1"/&gt;
			&lt;sx:delimitedField name="currency"/&gt;
		  &lt;/sx:flatRecordType&gt;
		&lt;/sx:when&gt;
	  &lt;/sx:flatRecordTypeChoice&gt;
	&lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="exoticsToXmlMapping"&gt;
	&lt;exotics&gt;
	  &lt;sx:groupBy fields="tradeId"&gt;
		&lt;trade&gt;&lt;option&gt;
		  &lt;sx:choose&gt;
			&lt;sx:when test="recordType='Cap' or (recordType='SWAP' and style='FLOAT')"&gt;
			  &lt;sx:toString value="{recordType}"/&gt;
			&lt;/sx:when&gt;
		  &lt;/sx:choose&gt;&lt;/option&gt;
		  &lt;sx:fieldAttributeMap field="tradeId" attribute="tradeId"/&gt;
		  &lt;sx:onRecord recordType="Cap"&gt;
			  &lt;sx:choose&gt;
				&lt;sx:when test="buySell='BUY'"&gt;
		 	&lt;capBuy&gt;
			  &lt;sx:fieldElementMap field="buySell" element="buySell"/&gt;
			  &lt;sx:elementMap element="maturityDate"&gt;
				&lt;sx:fieldAttributeMap field="maturityDate" attribute="original"/&gt;
			  	&lt;sx:choose&gt;
			  		&lt;sx:when test="maturityDate='2010/04/28'"&gt;
			  			&lt;sx:toString value="2001/04/28"/&gt;
			  		&lt;/sx:when&gt;
			  	&lt;/sx:choose&gt;
			  &lt;/sx:elementMap&gt;
			  &lt;sx:fieldElementMap field="strike" element="strike"/&gt;
			&lt;/capBuy&gt;
				&lt;/sx:when&gt;
				&lt;sx:otherwise&gt;
		 	&lt;capSell&gt;
			  &lt;sx:fieldElementMap field="buySell" element="buySell"/&gt;
			  &lt;sx:elementMap element="maturityDate"&gt;
				&lt;sx:fieldAttributeMap field="maturityDate" attribute="original"/&gt;
			  	&lt;sx:choose&gt;
			  		&lt;sx:when test="maturityDate='2010/04/28'"&gt;
			  			&lt;sx:toString value="2001/04/28"/&gt;
			  		&lt;/sx:when&gt;
			  	&lt;/sx:choose&gt;
			  &lt;/sx:elementMap&gt;
			  &lt;sx:fieldElementMap field="strike" element="strike"/&gt;
			&lt;/capSell&gt;
				&lt;/sx:otherwise&gt;
			  &lt;/sx:choose&gt;
		  &lt;/sx:onRecord&gt;
		  &lt;sx:onRecord recordType="SwapFloatingLeg"&gt;
			&lt;swapLeg&gt;
			  &lt;sx:fieldAttributeMap field="style" attribute="style"/&gt;
			  &lt;sx:fieldElementMap field="side" element="side"/&gt;
			  &lt;maturityDate&gt;
				&lt;sx:fieldAttributeMap field="maturityDate" attribute="original"/&gt;
			  	&lt;sx:choose&gt;
			  		&lt;sx:when test="maturityDate='2010/04/28'"&gt;
			  			&lt;sx:toString value="2001/04/29"/&gt;
			  		&lt;/sx:when&gt;
			  	&lt;/sx:choose&gt;
			  &lt;/maturityDate&gt;
			  &lt;sx:fieldElementMap field="currency" element="currency"/&gt;
			  &lt;sx:fieldElementMap field="index" element="index"/&gt;
			  &lt;sx:fieldElementMap field="notional" element="notional"/&gt;
			&lt;/swapLeg&gt;
		  &lt;/sx:onRecord&gt;
		  &lt;sx:onRecord recordType="SwapFixedLeg"&gt;
			&lt;swapLeg&gt;
			  &lt;sx:fieldAttributeMap field="style" attribute="style"/&gt;
			  &lt;sx:fieldElementMap field="side" element="side"/&gt;
			&lt;/swapLeg&gt;
		  &lt;/sx:onRecord&gt;
		&lt;/trade&gt;
	  &lt;/sx:groupBy&gt;
	&lt;/exotics&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-exotics.xml -o output/exotics.xml exotics

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e465"></a>Converting flat files with record mappings that have optional elements (optional elements)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e468"></a>
      <a class="indexterm" name="d4e470"></a>
      <a class="indexterm" name="d4e473"></a>
      <p>
The example below shows how to convert a
flat file to XML by applying an XSLT transform to the canonical XML
representation of each record.
      </p>
      <p>
The input file is shown below.
      </p>
      <pre class="programlisting">
        
262025218|John|Smith|657827168||1|Main Street|London|45879|56|||||
262091012|Jane|Bell||000000000000|105|Penny Lane|Oxford|12345|56|1|Main Street|London|45879|56

      </pre>
      <p>Each line has an id, followed by a first and last name, followed by a customer address, and optionally
a billing address.  If the house number and street of the billing address are empty, the rule is that the
entire billing address be omitted from the XML output.
      </p>
      <p>
The desired output is shown below.
      </p>
      <pre class="programlisting">
        
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;mns:Message xmlns:mns="www.abc.com/abc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="www.abc.com/abc abc_v_1.1.xsd "&gt;
   &lt;wf_id&gt;262025218&lt;/wf_id&gt;
   &lt;timeStamp&gt;2006-02-11T22:18:21&lt;/timeStamp&gt;
   &lt;MessageData&gt;
      &lt;addCustomerRequest&gt;
         &lt;foreName&gt;John&lt;/foreName&gt;
         &lt;surName&gt;Smith&lt;/surName&gt;
         &lt;custAddress&gt;
            &lt;houseNumber&gt;1&lt;/houseNumber&gt;
            &lt;street&gt;Main Street&lt;/street&gt;
            &lt;town&gt;London&lt;/town&gt;
            &lt;postCode&gt;45879&lt;/postCode&gt;
            &lt;country&gt;56&lt;/country&gt;
         &lt;/custAddress&gt;
      &lt;/addCustomerRequest&gt;
   &lt;/MessageData&gt;
   &lt;wf_id&gt;262091012&lt;/wf_id&gt;
   &lt;timeStamp&gt;2006-02-11T22:18:21&lt;/timeStamp&gt;
   &lt;MessageData&gt;
      &lt;addCustomerRequest&gt;
         &lt;foreName&gt;Jane&lt;/foreName&gt;
         &lt;surName&gt;Bell&lt;/surName&gt;
         &lt;custAddress&gt;
            &lt;houseNumber&gt;105&lt;/houseNumber&gt;
            &lt;street&gt;Penny Lane&lt;/street&gt;
            &lt;town&gt;Oxford&lt;/town&gt;
            &lt;postCode&gt;12345&lt;/postCode&gt;
            &lt;country&gt;56&lt;/country&gt;
         &lt;/custAddress&gt;
         &lt;billAddress&gt;
            &lt;houseNumber&gt;1&lt;/houseNumber&gt;
            &lt;street&gt;Main Street&lt;/street&gt;
            &lt;town&gt;London&lt;/town&gt;
            &lt;postCode&gt;45879&lt;/postCode&gt;
            &lt;country&gt;56&lt;/country&gt;
         &lt;/billAddress&gt;
      &lt;/addCustomerRequest&gt;
   &lt;/MessageData&gt;
&lt;/mns:Message&gt;

      </pre>
      <p>
The following resources script does the transformation.
      </p>
      <pre class="programlisting">
        
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="addCustomer"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:xsltSerializer&gt;
        &lt;sx:outputProperty name="indent" value="yes"/&gt;
      &lt;/sx:xsltSerializer&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="addCustomer"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="customerFile"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType name="customer"&gt;
        &lt;sx:fieldDelimiter value="|"/&gt;
        &lt;sx:delimitedField name="rowid"/&gt;
        &lt;sx:delimitedField name="forename"/&gt;
        &lt;sx:delimitedField name="surname"/&gt;
        &lt;sx:delimitedField name="vatnumber"/&gt;
        &lt;sx:delimitedField name="ninumber"/&gt;
        &lt;sx:delimitedField name="custaddr_house_nr"/&gt;
        &lt;sx:delimitedField name="custaddr_street"/&gt;
        &lt;sx:delimitedField name="custaddr_town"/&gt;
        &lt;sx:delimitedField name="custaddr_postcode"/&gt;
        &lt;sx:delimitedField name="custaddr_country"/&gt;
        &lt;sx:delimitedField name="billaddr_house_nr"/&gt;
        &lt;sx:delimitedField name="billaddr_street"/&gt;
        &lt;sx:delimitedField name="billaddr_town"/&gt;
        &lt;sx:delimitedField name="billaddr_postcode"/&gt;
        &lt;sx:delimitedField name="billaddr_country"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordContent id="addCustomer"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:fileSource file="data/optionalElements.txt"/&gt;
      &lt;sx:flatFile ref="customerFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="addCustomerToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:recordMapping id="addCustomerToXmlMapping"&gt;
    &lt;mns:Message xmlns:mns="www.abc.com/abc"
                 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                 xsi:schemaLocation="www.abc.com/abc abc_v_1.1.xsd"&gt;
      &lt;sx:onRecord&gt;
        &lt;sx:fieldElementMap field="rowid" element="wf_id"/&gt;
        &lt;timeStamp&gt;
          &lt;sx:formatDateTime format = "yyyy-MM-dd'T'HH:mm:ss"&gt;
            &lt;sx:currentDateTime/&gt;
          &lt;/sx:formatDateTime&gt;
        &lt;/timeStamp&gt;
        &lt;sx:transformRecord&gt;
          &lt;sx:xslt&gt;
            &lt;xsl:transform version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
              &lt;xsl:template match="customer"&gt;
                &lt;MessageData&gt;
                  &lt;addCustomerRequest&gt;
                    &lt;xsl:element name="foreName"&gt;
                      &lt;xsl:value-of select="forename"/&gt;
                    &lt;/xsl:element&gt;
                    &lt;xsl:element name="surName"&gt;
                      &lt;xsl:value-of select="surname"/&gt;
                    &lt;/xsl:element&gt;
                    &lt;custAddress&gt;
                      &lt;xsl:element name="houseNumber"&gt;
                        &lt;xsl:value-of select="custaddr_house_nr"/&gt;
                      &lt;/xsl:element&gt;
                      &lt;xsl:element name="street"&gt;
                        &lt;xsl:value-of select="custaddr_street"/&gt;
                      &lt;/xsl:element&gt;
                      &lt;xsl:element name="town"&gt;
                        &lt;xsl:value-of select="custaddr_town"/&gt;
                      &lt;/xsl:element&gt;
                      &lt;xsl:element name="postCode"&gt;
                        &lt;xsl:value-of select="custaddr_postcode"/&gt;
                      &lt;/xsl:element&gt;
                      &lt;xsl:element name="country"&gt;
                        &lt;xsl:value-of select="custaddr_country"/&gt;
                      &lt;/xsl:element&gt;
                    &lt;/custAddress&gt;
                    &lt;xsl:if test="string(billaddr_house_nr) and string(billaddr_street)"&gt;
                      &lt;billAddress&gt;
                        &lt;xsl:element name="houseNumber"&gt;
                          &lt;xsl:value-of select="billaddr_house_nr"/&gt;
                        &lt;/xsl:element&gt;
                        &lt;xsl:element name="street"&gt;
                          &lt;xsl:value-of select="billaddr_street"/&gt;
                        &lt;/xsl:element&gt;
                        &lt;xsl:element name="town"&gt;
                          &lt;xsl:value-of select="billaddr_town"/&gt;
                        &lt;/xsl:element&gt;
                        &lt;xsl:element name="postCode"&gt;
                          &lt;xsl:value-of select="billaddr_postcode"/&gt;
                        &lt;/xsl:element&gt;
                        &lt;xsl:element name="country"&gt;
                          &lt;xsl:value-of select="billaddr_country"/&gt;
                        &lt;/xsl:element&gt;
                      &lt;/billAddress&gt;
                    &lt;/xsl:if&gt;
                  &lt;/addCustomerRequest&gt;
                &lt;/MessageData&gt;
              &lt;/xsl:template&gt;
            &lt;/xsl:transform&gt;
          &lt;/sx:xslt&gt;
        &lt;/sx:transformRecord&gt;
      &lt;/sx:onRecord&gt;
    &lt;/mns:Message&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

      </pre>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-optionalElements.xml  
  -o output/optionalElements.xml optionalElements

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e486"></a>Converting a Java properties file to XML (messages)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e489"></a>
      <a class="indexterm" name="d4e492"></a>
      <p>
The example below shows how to convert a
Java properties file to XML.</p>
      <p>
The input file is a Java properties file.
      </p>
      <div class="figure"><a name="messages.properties"></a><p class="title"><b>Figure&nbsp;22.&nbsp;Input property file messages.properties</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
parser.ope.2=')' or '-[' or '+[' or '&amp;[' is expected.
parser.factor.5=A back reference or an anchor or a lookahead or a lookbehind \
is expected in a conditional pattern.
parser.next.2='?' is not expected.  '(?:' or '(?=' or '(?!' or '(?&lt;' or '(?#' or '(?&gt;'?
#parser.next.3='(?&lt;=' or '(?&lt;!' is expected.

        </pre>
      </div></div><br class="figure-break">
      <p>
This file has a number of features.
        </p><div class="itemizedlist"><ul type="disc"><li>
            <p>The entries are key-value pairs separated by the '=' symbol.</p>
          </li><li>
            <p>The value in the first line contains an '&amp;' symbol,
which is a special character in XML, and will be escaped in the output file.</p>
          </li><li>
            <p>The second line ends with a continuation character.</p>
          </li><li>
            <p>The value in the third line contains an '=' symbol.</p>
          </li><li>
            <p>The last line starts with a comment symbol.</p>
          </li></ul></div><p>
      </p>
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="messages.xml"></a><p class="title"><b>Figure&nbsp;23.&nbsp;Output XML file messages.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;messages&gt;
  &lt;parser.ope.2&gt;')' or '-[' or '+[' or '&amp;amp;[' is expected.&lt;/parser.ope.2&gt;
  &lt;parser.factor.5&gt;A back reference or an anchor or a lookahead or a lookbehind is expected in a conditional pattern.&lt;/parser.factor.5&gt;
  &lt;parser.next.2&gt;'?' is not expected.  '(?:' or '(?=' or '(?!' or '(?&amp;lt;' or '(?#' or '(?&amp;gt;'?&lt;/parser.next.2&gt;
&lt;/messages&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-messages.xml"></a><p class="title"><b>Figure&nbsp;24.&nbsp;Resources script resources-messages.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;
   
  &lt;sx:service id="messages"&gt;                         
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="messages"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;
  
  &lt;sx:recordContent id="messages"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:urlSource url="data/messages.properties"/&gt;
      &lt;sx:flatFile&gt;
        &lt;sx:recordDelimiter continuation="\" value="\r\n"/&gt; 
        &lt;sx:recordDelimiter continuation="\" value="\n"/&gt; 
        &lt;sx:commentStarter value="#"/&gt;
        &lt;sx:flatFileBody&gt;
          &lt;sx:flatRecordType name="property"&gt;
            &lt;sx:delimitedField name="name"&gt;
              &lt;sx:fieldDelimiter value="="/&gt;
            &lt;/sx:delimitedField&gt;
            &lt;sx:delimitedField name="value"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:flatFileBody&gt;
      &lt;/sx:flatFile&gt;
    &lt;/sx:flatFileReader&gt;

    &lt;sx:recordMapping&gt;
      &lt;messages&gt;
        &lt;sx:onRecord&gt;
          &lt;sx:fieldElementMap field="value" element="{name}"/&gt;
        &lt;/sx:onRecord&gt;
      &lt;/messages&gt;
    &lt;/sx:recordMapping&gt;
  &lt;/sx:recordContent&gt;
  
&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
Note the following points about this script.
        </p><div class="itemizedlist"><ul type="disc"><li>
            <p>
The '=' delimiter is associated only with the
              <code class="code">name</code>
field,
not the
              <code class="code">value</code>
field.
            </p>
          </li><li>
            <p>
There is no delimiter specified for the
              <code class="code">value</code>
field, nor for the record as a whole.
This means that the
              <code class="code">value</code>
field will contain all the text between the first '=' symbol and the
record delimiter, including any more '=' symbols.
            </p>
          </li></ul></div><p>
      </p>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-messages.xml -o output/messages.xml 
    messages

        </pre><p>
      </p>
    </div>

    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e532"></a>Transforming a Java properties file with extra name field delimiters to produce nested tags (nested tags 1)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e535"></a>
      <a class="indexterm" name="d4e538"></a>
      <a class="indexterm" name="d4e541"></a>
      <p>
This example shows one way to write a resources script that will convert a
Java properties file to XML with nested tags.</p>
      <p>
The input file is a Java properties file.
      </p>
      <div class="figure"><a name="multipart-keys.properties"></a><p class="title"><b>Figure&nbsp;25.&nbsp;Input property file multipart-keys.properties</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
image.text.info1=hello world 1 
image.text.info2=hello \
world 2 
image.text.info3=hello world 3

        </pre>
      </div></div><br class="figure-break">
      <p>
This file has a number of features.
        </p><div class="itemizedlist"><ul type="disc"><li>
            <p>The entries are key-value pairs separated by an '=' symbol.</p>
          </li><li>
            <p>Each name consists of three parts separated by a '.' symbol</p>
          </li><li>
            <p>The second line ends with a continuation character.</p>
          </li></ul></div><p>
      </p>
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="nested-tags1.xml"></a><p class="title"><b>Figure&nbsp;26.&nbsp;Output XML file nested-tags1.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;messages&gt;
  &lt;image&gt;
    &lt;text&gt;
      &lt;info1&gt;hello world 1&lt;/info1&gt;
      &lt;info2&gt;hello world 2&lt;/info2&gt;
      &lt;info3&gt;hello world 3&lt;/info3&gt;
    &lt;/text&gt;
  &lt;/image&gt;
&lt;/messages&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
Note that each level of nesting corresponds to separate part of the key.
      </p>
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-messages.xml"></a><p class="title"><b>Figure&nbsp;27.&nbsp;Resources script resources-props2nested1.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="messages"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="messages"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="messages"&gt;

    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile&gt;
        &lt;sx:commentStarter value="#"/&gt;
        &lt;sx:commentStarter value="//"/&gt;
        &lt;sx:recordDelimiter continuation="\" value="\r\n"/&gt;
        &lt;sx:recordDelimiter continuation="\" value="\n"/&gt;
        &lt;sx:flatFileBody&gt;
          &lt;sx:flatRecordType name="property"&gt;
            &lt;sx:delimitedField name="key1"&gt;
              &lt;sx:fieldDelimiter value="."/&gt;
            &lt;/sx:delimitedField&gt;
            &lt;sx:delimitedField name="key2"&gt;
              &lt;sx:fieldDelimiter value="."/&gt;
            &lt;/sx:delimitedField&gt;
            &lt;sx:delimitedField name="key3"&gt;
              &lt;sx:fieldDelimiter value="="/&gt;
            &lt;/sx:delimitedField&gt;
            &lt;sx:delimitedField name="value"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:flatFileBody&gt;
      &lt;/sx:flatFile&gt;
    &lt;/sx:flatFileReader&gt;

    &lt;sx:recordMapping&gt;
      &lt;messages&gt;
        &lt;sx:groupBy fields="key1"&gt;
          &lt;sx:elementMap element="{key1}"&gt;
            &lt;sx:groupBy fields="key2 key2"&gt;
              &lt;sx:elementMap element="{key2}"&gt;
                &lt;sx:onRecord&gt;
                  &lt;sx:fieldElementMap field="value" element="{key3}"/&gt;
                &lt;/sx:onRecord&gt;
              &lt;/sx:elementMap&gt;
            &lt;/sx:groupBy&gt;
          &lt;/sx:elementMap&gt;
        &lt;/sx:groupBy&gt;
      &lt;/messages&gt;
    &lt;/sx:recordMapping&gt;

  &lt;/sx:recordContent&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
This script relies on reading each record as four fields.
        </p><div class="itemizedlist"><ul type="disc"><li>
            <span>
              <code class="code">key1</code>
is terminated with a '.' delimiter</span>
          </li><li>
            <span>
              <code class="code">key2</code>
is terminated with a '.' delimiter</span>
          </li><li>
            <span>
              <code class="code">key3</code>
is terminated with an '=' delimiter</span>
          </li><li>
            <span>
              <code class="code">value</code>
is terminated with a record delimiter</span>
          </li></ul></div><p>
      </p>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -i data/multipart-keys.properties 
    -o output/nested-tags1.xml -r resources-props2nested1.xml messages

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e582"></a>Transforming a Java properties file with name subfield delimiters to produce nested tags (nested tags 2)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e585"></a>
      <a class="indexterm" name="d4e588"></a>
      <p>
This example shows another way to write a resources script that will convert a
Java properties file to XML with nested tags.
      </p>
      <p>
The
        <a class="xref" href="#multipart-keys.properties" title="Figure&nbsp;25.&nbsp;Input property file multipart-keys.properties">properties input file</a>
and the desired
        <a class="xref" href="#nested-tags1.xml" title="Figure&nbsp;26.&nbsp;Output XML file nested-tags1.xml">XML output file</a>
are the same as the previous example.
      </p>
      <p>
This time the resources script is written as follows.
      </p>
      <div class="figure"><a name="resources-messages.xml"></a><p class="title"><b>Figure&nbsp;28.&nbsp;Resources script resources-props2nested2.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="messages"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="messages"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="messages"&gt;

    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile&gt;
        &lt;sx:commentStarter value="#"/&gt;
        &lt;sx:commentStarter value="//"/&gt;
        &lt;sx:recordDelimiter continuation="\" value="\r\n"/&gt;
        &lt;sx:recordDelimiter continuation="\" value="\n"/&gt;
        &lt;sx:flatFileBody&gt;
          &lt;sx:flatRecordType name="property"&gt;
            &lt;sx:delimitedField name="name"&gt;
              &lt;sx:fieldDelimiter value="="/&gt;
              &lt;sx:subfieldDelimiter value="."/&gt;
            &lt;/sx:delimitedField&gt;
            &lt;sx:delimitedField name="value"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:flatFileBody&gt;
      &lt;/sx:flatFile&gt;
    &lt;/sx:flatFileReader&gt;

    &lt;sx:recordMapping&gt;
      &lt;messages&gt;
        &lt;sx:groupBy fields="name[1]"&gt;
          &lt;sx:elementMap element="{name[1]}"&gt;
            &lt;sx:groupBy fields="name[1] name[2]"&gt;
              &lt;sx:elementMap element="{name[2]}"&gt;
                &lt;sx:onRecord&gt;
                  &lt;sx:fieldElementMap field="value" element="{name[3]}"/&gt;
                &lt;/sx:onRecord&gt;
              &lt;/sx:elementMap&gt;
            &lt;/sx:groupBy&gt;
          &lt;/sx:elementMap&gt;
        &lt;/sx:groupBy&gt;
      &lt;/messages&gt;
    &lt;/sx:recordMapping&gt;

  &lt;/sx:recordContent&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
This script relies on reading each record as two fields, a multi-valued name field and a value field.
        </p><div class="itemizedlist"><ul type="disc"><li>
            <span>
              <code class="code">name</code>
has three values that may be indexed as 1...3</span>
          </li><li>
            <span>
              <code class="code">value</code>
has one value</span>
          </li></ul></div><p>
      </p>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -i data/multipart-keys.properties 
    -o output/nested-tags2.xml -r resources-props2nested2.xml messages

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e609"></a>Reordering a group of records before mapping to XML (multiple summaries)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e612"></a>
      <p>
The example below shows how to reorder a group of records
        before mapping them to XML.</p>
      <p>
The input file is shown below.
      </p>
      <pre class="programlisting">
        
HEADER  
S 001 
S 002 
B 001
S 003 
B 002
TRAILER 

      </pre>
      <p>Each 'B' record represents a summary of the 'S' records since the last summary..
      </p>
      <p>
Suppose you want to turn it into the following:.
      </p>
      <pre class="programlisting">
        
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;DOCUMENT&gt;
  &lt;HEADER/&gt;
  &lt;B value="001"&gt;
    &lt;S value="001"/&gt;
    &lt;S value="002"/&gt;
  &lt;/B&gt;
  &lt;B value="003"&gt;
    &lt;S value="003"/&gt;
  &lt;/B&gt;
  &lt;TRAILER/&gt;
&lt;/DOCUMENT&gt;

      </pre>
      <p>
If the summary records came before the details, rather than after, the mapping would be straightforward:
see the examples with sx:innerGroup grouping elements. This suggests reordering the records as they come in.
      </p>
      <p>
The following resources script does the transformation.
      </p>
      <pre class="programlisting">
        
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="multipleSummaries"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="multipleSummariesContent"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="multipleSummariesContent"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:urlSource url="data/multipleSummaries.txt"/&gt;
      &lt;sx:flatFile ref="multipleSummariesFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="multipleSummariesMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:recordMapping id="multipleSummariesMapping"&gt;
    &lt;DOCUMENT&gt;
      &lt;sx:groupChoice&gt;

        &lt;sx:innerGroup startTest="sx:current/Header" 
                       endTest="sx:previous/Header"&gt;
          &lt;sx:onRecord&gt;
            &lt;HEADER/&gt;
          &lt;/sx:onRecord&gt;
        &lt;/sx:innerGroup&gt;

        &lt;sx:innerGroup startTest="sx:current/Trailer" 
                       endTest="sx:previous/Trailer"&gt;
          &lt;sx:onRecord&gt;
            &lt;TRAILER/&gt;
          &lt;/sx:onRecord&gt;                                        
        &lt;/sx:innerGroup&gt;

        &lt;sx:innerGroup startTest="sx:current/S" 
                       endTest="sx:previous/B"&gt;
          &lt;!-- reorder the records in this group - move the B records to the front --&gt;
          &lt;sx:reorderRecords recordTypes="B S"/&gt;
            &lt;B&gt;
              &lt;sx:fieldAttributeMap field="value" attribute="value"/&gt;
              &lt;sx:onRecord recordType='S'&gt;
                &lt;S&gt;
                  &lt;sx:fieldAttributeMap field="value" attribute="value"/&gt;
                &lt;/S&gt;
              &lt;/sx:onRecord&gt;
            &lt;/B&gt;
        &lt;/sx:innerGroup&gt;

      &lt;/sx:groupChoice&gt;
    &lt;/DOCUMENT&gt;
  &lt;/sx:recordMapping&gt;

  &lt;sx:flatFile id="multipleSummariesFile"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:fieldDelimiter&gt;                            
        &lt;sx:whitespaceSeparator/&gt;
      &lt;/sx:fieldDelimiter&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:delimitedField name="tag"/&gt;
        &lt;sx:when test="tag='HEADER'"&gt;
          &lt;sx:flatRecordType name="Header"&gt;
            &lt;sx:delimitedField name="tag"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="tag='TRAILER'"&gt;
          &lt;sx:flatRecordType name="Trailer"&gt;
            &lt;sx:delimitedField name="tag"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="tag='S'"&gt;
          &lt;sx:flatRecordType name="S"&gt;
            &lt;sx:delimitedField name="tag"/&gt;
            &lt;sx:delimitedField name="value"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="tag='B'"&gt;
          &lt;sx:flatRecordType name="B"&gt;
            &lt;sx:delimitedField name="tag"/&gt;
            &lt;sx:delimitedField name="value"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

&lt;/sx:resources&gt;

      </pre>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-multipleSummaries.xml  
  -o output/multipleSummaries.xml multipleSummaries

        </pre><p>
      </p>
    </div>
  </div>
  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e626"></a>Delimited Fields, Multiple Record Types, Repeating Groups</h3></div></div></div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e628"></a>Mapping multiple repeating groups to XML (students-delim)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e631"></a>
      <p>
Suppose you have the following delimited file of students, their course grades, and their addresses.
      </p>
      <div class="figure"><a name="students-delim.txt"></a><p class="title"><b>Figure&nbsp;29.&nbsp;Input flat file students-delim.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
JANE^ENGL^C-~MATH^A+|1972^BLUE^CHICAGO^IL~ATLANTA^GA

        </pre>
      </div></div><br class="figure-break">
      <p>
The file has the following layout.
      </p>
      <table colsep="0">
        <tr>
          <td>name</td>
          <td>the field delimiter ^ defines the end of the field</td>
        </tr>
        <tr>
          <td>subject-grade</td>
          <td>repeating group, repeating segments are separated by the repeat delimiter ~, the segment delimiter | defines the end of the group</td>
        </tr>
        <tr>
          <td>year-born</td>
          <td>the field delimiter ^ defines the end of the field</td>
        </tr>
        <tr>
          <td>favorite-color</td>
          <td>the field delimiter ^ defines the end of the field</td>
        </tr>
        <tr>
          <td>address</td>
          <td>repeating group, repeating segments are separated by the repeat delimiter ~, the segment delimiter | defines the end of the group</td>
        </tr>
      </table>
      <p>
You want the XML output to look as follows.
      </p>
      <div class="figure"><a name="students-fix.xml"></a><p class="title"><b>Figure&nbsp;30.&nbsp;Output XML file students-fix.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;StudentGrades&gt;
  &lt;StudentGrade&gt;
    &lt;Name&gt;JANE&lt;/Name&gt;
    &lt;SubjectGrade&gt;
      &lt;Subject&gt;ENGL&lt;/Subject&gt;
      &lt;Grade&gt;C-&lt;/Grade&gt;
    &lt;/SubjectGrade&gt;
    &lt;SubjectGrade&gt;
      &lt;Subject&gt;MATH&lt;/Subject&gt;
      &lt;Grade&gt;A+&lt;/Grade&gt;
    &lt;/SubjectGrade&gt;
    &lt;YearBorn&gt;1972&lt;/YearBorn&gt;
    &lt;FavoriteColor&gt;BLUE&lt;/FavoriteColor&gt;
    &lt;Address&gt;
      &lt;City&gt;CHICAGO&lt;/City&gt;
      &lt;State&gt;IL&lt;/State&gt;
    &lt;/Address&gt;
    &lt;Address&gt;
      &lt;City&gt;ATLANTA&lt;/City&gt;
      &lt;State&gt;GA&lt;/State&gt;
    &lt;/Address&gt;
  &lt;/StudentGrade&gt;
&lt;/StudentGrades&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>The required resources script is
      </p>
      <div class="figure"><a name="resources-students-delim.xml"></a><p class="title"><b>Figure&nbsp;31.&nbsp;Resources script resources-students-delim.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="students"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="students-content"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="students-content"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile ref="students-file"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="students-mapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="students-file"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType name="student"&gt;
        &lt;sx:fieldDelimiter value="^"/&gt;                                              
        &lt;sx:repeatDelimiter value="~"/&gt;
        &lt;sx:segmentDelimiter value="|"/&gt;
        &lt;sx:delimitedField name="name"/&gt;
        &lt;sx:repeatingGroup name="grades"&gt;
          &lt;sx:flatRecordType name="subject-grade"&gt;
            &lt;sx:fieldDelimiter value="^"/&gt;                                              
            &lt;sx:delimitedField name="subject"/&gt;
            &lt;sx:delimitedField name="grade"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:repeatingGroup&gt;
        &lt;sx:delimitedField name="year-born"/&gt;
        &lt;sx:delimitedField name="favorite-color"/&gt;
        &lt;sx:repeatingGroup name="addresses"&gt;
          &lt;sx:flatRecordType name="address"&gt;
            &lt;sx:fieldDelimiter value="^"/&gt;                                              
            &lt;sx:delimitedField name="city"/&gt;
            &lt;sx:delimitedField name="state"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:repeatingGroup&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="students-mapping"&gt;
    &lt;StudentGrades&gt;
      &lt;sx:onRecord&gt;
        &lt;StudentGrade&gt;
          &lt;sx:fieldElementMap field="name" element="Name"/&gt;
          &lt;sx:subrecordMapping repeatingGroup="grades"&gt;
            &lt;sx:onRecord&gt;
              &lt;SubjectGrade&gt;
                &lt;sx:fieldElementMap field="subject" element="Subject"/&gt;
                &lt;sx:fieldElementMap field="grade" element="Grade"/&gt;
              &lt;/SubjectGrade&gt;
            &lt;/sx:onRecord&gt;
          &lt;/sx:subrecordMapping&gt;
          &lt;sx:fieldElementMap field="year-born" element="YearBorn"/&gt;
          &lt;sx:fieldElementMap field="favorite-color" element="FavoriteColor"/&gt;
          &lt;sx:subrecordMapping repeatingGroup="addresses"&gt;
            &lt;sx:onRecord&gt;
              &lt;Address&gt;
                &lt;sx:fieldElementMap field="city" element="City"/&gt;
                &lt;sx:fieldElementMap field="state" element="State"/&gt;
              &lt;/Address&gt;
            &lt;/sx:onRecord&gt;
          &lt;/sx:subrecordMapping&gt;
        &lt;/StudentGrade&gt;
      &lt;/sx:onRecord&gt;
    &lt;/StudentGrades&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml  -r resources-students-delim.xml -i data/students-delim.txt -o output/students-delim.xml 
    students

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e665"></a>Mapping a sequence of nested repeating groups to XML (invoice)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e668"></a>
      <a class="indexterm" name="d4e671"></a>
      <p>
Suppose you have the following data file.
      </p>
      <div class="figure"><a name="invoice.txt"></a><p class="title"><b>Figure&nbsp;32.&nbsp;Input flat file invoice.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
12|2007-02-02|DocType|} 
SndId|SndName|SndAddress|SndZip|} 
RecId|RecName|RecAddress|RecZip|} 
~ 
1|Item 1|2|Kg|150|300|} 
2|Item 2|2|Kg|350|700|} 
3|Item 3|1|$|50|50|} 
4|Item 4|10|Unt|30|100|} 
~ 
1|Ref 1|Doc 1|Text|} 
2|Ref 2|Doc 2|Text|} 
~ 
1|Disc 1|Item 1|} 
2|Disc 2|Item 2|} 
3|Disc 3|Item 3|} 
~ 
Code a|Value 1|} 
Code z|Value 3|} 
Code x|Value 2|} 
Code w|Value 2|} 
Code y|Value 1|}
~ 
!

        </pre>
      </div></div><br class="figure-break">
      <p>The file has
        <code class="code">n</code>
sections separated by the "~" character.  The first section has several non repeating records separated by a "}".
But after that, there are 4 repeating sections separated by the same "~" as above.  Each repeating section starts where the previous one ends.
      </p>
      <p>The character "!" as the first character in the last line indicates the end of the data.
      </p>
      <p>
You want the XML output to look as follows.
      </p>
      <div class="figure"><a name="invoice.xml"></a><p class="title"><b>Figure&nbsp;33.&nbsp;Output XML file invoice.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;InvoiceDocument&gt;
   &lt;Header&gt;
      &lt;DocId&gt;
         &lt;Id&gt;12&lt;/Id&gt;
         &lt;DocDate&gt;2007-02-02&lt;/DocDate&gt;
         &lt;DocumentType&gt;DocType&lt;/DocumentType&gt;
      &lt;/DocId&gt;
      &lt;Sender&gt;
         &lt;SenderPassport&gt;SndId&lt;/SenderPassport&gt;
         &lt;SenderFullName&gt;SndName&lt;/SenderFullName&gt;
         &lt;SenderAddress&gt;SndAddress&lt;/SenderAddress&gt;
         &lt;SenderZip&gt;SndZip&lt;/SenderZip&gt;
      &lt;/Sender&gt;
      &lt;Recipient&gt;
         &lt;RecipientPassport&gt;RecId&lt;/RecipientPassport&gt;
         &lt;RecipientFullName&gt;RecName&lt;/RecipientFullName&gt;
         &lt;RecipientAddress&gt;RecAddress&lt;/RecipientAddress&gt;
         &lt;RecipientZip&gt;RecZip&lt;/RecipientZip&gt;
      &lt;/Recipient&gt;
   &lt;/Header&gt;
   &lt;Detail&gt;
      &lt;Item&gt;1&lt;/Item&gt;
      &lt;Description&gt;Item 1&lt;/Description&gt;
      &lt;Quantity&gt;2&lt;/Quantity&gt;
      &lt;Unit&gt;Kg&lt;/Unit&gt;
      &lt;ItemPrice&gt;150&lt;/ItemPrice&gt;
      &lt;TotalPrice&gt;300&lt;/TotalPrice&gt;
   &lt;/Detail&gt;
   &lt;Detail&gt;
      &lt;Item&gt;2&lt;/Item&gt;
      &lt;Description&gt;Item 2&lt;/Description&gt;
      &lt;Quantity&gt;2&lt;/Quantity&gt;
      &lt;Unit&gt;Kg&lt;/Unit&gt;
      &lt;ItemPrice&gt;350&lt;/ItemPrice&gt;
      &lt;TotalPrice&gt;700&lt;/TotalPrice&gt;
   &lt;/Detail&gt;
   &lt;Detail&gt;
      &lt;Item&gt;3&lt;/Item&gt;
      &lt;Description&gt;Item 3&lt;/Description&gt;
      &lt;Quantity&gt;1&lt;/Quantity&gt;
      &lt;Unit&gt;$&lt;/Unit&gt;
      &lt;ItemPrice&gt;50&lt;/ItemPrice&gt;
      &lt;TotalPrice&gt;50&lt;/TotalPrice&gt;
   &lt;/Detail&gt;
   &lt;Detail&gt;
      &lt;Item&gt;4&lt;/Item&gt;
      &lt;Description&gt;Item 4&lt;/Description&gt;
      &lt;Quantity&gt;10&lt;/Quantity&gt;
      &lt;Unit&gt;Unt&lt;/Unit&gt;
      &lt;ItemPrice&gt;30&lt;/ItemPrice&gt;
      &lt;TotalPrice&gt;100&lt;/TotalPrice&gt;
   &lt;/Detail&gt;
   &lt;Reference&gt;
      &lt;RefId&gt;1&lt;/RefId&gt;
      &lt;RefType&gt;Ref 1&lt;/RefType&gt;
      &lt;RefDoc&gt;Doc 1&lt;/RefDoc&gt;
      &lt;RefText&gt;Text&lt;/RefText&gt;
   &lt;/Reference&gt;
   &lt;Reference&gt;
      &lt;RefId&gt;2&lt;/RefId&gt;
      &lt;RefType&gt;Ref 2&lt;/RefType&gt;
      &lt;RefDoc&gt;Doc 2&lt;/RefDoc&gt;
      &lt;RefText&gt;Text&lt;/RefText&gt;
   &lt;/Reference&gt;
   &lt;Discount&gt;
      &lt;DiscId&gt;1&lt;/DiscId&gt;
      &lt;DiscDescription&gt;Disc 1&lt;/DiscDescription&gt;
      &lt;DiscItem&gt;Item 1&lt;/DiscItem&gt;
   &lt;/Discount&gt;
   &lt;Discount&gt;
      &lt;DiscId&gt;2&lt;/DiscId&gt;
      &lt;DiscDescription&gt;Disc 2&lt;/DiscDescription&gt;
      &lt;DiscItem&gt;Item 2&lt;/DiscItem&gt;
   &lt;/Discount&gt;
   &lt;Discount&gt;
      &lt;DiscId&gt;3&lt;/DiscId&gt;
      &lt;DiscDescription&gt;Disc 3&lt;/DiscDescription&gt;
      &lt;DiscItem&gt;Item 3&lt;/DiscItem&gt;
   &lt;/Discount&gt;
   &lt;Code&gt;
      &lt;Code&gt;Code a&lt;/Code&gt;
      &lt;Value&gt;Value 1&lt;/Value&gt;
   &lt;/Code&gt;
   &lt;Code&gt;
      &lt;Code&gt;Code z&lt;/Code&gt;
      &lt;Value&gt;Value 3&lt;/Value&gt;
   &lt;/Code&gt;
   &lt;Code&gt;
      &lt;Code&gt;Code x&lt;/Code&gt;
      &lt;Value&gt;Value 2&lt;/Value&gt;
   &lt;/Code&gt;
   &lt;Code&gt;
      &lt;Code&gt;Code w&lt;/Code&gt;
      &lt;Value&gt;Value 2&lt;/Value&gt;
   &lt;/Code&gt;
   &lt;Code&gt;
      &lt;Code&gt;Code y&lt;/Code&gt;
      &lt;Value&gt;Value 1&lt;/Value&gt;
   &lt;/Code&gt;
&lt;/InvoiceDocument&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>The required resources script is
      </p>
      <div class="figure"><a name="resources-invoice.xml"></a><p class="title"><b>Figure&nbsp;34.&nbsp;Resources script resources-invoice.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="invoice"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:xsltSerializer&gt;
        &lt;sx:outputProperty name="indent" value="yes"/&gt;
      &lt;/sx:xsltSerializer&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="invoice-content"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="invoice-content"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile ref="invoice-file"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="invoice-mapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="invoice-file"&gt;
    &lt;sx:recordDelimiter value="\r\n!"/&gt;
    &lt;sx:recordDelimiter value="\n!"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType name="invoice" omitFinalRepeatDelimiter="false"&gt;
        &lt;sx:repeatDelimiter value="~"/&gt;
        &lt;sx:repeatingGroup name="Header" count="1"&gt;
          &lt;sx:flatRecordType name="Header"&gt;
            &lt;sx:fieldDelimiter value="|"/&gt;
            &lt;sx:repeatDelimiter value="}"/&gt;
            &lt;!--sx:segmentDelimiter value="~"/--&gt;
            &lt;sx:repeatingGroup name="Document" count="1"&gt;
              &lt;sx:flatRecordType name="Doc"&gt;
                &lt;sx:delimitedField name="Id"/&gt;
                &lt;sx:delimitedField name="DocDate"/&gt;
                &lt;sx:delimitedField name="DocumentType"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:repeatingGroup&gt;
            &lt;sx:repeatingGroup name="Sender" count="1"&gt;
              &lt;sx:flatRecordType name="Sender"&gt;
                &lt;sx:delimitedField name="SenderPassport"/&gt;
                &lt;sx:delimitedField name="SenderFullName"/&gt;
                &lt;sx:delimitedField name="SenderAddress"/&gt;
                &lt;sx:delimitedField name="SenderZip"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:repeatingGroup&gt;
            &lt;sx:repeatingGroup name="Recipient" count="1"&gt;
              &lt;sx:flatRecordType name="Recipient"&gt;
                &lt;sx:delimitedField name="RecipientPassport"/&gt;
                &lt;sx:delimitedField name="RecipientFullName"/&gt;
                &lt;sx:delimitedField name="RecipientAddress"/&gt;
                &lt;sx:delimitedField name="RecipientZip"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:repeatingGroup&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:repeatingGroup&gt;

        &lt;sx:repeatingGroup name="Detail" count="1"&gt;
          &lt;sx:flatRecordType name="Detail"&gt;
            &lt;sx:fieldDelimiter value="|"/&gt;
            &lt;sx:repeatDelimiter value="}"/&gt;
            &lt;sx:repeatingGroup name="Item"&gt;
              &lt;sx:flatRecordType name="Item"&gt;
                &lt;sx:delimitedField name="Item"/&gt;
                &lt;sx:delimitedField name="Description"/&gt;
                &lt;sx:delimitedField name="Quantity"/&gt;
                &lt;sx:delimitedField name="Unit"/&gt;
                &lt;sx:delimitedField name="ItemPrice"/&gt;
                &lt;sx:delimitedField name="TotalPrice"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:repeatingGroup&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:repeatingGroup&gt;

        &lt;sx:repeatingGroup name="Reference" count="1"&gt;
          &lt;sx:flatRecordType name="Reference"&gt;
            &lt;sx:fieldDelimiter value="|"/&gt;
            &lt;sx:repeatDelimiter value="}"/&gt;
            &lt;sx:segmentDelimiter value="~"/&gt;
            &lt;sx:repeatingGroup name="Ref"&gt;
              &lt;sx:flatRecordType name="Ref"&gt;
                &lt;sx:delimitedField name="RefId"/&gt;
                &lt;sx:delimitedField name="RefType"/&gt;
                &lt;sx:delimitedField name="RefDoc"/&gt;
                &lt;sx:delimitedField name="RefText"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:repeatingGroup&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:repeatingGroup&gt;

        &lt;sx:repeatingGroup name="Discount" count="1"&gt;
          &lt;sx:flatRecordType name="Discount"&gt;
            &lt;sx:fieldDelimiter value="|"/&gt;
            &lt;sx:repeatDelimiter value="}"/&gt;
            &lt;sx:segmentDelimiter value="~"/&gt;
            &lt;sx:repeatingGroup name="Disc"&gt;
              &lt;sx:flatRecordType name="Disc"&gt;
                &lt;sx:delimitedField name="DiscId"/&gt;
                &lt;sx:delimitedField name="DiscDescription"/&gt;
                &lt;sx:delimitedField name="DiscItem"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:repeatingGroup&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:repeatingGroup&gt;

        &lt;sx:repeatingGroup name="Codes" count="1"&gt;
          &lt;sx:flatRecordType name="Codes"&gt;
            &lt;sx:fieldDelimiter value="|"/&gt;
            &lt;sx:repeatDelimiter value="}"/&gt;
            &lt;sx:segmentDelimiter value="~"/&gt;
            &lt;sx:repeatingGroup name="Code"&gt;
              &lt;sx:flatRecordType name="Code"&gt;
                &lt;sx:delimitedField name="Code"/&gt;
                &lt;sx:delimitedField name="Value"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:repeatingGroup&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:repeatingGroup&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="invoice-mapping"&gt;
    &lt;InvoiceDocument&gt;
      &lt;sx:onRecord&gt;
        &lt;sx:subrecordMapping repeatingGroup="Header"&gt;
          &lt;sx:onRecord&gt;
            &lt;Header&gt;
              &lt;sx:subrecordMapping repeatingGroup="Document"&gt;
                &lt;sx:onRecord&gt;
                  &lt;DocId&gt;
                    &lt;sx:fieldElementMap field="Id" element="Id"/&gt;
                    &lt;sx:fieldElementMap field="DocDate" element="DocDate"/&gt;
                    &lt;sx:fieldElementMap field="DocumentType" element="DocumentType"/&gt;
                  &lt;/DocId&gt;
                &lt;/sx:onRecord&gt;
              &lt;/sx:subrecordMapping&gt;
              &lt;sx:subrecordMapping repeatingGroup="Sender"&gt;
                &lt;sx:onRecord&gt;
                  &lt;Sender&gt;
                    &lt;sx:fieldElementMap field="SenderPassport" element="SenderPassport"/&gt;
                    &lt;sx:fieldElementMap field="SenderFullName" element="SenderFullName"/&gt;
                    &lt;sx:fieldElementMap field="SenderAddress" element="SenderAddress"/&gt;
                    &lt;sx:fieldElementMap field="SenderZip" element="SenderZip"/&gt;
                  &lt;/Sender&gt;
                &lt;/sx:onRecord&gt;
              &lt;/sx:subrecordMapping&gt;
              &lt;sx:subrecordMapping repeatingGroup="Recipient"&gt;
                &lt;sx:onRecord&gt;
                  &lt;Recipient&gt;
                    &lt;sx:fieldElementMap field="RecipientPassport" element="RecipientPassport"/&gt;
                    &lt;sx:fieldElementMap field="RecipientFullName" element="RecipientFullName"/&gt;
                    &lt;sx:fieldElementMap field="RecipientAddress" element="RecipientAddress"/&gt;
                    &lt;sx:fieldElementMap field="RecipientZip" element="RecipientZip"/&gt;
                  &lt;/Recipient&gt;
                &lt;/sx:onRecord&gt;
              &lt;/sx:subrecordMapping&gt;
            &lt;/Header&gt;
          &lt;/sx:onRecord&gt;
        &lt;/sx:subrecordMapping&gt;

        &lt;sx:subrecordMapping repeatingGroup="Detail"&gt;
          &lt;sx:onRecord&gt;
            &lt;sx:subrecordMapping repeatingGroup="Item"&gt;
              &lt;sx:onRecord&gt;
                &lt;Detail&gt;
                  &lt;sx:fieldElementMap field="Item" element="Item"/&gt;
                  &lt;sx:fieldElementMap field="Description" element="Description"/&gt;
                  &lt;sx:fieldElementMap field="Quantity" element="Quantity"/&gt;
                  &lt;sx:fieldElementMap field="Unit" element="Unit"/&gt;
                  &lt;sx:fieldElementMap field="ItemPrice" element="ItemPrice"/&gt;
                  &lt;sx:fieldElementMap field="TotalPrice" element="TotalPrice"/&gt;
                &lt;/Detail&gt;
              &lt;/sx:onRecord&gt;
            &lt;/sx:subrecordMapping&gt;
          &lt;/sx:onRecord&gt;
        &lt;/sx:subrecordMapping&gt;

        &lt;sx:subrecordMapping repeatingGroup="Reference"&gt;
          &lt;sx:onRecord&gt;
            &lt;sx:subrecordMapping repeatingGroup="Ref"&gt;
              &lt;sx:onRecord&gt;
                &lt;Reference&gt;
                  &lt;sx:fieldElementMap field="RefId" element="RefId"/&gt;
                  &lt;sx:fieldElementMap field="RefType" element="RefType"/&gt;
                  &lt;sx:fieldElementMap field="RefDoc" element="RefDoc"/&gt;
                  &lt;sx:fieldElementMap field="RefText" element="RefText"/&gt;
                &lt;/Reference&gt;
              &lt;/sx:onRecord&gt;
            &lt;/sx:subrecordMapping&gt;
          &lt;/sx:onRecord&gt;
        &lt;/sx:subrecordMapping&gt;

        &lt;sx:subrecordMapping repeatingGroup="Discount"&gt;
          &lt;sx:onRecord&gt;
            &lt;sx:subrecordMapping repeatingGroup="Disc"&gt;
              &lt;sx:onRecord&gt;
                &lt;Discount&gt;
                  &lt;sx:fieldElementMap field="DiscId" element="DiscId"/&gt;
                  &lt;sx:fieldElementMap field="DiscDescription" element="DiscDescription"/&gt;
                  &lt;sx:fieldElementMap field="DiscItem" element="DiscItem"/&gt;
                &lt;/Discount&gt;
              &lt;/sx:onRecord&gt;
            &lt;/sx:subrecordMapping&gt;
          &lt;/sx:onRecord&gt;
        &lt;/sx:subrecordMapping&gt;

        &lt;sx:subrecordMapping repeatingGroup="Codes"&gt;
          &lt;sx:onRecord&gt;
            &lt;sx:subrecordMapping repeatingGroup="Code"&gt;
              &lt;sx:onRecord&gt;
                &lt;Code&gt;
                  &lt;sx:fieldElementMap field="Code" element="Code"/&gt;
                  &lt;sx:fieldElementMap field="Value" element="Value"/&gt;
                &lt;/Code&gt;
              &lt;/sx:onRecord&gt;
            &lt;/sx:subrecordMapping&gt;
          &lt;/sx:onRecord&gt;
        &lt;/sx:subrecordMapping&gt;
      &lt;/sx:onRecord&gt;
    &lt;/InvoiceDocument&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The idea is to map all the data up to the terminating "!" as one record, and to structure the record as a sequence of nested
repeating groups.
      </p>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml  -r resources-invoice.xml -i data/invoice.txt -o output/invoice.xml 
    invoice

        </pre><p>
      </p>
    </div>
  </div>
  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e692"></a>EDI Examples</h3></div></div></div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e694"></a>EDI to XML (comptest)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e697"></a>
      <a class="indexterm" name="d4e699"></a>
      <p>
The example below shows how to convert a
composite field in an edi file to XML.
      </p>
      <p>
The input file is an edi file.
      </p>
      <div class="figure"><a name="comptest.txt"></a><p class="title"><b>Figure&nbsp;35.&nbsp;Input edi file comptest.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
BKG+1++4+Y:1:B:0:M:0:L:1'

        </pre>
      </div></div><br class="figure-break">
      <p>
This file has a number of features.
        </p><div class="itemizedlist"><ul type="disc"><li>
            <p>The segment delimiter "'" terminates the segment.</p>
          </li><li>
            <p>The field delimiter "+" terminates a field.</p>
          </li><li>
            <p>Composite fields are delimited with ":".</p>
          </li></ul></div><p>
      </p>
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="messages.xml"></a><p class="title"><b>Figure&nbsp;36.&nbsp;Output XML file messages.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;edifact&gt;
  &lt;segment segmentType="BKG"&gt;
    &lt;flightSegmentNumber&gt;1&lt;/flightSegmentNumber&gt;
    &lt;accessID/&gt;
    &lt;bookingCodeCount&gt;4&lt;/bookingCodeCount&gt;
    &lt;C704&gt;
      &lt;bookingCode&gt;Y&lt;/bookingCode&gt;
      &lt;seatAvailabilityCount&gt;1&lt;/seatAvailabilityCount&gt;
    &lt;/C704&gt;
    &lt;C704&gt;
      &lt;bookingCode&gt;B&lt;/bookingCode&gt;
      &lt;seatAvailabilityCount&gt;0&lt;/seatAvailabilityCount&gt;
    &lt;/C704&gt;
    &lt;C704&gt;
      &lt;bookingCode&gt;M&lt;/bookingCode&gt;
      &lt;seatAvailabilityCount&gt;0&lt;/seatAvailabilityCount&gt;
    &lt;/C704&gt;
    &lt;C704&gt;
      &lt;bookingCode&gt;L&lt;/bookingCode&gt;
      &lt;seatAvailabilityCount&gt;1&lt;/seatAvailabilityCount&gt;
    &lt;/C704&gt;
  &lt;/segment&gt;
&lt;/edifact&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-comptest.xml"></a><p class="title"><b>Figure&nbsp;37.&nbsp;Resources script resources-comptest.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="edifact"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="edifact"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="edifact"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile ref="edifactFlatFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="edifactToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="edifactFlatFile"&gt;
    &lt;sx:recordDelimiter value="'"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:fieldDelimiter value="+"/&gt;
        &lt;sx:delimitedField name="segmentType"/&gt;
        &lt;!-- edifact3 - Body Segments.--&gt;
        &lt;!-- BKG BOOKING CODE DATA .--&gt;
        &lt;sx:when test="segmentType='BKG'"&gt;
          &lt;sx:flatRecordType name='BKG'&gt;
            &lt;sx:fieldDelimiter value="+"/&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:delimitedField name="flightSegmentNumber"/&gt;
            &lt;sx:delimitedField name="accessID"/&gt;
            &lt;sx:delimitedField name="bookingCodeCount"/&gt;
            &lt;sx:repeatingGroup name="booking" count="{bookingCodeCount}"&gt;
              &lt;sx:flatRecordType name="C704"&gt;
                &lt;sx:fieldDelimiter value=":"/&gt;
                &lt;sx:delimitedField name="bookingCode"&gt;
                &lt;/sx:delimitedField&gt;
                &lt;sx:delimitedField name="seatAvailabilityCount"&gt;
                &lt;/sx:delimitedField&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:repeatingGroup&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="edifactToXmlMapping"&gt;
    &lt;edifact&gt;
      &lt;!-- edifact3 - Body Segments.--&gt;
      &lt;!-- BKG BOOKING CODE DATA.--&gt;
      &lt;sx:onRecord recordType="BKG"&gt;
        &lt;sx:elementMap element="segment"&gt;
          &lt;sx:fieldAttributeMap field="segmentType" attribute="segmentType"/&gt;
          &lt;sx:fieldElementMap field="flightSegmentNumber" element="flightSegmentNumber"/&gt;
          &lt;sx:fieldElementMap field="accessID" element="accessID"/&gt;
          &lt;sx:fieldElementMap field="bookingCodeCount" element="bookingCodeCount"/&gt;
          &lt;sx:subrecordMapping repeatingGroup="booking"&gt;
            &lt;sx:onRecord recordType="C704"&gt;
              &lt;C704&gt;
                &lt;sx:fieldElementMap field="bookingCode" element="bookingCode"/&gt;
                &lt;sx:fieldElementMap field="seatAvailabilityCount" element="seatAvailabilityCount"/&gt;
              &lt;/C704&gt;
            &lt;/sx:onRecord&gt;
          &lt;/sx:subrecordMapping&gt;
        &lt;/sx:elementMap&gt;
      &lt;/sx:onRecord&gt;
    &lt;/edifact&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
Note the following points about this script.
        </p><div class="itemizedlist"><ul type="disc"><li>
            <p>
All the values of the composite field are put in the multiple valued field "C704".
            </p>
          </li><li>
            <p>
The sx:repeatingGroup element allows us to map these values, repeated two at a time,
named as
              <code class="code">bookingCode</code>
and
              <code class="code">seatAvailabilityCount</code>
.
            </p>
          </li></ul></div><p>
      </p>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -i data/comptest.txt -r resources-comptest.xml 
  -o output/comptest.xml edifact

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e732"></a>EDI to XML with Escaped Delimiters (Invoic96A)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e735"></a>
      <a class="indexterm" name="d4e737"></a>
      <p>
The example below shows how to convert a
composite field in an edi file to XML.
      </p>
      <p>
The input file is an edi file.
      </p>
      <div class="figure"><a name="invoic96A.txt"></a><p class="title"><b>Figure&nbsp;38.&nbsp;Input edi file invoic96A.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
UNB+UNOA:3+0000008033253:14+01534730278:ZZ+080130:0000+04000020++++++1'
UNH+1+INVOIC:D:96A:UN:EAN008'
BGM+381+1000322+9'
DTM+137:20080130:102'
NAD+SU+++COMPANY XXXX ?+ YYYY+VIA ROMA, 1+CITTA?' DI?: GENOVA+GE+16163+IT'
RFF+VA:05577790207'
CUX+2:EUR:4+3'
PAT+10E+ZZZ:::BONIFICO BANCARIO 90 GG D.F.+5:1:D:090'
DTM+13:20080430:102'
LIN+1+L02+8026495011408:EN'
IMD+B++TU:::BAGUETTE PREC. GR.280 40PZ'
QTY+47:5.000:PCE'
QTY+59:40.000:PCE'
MOA+203:54.130:EUR:4'
PRI+AAA:10.830::::PCE'
UNS+S'
MOA+125:54.130'
UNT+46+1'
UNZ+1+04000020'

        </pre>
      </div></div><br class="figure-break">
      <p>
This file has a number of features.
        </p><div class="itemizedlist"><ul type="disc"><li>
            <p>Records are terminated with <code class="code">'</code></p>
          </li><li>
            <p>Fields are terminated with <code class="code">+</code></p>
          </li><li>
            <p>Subfields are terminated with <code class="code">:</code></p>
          </li><li>
            <p>The character ? is used as an escape character. For example, 
              <code class="code">COMPANY?: XXXX?+YYYY+</code> will be interpreted as: 
<code class="code">COMPANY: XXXX+YYYY</code> 
              </p>
          </li><li>Sometimes the input file could be formatted with a fixed 80 
            column width.  Linefeed characters should be stripped.
          </li></ul></div><p>
      </p>
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="invoic96A.xml"></a><p class="title"><b>Figure&nbsp;39.&nbsp;Output XML file invoic96A.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;Invoic96A&gt;
   &lt;UNB&gt;
      &lt;segmentType&gt;UNB&lt;/segmentType&gt;
   &lt;/UNB&gt;
   &lt;UNH&gt;
      &lt;segmentType&gt;UNH&lt;/segmentType&gt;
      &lt;DE0062&gt;1&lt;/DE0062&gt;
      &lt;S009&gt;
         &lt;S009&gt;
            &lt;DE0065&gt;INVOIC&lt;/DE0065&gt;
            &lt;DE0052&gt;D&lt;/DE0052&gt;
            &lt;DE0054&gt;96A&lt;/DE0054&gt;
            &lt;DE0051&gt;UN&lt;/DE0051&gt;
            &lt;DE0057&gt;EAN008&lt;/DE0057&gt;
         &lt;/S009&gt;
      &lt;/S009&gt;
      &lt;DE0068/&gt;
   &lt;/UNH&gt;
   &lt;BGM&gt;
      &lt;segmentType&gt;BGM&lt;/segmentType&gt;
      &lt;C002&gt;
         &lt;C002&gt;
            &lt;DE1001&gt;381&lt;/DE1001&gt;
            &lt;DE1131/&gt;
            &lt;DE3055/&gt;
            &lt;DE1000/&gt;
         &lt;/C002&gt;
      &lt;/C002&gt;
      &lt;DE1004&gt;1000322&lt;/DE1004&gt;
      &lt;DE1225&gt;9&lt;/DE1225&gt;
      &lt;DE4343/&gt;
   &lt;/BGM&gt;
   &lt;DTM&gt;
      &lt;segmentType&gt;DTM&lt;/segmentType&gt;
      &lt;C507&gt;
         &lt;C507&gt;
            &lt;DE2005&gt;137&lt;/DE2005&gt;
            &lt;DE2380&gt;20080130&lt;/DE2380&gt;
            &lt;DE2379&gt;102&lt;/DE2379&gt;
         &lt;/C507&gt;
      &lt;/C507&gt;
   &lt;/DTM&gt;
   &lt;NAD&gt;
      &lt;segmentType&gt;NAD&lt;/segmentType&gt;
      &lt;DE3035&gt;SU&lt;/DE3035&gt;
      &lt;C080&gt;
         &lt;C080&gt;
            &lt;DE3036-1&gt;COMPANY XXXX + YYYY&lt;/DE3036-1&gt;
            &lt;DE3036-2/&gt;
            &lt;DE3036-3/&gt;
            &lt;DE3036-4/&gt;
            &lt;DE3036-5/&gt;
            &lt;DE3045/&gt;
         &lt;/C080&gt;
      &lt;/C080&gt;
      &lt;C059&gt;
         &lt;C059&gt;
            &lt;DE3042-1&gt;VIA ROMA, 1&lt;/DE3042-1&gt;
            &lt;DE3042-2/&gt;
            &lt;DE3042-3/&gt;
            &lt;DE3042-4/&gt;
         &lt;/C059&gt;
      &lt;/C059&gt;
      &lt;DE3164&gt;CITTA' DI: GENOVA&lt;/DE3164&gt;
      &lt;DE3229&gt;GE&lt;/DE3229&gt;
      &lt;DE3251&gt;16163&lt;/DE3251&gt;
      &lt;DE3207&gt;IT&lt;/DE3207&gt;
   &lt;/NAD&gt;
   &lt;RFF&gt;
      &lt;segmentType&gt;RFF&lt;/segmentType&gt;
      &lt;C506&gt;
         &lt;C506&gt;
            &lt;DE1153&gt;VA&lt;/DE1153&gt;
            &lt;DE1154&gt;05577790207&lt;/DE1154&gt;
            &lt;DE1156/&gt;
            &lt;DE4000/&gt;
         &lt;/C506&gt;
      &lt;/C506&gt;
   &lt;/RFF&gt;
   &lt;CUX&gt;
      &lt;segmentType&gt;CUX&lt;/segmentType&gt;
      &lt;C504&gt;
         &lt;C504&gt;
            &lt;DE6347&gt;2&lt;/DE6347&gt;
            &lt;DE6345&gt;EUR&lt;/DE6345&gt;
            &lt;DE6343&gt;4&lt;/DE6343&gt;
            &lt;DE6348/&gt;
         &lt;/C504&gt;
         &lt;C504&gt;
            &lt;DE6347&gt;3&lt;/DE6347&gt;
            &lt;DE6345/&gt;
            &lt;DE6343/&gt;
            &lt;DE6348/&gt;
         &lt;/C504&gt;
      &lt;/C504&gt;
      &lt;DE5402/&gt;
      &lt;DE6341/&gt;
   &lt;/CUX&gt;
   &lt;PAT&gt;
      &lt;segmentType&gt;PAT&lt;/segmentType&gt;
      &lt;DE4279&gt;10E&lt;/DE4279&gt;
      &lt;C110&gt;
         &lt;C110&gt;
            &lt;DE4277&gt;ZZZ&lt;/DE4277&gt;
            &lt;DE1131/&gt;
            &lt;DE3055/&gt;
            &lt;DE4276-1&gt;BONIFICO BANCARIO 90 GG D.F.&lt;/DE4276-1&gt;
            &lt;DE4276-2/&gt;
         &lt;/C110&gt;
      &lt;/C110&gt;
      &lt;C112&gt;
         &lt;C112&gt;
            &lt;DE2475&gt;5&lt;/DE2475&gt;
            &lt;DE2009&gt;1&lt;/DE2009&gt;
            &lt;DE2151&gt;D&lt;/DE2151&gt;
            &lt;DE2152&gt;090&lt;/DE2152&gt;
         &lt;/C112&gt;
      &lt;/C112&gt;
   &lt;/PAT&gt;
   &lt;DTM&gt;
      &lt;segmentType&gt;DTM&lt;/segmentType&gt;
      &lt;C507&gt;
         &lt;C507&gt;
            &lt;DE2005&gt;13&lt;/DE2005&gt;
            &lt;DE2380&gt;20080430&lt;/DE2380&gt;
            &lt;DE2379&gt;102&lt;/DE2379&gt;
         &lt;/C507&gt;
      &lt;/C507&gt;
   &lt;/DTM&gt;
   &lt;LIN&gt;
      &lt;segmentType&gt;LIN&lt;/segmentType&gt;
      &lt;DE1082&gt;1&lt;/DE1082&gt;
      &lt;DE1229&gt;L02&lt;/DE1229&gt;
      &lt;C212&gt;
         &lt;C212&gt;
            &lt;DE7140&gt;8026495011408&lt;/DE7140&gt;
            &lt;DE7143&gt;EN&lt;/DE7143&gt;
            &lt;DE1131/&gt;
            &lt;DE3055/&gt;
         &lt;/C212&gt;
      &lt;/C212&gt;
      &lt;DE1222/&gt;
      &lt;DE7083/&gt;
   &lt;/LIN&gt;
   &lt;IMD&gt;
      &lt;segmentType&gt;IMD&lt;/segmentType&gt;
      &lt;DE7077&gt;B&lt;/DE7077&gt;
      &lt;DE7081/&gt;
      &lt;C273&gt;
         &lt;C273&gt;
            &lt;DE7009&gt;TU&lt;/DE7009&gt;
            &lt;DE1131/&gt;
            &lt;DE3055/&gt;
            &lt;DE7008-1&gt;BAGUETTE PREC. GR.280 40PZ&lt;/DE7008-1&gt;
            &lt;DE7008-2/&gt;
            &lt;DE3435/&gt;
         &lt;/C273&gt;
      &lt;/C273&gt;
      &lt;DE7383/&gt;
   &lt;/IMD&gt;
   &lt;QTY&gt;
      &lt;segmentType&gt;QTY&lt;/segmentType&gt;
      &lt;C186&gt;
         &lt;C186&gt;
            &lt;DE6063&gt;47&lt;/DE6063&gt;
            &lt;DE6060&gt;5.000&lt;/DE6060&gt;
            &lt;DE6411&gt;PCE&lt;/DE6411&gt;
         &lt;/C186&gt;
      &lt;/C186&gt;
   &lt;/QTY&gt;
   &lt;QTY&gt;
      &lt;segmentType&gt;QTY&lt;/segmentType&gt;
      &lt;C186&gt;
         &lt;C186&gt;
            &lt;DE6063&gt;59&lt;/DE6063&gt;
            &lt;DE6060&gt;40.000&lt;/DE6060&gt;
            &lt;DE6411&gt;PCE&lt;/DE6411&gt;
         &lt;/C186&gt;
      &lt;/C186&gt;
   &lt;/QTY&gt;
   &lt;MOA&gt;
      &lt;segmentType&gt;MOA&lt;/segmentType&gt;
      &lt;C516&gt;
         &lt;C516&gt;
            &lt;DE5025&gt;203&lt;/DE5025&gt;
            &lt;DE5004&gt;54.130&lt;/DE5004&gt;
            &lt;DE6345&gt;EUR&lt;/DE6345&gt;
            &lt;DE6343&gt;4&lt;/DE6343&gt;
            &lt;DE4405/&gt;
         &lt;/C516&gt;
      &lt;/C516&gt;
   &lt;/MOA&gt;
   &lt;PRI&gt;
      &lt;segmentType&gt;PRI&lt;/segmentType&gt;
      &lt;C509&gt;
         &lt;C509&gt;
            &lt;DE5125&gt;AAA&lt;/DE5125&gt;
            &lt;DE5118&gt;10.830&lt;/DE5118&gt;
            &lt;DE5375/&gt;
            &lt;DE5387/&gt;
            &lt;DE5284/&gt;
            &lt;DE6411&gt;PCE&lt;/DE6411&gt;
         &lt;/C509&gt;
      &lt;/C509&gt;
      &lt;DE5213/&gt;
   &lt;/PRI&gt;
   &lt;UNS&gt;
      &lt;segmentType&gt;UNS&lt;/segmentType&gt;
      &lt;DE0081&gt;S&lt;/DE0081&gt;
   &lt;/UNS&gt;
   &lt;MOA&gt;
      &lt;segmentType&gt;MOA&lt;/segmentType&gt;
      &lt;C516&gt;
         &lt;C516&gt;
            &lt;DE5025&gt;125&lt;/DE5025&gt;
            &lt;DE5004&gt;54.130&lt;/DE5004&gt;
            &lt;DE6345/&gt;
            &lt;DE6343/&gt;
            &lt;DE4405/&gt;
         &lt;/C516&gt;
      &lt;/C516&gt;
   &lt;/MOA&gt;
   &lt;UNT&gt;
      &lt;segmentType&gt;UNT&lt;/segmentType&gt;
      &lt;DE0074&gt;46&lt;/DE0074&gt;
      &lt;DE0062&gt;1&lt;/DE0062&gt;
   &lt;/UNT&gt;
   &lt;UNZ&gt;
      &lt;segmentType&gt;UNZ&lt;/segmentType&gt;
      &lt;F0036&gt;1&lt;/F0036&gt;
      &lt;F0020&gt;04000020&lt;/F0020&gt;
   &lt;/UNZ&gt;
&lt;/Invoic96A&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-invoic96A.xml"></a><p class="title"><b>Figure&nbsp;40.&nbsp;Resources script resources-invoic96A.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:msv="http://www.servingxml.com/extensions/msv"
              xmlns:fn="http://www.w3.org/2005/xpath-functions"&gt;

  &lt;sx:service id="invoic96A-to-xml"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:xsltSerializer&gt;
        &lt;sx:outputProperty name="indent" value="yes"/&gt;
      &lt;/sx:xsltSerializer&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="Invoic_96A_1"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="Invoic_96A_1" name="Invoic96A"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:flatFile ref="edifactFlatFile"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;sx:discardHandler&gt;
        &lt;sx:log message="{$sx:message}"/&gt;
      &lt;/sx:discardHandler&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:recordContent&gt;
	
  &lt;sx:flatFile id="edifactFlatFile"&gt;
    &lt;sx:recordDelimiter value="'" escapeCharacter="?"/&gt;
    &lt;!-- If a line is broken with a new line character, strip the new line character --&gt;
    &lt;sx:recordDelimiter value="\r\n" continuationSequence="\r\n"/&gt;
    &lt;sx:recordDelimiter value="\n" continuationSequence="\n"/&gt;
    &lt;!-- if a ' character is found after a ? (?')--&gt;
    &lt;!-- it is an escape sequence and should remain the ' character--&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:fieldDelimiter value="+" escapeCharacter="?"/&gt;
        &lt;sx:delimitedField name="segmentType"/&gt;

        &lt;sx:when test="segmentType='UNA' or segmentType='UNA:'"&gt;
          &lt;sx:flatRecordType name='UNA'&gt;
            &lt;sx:fieldDelimiter value="+" escapeCharacter="?"/&gt;
            &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;

        &lt;sx:when test="segmentType='UNB'"&gt;
          &lt;sx:flatRecordType name='UNB'&gt;
            &lt;sx:fieldDelimiter value="+" escapeCharacter="?"/&gt;
            &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;

        &lt;sx:when test="segmentType='UNH'"&gt;
          &lt;sx:flatRecordType name='UNH'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:delimitedField name="DE0062"/&gt;
            &lt;sx:nonrepeatingGroup name="S009"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="S009"&gt;
                &lt;sx:delimitedField name="DE0065"/&gt;
                &lt;sx:delimitedField name="DE0052"/&gt;
                &lt;sx:delimitedField name="DE0054"/&gt;
                &lt;sx:delimitedField name="DE0051"/&gt;
                &lt;sx:delimitedField name="DE0057"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:delimitedField name="DE0068"/&gt;
            &lt;sx:nonrepeatingGroup name="S010"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="S010"&gt;
                &lt;sx:delimitedField name="DE0070"/&gt;
                &lt;sx:delimitedField name="DE0073"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='BGM'"&gt;
          &lt;sx:flatRecordType name='BGM'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:nonrepeatingGroup name="C002"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C002"&gt;
                &lt;sx:delimitedField name="DE1001"/&gt;
                &lt;sx:delimitedField name="DE1131"/&gt;
                &lt;sx:delimitedField name="DE3055"/&gt;
                &lt;sx:delimitedField name="DE1000"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:delimitedField name="DE1004"/&gt;
            &lt;sx:delimitedField name="DE1225"/&gt;
            &lt;sx:delimitedField name="DE4343"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='DTM'"&gt;
          &lt;sx:flatRecordType name='DTM'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:nonrepeatingGroup name="C507"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C507"&gt;
                &lt;sx:delimitedField name="DE2005"/&gt;
                &lt;sx:delimitedField name="DE2380"/&gt;
                &lt;sx:delimitedField name="DE2379"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='PAI'"&gt;
          &lt;sx:flatRecordType name='PAI'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:nonrepeatingGroup name="C534"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C534"&gt;
                &lt;sx:delimitedField name="DE4439"/&gt;
                &lt;sx:delimitedField name="DE4431"/&gt;
                &lt;sx:delimitedField name="DE4461"/&gt;
                &lt;sx:delimitedField name="DE1131"/&gt;
                &lt;sx:delimitedField name="DE3055"/&gt;
                &lt;sx:delimitedField name="DE4435"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='FTX'"&gt;
          &lt;sx:flatRecordType name='FTX'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:delimitedField name="DE4451"/&gt;
            &lt;sx:delimitedField name="DE4453"/&gt;
            &lt;sx:nonrepeatingGroup name="C107"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C107"&gt;
                &lt;sx:delimitedField name="DE4441"/&gt;
                &lt;sx:delimitedField name="DE1131"/&gt;
                &lt;sx:delimitedField name="DE3055"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:nonrepeatingGroup name="C108"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C108"&gt;
                &lt;sx:delimitedField name="DE4440-1"/&gt;
                &lt;sx:delimitedField name="DE4440-2"/&gt;
                &lt;sx:delimitedField name="DE4440-3"/&gt;
                &lt;sx:delimitedField name="DE4440-4"/&gt;
                &lt;sx:delimitedField name="DE4440-5"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:delimitedField name="DE3453"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='NAD'"&gt;
          &lt;sx:flatRecordType name='NAD'&gt;
            &lt;sx:fieldDelimiter value="+" escapeCharacter="?"/&gt;
            &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:delimitedField name="DE3035"/&gt;
            &lt;sx:nonrepeatingGroup name="C082"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C082"&gt;
                &lt;sx:delimitedField name="DE3039"/&gt;
                &lt;sx:delimitedField name="DE1131"/&gt;
                &lt;sx:delimitedField name="DE3055"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:nonrepeatingGroup name="C058"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C058"&gt;
                &lt;sx:delimitedField name="DE3124-1"/&gt;
                &lt;sx:delimitedField name="DE3124-2"/&gt;
                &lt;sx:delimitedField name="DE3124-3"/&gt;
                &lt;sx:delimitedField name="DE3124-4"/&gt;
                &lt;sx:delimitedField name="DE3124-5"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:nonrepeatingGroup name="C080"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C080"&gt;
                &lt;sx:delimitedField name="DE3036-1"/&gt;
                &lt;sx:delimitedField name="DE3036-2"/&gt;
                &lt;sx:delimitedField name="DE3036-3"/&gt;
                &lt;sx:delimitedField name="DE3036-4"/&gt;
                &lt;sx:delimitedField name="DE3036-5"/&gt;
                &lt;sx:delimitedField name="DE3045"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:nonrepeatingGroup name="C059"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C059"&gt;
                &lt;sx:delimitedField name="DE3042-1"/&gt;
                &lt;sx:delimitedField name="DE3042-2"/&gt;
                &lt;sx:delimitedField name="DE3042-3"/&gt;
                &lt;sx:delimitedField name="DE3042-4"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:delimitedField name="DE3164"/&gt;
            &lt;sx:delimitedField name="DE3229"/&gt;
            &lt;sx:delimitedField name="DE3251"/&gt;
            &lt;sx:delimitedField name="DE3207"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='FII'"&gt;
          &lt;sx:flatRecordType name='FII'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:delimitedField name="DE3035"/&gt;
            &lt;sx:nonrepeatingGroup name="C078"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C078"&gt;
                &lt;sx:delimitedField name="DE3194"/&gt;
                &lt;sx:delimitedField name="DE3192-1"/&gt;
                &lt;sx:delimitedField name="DE3192-2"/&gt;
                &lt;sx:delimitedField name="DE6345"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:nonrepeatingGroup name="C088"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C088"&gt;
                &lt;sx:delimitedField name="DE3433"/&gt;
                &lt;sx:delimitedField name="DE1131-1"/&gt;
                &lt;sx:delimitedField name="DE3055-1"/&gt;
                &lt;sx:delimitedField name="DE3434"/&gt;
                &lt;sx:delimitedField name="DE1131-2"/&gt;
                &lt;sx:delimitedField name="DE3055-2"/&gt;
                &lt;sx:delimitedField name="DE3432"/&gt;
                &lt;sx:delimitedField name="DE3436"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:delimitedField name="DE3207"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='RFF'"&gt;
          &lt;sx:flatRecordType name='RFF'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:nonrepeatingGroup name="C506"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C506"&gt;
                &lt;sx:delimitedField name="DE1153"/&gt;
                &lt;sx:delimitedField name="DE1154"/&gt;
                &lt;sx:delimitedField name="DE1156"/&gt;
                &lt;sx:delimitedField name="DE4000"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='CTA'"&gt;
          &lt;sx:flatRecordType name='CTA'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:delimitedField name="DE3139"/&gt;
            &lt;sx:nonrepeatingGroup name="C056"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C056"&gt;
                &lt;sx:delimitedField name="DE3413"/&gt;
                &lt;sx:delimitedField name="DE3412"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='COM'"&gt;
          &lt;sx:flatRecordType name='COM'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:nonrepeatingGroup name="C076"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C076"&gt;
                &lt;sx:delimitedField name="DE3148"/&gt;
                &lt;sx:delimitedField name="DE3155"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
          &lt;/sx:flatRecordType&gt; 
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='CUX'"&gt;
          &lt;sx:flatRecordType name='CUX'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:repeatingGroup name="C504" count="2"&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:repeatDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;!--&lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;--&gt;
              &lt;sx:flatRecordType name="C504"&gt;
                &lt;sx:delimitedField name="DE6347"/&gt;
                &lt;sx:delimitedField name="DE6345"/&gt;
                &lt;sx:delimitedField name="DE6343"/&gt;
                &lt;sx:delimitedField name="DE6348"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:repeatingGroup&gt;
            &lt;sx:delimitedField name="DE5402"/&gt;
            &lt;sx:delimitedField name="DE6341"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='PAT'"&gt;
          &lt;sx:flatRecordType name='PAT'&gt;
            &lt;sx:fieldDelimiter value="+" escapeCharacter="?"/&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:delimitedField name="DE4279"/&gt;
            &lt;sx:nonrepeatingGroup name="C110"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C110"&gt;
                &lt;sx:delimitedField name="DE4277"/&gt;
                &lt;sx:delimitedField name="DE1131"/&gt;
                &lt;sx:delimitedField name="DE3055"/&gt;
                &lt;sx:delimitedField name="DE4276-1"/&gt;
                &lt;sx:delimitedField name="DE4276-2"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:nonrepeatingGroup name="C112"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C112"&gt;
                &lt;sx:delimitedField name="DE2475"/&gt;
                &lt;sx:delimitedField name="DE2009"/&gt;
                &lt;sx:delimitedField name="DE2151"/&gt;
                &lt;sx:delimitedField name="DE2152"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='PCD'"&gt;
          &lt;sx:flatRecordType name='PCD'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:nonrepeatingGroup name="C501"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C501"&gt;
                &lt;sx:delimitedField name="DE5245"/&gt;
                &lt;sx:delimitedField name="DE5482"/&gt;
                &lt;sx:delimitedField name="DE5249"/&gt;
                &lt;sx:delimitedField name="DE1131"/&gt;
                &lt;sx:delimitedField name="DE3055"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='MOA'"&gt;
          &lt;sx:flatRecordType name='MOA'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:nonrepeatingGroup name="C516"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C516"&gt;
                &lt;sx:delimitedField name="DE5025"/&gt;
                &lt;sx:delimitedField name="DE5004"/&gt;
                &lt;sx:delimitedField name="DE6345"/&gt;
                &lt;sx:delimitedField name="DE6343"/&gt;
                &lt;sx:delimitedField name="DE4405"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='ALC'"&gt;
          &lt;sx:flatRecordType name='ALC'&gt;
            &lt;sx:fieldDelimiter value="+" escapeCharacter="?"/&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:delimitedField name="DE5463"/&gt;
            &lt;sx:nonrepeatingGroup name="C552"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C552"&gt;
                &lt;sx:delimitedField name="DE1230"/&gt;
                &lt;sx:delimitedField name="DE5189"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:delimitedField name="DE4471"/&gt;
            &lt;sx:delimitedField name="DE1227"/&gt;
            &lt;sx:nonrepeatingGroup name="C214"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C214"&gt;
                &lt;sx:delimitedField name="DE7161"/&gt;
                &lt;sx:delimitedField name="DE1131"/&gt;
                &lt;sx:delimitedField name="DE3055"/&gt;
                &lt;sx:delimitedField name="DE7160-1"/&gt;
                &lt;sx:delimitedField name="DE7160-2"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;!-- Detail segments --&gt;
        &lt;sx:when test="segmentType='LIN'"&gt;
          &lt;sx:flatRecordType name='LIN'&gt;
            &lt;sx:fieldDelimiter value="+" escapeCharacter="?"/&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:delimitedField name="DE1082"/&gt;
            &lt;sx:delimitedField name="DE1229"/&gt;
            &lt;sx:nonrepeatingGroup name="C212"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C212"&gt;
                &lt;sx:delimitedField name="DE7140"/&gt;
                &lt;sx:delimitedField name="DE7143"/&gt;
                &lt;sx:delimitedField name="DE1131"/&gt;
                &lt;sx:delimitedField name="DE3055"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:nonrepeatingGroup name="C829"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C829"&gt;
                &lt;sx:delimitedField name="DE5495"/&gt;
                &lt;sx:delimitedField name="DE1082"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:delimitedField name="DE1222"/&gt;
            &lt;sx:delimitedField name="DE7083"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='PIA'"&gt;
          &lt;sx:flatRecordType name='PIA'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:delimitedField name="DE4347"/&gt;
            &lt;sx:nonrepeatingGroup name="C212"&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;!--&lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;--&gt;
              &lt;sx:flatRecordType name="C212"&gt;
                &lt;sx:delimitedField name="DE7140"/&gt;
                &lt;sx:delimitedField name="DE7143"/&gt;
                &lt;sx:delimitedField name="DE1131"/&gt;
                &lt;sx:delimitedField name="DE3055"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='IMD'"&gt;
          &lt;sx:flatRecordType name='IMD'&gt;
            &lt;sx:fieldDelimiter value="+" escapeCharacter="?"/&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:delimitedField name="DE7077"/&gt;
            &lt;sx:delimitedField name="DE7081"/&gt;
            &lt;sx:nonrepeatingGroup name="C273"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C273"&gt;
                &lt;sx:delimitedField name="DE7009"/&gt;
                &lt;sx:delimitedField name="DE1131"/&gt;
                &lt;sx:delimitedField name="DE3055"/&gt;
                &lt;sx:delimitedField name="DE7008-1"/&gt;
                &lt;sx:delimitedField name="DE7008-2"/&gt;
                &lt;sx:delimitedField name="DE3435"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:delimitedField name="DE7383"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='QTY'"&gt;
          &lt;sx:flatRecordType name='QTY'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:nonrepeatingGroup name="C186"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C186"&gt;
                &lt;sx:delimitedField name="DE6063"/&gt;
                &lt;sx:delimitedField name="DE6060"/&gt;
                &lt;sx:delimitedField name="DE6411"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='PRI'"&gt;
          &lt;sx:flatRecordType name='PRI'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:nonrepeatingGroup name="C509"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C509"&gt;
                &lt;sx:delimitedField name="DE5125"/&gt;
                &lt;sx:delimitedField name="DE5118"/&gt;
                &lt;sx:delimitedField name="DE5375"/&gt;
                &lt;sx:delimitedField name="DE5387"/&gt;
                &lt;sx:delimitedField name="DE5284"/&gt;
                &lt;sx:delimitedField name="DE6411"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:delimitedField name="DE5213"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='TAX'"&gt;
          &lt;sx:flatRecordType name='TAX'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:delimitedField name="DE5283"/&gt;
            &lt;sx:nonrepeatingGroup name="C241"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C241"&gt;
                &lt;sx:delimitedField name="DE5153"/&gt;
                &lt;sx:delimitedField name="DE1131"/&gt;
                &lt;sx:delimitedField name="DE3055"/&gt;
                &lt;sx:delimitedField name="DE5152"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:nonrepeatingGroup name="C533"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C533"&gt;
                &lt;sx:delimitedField name="DE5289"/&gt;
                &lt;sx:delimitedField name="DE1131"/&gt;
                &lt;sx:delimitedField name="DE3055"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:delimitedField name="DE5286"/&gt;
            &lt;sx:nonrepeatingGroup name="C243"&gt;
              &lt;sx:segmentDelimiter value="+" escapeCharacter="?"/&gt;
              &lt;sx:fieldDelimiter value=":" escapeCharacter="?"/&gt;
              &lt;sx:flatRecordType name="C243"&gt;
                &lt;sx:delimitedField name="DE5279"/&gt;
                &lt;sx:delimitedField name="DE1131-1"/&gt;
                &lt;sx:delimitedField name="DE3055-1"/&gt;
                &lt;sx:delimitedField name="DE5278"/&gt;
                &lt;sx:delimitedField name="DE5273"/&gt;
                &lt;sx:delimitedField name="DE1131-2"/&gt;
                &lt;sx:delimitedField name="DE3055-2"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:nonrepeatingGroup&gt;
            &lt;sx:delimitedField name="DE5305"/&gt;
            &lt;sx:delimitedField name="DE3446"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
		
        &lt;!-- Trailer segments --&gt;
        &lt;sx:when test="segmentType='UNS'"&gt;
          &lt;sx:flatRecordType name='UNS'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:delimitedField name="DE0081"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='UNT'"&gt;
          &lt;sx:flatRecordType name='UNT'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:delimitedField name="DE0074"/&gt;
            &lt;sx:delimitedField name="DE0062"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="segmentType='UNZ'"&gt;
          &lt;sx:flatRecordType name='UNZ'&gt;
            &lt;sx:fieldDelimiter value="+" escapeCharacter="?"/&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
            &lt;sx:delimitedField name="F0036"/&gt;
            &lt;sx:delimitedField name="F0020"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;

        &lt;sx:otherwise&gt;
          &lt;sx:flatRecordType name='ERROR'&gt;
            &lt;sx:delimitedField name="segmentType"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:otherwise&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

&lt;/sx:resources&gt;</pre>
      </div></div><br class="figure-break">
      <p>
Note the following points about this script.
        </p><div class="itemizedlist"><ul type="disc"><li>
            <p>
Record delimiters delimit the boundaries of a record, segment delimiters delimit
areas within a record, and repeat delimiters separate subrecords from each other
within segments. An <a class="link" href="../guide/index.html#sx:repeatingGroup" target="_top">sx:repeatingGroup</a> reads the subrecords separated by repeat
delimiters within a segment. A special case is when there are a number of
segments, but at most one subrecord per segment, a nonrepeating group. An 
<a class="link" href="../guide/index.html#sx:nonrepeatingGroup" target="_top">sx:nonrepeatingGroup</a> reads the single subrecord, if any.
              </p>
          </li><li><p>The continuation sequence for a linefeed 
                       is defined be the linefeed itself, e.g.
                               </p>
<pre class="programlisting">
    &lt;sx:recordDelimiter value="\r\n" continuationSequence="\r\n"/&gt;
    &lt;sx:recordDelimiter value="\n" continuationSequence="\n"/&gt;
</pre><p>This has the effect of stripping out the linefeed 
                      characters.
          </p>
                     </li></ul></div><p>
      </p>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-invoic96A.xml -i data/invoic96A.txt 
    -o output/invoic96A.xml invoic96A-to-xml
    
        </pre><p>
      </p>
    </div>
  </div>
  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e780"></a>FpML Examples</h3></div></div></div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e782"></a>FRA to FpML</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e785"></a>
      <p> Suppose "Bank A" has the following CSV file of FRA trades.  Each FRA
trade is represented by one record in the file.
      </p>
      <div class="figure"><a name="fra.csv"></a><p class="title"><b>Figure&nbsp;41.&nbsp;Input flat file fra.csv</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
product,trade_id,client_id,client_name,trade_date,buy_sell_code,currency,index,tenor,day_count_basis,fixed_rate,start_date,maturity_date,payment_date,notional
FRA,1001,party1,Party 1,2006/12/07,BUY,CAD,BA,3M,ACT/365,0.04,   2008/09/08,2008/12/08,2008/09/08,250000000
FRA,1002,party1,Party 1,2007/03/19,B,CAD,BA,3M,ACT/365,0.04,   2008/09/15,2008/12/15,2008/09/15,110000000
FRA,1003,party1,Party 1,2007/03/19,SELL,CAD,BA,3M,ACT/365,0.04,  2008/12/15,2009/03/16,2008/12/15,70000000 
FRA,1004,party2,Party 2,2007/05/02,BUY,USD,LIBOR,3M,ACT/360,0.04,2009/02/02,2009/05/04,2009/02/02,100000000
FRA,1005,party2,Party 2,2007/05/02,BUY,USD,LIBOR,3M,ACT/360,0.04,2009/02/02,2009/05/04,2009/02/02,100000000
FRA,1006,party3,Party 3,2007/08/01,B,USD,LIBOR,3M,ACT/360,0.05,09/05/01,2009/08/04,2009/05/01,50000000 

        </pre>
      </div></div><br class="figure-break">
      <p>
    Note that two of the FRA trades have errors.  The trade with trade_id 1002
    has an invalid buy_sell_code, "B" instead of "BUY".  The trade with trade id
    1006 has the same problem with the buy_sell_code, and also has an invalid
    start_date, with a two digit year instead of a four digit year.  Bank A
    wants to reject the trades with errors and write them along with an error
    message to a discard file.
      </p>
      <p>Bank A wants the XML output to look as follows.
      </p>
      <div class="figure"><a name="fra.xml"></a><p class="title"><b>Figure&nbsp;42.&nbsp;Output XML file fra.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;dataDocument xmlns="http://www.fpml.org/FpML-5-0/reporting" 
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" fpmlVersion="5-0" 
              xsi:schemaLocation="http://www.fpml.org/FpML-5-0/reporting ../fpml-main-5-0.xsd"&gt;
  &lt;trade&gt;
    &lt;tradeHeader&gt;
      &lt;partyTradeIdentifier&gt;
        &lt;tradeId tradeIdScheme="http://www.banka.com/ird/trade-id"&gt;1001&lt;/tradeId&gt;
      &lt;/partyTradeIdentifier&gt;
      &lt;tradeDate&gt;2006-12-07&lt;/tradeDate&gt;
    &lt;/tradeHeader&gt;
    &lt;fra&gt;
      &lt;sellerPartyReference&gt;party1&lt;/sellerPartyReference&gt;
      &lt;adjustedEffectiveDate&gt;2008-09-08&lt;/adjustedEffectiveDate&gt;
      &lt;adjustedTerminationDate&gt;2008-12-08&lt;/adjustedTerminationDate&gt;
      &lt;paymentDate&gt;
        &lt;adjustedDate&gt;2008-09-08&lt;/adjustedDate&gt;
      &lt;/paymentDate&gt;
      &lt;dayCountFraction&gt;ACT/365&lt;/dayCountFraction&gt;
      &lt;notional&gt;
        &lt;currency&gt;CAD&lt;/currency&gt;
        &lt;amount&gt;250000000&lt;/amount&gt;
      &lt;/notional&gt;
      &lt;fixedRate&gt;0.04&lt;/fixedRate&gt;
      &lt;floatingRateIndex&gt;BA&lt;/floatingRateIndex&gt;
      &lt;indexTenor&gt;
        &lt;periodMultiplier&gt;3&lt;/periodMultiplier&gt;
        &lt;period&gt;M&lt;/period&gt;
      &lt;/indexTenor&gt;
    &lt;/fra&gt;
  &lt;/trade&gt;
  &lt;trade&gt;
    &lt;tradeHeader&gt;
      &lt;partyTradeIdentifier&gt;
        &lt;tradeId tradeIdScheme="http://www.banka.com/ird/trade-id"&gt;1003&lt;/tradeId&gt;
      &lt;/partyTradeIdentifier&gt;
      &lt;tradeDate&gt;2007-03-19&lt;/tradeDate&gt;
    &lt;/tradeHeader&gt;
    &lt;fra&gt;
      &lt;buyerPartyReference&gt;party1&lt;/buyerPartyReference&gt;
      &lt;adjustedEffectiveDate&gt;2008-12-15&lt;/adjustedEffectiveDate&gt;
      &lt;adjustedTerminationDate&gt;2009-03-16&lt;/adjustedTerminationDate&gt;
      &lt;paymentDate&gt;
        &lt;adjustedDate&gt;2008-12-15&lt;/adjustedDate&gt;
      &lt;/paymentDate&gt;
      &lt;dayCountFraction&gt;ACT/365&lt;/dayCountFraction&gt;
      &lt;notional&gt;
        &lt;currency&gt;CAD&lt;/currency&gt;
        &lt;amount&gt;70000000&lt;/amount&gt;
      &lt;/notional&gt;
      &lt;fixedRate&gt;0.04&lt;/fixedRate&gt;
      &lt;floatingRateIndex&gt;BA&lt;/floatingRateIndex&gt;
      &lt;indexTenor&gt;
        &lt;periodMultiplier&gt;3&lt;/periodMultiplier&gt;
        &lt;period&gt;M&lt;/period&gt;
      &lt;/indexTenor&gt;
    &lt;/fra&gt;
  &lt;/trade&gt;
  &lt;trade&gt;
    &lt;tradeHeader&gt;
      &lt;partyTradeIdentifier&gt;
        &lt;tradeId tradeIdScheme="http://www.banka.com/ird/trade-id"&gt;1004&lt;/tradeId&gt;
      &lt;/partyTradeIdentifier&gt;
      &lt;tradeDate&gt;2007-05-02&lt;/tradeDate&gt;
    &lt;/tradeHeader&gt;
    &lt;fra&gt;
      &lt;sellerPartyReference&gt;party2&lt;/sellerPartyReference&gt;
      &lt;adjustedEffectiveDate&gt;2009-02-02&lt;/adjustedEffectiveDate&gt;
      &lt;adjustedTerminationDate&gt;2009-05-04&lt;/adjustedTerminationDate&gt;
      &lt;paymentDate&gt;
        &lt;adjustedDate&gt;2009-02-02&lt;/adjustedDate&gt;
      &lt;/paymentDate&gt;
      &lt;dayCountFraction&gt;ACT/360&lt;/dayCountFraction&gt;
      &lt;notional&gt;
        &lt;currency&gt;USD&lt;/currency&gt;
        &lt;amount&gt;100000000&lt;/amount&gt;
      &lt;/notional&gt;
      &lt;fixedRate&gt;0.04&lt;/fixedRate&gt;
      &lt;floatingRateIndex&gt;LIBOR&lt;/floatingRateIndex&gt;
      &lt;indexTenor&gt;
        &lt;periodMultiplier&gt;3&lt;/periodMultiplier&gt;
        &lt;period&gt;M&lt;/period&gt;
      &lt;/indexTenor&gt;
    &lt;/fra&gt;
  &lt;/trade&gt;
  &lt;trade&gt;
    &lt;tradeHeader&gt;
      &lt;partyTradeIdentifier&gt;
        &lt;tradeId tradeIdScheme="http://www.banka.com/ird/trade-id"&gt;1005&lt;/tradeId&gt;
      &lt;/partyTradeIdentifier&gt;
      &lt;tradeDate&gt;2007-05-02&lt;/tradeDate&gt;
    &lt;/tradeHeader&gt;
    &lt;fra&gt;
      &lt;sellerPartyReference&gt;party2&lt;/sellerPartyReference&gt;
      &lt;adjustedEffectiveDate&gt;2009-02-02&lt;/adjustedEffectiveDate&gt;
      &lt;adjustedTerminationDate&gt;2009-05-04&lt;/adjustedTerminationDate&gt;
      &lt;paymentDate&gt;
        &lt;adjustedDate&gt;2009-02-02&lt;/adjustedDate&gt;
      &lt;/paymentDate&gt;
      &lt;dayCountFraction&gt;ACT/360&lt;/dayCountFraction&gt;
      &lt;notional&gt;
        &lt;currency&gt;USD&lt;/currency&gt;
        &lt;amount&gt;100000000&lt;/amount&gt;
      &lt;/notional&gt;
      &lt;fixedRate&gt;0.04&lt;/fixedRate&gt;
      &lt;floatingRateIndex&gt;LIBOR&lt;/floatingRateIndex&gt;
      &lt;indexTenor&gt;
        &lt;periodMultiplier&gt;3&lt;/periodMultiplier&gt;
        &lt;period&gt;M&lt;/period&gt;
      &lt;/indexTenor&gt;
    &lt;/fra&gt;
  &lt;/trade&gt;
  &lt;party id="bankA"&gt;
    &lt;partyId&gt;Bank A&lt;/partyId&gt;
  &lt;/party&gt;
  &lt;party id="party1"&gt;
    &lt;partyId&gt;Party 1&lt;/partyId&gt;
  &lt;/party&gt;
  &lt;party id="party3"&gt;
    &lt;partyId&gt;Party 3&lt;/partyId&gt;
  &lt;/party&gt;
  &lt;party id="party2"&gt;
    &lt;partyId&gt;Party 2&lt;/partyId&gt;
  &lt;/party&gt;
&lt;/dataDocument&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
  Note that the document concludes with a unique list of parties that
  are referenced by
        <code class="sgmltag-element">id</code>
in the
        <code class="sgmltag-element">buyerPartyReference</code>
and
        <code class="sgmltag-element">sellerPartyReference</code>
  elements.
      </p>
      <p>The required resources script is
      </p>
      <div class="figure"><a name="resources-fra.xml"></a><p class="title"><b>Figure&nbsp;43.&nbsp;Resources script resources-fra.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:fn="http://www.w3.org/2005/xpath-functions"&gt;

  &lt;sx:service id="fra-to-xml"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="fra-xml"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="fra-xml"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:flatFile ref="fra-flat-file"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;sx:recordValidator message="Error in trade {trade_id}."&gt;
        &lt;sx:fieldValidator field="buy_sell_code"
                          message="Invalid buy_sell_code {buy_sell_code}."&gt;
          &lt;sx:or&gt;
            &lt;sx:valueRestriction pattern="BUY"/&gt;
            &lt;sx:valueRestriction pattern="SELL"/&gt;
          &lt;/sx:or&gt;
        &lt;/sx:fieldValidator&gt;
        &lt;sx:fieldValidator field="start_date"
                           message="Invalid start_date {start_date}."&gt;
          &lt;sx:valueRestriction pattern="(19|20)\d\d[/](0[1-9]|1[012])[/](0[1-9]|[12][0-9]|3[01])"/&gt;
        &lt;/sx:fieldValidator&gt;
        &lt;sx:fieldValidator field="maturity_date"
                           message="Invalid maturity_date {maturity_date}."&gt;
          &lt;sx:valueRestriction pattern="(20|21)\d\d[/](0[1-9]|1[012])[/](0[1-9]|[12][0-9]|3[01])"/&gt;
        &lt;/sx:fieldValidator&gt;
      &lt;/sx:recordValidator&gt;
      &lt;sx:discardHandler&gt;
        &lt;sx:log message="{$sx:message}"/&gt;
        &lt;sx:modifyRecord&gt;
          &lt;sx:newField name="message" value="{$sx:message}"/&gt;
        &lt;/sx:modifyRecord&gt;
        &lt;sx:flatFileWriter&gt;
          &lt;sx:fileSink file="output/fra-error.csv"/&gt;
        &lt;/sx:flatFileWriter&gt;
      &lt;/sx:discardHandler&gt;
    &lt;/sx:recordStream&gt;
    &lt;sx:recordMapping ref="fra-to-xml-mapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="fra-flat-file"&gt;
    &lt;sx:flatFileHeader lineCount="1"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:fieldDelimiter value=","/&gt;
        &lt;sx:delimitedField name="record_type"/&gt;
        &lt;sx:when test="record_type='FRA'"&gt;
          &lt;sx:flatRecordType name='fra'&gt;
            &lt;sx:fieldDelimiter value=","/&gt;
            &lt;sx:delimitedField name="record_type"/&gt;
            &lt;sx:delimitedField name="trade_id"/&gt;
            &lt;sx:delimitedField name="client_id"/&gt;
            &lt;sx:delimitedField name="client_name"/&gt;
            &lt;sx:delimitedField name="trade_date"/&gt;
            &lt;sx:delimitedField name="buy_sell_code"/&gt;
            &lt;sx:delimitedField name="currency"/&gt;
            &lt;sx:delimitedField name="index"/&gt;
            &lt;sx:delimitedField name="tenor"/&gt;
            &lt;sx:delimitedField name="day_count_basis"/&gt;
            &lt;sx:delimitedField name="fixed_rate"/&gt;
            &lt;sx:delimitedField name="start_date"/&gt;
            &lt;sx:delimitedField name="maturity_date"/&gt;
            &lt;sx:delimitedField name="payment_date"/&gt;
            &lt;sx:delimitedField name="notional"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="fra-to-xml-mapping"&gt;
    &lt;dataDocument xmlns="http://www.fpml.org/FpML-5-0/reporting"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  fpmlVersion="5-0"
                  xsi:schemaLocation="http://www.fpml.org/FpML-5-0/reporting ../fpml-main-5-0.xsd"&gt;
      &lt;sx:groupBy fields="trade_id"&gt;
        &lt;trade&gt;
          &lt;tradeHeader&gt;
            &lt;partyTradeIdentifier&gt;
              &lt;sx:fieldElementMap field="trade_id"
                                  element="tradeId"&gt;
                &lt;sx:fieldAttributeMap value="http://www.banka.com/ird/trade-id"
                                      attribute="tradeIdScheme"/&gt;
              &lt;/sx:fieldElementMap&gt;
            &lt;/partyTradeIdentifier&gt;
            &lt;tradeDate&gt;
              &lt;sx:toXmlDate fromFormat="yyyy/MM/dd"&gt;
                &lt;sx:toString value="{trade_date}"/&gt;
              &lt;/sx:toXmlDate&gt;
            &lt;/tradeDate&gt;
          &lt;/tradeHeader&gt;
          &lt;sx:onRecord recordType="fra"&gt;
            &lt;fra&gt;
              &lt;sx:choose&gt;
                &lt;sx:when test="buy_sell_code='BUY'"&gt;
                  &lt;sx:fieldElementMap field="client_id"
                                      element="sellerPartyReference"/&gt;
                &lt;/sx:when&gt;
                &lt;sx:otherwise&gt;
                  &lt;sx:fieldElementMap field="client_id"
                                      element="buyerPartyReference"/&gt;
                &lt;/sx:otherwise&gt;
              &lt;/sx:choose&gt;
              &lt;adjustedEffectiveDate&gt;
                &lt;sx:toXmlDate fromFormat="yyyy/MM/dd"&gt;
                  &lt;sx:toString value="{start_date}"/&gt;
                &lt;/sx:toXmlDate&gt;
              &lt;/adjustedEffectiveDate&gt;
              &lt;adjustedTerminationDate&gt;
                &lt;sx:toXmlDate fromFormat="yyyy/MM/dd"&gt;
                  &lt;sx:toString value="{maturity_date}"/&gt;
                &lt;/sx:toXmlDate&gt;
              &lt;/adjustedTerminationDate&gt;
              &lt;paymentDate&gt;
                &lt;adjustedDate&gt;
                  &lt;sx:toXmlDate fromFormat="yyyy/MM/dd"&gt;
                    &lt;sx:toString value="{payment_date}"/&gt;
                  &lt;/sx:toXmlDate&gt;
                &lt;/adjustedDate&gt;
              &lt;/paymentDate&gt;
              &lt;sx:fieldElementMap field="day_count_basis"
                                  element="dayCountFraction"/&gt;
              &lt;notional&gt;
                &lt;sx:fieldElementMap field="currency"
                                    element="currency"/&gt;
                &lt;sx:fieldElementMap field="notional"
                                    element="amount"/&gt;
              &lt;/notional&gt;
              &lt;sx:fieldElementMap field="fixed_rate"
                                  element="fixedRate"/&gt;
              &lt;sx:fieldElementMap field="index"
                                  element="floatingRateIndex"/&gt;
              &lt;indexTenor&gt;
                &lt;sx:choose&gt;
                  &lt;sx:when test="fn:ends-with(tenor,'D')"&gt;
                    &lt;sx:fieldElementMap element="periodMultiplier"&gt;
                      &lt;sx:toString select="fn:substring-before(tenor,'D')"/&gt;
                    &lt;/sx:fieldElementMap&gt;
                    &lt;period&gt;D&lt;/period&gt;
                  &lt;/sx:when&gt;
                  &lt;sx:when test="fn:ends-with(tenor,'M')"&gt;
                    &lt;sx:fieldElementMap element="periodMultiplier"&gt;
                      &lt;sx:toString select="fn:substring-before(tenor,'M')"/&gt;
                    &lt;/sx:fieldElementMap&gt;
                    &lt;period&gt;M&lt;/period&gt;
                  &lt;/sx:when&gt;
                  &lt;sx:when test="fn:ends-with(tenor,'Y')"&gt;
                    &lt;sx:fieldElementMap element="periodMultiplier"&gt;
                      &lt;sx:toString select="fn:substring-before(tenor,'Y')"/&gt;
                    &lt;/sx:fieldElementMap&gt;
                    &lt;period&gt;Y&lt;/period&gt;
                  &lt;/sx:when&gt;
                &lt;/sx:choose&gt;
              &lt;/indexTenor&gt;
            &lt;/fra&gt;
          &lt;/sx:onRecord&gt;
        &lt;/trade&gt;
      &lt;/sx:groupBy&gt;

      &lt;sx:nestedContent&gt;
        &lt;sx:recordContent ref="clients"/&gt;
      &lt;/sx:nestedContent&gt;
    &lt;/dataDocument&gt;
  &lt;/sx:recordMapping&gt;

  &lt;sx:recordContent id="clients"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:flatFile ref="fra-flat-file"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;sx:recordProjection fields="client_id client_name"/&gt;
    &lt;/sx:recordStream&gt;
    &lt;sx:recordMapping&gt;
      &lt;party id="bankA"&gt;
        &lt;partyId&gt;Bank A&lt;/partyId&gt;
      &lt;/party&gt;
      &lt;sx:onRecord&gt;
        &lt;party&gt;
          &lt;sx:fieldAttributeMap field="client_id" attribute="id"/&gt;
          &lt;sx:fieldElementMap field="client_name" element="partyId"/&gt;
        &lt;/party&gt;
      &lt;/sx:onRecord&gt;
    &lt;/sx:recordMapping&gt;
  &lt;/sx:recordContent&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
  We use the
        <a class="link" href="../guide/index.html#sx:nestedContent" target="_top">sx:nestedContent</a>
  element to insert a list of parties from the
        <code class="filename">swap.csv</code>
file into the output XML, and we use the
        <a class="link" href="../guide/index.html#sx:recordProjection" target="_top">sx:recordProjection</a>
  element to eliminate duplicate pairs of client_id and client_name.
      </p>
      <p>
You can run this example on the command line by entering
      </p>
      <pre class="programlisting">
        
servingxml -i data/fra.csv -o output/fra.xml -r resources-fra.xml fra-to-xml

      </pre>
      <p>
  The following error messages will be written to the console (or log file.)
        </p><pre class="programlisting">
25-Sep-2008 10:10:47 PM com.servingxml.util.system.DefaultLogger error
SEVERE: Error in record "fra" on line 3.  Error in trade 1002. Invalid buy_sell_code B.
25-Sep-2008 10:10:47 PM com.servingxml.util.system.DefaultLogger error
SEVERE: Error in record "fra" on line 7.  Error in trade 1006. Invalid buy_sell_code B. Invalid start_date 09/05/01.
        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e813"></a>Swap to FpML</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e816"></a>
      <p> Suppose "Bank A" has the following CSV file of SWAP trades.  Each swap
trade is represented by two records in the file, one for the pay (PAY) side, and
one for the receive (REC) side.
      </p>
      <div class="figure"><a name="swap.csv"></a><p class="title"><b>Figure&nbsp;44.&nbsp;Input flat file swap.csv</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
product,trade_id,client_id,client_name,trade_date,pay_receive_code,currency,index,tenor,day_count_basis,fixed_rate,start_date,maturity_date,reset_date,payment_date,notional,calculation_period
SWAP,2001,party1,Party 1,2008/05/14,PAY,FIXED,CAD,BA,6M,30/360,0.04,2008/07/17,2009/01/17,2008/07/17,2009/01/17,10000000.00,6M
SWAP,2001,party1,Party 1,2008/05/14,REC,FLOAT,CAD,BA,6M,30/360,0.04,2008/07/17,2009/01/17,2008/07/17,2009/01/17,10000000.00,6M
SWAP,2002,party2,Party 2,2008/05/14,PAY,FIXED,CAD,BA,6M,30/360,0.04,2008/07/17,2009/01/17,2008/07/17,2009/01/17,10000000.00,6M
SWAP,2002,party2,Party 2,2008/05/14,R,FLOAT,CAD,BA,6M,30/360,0.04,2008/07/17,2009/01/17,2008/07/17,2009/01/17,10000000.00,6M

        </pre>
      </div></div><br class="figure-break">
      <p>
    Note that one of the records, the receive side for the trade with trade_id
    2002, has an invalid value for pay_receive_code, the value has been
    mistakenly entered as "R" instead of "REC".  Bank A wants to validate this
    field, and if it is wrong for either side of the swap, Bank A wants to
    reject both sides, and write them both with an error message to a discard
    file.
      </p>
      <p>Bank A wants the XML output to look as follows.
      </p>
      <div class="figure"><a name="swap.xml"></a><p class="title"><b>Figure&nbsp;45.&nbsp;Output XML file swap.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;dataDocument xmlns="http://www.fpml.org/FpML-5-0/reporting" 
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
              fpmlVersion="5-0" 
              xsi:schemaLocation="http://www.fpml.org/FpML-5-0/reporting ../fpml-main-5-0.xsd"&gt;
  &lt;trade&gt;
    &lt;tradeHeader&gt;
      &lt;partyTradeIdentifier&gt;
        &lt;tradeId tradeIdScheme="http://www.banka.com/ird/trade-id"&gt;2001&lt;/tradeId&gt;
      &lt;/partyTradeIdentifier&gt;
      &lt;tradeDate&gt;2008-05-14&lt;/tradeDate&gt;
    &lt;/tradeHeader&gt;
    &lt;swap&gt;
      &lt;swapStream&gt;
        &lt;payerPartyReference href="bankA"/&gt;
        &lt;calculationPeriodDates id="floatingCalcPeriodDates"&gt;
          &lt;effectiveDate&gt;
            &lt;adjustedDate&gt;2008-07-17&lt;/adjustedDate&gt;
          &lt;/effectiveDate&gt;
          &lt;terminationDate&gt;
            &lt;adjustedDate&gt;2009-01-17&lt;/adjustedDate&gt;
          &lt;/terminationDate&gt;
          &lt;calculationPeriodFrequency&gt;
            &lt;periodMultiplier&gt;6&lt;/periodMultiplier&gt;
            &lt;period&gt;M&lt;/period&gt;
          &lt;/calculationPeriodFrequency&gt;
        &lt;/calculationPeriodDates&gt;
        &lt;calculationPeriodAmount&gt;
          &lt;calculation&gt;
            &lt;notionalSchedule&gt;
              &lt;notionalStepSchedule&gt;
                &lt;initialValue&gt;10000000.00&lt;/initialValue&gt;
                &lt;currency currencyScheme="http://www.fpml.org/ext/iso4217"&gt;CAD&lt;/currency&gt;
              &lt;/notionalStepSchedule&gt;
            &lt;/notionalSchedule&gt;
            &lt;fixedRateSchedule&gt;
              &lt;initialValue&gt;0.04&lt;/initialValue&gt;
            &lt;/fixedRateSchedule&gt;
            &lt;dayCountFraction&gt;30/360&lt;/dayCountFraction&gt;
          &lt;/calculation&gt;
        &lt;/calculationPeriodAmount&gt;
      &lt;/swapStream&gt;
      &lt;swapStream&gt;
        &lt;payerPartyReference href="party1"/&gt;
        &lt;calculationPeriodDates id="floatingCalcPeriodDates"&gt;
          &lt;effectiveDate&gt;
            &lt;adjustedDate&gt;2008-07-17&lt;/adjustedDate&gt;
          &lt;/effectiveDate&gt;
          &lt;terminationDate&gt;
            &lt;adjustedDate&gt;2009-01-17&lt;/adjustedDate&gt;
          &lt;/terminationDate&gt;
          &lt;calculationPeriodFrequency&gt;
            &lt;periodMultiplier&gt;6&lt;/periodMultiplier&gt;
            &lt;period&gt;M&lt;/period&gt;
          &lt;/calculationPeriodFrequency&gt;
        &lt;/calculationPeriodDates&gt;
        &lt;calculationPeriodAmount&gt;
          &lt;calculation&gt;
            &lt;notionalSchedule&gt;
              &lt;notionalStepSchedule&gt;
                &lt;initialValue&gt;10000000.00&lt;/initialValue&gt;
                &lt;currency currencyScheme="http://www.fpml.org/ext/iso4217"&gt;CAD&lt;/currency&gt;
              &lt;/notionalStepSchedule&gt;
            &lt;/notionalSchedule&gt;
            &lt;floatingRateCalculation&gt;
              &lt;floatingRateIndex&gt;BA&lt;/floatingRateIndex&gt;
              &lt;indexTenor&gt;
                &lt;periodMultiplier&gt;6&lt;/periodMultiplier&gt;
                &lt;period&gt;M&lt;/period&gt;
              &lt;/indexTenor&gt;
            &lt;/floatingRateCalculation&gt;
            &lt;dayCountFraction&gt;30/360&lt;/dayCountFraction&gt;
          &lt;/calculation&gt;
        &lt;/calculationPeriodAmount&gt;
      &lt;/swapStream&gt;
    &lt;/swap&gt;
  &lt;/trade&gt;
  &lt;party id="bankA"&gt;
    &lt;partyId&gt;Bank A&lt;/partyId&gt;
  &lt;/party&gt;
  &lt;party id="party1"&gt;
    &lt;partyId&gt;Party 1&lt;/partyId&gt;
  &lt;/party&gt;
  &lt;party id="party2"&gt;
    &lt;partyId&gt;Party 2&lt;/partyId&gt;
  &lt;/party&gt;
&lt;/dataDocument&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
    Note that the document concludes with a unique list of parties that
    are referenced by
        <code class="sgmltag-element">id</code>
in the
        <code class="sgmltag-element">payerPartyReference</code>
elements.
      </p>
      <p>The required resources script is
      </p>
      <div class="figure"><a name="resources-swap.xml"></a><p class="title"><b>Figure&nbsp;46.&nbsp;Resources script resources-swap.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:fn="http://www.w3.org/2005/xpath-functions"&gt;

  &lt;sx:service id="swap-to-xml"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="swap-xml"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="swap-xml"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:flatFile ref="swap-flat-file"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;sx:modifyRecord&gt;
        &lt;sx:newField name="trade_id" select="legs/child::node()[1]/trade_id"/&gt;
        &lt;sx:newField name="trade_date" select="legs/child::node()[1]/trade_date"/&gt;
      &lt;/sx:modifyRecord&gt;
      &lt;sx:recordValidator ref="swap-validator"/&gt;
      &lt;sx:discardHandler&gt;
        &lt;sx:log message="{$sx:message}"/&gt;
        &lt;sx:splitRecord recordType="swap" repeatingGroup="legs"/&gt;
        &lt;sx:flatFileWriter&gt;
          &lt;sx:fileSink file="output/swap-error.csv"/&gt;
        &lt;/sx:flatFileWriter&gt;
      &lt;/sx:discardHandler&gt;
    &lt;/sx:recordStream&gt;
    &lt;sx:recordMapping ref="swap-to-xml-mapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="swap-flat-file"&gt;
    &lt;sx:flatFileHeader lineCount="1"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:compositeFlatRecordType&gt;
        &lt;sx:delimitedField name="record_type"/&gt;
        &lt;sx:delimitedField name="trade_id"/&gt;
        &lt;sx:combinePhysicalRecords recordType="swap"
                              repeatingGroup="legs"
                              endTest="sx:current//trade_id != sx:previous//trade_id"&gt;
          &lt;sx:flatRecordTypeChoice&gt;
            &lt;sx:fieldDelimiter value=","/&gt;
            &lt;sx:delimitedField name="record_type"/&gt;
            &lt;sx:delimitedField name="trade_id"/&gt;
            &lt;sx:delimitedField name="client_id"/&gt;
            &lt;sx:delimitedField name="client_name"/&gt;
            &lt;sx:delimitedField name="trade_date"/&gt;
            &lt;sx:delimitedField name="pay_receive_code"/&gt;
            &lt;sx:delimitedField name="fixed_float_code"/&gt;
            &lt;sx:when test="record_type='SWAP' and fixed_float_code='FLOAT'"&gt;
              &lt;sx:flatRecordType name='swap_floating_leg'&gt;
                &lt;sx:fieldDelimiter value=","/&gt;
                &lt;sx:delimitedField name="record_type"/&gt;
                &lt;sx:delimitedField name="trade_id"/&gt;
                &lt;sx:delimitedField name="client_id"/&gt;
                &lt;sx:delimitedField name="client_name"/&gt;
                &lt;sx:delimitedField name="trade_date"/&gt;
                &lt;sx:delimitedField name="pay_receive_code"/&gt;
                &lt;sx:delimitedField name="fixed_float_code"/&gt;
                &lt;sx:delimitedField name="currency"/&gt;
                &lt;sx:delimitedField name="index"/&gt;
                &lt;sx:delimitedField name="tenor"/&gt;
                &lt;sx:delimitedField name="day_count_basis"/&gt;
                &lt;sx:delimitedField name="fixed_rate"/&gt;
                &lt;sx:delimitedField name="start_date"/&gt;
                &lt;sx:delimitedField name="maturity_date"/&gt;
                &lt;sx:delimitedField name="reset_date"/&gt;
                &lt;sx:delimitedField name="payment_date"/&gt;
                &lt;sx:delimitedField name="notional"/&gt;
                &lt;sx:delimitedField name="calculation_period"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:when&gt;
            &lt;sx:when test="record_type='SWAP' and fixed_float_code='FIXED'"&gt;
              &lt;sx:flatRecordType name='swap_fixed_leg'&gt;
                &lt;sx:fieldDelimiter value=","/&gt;
                &lt;sx:delimitedField name="record_type"/&gt;
                &lt;sx:delimitedField name="trade_id"/&gt;
                &lt;sx:delimitedField name="client_id"/&gt;
                &lt;sx:delimitedField name="client_name"/&gt;
                &lt;sx:delimitedField name="trade_date"/&gt;
                &lt;sx:delimitedField name="pay_receive_code"/&gt;
                &lt;sx:delimitedField name="fixed_float_code"/&gt;
                &lt;sx:delimitedField name="currency"/&gt;
                &lt;sx:delimitedField name="index"/&gt;
                &lt;sx:delimitedField name="tenor"/&gt;
                &lt;sx:delimitedField name="day_count_basis"/&gt;
                &lt;sx:delimitedField name="fixed_rate"/&gt;
                &lt;sx:delimitedField name="start_date"/&gt;
                &lt;sx:delimitedField name="maturity_date"/&gt;
                &lt;sx:delimitedField name="reset_date"/&gt;
                &lt;sx:delimitedField name="payment_date"/&gt;
                &lt;sx:delimitedField name="notional"/&gt;
                &lt;sx:delimitedField name="calculation_period"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:when&gt;
          &lt;/sx:flatRecordTypeChoice&gt;
        &lt;/sx:combinePhysicalRecords&gt;
      &lt;/sx:compositeFlatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;
  &lt;sx:recordValidator id="swap-validator"
                      recordType="swap"
                      message="Error in trade {trade_id}."&gt;
    &lt;sx:fieldValidator field="legs"
                       message=""&gt;
      &lt;sx:recordValidator&gt;
        &lt;sx:fieldValidator field="pay_receive_code"
                           message="Invalid pay_receive_code {pay_receive_code}."&gt;
          &lt;sx:or&gt;
            &lt;sx:valueRestriction pattern="PAY"/&gt;
            &lt;sx:valueRestriction pattern="REC"/&gt;
          &lt;/sx:or&gt;
        &lt;/sx:fieldValidator&gt;
        &lt;sx:fieldValidator field="fixed_float_code"
                           message="Invalid fixed_float_code {fixed_float_code}."&gt;
          &lt;sx:or&gt;
            &lt;sx:valueRestriction pattern="FIXED"/&gt;
            &lt;sx:valueRestriction pattern="FLOAT"/&gt;
          &lt;/sx:or&gt;
        &lt;/sx:fieldValidator&gt;
        &lt;sx:fieldValidator field="start_date"
                           message="Invalid start_date {start_date}."&gt;
          &lt;sx:valueRestriction pattern="(19|20)\d\d[/](0[1-9]|1[012])[/](0[1-9]|[12][0-9]|3[01])"/&gt;
        &lt;/sx:fieldValidator&gt;
        &lt;sx:fieldValidator field="maturity_date"
                           message="Invalid maturity_date {maturity_date}."&gt;
          &lt;sx:valueRestriction pattern="(20|21)\d\d[/](0[1-9]|1[012])[/](0[1-9]|[12][0-9]|3[01])"/&gt;
        &lt;/sx:fieldValidator&gt;
      &lt;/sx:recordValidator&gt;
    &lt;/sx:fieldValidator&gt;
  &lt;/sx:recordValidator&gt;

  &lt;sx:recordMapping id="swap-to-xml-mapping"&gt;
    &lt;dataDocument xmlns="http://www.fpml.org/FpML-5-0/reporting"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  fpmlVersion="5-0"
                  xsi:schemaLocation="http://www.fpml.org/FpML-5-0/reporting ../fpml-main-5-0.xsd"&gt;
      &lt;sx:groupBy fields="trade_id"&gt;
        &lt;trade&gt;
          &lt;tradeHeader&gt;
            &lt;partyTradeIdentifier&gt;
              &lt;sx:fieldElementMap field="trade_id" element="tradeId"&gt;
                &lt;sx:fieldAttributeMap value="http://www.banka.com/ird/trade-id"
                                      attribute="tradeIdScheme"/&gt;
              &lt;/sx:fieldElementMap&gt;
            &lt;/partyTradeIdentifier&gt;
            &lt;tradeDate&gt;
              &lt;sx:toXmlDate fromFormat="yyyy/MM/dd"&gt;
                &lt;sx:toString value="{trade_date}"/&gt;
              &lt;/sx:toXmlDate&gt;
            &lt;/tradeDate&gt;
          &lt;/tradeHeader&gt;
          &lt;swap&gt;
            &lt;sx:subrecordMapping repeatingGroup="legs"&gt;
              &lt;sx:groupBy fields="trade_id pay_receive_code"&gt;
                &lt;swapStream&gt;
                  &lt;sx:choose&gt;
                    &lt;sx:when test="pay_receive_code='PAY'"&gt;
                      &lt;payerPartyReference&gt;
                        &lt;sx:fieldAttributeMap value="bankA"
                                              attribute="href"/&gt;
                      &lt;/payerPartyReference&gt;
                    &lt;/sx:when&gt;
                    &lt;sx:when test="pay_receive_code='REC'"&gt;
                      &lt;payerPartyReference&gt;
                        &lt;sx:fieldAttributeMap field="client_id"
                                              attribute="href"/&gt;
                      &lt;/payerPartyReference&gt;
                    &lt;/sx:when&gt;
                  &lt;/sx:choose&gt;
                  &lt;calculationPeriodDates id="floatingCalcPeriodDates"&gt;
                    &lt;effectiveDate&gt;
                      &lt;adjustedDate&gt;
                        &lt;sx:toXmlDate fromFormat="yyyy/MM/dd"&gt;
                          &lt;sx:toString value="{start_date}"/&gt;
                        &lt;/sx:toXmlDate&gt;
                      &lt;/adjustedDate&gt;
                    &lt;/effectiveDate&gt;
                    &lt;terminationDate&gt;
                      &lt;adjustedDate&gt;
                        &lt;sx:toXmlDate fromFormat="yyyy/MM/dd"&gt;
                          &lt;sx:toString value="{maturity_date}"/&gt;
                        &lt;/sx:toXmlDate&gt;
                      &lt;/adjustedDate&gt;
                    &lt;/terminationDate&gt;
                    &lt;calculationPeriodFrequency&gt;
                      &lt;sx:parameter name="term" value="{calculation_period}"/&gt;
                      &lt;sx:choose ref="expand-term"/&gt;
                    &lt;/calculationPeriodFrequency&gt;
                  &lt;/calculationPeriodDates&gt;
                  &lt;calculationPeriodAmount&gt;
                    &lt;calculation&gt;
                      &lt;notionalSchedule&gt;
                        &lt;notionalStepSchedule&gt;
                          &lt;sx:fieldElementMap field="notional" element="initialValue"/&gt;
                          &lt;sx:fieldElementMap field="currency" element="currency"&gt;
                            &lt;sx:fieldAttributeMap value="http://www.fpml.org/ext/iso4217"
                                                  attribute="currencyScheme"/&gt;
                          &lt;/sx:fieldElementMap&gt;
                        &lt;/notionalStepSchedule&gt;
                      &lt;/notionalSchedule&gt;
                      &lt;sx:choose&gt;
                        &lt;sx:when test="fixed_float_code='FLOAT'"&gt;
                          &lt;floatingRateCalculation&gt;
                            &lt;sx:fieldElementMap field="index"
                                                element="floatingRateIndex"/&gt;
                            &lt;indexTenor&gt;
                              &lt;sx:parameter name="term" value="{tenor}"/&gt;
                              &lt;sx:choose ref="expand-term"/&gt;
                            &lt;/indexTenor&gt;
                          &lt;/floatingRateCalculation&gt;
                        &lt;/sx:when&gt;
                        &lt;sx:when test="fixed_float_code='FIXED'"&gt;
                          &lt;fixedRateSchedule&gt;
                            &lt;sx:fieldElementMap field="fixed_rate"
                                                element="initialValue"/&gt;
                          &lt;/fixedRateSchedule&gt;
                        &lt;/sx:when&gt;
                      &lt;/sx:choose&gt;
                      &lt;sx:fieldElementMap field="day_count_basis"
                                          element="dayCountFraction"/&gt;
                    &lt;/calculation&gt;
                  &lt;/calculationPeriodAmount&gt;
                &lt;/swapStream&gt;
              &lt;/sx:groupBy&gt;
            &lt;/sx:subrecordMapping&gt;
          &lt;/swap&gt;
        &lt;/trade&gt;
      &lt;/sx:groupBy&gt;

      &lt;sx:nestedContent&gt;
        &lt;sx:recordContent ref="clients"/&gt;
      &lt;/sx:nestedContent&gt;
    &lt;/dataDocument&gt;
  &lt;/sx:recordMapping&gt;

  &lt;!-- Expands a parameter named "term" with a value &lt;number&gt;&lt;D|M|Y&gt; as
    &lt;periodMultiplier&gt;number&lt;/periodMultiplier&gt;
    &lt;period&gt;D|M|Y&lt;/period&gt;
  --&gt;
  &lt;sx:choose id="expand-term"&gt;
    &lt;sx:when test="fn:ends-with($term,'D')"&gt;
      &lt;sx:fieldElementMap element="periodMultiplier"&gt;
        &lt;sx:toString select="fn:substring-before($term,'D')"/&gt;
      &lt;/sx:fieldElementMap&gt;
      &lt;period&gt;D&lt;/period&gt;
    &lt;/sx:when&gt;
    &lt;sx:when test="fn:ends-with($term,'M')"&gt;
      &lt;sx:fieldElementMap element="periodMultiplier"&gt;
        &lt;sx:toString select="fn:substring-before($term,'M')"/&gt;
      &lt;/sx:fieldElementMap&gt;
      &lt;period&gt;M&lt;/period&gt;
    &lt;/sx:when&gt;
    &lt;sx:when test="fn:ends-with($term,'Y')"&gt;
      &lt;sx:fieldElementMap element="periodMultiplier"&gt;
        &lt;sx:toString select="fn:substring-before($term,'Y')"/&gt;
      &lt;/sx:fieldElementMap&gt;
      &lt;period&gt;Y&lt;/period&gt;
    &lt;/sx:when&gt;
  &lt;/sx:choose&gt;

  &lt;sx:recordContent id="clients"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:flatFile&gt;
          &lt;sx:flatFileHeader lineCount="1"/&gt;
          &lt;sx:flatFileBody&gt;
            &lt;sx:flatRecordType&gt;
              &lt;sx:fieldDelimiter value=","/&gt;
              &lt;sx:delimitedField name="record_type"/&gt;
              &lt;sx:delimitedField name="trade_id"/&gt;
              &lt;sx:delimitedField name="client_id"/&gt;
              &lt;sx:delimitedField name="client_name"/&gt;
            &lt;/sx:flatRecordType&gt;
          &lt;/sx:flatFileBody&gt;
        &lt;/sx:flatFile&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;sx:recordProjection fields="client_id client_name"/&gt;
    &lt;/sx:recordStream&gt;
    &lt;sx:recordMapping&gt;
      &lt;party id="bankA"&gt;
        &lt;partyId&gt;Bank A&lt;/partyId&gt;
      &lt;/party&gt;
      &lt;sx:onRecord&gt;
        &lt;party&gt;
          &lt;sx:fieldAttributeMap field="client_id" attribute="id"/&gt;
          &lt;sx:fieldElementMap field="client_name" element="partyId"/&gt;
        &lt;/party&gt;
      &lt;/sx:onRecord&gt;
    &lt;/sx:recordMapping&gt;
  &lt;/sx:recordContent&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
    Note the following points about this script.
      </p>
      <div class="itemizedlist"><ul type="disc"><li>
          <p>We use the
            <a class="link" href="../guide/index.html#sx:combineRecords" target="_top">sx:combineRecords</a>
        element to compose a single record from the two legs of the swap.  This
        way, when we validate the composite record, a failure in either of the
        legs will result in the entire swap being discarded, not just one of the
        legs.
          </p>
        </li><li>
          <p>
        We use the
            <a class="link" href="../guide/index.html#sx:nestedContent" target="_top">sx:nestedContent</a>
        element to insert a list of parties from the
            <code class="filename">swap.csv</code>
file into the output XML, and we use the
            <a class="link" href="../guide/index.html#sx:recordProjection" target="_top">sx:recordProjection</a>
        element to eliminate duplicate pairs of client_id and client_name.
          </p>
        </li><li>
          <p>Inside the
            <a class="link" href="../guide/index.html#sx:discardHandler" target="_top">sx:discardHandler</a>
        element, we use the
            <a class="link" href="../guide/index.html#sx:splitRecord" target="_top">sx:splitRecord</a>
        element to decompose the composite swap record back into separate leg
        records.  This allows us to easily use the default record writer to
        write the legs to a discard file.
          </p>
        </li><li>
          <p>We have two fields,
            <code class="code">calculation_period</code>
and
            <code class="code">tenor</code>
, that have values like
            <code class="code">3M</code>
and
            <code class="code">30D</code>
, where the numeric value and the trailing letter need to
       be mapped separately to the elements
            <code class="sgmltag-element">periodMultiplier</code>
       and
            <code class="sgmltag-element">period</code>
.  We use a parameterized
            <a class="link" href="../guide/index.html#sx:choose" target="_top">sx:choose</a>
      instruction to handle both cases.
          </p>
        </li></ul></div>
      <p>
You can run this example on the command line by entering
      </p>
      <pre class="programlisting">
        
servingxml -i data/swap.csv -o output/swap.xml -r resources-swap.xml swap-to-xml

      </pre>
      <p>
  The following error message will be written to the console (or log file.)
        </p><pre class="programlisting">
25-Sep-2008 10:10:54 PM com.servingxml.util.system.DefaultLogger error
SEVERE: Error in record "swap" on line 5.  Error in trade 2002.  Invalid pay_receive_code R.</pre><p>
      </p>
    </div>
  </div>
  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e862"></a>Fixed Width Fields, Single Record Type, Line Delimited</h3></div></div></div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e864"></a>A flat file to XML mapping with field substitutions (abtest)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e867"></a>
      <p>
The example below shows how to convert a
flat file to XML.
      </p>
      <p>
The input file is a positional file.
      </p>
      <div class="figure"><a name="abtest.txt"></a><p class="title"><b>Figure&nbsp;47.&nbsp;Input flat file abtest.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
ABTESTCD10 
ACTESTCD12 
ABTESTCC80

        </pre>
      </div></div><br class="figure-break">
      <p>
The requirements are as follows:
        </p><div class="itemizedlist"><ul type="disc"><li>
First 2 chars: if AB the output will be SOUTH, if AC then output is WEST.
          </li><li>
For the 7th and 9th chars:  if CD, then output change to 01, otherwise 02
          </li></ul></div><p>
      </p>
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="recs.xml"></a><p class="title"><b>Figure&nbsp;48.&nbsp;Output XML file Recs.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;Recs&gt;
  &lt;Rec&gt;
    &lt;First&gt;SOUTH&lt;/First&gt;
    &lt;Second&gt;TEST&lt;/Second&gt;
    &lt;Third&gt;01&lt;/Third&gt;
    &lt;Last&gt;10&lt;/Last&gt;
  &lt;/Rec&gt;
  &lt;Rec&gt;
    &lt;First&gt;WEST&lt;/First&gt;
    &lt;Second&gt;TEST&lt;/Second&gt;
    &lt;Third&gt;01&lt;/Third&gt;
    &lt;Last&gt;12&lt;/Last&gt;
  &lt;/Rec&gt;
  &lt;Rec&gt;
    &lt;First&gt;SOUTH&lt;/First&gt;
    &lt;Second&gt;TEST&lt;/Second&gt;
    &lt;Third&gt;02&lt;/Third&gt;
    &lt;Last&gt;80&lt;/Last&gt;
  &lt;/Rec&gt;
&lt;/Recs&gt;
        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-abtest.xml"></a><p class="title"><b>Figure&nbsp;49.&nbsp;Resources script resources-abtest.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0"?&gt;
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:msv="http://www.servingxml.com/extensions/msv"&gt;

  &lt;sx:service id="abtest"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="data"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="data"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:urlSource url="data/abtest.txt"/&gt;
      &lt;sx:flatFile ref="flatFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="abtestToXml"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="flatFile"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType name="match"&gt;
        &lt;sx:positionalField name="first" width="2"/&gt;
        &lt;sx:positionalField name="second" width="4"/&gt;
        &lt;sx:positionalField name="third" width="2"/&gt;
        &lt;sx:positionalField name="fourth" width="2"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="abtestToXml"&gt;
    &lt;Recs&gt;
      &lt;sx:onRecord&gt;
        &lt;Rec&gt;
          &lt;sx:fieldElementMap match="first[text()='AB']" select="'SOUTH'" element="First"/&gt;
          &lt;sx:fieldElementMap match="first[text()='AC']" select="'WEST'" element="First"/&gt;
          &lt;sx:fieldElementMap field="second" element="Second"/&gt;
          &lt;sx:fieldElementMap match="third[text()='CD']" select="'01'" element="Third"/&gt;
          &lt;sx:fieldElementMap match="third[text()!='CD']" select="'02'" element="Third"/&gt;
          &lt;sx:fieldElementMap field="fourth" element="Last"/&gt;
        &lt;/Rec&gt;
      &lt;/sx:onRecord&gt;
    &lt;/Recs&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-abtest.xml -o output/abtest.xml abtest

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e888"></a>Mapping a record to separate top level sections in the XML (persons)</h4></div></div></div>
      
      
      <p>
Suppose you have the following positional file of persons and their addresses.
      </p>
      <div class="figure"><a name="segments.txt"></a><p class="title"><b>Figure&nbsp;50.&nbsp;Input flat file persons.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
PersonId Name       FirstName       Street              Postcode    CityTown
1        Jones      Joe             215 Walmer Rd       M5R3P7      Toronto
1        Jones      Joe             180 Redwood ST      94102-3280  San Francisco
2        Davis      Ken             212 Harbord St      M5S1H6      Toronto
3        Morris     Jane            1100 Danforth Ave   M4J1N2      Toronto
3        Morris     Jane            6 Green St          94111-1402  San Francisco

        </pre>
      </div></div><br class="figure-break">
      <p>
Each line containes information about a person and an address.
A person may have multiple lines indicating multiple addresses.
      </p>
      <p>
You want the XML output to look as follows.
      </p>
      <div class="figure"><a name="persons.xml"></a><p class="title"><b>Figure&nbsp;51.&nbsp;Output XML file persons.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;Persons-Addresses&gt;
  &lt;Persons&gt;
    &lt;Person&gt;
      &lt;PersonId&gt;1&lt;/PersonId&gt;
      &lt;Name&gt;Jones&lt;/Name&gt;
      &lt;FirstName&gt;Joe&lt;/FirstName&gt;
    &lt;/Person&gt;
    &lt;Person&gt;
      &lt;PersonId&gt;2&lt;/PersonId&gt;
      &lt;Name&gt;Davis&lt;/Name&gt;
      &lt;FirstName&gt;Ken&lt;/FirstName&gt;
    &lt;/Person&gt;
    &lt;Person&gt;
      &lt;PersonId&gt;3&lt;/PersonId&gt;
      &lt;Name&gt;Morris&lt;/Name&gt;
      &lt;FirstName&gt;Jane&lt;/FirstName&gt;
    &lt;/Person&gt;
  &lt;/Persons&gt;
  &lt;Addresses&gt;
    &lt;Address&gt;
      &lt;PersonId&gt;1&lt;/PersonId&gt;
      &lt;Street&gt;215 Walmer Rd&lt;/Street&gt;
      &lt;PostCode&gt;M5R3P7&lt;/PostCode&gt;
      &lt;CityTown&gt;Toronto&lt;/CityTown&gt;
    &lt;/Address&gt;
    &lt;Address&gt;
      &lt;PersonId&gt;1&lt;/PersonId&gt;
      &lt;Street&gt;180 Redwood ST&lt;/Street&gt;
      &lt;PostCode&gt;94102-3280&lt;/PostCode&gt;
      &lt;CityTown&gt;San Francisco&lt;/CityTown&gt;
    &lt;/Address&gt;
    &lt;Address&gt;
      &lt;PersonId&gt;2&lt;/PersonId&gt;
      &lt;Street&gt;212 Harbord St&lt;/Street&gt;
      &lt;PostCode&gt;M5S1H6&lt;/PostCode&gt;
      &lt;CityTown&gt;Toronto&lt;/CityTown&gt;
    &lt;/Address&gt;
    &lt;Address&gt;
      &lt;PersonId&gt;3&lt;/PersonId&gt;
      &lt;Street&gt;1100 Danforth Ave&lt;/Street&gt;
      &lt;PostCode&gt;M4J1N2&lt;/PostCode&gt;
      &lt;CityTown&gt;Toronto&lt;/CityTown&gt;
    &lt;/Address&gt;
    &lt;Address&gt;
      &lt;PersonId&gt;3&lt;/PersonId&gt;
      &lt;Street&gt;6 Green St&lt;/Street&gt;
      &lt;PostCode&gt;94111-1402&lt;/PostCode&gt;
      &lt;CityTown&gt;San Francisco&lt;/CityTown&gt;
    &lt;/Address&gt;
  &lt;/Addresses&gt;
&lt;/Persons-Addresses&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
There are two ways to do this:
      </p>
      <div class="itemizedlist"><ul type="disc"><li>
          <p>
        Use a record mapping section with two
            <a class="link" href="../guide/index.html#sx:groupBy" target="_top">sx:groupBy</a>
        sections. In this case the implementation will
    buffer the records in memory until the first group is finished, and only then
    do the second.
          </p>
        </li><li>
          <p>
        Within a record mapping section, read the flat file twice, first inserting
        the person data content, and then inserting the address content.
          </p>
        </li></ul></div>

      <p>
    Taking the first approach, the resources script looks like this:
      </p>
      <div class="figure"><a name="resources-persons1.xml"></a><p class="title"><b>Figure&nbsp;52.&nbsp;Resources script resources-persons1.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="personsAddresses"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="persons"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="personsData"&gt;
    &lt;sx:flatFileHeader lineCount="1"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="persons"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordContent id="persons"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile ref="personsData"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="personsAddressesMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatRecordType id="persons" name="persons"&gt;
    &lt;sx:positionalField name="PersonId" width="9"/&gt;
    &lt;sx:positionalField name="Name" width="11"/&gt;
    &lt;sx:positionalField name="FirstName" width="16"/&gt;
    &lt;sx:positionalField name="Street" width="20"/&gt;
    &lt;sx:positionalField name="PostCode" width="12"/&gt;
    &lt;sx:positionalField name="CityTown" width="20" /&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:recordMapping id="personsAddressesMapping"&gt;
    &lt;Persons-Addresses&gt;
      &lt;Persons&gt;
        &lt;sx:groupBy fields="PersonId"&gt;
          &lt;Person&gt;
            &lt;sx:fieldElementMap field="PersonId" element="PersonId"/&gt;
            &lt;sx:fieldElementMap field="Name" element="Name"/&gt;
            &lt;sx:fieldElementMap field="FirstName" element="FirstName"/&gt;
            &lt;sx:onRecord/&gt;
          &lt;/Person&gt;
        &lt;/sx:groupBy&gt;
      &lt;/Persons&gt;
      &lt;Addresses&gt;
        &lt;sx:onRecord&gt;
          &lt;Address&gt;
            &lt;sx:fieldElementMap field="PersonId" element="PersonId"/&gt;
            &lt;sx:fieldElementMap field="Street" element="Street"/&gt;
            &lt;sx:fieldElementMap field="PostCode" element="PostCode"/&gt;
            &lt;sx:fieldElementMap field="CityTown" element="CityTown"/&gt;
          &lt;/Address&gt;
        &lt;/sx:onRecord&gt;
      &lt;/Addresses&gt;
    &lt;/Persons-Addresses&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
    Taking the second approach, the resources script looks like this:
      </p>
      <div class="figure"><a name="resources-persons2.xml"></a><p class="title"><b>Figure&nbsp;53.&nbsp;Resources script resources-persons2.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="personsAddresses"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="persons"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="personsData"&gt;
    &lt;sx:flatFileHeader lineCount="1"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="persons"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordContent id="persons"&gt;
    &lt;sx:recordMapping ref="personsAddressesMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatRecordType id="persons" name="persons"&gt;
    &lt;sx:positionalField name="PersonId" width="9"/&gt;
    &lt;sx:positionalField name="Name" width="11"/&gt;
    &lt;sx:positionalField name="FirstName" width="16"/&gt;
    &lt;sx:positionalField name="Street" width="20"/&gt;
    &lt;sx:positionalField name="PostCode" width="12"/&gt;
    &lt;sx:positionalField name="CityTown" width="20" /&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:recordMapping id="personsAddressesMapping"&gt;
    &lt;Persons-Addresses&gt;
      &lt;sx:nestedContent&gt;
        &lt;sx:recordContent&gt;
          &lt;sx:flatFileReader&gt;
            &lt;sx:flatFile ref="personsData"/&gt;
          &lt;/sx:flatFileReader&gt;
          &lt;sx:recordMapping ref="personsMapping"/&gt;
        &lt;/sx:recordContent&gt;
      &lt;/sx:nestedContent&gt;
      &lt;sx:nestedContent&gt;
        &lt;sx:recordContent&gt;
          &lt;sx:flatFileReader&gt;
            &lt;sx:flatFile ref="personsData"/&gt;
          &lt;/sx:flatFileReader&gt;
          &lt;sx:recordMapping ref="addressesMapping"/&gt;
        &lt;/sx:recordContent&gt;
      &lt;/sx:nestedContent&gt;
    &lt;/Persons-Addresses&gt;
  &lt;/sx:recordMapping&gt;

  &lt;sx:recordMapping id="personsMapping"&gt;
    &lt;Persons&gt;
      &lt;sx:groupBy fields="PersonId"&gt;
        &lt;Person&gt;
          &lt;sx:fieldElementMap field="PersonId" element="PersonId"/&gt;
          &lt;sx:fieldElementMap field="Name" element="Name"/&gt;
          &lt;sx:fieldElementMap field="FirstName" element="FirstName"/&gt;
          &lt;sx:onRecord/&gt;
        &lt;/Person&gt;
      &lt;/sx:groupBy&gt;
    &lt;/Persons&gt;
  &lt;/sx:recordMapping&gt;

  &lt;sx:recordMapping id="addressesMapping"&gt;
    &lt;Addresses&gt;
      &lt;sx:onRecord&gt;
        &lt;Address&gt;
          &lt;sx:fieldElementMap field="PersonId" element="PersonId"/&gt;
          &lt;sx:fieldElementMap field="Street" element="Street"/&gt;
          &lt;sx:fieldElementMap field="PostCode" element="PostCode"/&gt;
          &lt;sx:fieldElementMap field="CityTown" element="CityTown"/&gt;
        &lt;/Address&gt;
      &lt;/sx:onRecord&gt;
    &lt;/Addresses&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
Note the following:
        </p><div class="itemizedlist"><ul type="disc"><li>
Since you only want to show distinct persons in the persons section, group by PersonId.
          </li></ul></div><p>
      </p>
      <p>
You can run the two examples on the command line by entering
        </p><pre class="programlisting">
          
servingxml -i data/persons.txt -o output/persons1.xml -r resources-persons1.xml 
    personsAddresses 

        </pre><p>
        </p><pre class="programlisting">
          
servingxml -i data/persons.txt -o output/persons2.xml -r resources-persons2.xml 
    personsAddresses 

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e921"></a>Converting a directory of books positional files to XML files (all books)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e924"></a>
      <a class="indexterm" name="d4e927"></a>
      <a class="indexterm" name="d4e930"></a>
      <p>
The example below shows how to process
all the files in the
        <code class="filename">data</code>
directory matching the regular expression "books.*[.]txt",
convert them from positional flat file formats to XML files, and write them out to the
        <code class="filename">output</code>
directory.
      </p>
      <p>
As before, the input is a directory of files.
      </p>
      <div class="figure"><a name="directory"></a><p class="title"><b>Figure&nbsp;54.&nbsp;Directory containing input files</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
[.]                     countries.csv           multivalued-field.csv
[..]                    countries.xsd           plans.txt
3545_JH4DA3_4_H_.xml    country-record.xsd      tasks.csv
bad-countries.csv       exotics.txt             timesheets.csv
books.20040613.txt      hot-record.xsd          trades.txt
books.20040802.txt      hot-record.xsx
books.txt               hot.txt
books.xml               messages.properties
        </pre>
      </div></div><br class="figure-break">
      <p>
We want to take the positional files whose names match the regular expression
        <code class="code">"(books.*)[.]txt"</code>
and convert them all to XML files.
      </p>

      <div class="figure"><a name="books-output-files"></a><p class="title"><b>Figure&nbsp;55.&nbsp;Books XML output files.</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
books.xml            books.20040802.xml
books.20040613.xml

        </pre>
      </div></div><br class="figure-break">

      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-allbooks.xml"></a><p class="title"><b>Figure&nbsp;56.&nbsp;Resources script resources-allbooks.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;
   
  &lt;sx:service id="all-books"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:directoryReader directory="data"&gt;
        &lt;sx:fileFilter pattern="books.*[.]txt"/&gt;
      &lt;/sx:directoryReader&gt;
      &lt;sx:processRecord&gt;
        &lt;sx:parameter name="output-file"&gt;
          &lt;sx:findAndReplace searchFor ="(books.*)[.]txt" replaceWith ="$1.xml"&gt;
            &lt;sx:toString value="{name}"/&gt;
          &lt;/sx:findAndReplace&gt;
        &lt;/sx:parameter&gt;
        &lt;sx:serialize&gt;
          &lt;sx:xsltSerializer&gt;
            &lt;sx:fileSink directory="output" file="{$output-file}"/&gt;
          &lt;/sx:xsltSerializer&gt;
          &lt;sx:transform&gt;
            &lt;sx:content ref="books"/&gt;
          &lt;/sx:transform&gt;
        &lt;/sx:serialize&gt;
      &lt;/sx:processRecord&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="books"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:fileSource directory="{parentDirectory}" file="{name}"/&gt;
      &lt;sx:flatFile ref="booksFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="booksToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="booksFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="bookType"/&gt;
      &lt;sx:annotationRecord/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="bookType"/&gt;
    &lt;/sx:flatFileBody&gt;
    &lt;sx:flatFileTrailer&gt;
      &lt;sx:annotationRecord&gt;&lt;/sx:annotationRecord&gt;
      &lt;sx:annotationRecord&gt;This is a trailer record&lt;/sx:annotationRecord&gt;
    &lt;/sx:flatFileTrailer&gt;
  &lt;/sx:flatFile&gt;      

  &lt;sx:flatRecordType id="bookType" name="bookType"&gt;
    &lt;sx:positionalField name="category" label="Category" width="1"/&gt;
    &lt;sx:positionalField name="author" label="Author" width="30"/&gt;
    &lt;sx:positionalField name="title" label="Title" width="30"/&gt;
    &lt;sx:positionalField name="price" label="Price" width="10" justify="right"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:recordMapping id="booksToXmlMapping"&gt;
    &lt;myns:books xmlns:myns="http://mycompany.com/mynames/" 
                     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                     xsi:schemaLocation="url2"&gt;
      &lt;sx:onRecord&gt;
        &lt;myns:book&gt;
          &lt;sx:fieldAttributeMap field="category" attribute="categoryCode"/&gt;
          &lt;sx:fieldElementMap field="title" element="myns:title"/&gt;  
          &lt;sx:fieldElementMap field="author" element="myns:author"/&gt;
          &lt;sx:fieldElementMap field="price" element="myns:price"/&gt;
        &lt;/myns:book&gt;  
      &lt;/sx:onRecord&gt;
    &lt;/myns:books&gt;
  &lt;/sx:recordMapping&gt;  
  
&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml  -r resources-allbooks.xml all-books

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e951"></a>Converting a flat file to multiple XML book files (multiple books)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e954"></a>
      <p>
The example below shows how to process one flat file and produce multiple XML 
output files.
      </p>
      <p>
The input file is shown below.
      </p>
      <div class="figure"><a name="books.txt"></a><p class="title"><b>Figure&nbsp;57.&nbsp;Books input file</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
CAuthor                        Title                              Price ISBN

FCharles Bukowski              Factotum                           22.95 0876852630
FSergei Lukyanenko             The Night Watch                    17.99 0434014125
FAndrew Crumey                 Mr Mee                             22.00 0312282354
CSteven John Metsker           Building Parsers with Java         39.95 0201719622

This is a trailer record

        </pre>
      </div></div><br class="figure-break">
      <p>
We want to produce multiple files like the one shown below, with filenames
differentiated by the isbn number.
      </p>

      <div class="figure"><a name="book-0876852630.xml"></a><p class="title"><b>Figure&nbsp;58.&nbsp;Book XML output file book-0876852630.xml.</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;myns:book xmlns:myns="http://mycompany.com/mynames/" 
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
           categoryCode="F"&gt;
  &lt;myns:title&gt;Factotum&lt;/myns:title&gt;
  &lt;myns:author&gt;Charles Bukowski&lt;/myns:author&gt;
  &lt;myns:price&gt;22.95&lt;/myns:price&gt;
  &lt;myns:isbn&gt;0876852630&lt;/myns:isbn&gt;
&lt;/myns:book&gt;

        </pre>
      </div></div><br class="figure-break">

      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-books_multiple.xml"></a><p class="title"><b>Figure&nbsp;59.&nbsp;Resources script resources-books_multiple.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0"?&gt;

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
                     xmlns:myns="http://mycompany.com/mynames/" &gt;

  &lt;sx:service id="books"&gt;
    &lt;sx:transform&gt;
      &lt;sx:content ref="books"/&gt;
      &lt;sx:processSubtree path="/myns:books/myns:book"&gt;
        &lt;sx:parameter name="isbn" select="myns:isbn"/&gt;
        &lt;sx:serialize&gt;
          &lt;sx:xsltSerializer&gt; 
            &lt;sx:fileSink directory="output" file="book-{$isbn}.xml"/&gt; 
          &lt;/sx:xsltSerializer&gt; 
        &lt;/sx:serialize&gt;
      &lt;/sx:processSubtree&gt;
    &lt;/sx:transform&gt;
  &lt;/sx:service&gt;
  
  &lt;!--
  This sx:flatFileReader element does not specify a stream source, so 
  the source will default to the file specified with the -i option on the command line.
  --&gt;
  &lt;sx:recordContent id="books"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile ref="booksFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="booksToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="booksFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="bookType"/&gt;
      &lt;sx:annotationRecord/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="bookType"/&gt;
    &lt;/sx:flatFileBody&gt;
    &lt;sx:flatFileTrailer&gt;
      &lt;sx:annotationRecord&gt;&lt;/sx:annotationRecord&gt;
      &lt;sx:annotationRecord&gt;This is a trailer record&lt;/sx:annotationRecord&gt;
    &lt;/sx:flatFileTrailer&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatRecordType id="bookType" name="bookType"&gt;
    &lt;sx:positionalField name="category" label="Category" width="1"/&gt;
    &lt;sx:positionalField name="author" label="Author" width="30"/&gt;
    &lt;sx:positionalField name="title" label="Title" width="30"/&gt;
    &lt;sx:positionalField name="price" label="Price" width="10" justify="right"/&gt;
    &lt;sx:positionalField name="isbn" label="ISBN" start="73" width="10"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:recordMapping id="booksToXmlMapping"&gt;
    &lt;myns:books xmlns:myns="http://mycompany.com/mynames/"
                     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                     xsi:schemaLocation="url2"&gt;
      &lt;sx:onRecord&gt;
        &lt;myns:book&gt;
          &lt;sx:fieldAttributeMap field="category" attribute="categoryCode"/&gt;
          &lt;sx:fieldElementMap field="title" element="myns:title"/&gt;
          &lt;sx:fieldElementMap field="author" element="myns:author"/&gt;
          &lt;sx:fieldElementMap field="price" element="myns:price"/&gt;
          &lt;sx:fieldElementMap field="isbn" element="myns:isbn"/&gt;
        &lt;/myns:book&gt;
      &lt;/sx:onRecord&gt;
    &lt;/myns:books&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-books_multiple.xml -i data/books.txt books 

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e972"></a>Converting a flat file to multiple XML documents with default namespace
  prefixes (multiple default ns)
      </h4></div></div></div>
      
      
      <a class="indexterm" name="d4e975"></a>
      <a class="indexterm" name="d4e978"></a>
      <p>
The example below shows how to process
one flat file and produce multiple XML documents with default namespace
prefixes.
      </p>
      <p>
The input file is the same as in the previous example.
      </p>
      <div class="figure"><a name="books.txt"></a><p class="title"><b>Figure&nbsp;60.&nbsp;Books input file</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
CAuthor                        Title                              Price ISBN

FCharles Bukowski              Factotum                           22.95 0876852630
FSergei Lukyanenko             The Night Watch                    17.99 0434014125
FAndrew Crumey                 Mr Mee                             22.00 0312282354
CSteven John Metsker           Building Parsers with Java         39.95 0201719622

This is a trailer record

        </pre>
      </div></div><br class="figure-break">
      <p> This time we want to produce multiple files like the one shown below,
with a default namespace prefix.
      </p>

      <div class="figure"><a name="book-0876852630.xml"></a><p class="title"><b>Figure&nbsp;61.&nbsp;Book XML output file book-with-default-ns-0156028972.xml.</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;book xmlns="http://mycompany.com/mynames/"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      categoryCode="F"&gt;
   &lt;title&gt;Gun, with Occasional Music&lt;/title&gt;
   &lt;author&gt;Jonathan Lethem&lt;/author&gt;
   &lt;price&gt;17.99&lt;/price&gt;
   &lt;isbn&gt;0156028972&lt;/isbn&gt;
&lt;/book&gt;

        </pre>
      </div></div><br class="figure-break">

      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-multiple_default_ns.xml"></a><p class="title"><b>Figure&nbsp;62.&nbsp;Resources script resources-multiple_default_ns.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:myns="http://mycompany.com/mynames/"&gt;

  &lt;sx:service id="books"&gt;
    &lt;sx:transform&gt;
      &lt;sx:content ref="books"/&gt;
      &lt;sx:processSubtree path="/myns:books/myns:book"&gt;
        &lt;sx:parameter name="isbn" select="myns:isbn"/&gt;
        &lt;sx:serialize&gt;
          &lt;sx:xsltSerializer&gt;
            &lt;sx:fileSink directory="output" file="book-with-default-ns-{$isbn}.xml"/&gt;
            &lt;sx:outputProperty name="indent" value="yes"/&gt;
          &lt;/sx:xsltSerializer&gt;
        &lt;/sx:serialize&gt;
      &lt;/sx:processSubtree&gt;
    &lt;/sx:transform&gt;
  &lt;/sx:service&gt;
  
  &lt;!--
  This sx:flatFileReader element does not specify a stream source, so 
  the source will default to the file specified with the -i option on the command line.
  --&gt;
  &lt;sx:recordContent id="books"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile ref="booksFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="booksToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="booksFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="bookType"/&gt;
      &lt;sx:annotationRecord/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="bookType"/&gt;
    &lt;/sx:flatFileBody&gt;
    &lt;sx:flatFileTrailer&gt;
      &lt;sx:annotationRecord&gt;&lt;/sx:annotationRecord&gt;
      &lt;sx:annotationRecord&gt;This is a trailer record&lt;/sx:annotationRecord&gt;
    &lt;/sx:flatFileTrailer&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatRecordType id="bookType" name="bookType"&gt;
    &lt;sx:positionalField name="category" label="Category" width="1"/&gt;
    &lt;sx:positionalField name="author" label="Author" width="30"/&gt;
    &lt;sx:positionalField name="title" label="Title" width="30"/&gt;
    &lt;sx:positionalField name="price" label="Price" width="10" justify="right"/&gt;
    &lt;sx:positionalField name="isbn" label="ISBN" start="73" width="10"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:recordMapping id="booksToXmlMapping"&gt;
    &lt;books xmlns="http://mycompany.com/mynames/"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="url2"&gt;
      &lt;sx:onRecord&gt;
        &lt;book&gt;
          &lt;sx:fieldAttributeMap field="category" attribute="myns:categoryCode"/&gt;
          &lt;sx:fieldElementMap field="title" element="myns:title"/&gt;
          &lt;sx:fieldElementMap field="author" element="myns:author"/&gt;
          &lt;sx:fieldElementMap field="price" element="myns:price"/&gt;
          &lt;sx:fieldElementMap field="isbn" element="myns:isbn"/&gt;
        &lt;/book&gt;
      &lt;/sx:onRecord&gt;
    &lt;/books&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="d4e994"></a>Remarks</h5></div></div></div>
        
        <div class="itemizedlist"><ul type="disc"><li>
            <p>Note that the root element in the
              <a class="link" href="../guide/index.html#sx:recordMapping" target="_top">sx:recordMapping</a>
section
            contains a default namespace declaration, which will appear in the
            output XML, and which will have the effect that XML names belonging
            to the namespace "http://mycompany.com/mynames/" will be output
            without an explicit prefix.
            </p>
          </li><li>
            <p>Note that the
              <a class="link" href="../guide/index.html#sx:fieldAttributeMap" target="_top">sx:fieldAttributeMap</a>
and
              <a class="link" href="../guide/index.html#sx:fieldElementMap" target="_top">sx:fieldElementMap</a>
elements use the
              <code class="sgmltag-element">myns</code>
prefix to associate attribute and
                    element names with the namespace
                    "http://mycompany.com/mynames/".  The prefix is resolved
                    against the nearest in-scope prefix declaration for
              <code class="sgmltag-element">myns</code>
, which happens to be the one in the
              <a class="link" href="../guide/index.html#sx:resources" target="_top">sx:resources</a>
element.
            Since this declaration does not appear inside the record mapping
            section, it is used only to associate a name with a namespace, not
            for serialization.
            </p>
          </li><li>
            <p>If a prefix were omitted in an attribute or element mapping,
             say on
              <code class="sgmltag-element">title</code>
, that element would belong to no
                    namespace, all others would belong to the default namespace,
                    and the output would become
              </p><pre class="programlisting">
                
&lt;book xmlns="http://mycompany.com/mynames/"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      categoryCode="F"&gt;
   &lt;title xmlns=""&gt;Gun, with Occasional Music&lt;/title&gt;
   &lt;author&gt;Jonathan Lethem&lt;/author&gt;
   &lt;price&gt;17.99&lt;/price&gt;
   &lt;isbn&gt;0156028972&lt;/isbn&gt;
&lt;/book&gt;


              </pre><p>
            </p>
          </li></ul></div>
      </div>

      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-multiple_default_ns.xml -i data/books.txt books 

        </pre><p>
      </p>
    </div>
  </div>
  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e1013"></a>Flat Files with Multibyte Characters</h3></div></div></div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e1015"></a>A UTF-8 positional flat file with double byte characters
      </h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1018"></a>
      <p>
The example below shows how to convert a
positional flat file with multi-byte encoding to XML.
      </p>
      <p>
The input file is a positional flat file containing the following hex UTF-8 byte
input.
      </p>
      <div class="figure"><a name="doubleByte.txt"></a><p class="title"><b>Figure&nbsp;63.&nbsp;Input flat file doubleByte.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
41414242 43430A41 C3964242 43430A

        </pre>
      </div></div><br class="figure-break">
      <p>
    The two byte sequence C396 represents the single character &Ouml;.
      </p>
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="doubleByte.xml"></a><p class="title"><b>Figure&nbsp;64.&nbsp;Output XML file doubleByte.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="UTF-8" ?&gt; 
&lt;document&gt;
  &lt;documentData&gt;
    &lt;param1&gt;AA&lt;/param1&gt; 
    &lt;param2&gt;BB&lt;/param2&gt; 
    &lt;param3&gt;CC&lt;/param3&gt; 
  &lt;/documentData&gt;
  &lt;documentData&gt;
    &lt;param1&gt;A&Ouml;&lt;/param1&gt; 
    &lt;param2&gt;BB&lt;/param2&gt; 
    &lt;param3&gt;CC&lt;/param3&gt; 
  &lt;/documentData&gt;
&lt;/document&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-doubleByte.xml"></a><p class="title"><b>Figure&nbsp;65.&nbsp;Resources script resources-doubleByte.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="convert"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="data"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="data"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile ref="flatfile"/&gt;
      &lt;sx:defaultStreamSource encoding="UTF-8"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="recordmap"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="flatfile"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="recordtype"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatRecordType id="recordtype"&gt;
    &lt;sx:positionalField name="param1" width="2"/&gt;
    &lt;sx:positionalField name="param2" width="2"/&gt;
    &lt;sx:positionalField name="param3" width="2"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:recordMapping id="recordmap"&gt;
    &lt;document&gt;
      &lt;sx:onRecord&gt;
        &lt;documentData&gt;
          &lt;sx:fieldElementMap element="param1" field="param1"/&gt;
          &lt;sx:fieldElementMap element="param2" field="param2"/&gt;
          &lt;sx:fieldElementMap element="param3" field="param3"/&gt;
        &lt;/documentData&gt;
      &lt;/sx:onRecord&gt;
    &lt;/document&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-doubleByte.xml -i data/doubleByte.dat 
    -o output/doubleByte.xml convert

        </pre><p>
      </p>
    </div>
  </div>

  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e1037"></a>Fixed Width Fields, Multiple Record Types, Line Delimited</h3></div></div></div>
    

    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="trades-eg"></a>Converting a flat file with multiple record formats to XML (trades)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1042"></a>
      <a class="indexterm" name="d4e1045"></a>
      <a class="indexterm" name="d4e1048"></a>
      <a class="indexterm" name="d4e1051"></a>
      <a class="indexterm" name="d4e1054"></a>
      <p>
The example below shows how to convert a
flat file with multiple record formats to XML.
      </p>
      <p>
The input file is a positional flat file.
      </p>
      <div class="figure"><a name="trades.txt"></a><p class="title"><b>Figure&nbsp;66.&nbsp;Input flat file trades.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
TR000103/25/2005 1:50:00This is a trade record
TN0002X1234A child transaction
TN0003X1235Another child transaction

        </pre>
      </div></div><br class="figure-break">
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="trades.xml"></a><p class="title"><b>Figure&nbsp;67.&nbsp;Output XML file trades.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;trades feed="LONDON"&gt;
  &lt;trade id="0001"&gt;
    &lt;trade-date&gt;2005-03-25T01:50:00.000-05:00&lt;/trade-date&gt;
    &lt;description&gt;This is a trade record&lt;/description&gt;
    &lt;transaction id="0002"&gt;
      &lt;reference&gt;X1234&lt;/reference&gt;
      &lt;description&gt;A child transaction&lt;/description&gt;
    &lt;/transaction&gt;
    &lt;transaction id="0003"&gt;
      &lt;reference&gt;X1235&lt;/reference&gt;
      &lt;description&gt;Another child transaction&lt;/description&gt;
    &lt;/transaction&gt;
  &lt;/trade&gt;
&lt;/trades&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-trades.xml"></a><p class="title"><b>Figure&nbsp;68.&nbsp;Resources script resources-trades.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0"?&gt;
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="trades"&gt;
    &lt;sx:parameter name="feed"&gt;
      &lt;sx:defaultValue&gt;NY&lt;/sx:defaultValue&gt;
    &lt;/sx:parameter&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="trades"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="trades"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:urlSource url="data/trades.txt"/&gt;
        &lt;sx:flatFile ref="tradesFlatFile"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;sx:combineRecords recordType="composite" repeatingGroup="detail"
                                             startTest="sx:current//record_type='TR'"
                                             endTest="sx:current//record_type='TR'"&gt;
        &lt;sx:newField name="id" select="detail/trade/id"/&gt;
      &lt;/sx:combineRecords&gt;
    &lt;/sx:recordStream&gt;
    &lt;sx:recordMapping ref="tradesToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:recordMapping id="tradesToXmlMapping"&gt;
    &lt;trades&gt;
      &lt;sx:fieldAttributeMap value="{$feed}" attribute="feed"/&gt;
      &lt;sx:onRecord recordType="composite"&gt;
        &lt;trade&gt;
          &lt;sx:fieldAttributeMap field="id" attribute="id"/&gt;
          &lt;sx:subrecordMapping repeatingGroup="detail"&gt;
            &lt;sx:onRecord recordType="trade"&gt;
              &lt;sx:elementMap element="trade-date"&gt;
                &lt;sx:convertToDateTime format="MM/dd/yyyy H:mm:ss"&gt;
                  &lt;sx:concat separator=" "&gt; 
                    &lt;sx:toString value="{trade_date}"/&gt;
                    &lt;sx:toString value="{trade_time}"/&gt;
                  &lt;/sx:concat&gt;
                &lt;/sx:convertToDateTime&gt;
              &lt;/sx:elementMap&gt;
              &lt;sx:fieldElementMap field="description" element="description"/&gt;
            &lt;/sx:onRecord&gt;
            &lt;sx:onRecord recordType="transaction"&gt;
              &lt;transaction&gt;
                &lt;sx:fieldAttributeMap field="id" attribute="id"/&gt;
                &lt;sx:fieldElementMap field="reference" element="reference"/&gt;
                &lt;sx:fieldElementMap field="description" element="description"/&gt;
              &lt;/transaction&gt;
            &lt;/sx:onRecord&gt;
          &lt;/sx:subrecordMapping&gt;
        &lt;/trade&gt;
      &lt;/sx:onRecord&gt;
    &lt;/trades&gt;
  &lt;/sx:recordMapping&gt;

  &lt;sx:flatFile id="tradesFlatFile"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:positionalField name="record_type" width="2"/&gt;
        &lt;sx:when test="record_type='TR'"&gt;
          &lt;sx:flatRecordType name="trade"&gt;
            &lt;sx:positionalField name="record_type" width="2"/&gt;
            &lt;sx:positionalField name="id" width="4"/&gt;
            &lt;sx:positionalField name="trade_date" width="10"/&gt;
            &lt;sx:positionalField name="trade_time" width="8"/&gt;
            &lt;sx:positionalField name="description" width="30"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="record_type='TN'"&gt;
          &lt;sx:flatRecordType name="transaction"&gt;
            &lt;sx:positionalField name="record_type" width="2"/&gt;
            &lt;sx:positionalField name="id" width="4"/&gt;
            &lt;sx:positionalField name="reference" width="5"/&gt;
            &lt;sx:positionalField name="description" width="30"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
Note the following points about the content of the&lt;sx:elementMap element="trade-date"&gt; element.
        </p><div class="itemizedlist"><ul type="disc"><li>
The inner
            <a class="link" href="../guide/index.html#sx:concat" target="_top">sx:concat</a>
element concatenates the date and time fields from the record,
separating them with a space.
          </li><li>
The
            <a class="link" href="../guide/index.html#sx:convertDate" target="_top">sx:convertDate</a>
element converts the datetime value into something close to an
ISO 8601 date, where the input and output formats follow the syntax specified for the
            <a class="ulink" href="http://java.sun.com/j2se/1.3/docs/api/java/text/SimpleDateFormat.html" target="_top">JDK SimpleDateFormat</a>
class.
          </li><li>
The outer
            <a class="link" href="../guide/index.html#sx:findAndReplace" target="_top">sx:findAndReplace</a>
            element inserts a colon into the time format.
          </li></ul></div><p>
      </p>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-trades.xml -o output/trades.xml trades feed=LONDON

        </pre><p>
      </p>
    </div>

    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="CONV-eg"></a>Converting a flat file to XML with header, detail, and summary records (CONV)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1084"></a>
      <a class="indexterm" name="d4e1087"></a>
      <a class="indexterm" name="d4e1090"></a>
      <p>
The example below shows how to convert a
flat file with header, detail, and summary records to XML.
      </p>
      <p>
The input file is a positional flat file with variable record layouts.
      </p>
      <div class="figure"><a name="tasks.csv"></a><p class="title"><b>Figure&nbsp;69.&nbsp;Input flat file CONV_in.dat</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
90112345678abcdefg1000001 
100SURNAME1 GIVEN1 A 
100SURNAME2 GIVEN2 B 
3011111111AB111111 

        </pre>
      </div></div><br class="figure-break">
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="tasks.xml"></a><p class="title"><b>Figure&nbsp;70.&nbsp;Output XML file CONV.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;Submission&gt;
  &lt;Header&gt;
    &lt;record_type&gt;901&lt;/record_type&gt;
    &lt;sbmt_ref_id&gt;abcdefg&lt;/sbmt_ref_id&gt;
    &lt;trnmtr_tcd&gt;1&lt;/trnmtr_tcd&gt;
    &lt;summ_cnt&gt;000001&lt;/summ_cnt&gt;
  &lt;/Header&gt;
  &lt;All&gt;
    &lt;Level1&gt;
      &lt;Detail&gt;
        &lt;snm&gt;SURNAME1&lt;/snm&gt;
        &lt;gvn_nm&gt;GIVEN1&lt;/gvn_nm&gt;
        &lt;init&gt;A&lt;/init&gt;
      &lt;/Detail&gt;
      &lt;Detail&gt;
        &lt;snm&gt;SURNAME2&lt;/snm&gt;
        &lt;gvn_nm&gt;GIVEN2&lt;/gvn_nm&gt;
        &lt;init&gt;B&lt;/init&gt;
      &lt;/Detail&gt;
      &lt;Summary&gt;
        &lt;bn&gt;1111111AB111111&lt;/bn&gt;
      &lt;/Summary&gt;
    &lt;/Level1&gt;
  &lt;/All&gt;
&lt;/Submission&gt;
</pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-CONV.xml"></a><p class="title"><b>Figure&nbsp;71.&nbsp;Resources script resources-CONV.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:msv="http://www.servingxml.com/extensions/msv"&gt;

  &lt;sx:service id="CONV"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="CONV"/&gt;
        &lt;sx:removeEmptyElements elements="*"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="CONV"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:urlSource url="data/CONV_in.dat"/&gt;
      &lt;sx:flatFile ref="CONVFlatFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="CONVToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="CONVFlatFile"&gt;
    &lt;sx:commentStarter value="#"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:positionalField name="record_type" width="3"/&gt;
        &lt;sx:when test="record_type='901'"&gt;
          &lt;sx:flatRecordType name="header"&gt;
            &lt;sx:positionalField name="record_type" width="3"/&gt;
            &lt;sx:positionalField name="trnmtr_nbr" width="8"/&gt;
            &lt;sx:positionalField name="sbmt_ref_id" width="7"/&gt;
            &lt;sx:positionalField name="trnmtr_tcd" width="1"/&gt;
            &lt;sx:positionalField name="summ_cnt" width="6"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="record_type='100'"&gt;
          &lt;sx:flatRecordType name="detail"&gt;
            &lt;sx:positionalField name="record_type" width="3"/&gt;
            &lt;sx:positionalField name="snm" width="9"/&gt;
            &lt;sx:positionalField name="gvn_nm" width="7"/&gt;
            &lt;sx:positionalField name="init" width="1"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="record_type='301'"&gt;
          &lt;sx:flatRecordType name="summary"&gt;
            &lt;sx:positionalField name="record_type" width="3"/&gt;
            &lt;sx:positionalField name="bn" width="15"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="CONVToXmlMapping"&gt;
    &lt;Submission&gt;
      &lt;sx:onRecord recordType="header"&gt;
        &lt;Header&gt;
          &lt;sx:fieldElementMap field="record_type" element="record_type"/&gt;
          &lt;sx:fieldElementMap field="sbmt_ref_id" element="sbmt_ref_id"/&gt;
          &lt;sx:fieldElementMap field="trnmtr_tcd" element="trnmtr_tcd"/&gt;
          &lt;sx:fieldElementMap field="summ_cnt" element="summ_cnt"/&gt;
        &lt;/Header&gt;
      &lt;/sx:onRecord&gt;
      &lt;sx:innerGroup startTest="sx:current/detail or sx:current/summary"
                     endTest="not(sx:current/detail or sx:current/summary)"&gt;
        &lt;All&gt;
          &lt;Level1&gt;
            &lt;sx:onRecord recordType='detail'&gt;
              &lt;Detail&gt;
                &lt;sx:fieldElementMap field="snm" element="snm"/&gt;
                &lt;sx:fieldElementMap field="gvn_nm" element="gvn_nm"/&gt;
                &lt;sx:fieldElementMap field="init" element="init"/&gt;
              &lt;/Detail&gt;
            &lt;/sx:onRecord&gt;
            &lt;sx:onRecord recordType="summary"&gt;
              &lt;Summary&gt;
                &lt;sx:fieldElementMap field="bn" element="bn"/&gt;
              &lt;/Summary&gt;
            &lt;/sx:onRecord&gt;
          &lt;/Level1&gt;
        &lt;/All&gt;
      &lt;/sx:innerGroup&gt;
    &lt;/Submission&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -o output/CONV.xml -r resources-CONV.xml CONV

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e1108"></a>Converting a positional file to XML using a record filter (hot 1)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1111"></a>
      <a class="indexterm" name="d4e1114"></a>
      <a class="indexterm" name="d4e1117"></a>
      <p>
This is the first of two examples that map the
        <code class="filename">hot.txt</code>
flat file to XML.
      </p>
      <p>
The input file is a variable record positional file.
      </p>
      <div class="figure"><a name="hot.txt"></a><p class="title"><b>Figure&nbsp;72.&nbsp;Input flat file hot.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
BFH01value01
BCH02value02
BOH03value03
BKT06value04issue
BKP84value05A6USD2
BOT93value06
BOT94value07
BOH03value08
BKT06value09issue
BKP84value10A6CAD2
BOT93value11
BKT06value12refund
BKP84value13A6USD2
BOT93value14
BOT94value15
BCT95value16
BFT99value17

        </pre>
      </div></div><br class="figure-break">
      <p>
This file has variant record types.  The first five characters identify the record type,
and the next seven characters represent a hypothetical attribute.  The BKT06 and
BKP84 records have additional fields.
      </p>
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="hot1.xml"></a><p class="title"><b>Figure&nbsp;73.&nbsp;Output XML file hot1.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8" ?&gt;
&lt;hot&gt;
   &lt;BFH01 attr1="value01"/&gt;
   &lt;BCH02 attr1="value02"/&gt;
   &lt;BOH03 attr1="value03"/&gt;
   &lt;BKT06 attr1="value04"/&gt;
   &lt;BKP84 attr1="value05" amount="1.66" currency="USD"/&gt;
   &lt;BOT93 attr1="value06"/&gt;
   &lt;BOT94 attr1="value07"/&gt;
   &lt;BOH03 attr1="value08"/&gt;
   &lt;BKT06 attr1="value09"/&gt;
   &lt;BKP84 attr1="value10" amount="2.46" currency="CAD"/&gt;
   &lt;BOT93 attr1="value11"/&gt;
   &lt;BKT06 attr1="value12"/&gt;
   &lt;BKP84 attr1="value13" amount="2.27" currency="USD"/&gt;
   &lt;BOT93 attr1="value14"/&gt;
   &lt;BOT94 attr1="value15"/&gt;
   &lt;BCT95 attr1="value16"/&gt;
   &lt;BFT99 attr1="value17"/&gt;
&lt;/hot&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>

      <div class="figure"><a name="flatfile-hot.xml"></a><p class="title"><b>Figure&nbsp;74.&nbsp;flatfile-hot.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:flatFile id="hotFlatFile"&gt;
    &lt;sx:commentStarter value="#"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:positionalField name="record-type" width="5"/&gt;
        
        &lt;sx:when  test="record-type='BKP84'"&gt;
          &lt;sx:flatRecordType name="bkp84"&gt;
            &lt;sx:positionalField name="record-type-prefix"  width="3"/&gt;
            &lt;sx:positionalField name="record-type"  start="1" width="5"/&gt;
            &lt;sx:positionalField name="value" width="7"/&gt;
            &lt;sx:positionalField name="amount" width="2"/&gt;
            &lt;sx:positionalField name="currency" width="3"/&gt;
            &lt;sx:positionalField name="precision" width="1"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="record-type='BKT06'"&gt;
          &lt;sx:flatRecordType name="bkt06"&gt;
            &lt;sx:positionalField name="record-type-prefix"  width="3"/&gt;
            &lt;sx:positionalField name="record-type"  start="1" width="5"/&gt;
            &lt;sx:positionalField name="value" width="7"/&gt;
            &lt;sx:positionalField name="type" width="6"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:otherwise&gt;
          &lt;sx:flatRecordType name="other"&gt;
            &lt;sx:positionalField name="record-type-prefix"  width="3"/&gt;
            &lt;sx:positionalField name="record-type" start="1" width="5"/&gt;
            &lt;sx:positionalField name="value" width="7"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:otherwise&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;
    
&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The values in the
        <code class="code">bkp84</code>
record need to be transformed as follows:
      </p>
      <div class="itemizedlist"><ul type="disc"><li>
          <p>
The amount field is encoded as a hexadecimal value and needs to be converted to a
decimal value.
          </p>
        </li><li>
          <p>
The resulting decimal value needs to be converted to the specified precision.
          </p>
        </li></ul></div>
      <p>
In the hot 1 example in this section, we transform the values using a
        <a class="link" href="../guide/index.html#sx:customRecordFilter" target="_top">sx:customRecordFilter</a>
 element to define a custom record filter written in Java.  In the hot 2 example in the next section, we take a
different approach, transforming the values within an XPath select expression against the record
fields, making use of extension calls to static Java functions.
      </p>
      <div class="figure"><a name="hot-record.xsd"></a><p class="title"><b>Figure&nbsp;75.&nbsp;XML Schema file hot-record.xsd</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;
  &lt;!-- This element's name matches the value of the name attribute in the "bkp84" sx:flatFileRecordType. --&gt;
  &lt;xs:element name="bkp84" type="bkp84Type"/&gt;
  
  &lt;!-- This element's name matches the value of the name attribute in the "bkt06" sx:flatFileRecordType. --&gt;
  &lt;xs:element name="bkt06" type="bkt06Type"/&gt;
  
  &lt;!-- This element's name matches the value of the name attribute in the "other" sx:flatFileRecordType. --&gt;
  &lt;xs:element name="other" type="otherType"/&gt;

  &lt;xs:complexType name="bkp84Type"&gt;
    &lt;xs:sequence&gt;
      &lt;xs:element name="record-type-prefix" type="xs:string"/&gt;
      &lt;xs:element name="record-type" type="xs:string"/&gt;
      &lt;xs:element name="value" type="xs:string"/&gt;
      &lt;xs:element name="amount" type="xs:hexBinary"/&gt;
      &lt;xs:element name="currency" type="xs:string"/&gt;
      &lt;xs:element name="precision" type="xs:nonNegativeInteger"/&gt;
    &lt;/xs:sequence&gt;
  &lt;/xs:complexType&gt;

  &lt;xs:complexType name="bkt06Type"&gt;
    &lt;xs:sequence&gt;
      &lt;xs:element name="record-type-prefix" type="xs:string"/&gt;
      &lt;xs:element name="record-type" type="xs:string"/&gt;
      &lt;xs:element name="value" type="xs:string"/&gt;
      &lt;xs:element name="type" type="xs:string"/&gt;
    &lt;/xs:sequence&gt;
  &lt;/xs:complexType&gt;

  &lt;xs:complexType name="otherType"&gt;
    &lt;xs:sequence&gt;
      &lt;xs:element name="record-type-prefix" type="xs:string"/&gt;
      &lt;xs:element name="record-type" type="xs:string"/&gt;
      &lt;xs:element name="value" type="xs:string"/&gt;
    &lt;/xs:sequence&gt;
  &lt;/xs:complexType&gt;
&lt;/xs:schema&gt;

        </pre>
      </div></div><br class="figure-break">
      <div class="figure"><a name="resources-hot1.xml"></a><p class="title"><b>Figure&nbsp;76.&nbsp;Resources script resources-hot1.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:msv="http://www.servingxml.com/extensions/msv"&gt;

  &lt;sx:include href="flatfile-hot.xml"/&gt;

  &lt;sx:service id="hot1"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="hot1"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="hot1"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile ref="hotFlatFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;msv:recordValidator&gt;
      &lt;sx:urlSource url="data/hot-record.xsd"/&gt;
    &lt;/msv:recordValidator&gt;
    &lt;sx:customRecordFilter class="flat2xml.HotRecordFilter"/&gt;
    &lt;sx:discardHandler&gt;
      &lt;sx:log message="{$sx:message}"/&gt;
    &lt;/sx:discardHandler&gt;
    &lt;sx:recordMapping ref="hot1ToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:recordMapping id="hot1ToXmlMapping"&gt;
    &lt;hot&gt;
      &lt;sx:onRecord recordType="bkp84"&gt;
        &lt;sx:elementMap element="{record-type}"&gt;
          &lt;sx:fieldAttributeMap field="value" attribute="attr1"/&gt;
          &lt;sx:fieldAttributeMap field="calculatedAmount"  attribute="amount"/&gt;
          &lt;sx:fieldAttributeMap field="currency" attribute="currency"/&gt;
        &lt;/sx:elementMap&gt;
      &lt;/sx:onRecord&gt;
      &lt;sx:onRecord recordType="bkt06"&gt;
        &lt;sx:elementMap element="{record-type}"&gt;
          &lt;sx:fieldAttributeMap field="value" attribute="attr1"/&gt;
        &lt;/sx:elementMap&gt;
      &lt;/sx:onRecord&gt;
      &lt;sx:onRecord recordType="other"&gt;
        &lt;sx:elementMap element="{record-type}"&gt;
          &lt;sx:fieldAttributeMap field="value" attribute="attr1"/&gt;
        &lt;/sx:elementMap&gt;
      &lt;/sx:onRecord&gt;
    &lt;/hot&gt;
  &lt;/sx:recordMapping&gt;
    
&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <div class="figure"><a name="HotRecordFilter"></a><p class="title"><b>Figure&nbsp;77.&nbsp;HotRecordFilter class</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
package flat2xml;

import com.servingxml.app.ServiceContext;
import com.servingxml.components.recordio.AbstractRecordFilter;
import com.servingxml.app.Flow;
import com.servingxml.util.Name;
import com.servingxml.util.QualifiedName;
import com.servingxml.util.ServingXmlException;
import com.servingxml.util.record.Record;
import com.servingxml.util.record.RecordBuilder;

public class HotRecordFilter extends AbstractRecordFilter {
  private static final Name BKP84_RECORD_TYPE = new QualifiedName("bkp84");
  private static final Name AMOUNT_NAME = new QualifiedName("amount");
  private static final Name PRECISION_NAME = new QualifiedName("precision");
  private static final Name CALCULATED_AMOUNT_NAME = new QualifiedName("calculatedAmount");
  
  public void writeRecord(ServiceContext context, Flow flow) 
   {

    Record record = flow.getRecord();
    Flow newFlow = flow;
    if (record.getRecordType().getName().equals(BKP84_RECORD_TYPE)) {
      RecordBuilder recordBuilder = new RecordBuilder(record);
      String amountString = record.getString(AMOUNT_NAME);
      if (amountString == null) {
        throw new ServingXmlException("amount is NULL");
      }
      String precisionString = record.getString(PRECISION_NAME);
      if (precisionString == null) {
        throw new ServingXmlException("precision is NULL");
      }
      int amount = Integer.parseInt(amountString,16);
      int precision = Integer.parseInt(precisionString);
      double calculatedAmount = (double)amount/Math.pow(10.0,(double)precision);
      recordBuilder.setDouble(CALCULATED_AMOUNT_NAME,calculatedAmount);
      record = recordBuilder.toRecord();
      newFlow = flow.replaceRecord(context, record);
    }

    super.writeRecord(context, newFlow);
  }
}  
</pre>
      </div></div><br class="figure-break">
      <p>
You can run this example on the command line by
        </p><div class="itemizedlist"><ul type="disc"><li>
Compiling the Java class
            <code class="code">HotRecordFilter</code>
and copying
the resulting
            <code class="filename">.class</code>
file into the
            <code class="filename">dir/classes</code>
directory
          </li><li>
Entering the command
            <pre class="programlisting">
              
servingxml -r resources-hot1.xml -i data/hot.txt -o output/hot1.xml hot1

            </pre>
          </li></ul></div><p>
      </p>
    </div>

    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="hot2-eg"></a>Converting a positional file to XML with outer and inner grouping (hot 2)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1164"></a>
      <a class="indexterm" name="d4e1167"></a>
      <a class="indexterm" name="d4e1170"></a>
      <a class="indexterm" name="d4e1173"></a>
      <p>
This version of the hot example shows how to convert a
flat file to XML document with outer and inner grouping.   Each row in the flat 
file is validated with Sun's multi schema validator, and the row is discarded if 
an error is encountered.
      </p>
      <p>
This examples illustrates the
        <a class="link" href="../guide/index.html#sx:innerGroup" target="_top">sx:innerGroup</a>
and
        <a class="link" href="../guide/index.html#sx:innerGroup" target="_top">sx:outerGroup</a>
elements.  Both elements use
the
        <code class="sgmltag-attribute">startTest</code>
and
        <code class="sgmltag-attribute">endTest</code>
attributes to
define the beginning and end of a group through XPath boolean expressions applied to records.  They
differ in that
        <a class="link" href="../guide/index.html#sx:innerGroup" target="_top">sx:innerGroup</a>
will never allow any descendent
elements to be produced unless a group is recognized at its level, whereas a
        <a class="link" href="../guide/index.html#sx:innerGroup" target="_top">sx:outerGroup</a>
will only suppress content between this element and
the next succeeding grouping element.
      </p>
      <p>
The
        <code class="filename">resources-hot2.xml</code>
file defines the record mapping for this version of
the hot example.  The
        <code class="code">BFH01</code>
record type marks the beginning of a group of level 1,
the
        <code class="code">BFT99</code>
s mark the end.  The
        <code class="code">BCH02</code>
s mark
the beginning of a group of level 2, the
        <code class="code">BCT95</code>
s mark the end.
The
        <code class="code">BOH03</code>
marks the beginning of a group of level 3, the
        <code class="code">BOT94s</code>
mark the end.
      </p>
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="hot2.xml"></a><p class="title"><b>Figure&nbsp;78.&nbsp;Output XML file hot2.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8" ?&gt;
&lt;hot&gt;
   &lt;BFH01 attr1="value01"/&gt;
   &lt;periods&gt;
      &lt;period&gt;
         &lt;BCH02s&gt;
            &lt;BCH02 attr1="value02"/&gt;
         &lt;/BCH02s&gt;
         &lt;agents&gt;
            &lt;agent&gt;
               &lt;BOH03 attr1="value03"/&gt;
               &lt;issues&gt;
                  &lt;issue&gt;
                     &lt;BKT06 attr1="value04"/&gt;
                     &lt;BKP84 attr1="value05" amount="1.66" currency="USD"/&gt;
                  &lt;/issue&gt;
                  &lt;BOT93s&gt;
                     &lt;BOT93 attr1="value06"/&gt;
                  &lt;/BOT93s&gt;
               &lt;/issues&gt;
               &lt;BOT94s&gt;
                  &lt;BOT94 attr1="value07"/&gt;
               &lt;/BOT94s&gt;
            &lt;/agent&gt;
            &lt;agent&gt;
               &lt;BOH03 attr1="value08"/&gt;
               &lt;issues&gt;
                  &lt;issue&gt;
                     &lt;BKT06 attr1="value09"/&gt;
                     &lt;BKP84 attr1="value10" amount="2.46" currency="CAD"/&gt;
                  &lt;/issue&gt;
                  &lt;BOT93s&gt;
                     &lt;BOT93 attr1="value11"/&gt;
                  &lt;/BOT93s&gt;
               &lt;/issues&gt;
               &lt;refunds&gt;
                  &lt;refund&gt;
                     &lt;BKT06 attr1="value12"/&gt;
                     &lt;BKP84 attr1="value13" amount="2.27" currency="USD"/&gt;
                  &lt;/refund&gt;
                  &lt;BOT93s&gt;
                     &lt;BOT93 attr1="value14"/&gt;
                  &lt;/BOT93s&gt;
               &lt;/refunds&gt;
               &lt;BOT94s&gt;
                  &lt;BOT94 attr1="value15"/&gt;
               &lt;/BOT94s&gt;
            &lt;/agent&gt;
         &lt;/agents&gt;
         &lt;BCT95s&gt;
            &lt;BCT95 attr1="value16"/&gt;
         &lt;/BCT95s&gt;
      &lt;/period&gt;
   &lt;/periods&gt;
   &lt;BFT99s&gt;
      &lt;BFT99 attr1="value17"/&gt;
   &lt;/BFT99s&gt;
&lt;/hot&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-hot2.xml"></a><p class="title"><b>Figure&nbsp;79.&nbsp;Resources script resources-hot2.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:msv="http://www.servingxml.com/extensions/msv"
              xmlns:integer="java.lang.Integer" xmlns:math="java.lang.Math"&gt;

  &lt;sx:include href="flatfile-hot.xml"/&gt;

  &lt;sx:service id="hot2"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="hot2"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="hot2"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile ref="hotFlatFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;msv:recordValidator&gt;
      &lt;sx:urlSource url="data/hot-record.xsd"/&gt;
    &lt;/msv:recordValidator&gt;
    &lt;sx:discardHandler&gt;
      &lt;sx:log message="{$sx:message}"/&gt;
    &lt;/sx:discardHandler&gt;
    &lt;sx:recordMapping ref="hot2ToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:recordMapping id="hot2ToXmlMapping"&gt;
    &lt;hot&gt;
      &lt;sx:outerGroup startTest="sx:previous//record-type='BFH01'" 
                     endTest="sx:current//record-type='BFT99'"&gt;
        &lt;periods&gt;
          &lt;sx:outerGroup startTest="sx:current//record-type='BCH02'"
                         endTest="sx:previous//record-type='BCT95'"&gt;
            &lt;period&gt;
              &lt;sx:outerGroup startTest="sx:previous//record-type='BCH02'" 
                             endTest="sx:current//record-type='BCT95'"&gt;
                &lt;agents&gt;
                  &lt;sx:outerGroup startTest="sx:current//record-type='BOH03'" 
                                 endTest="sx:previous//record-type='BOT94'"&gt;
                    &lt;agent&gt;
                      &lt;sx:groupChoice&gt;
                        &lt;sx:innerGroup startTest="sx:current//record-type-prefix='BFH'" 
                                       endTest="sx:previous//record-type-prefix='BFH'"&gt;
                          &lt;sx:onRecord&gt;
                            &lt;sx:elementMap element="{record-type}"&gt;
                              &lt;sx:fieldAttributeMap field="value" attribute="attr1"/&gt;
                            &lt;/sx:elementMap&gt;
                          &lt;/sx:onRecord&gt;
                        &lt;/sx:innerGroup&gt;
                        &lt;sx:innerGroup startTest="sx:current//record-type-prefix='BOH'" 
                                       endTest="sx:previous//record-type-prefix='BOH'"&gt;
                          &lt;sx:onRecord&gt;
                            &lt;sx:elementMap element="{record-type}"&gt;
                              &lt;sx:fieldAttributeMap field="value" attribute="attr1"/&gt;
                            &lt;/sx:elementMap&gt;
                          &lt;/sx:onRecord&gt;
                        &lt;/sx:innerGroup&gt;
                        &lt;sx:innerGroup startTest="sx:current//record-type-prefix='BFT'" 
                                       endTest="sx:previous//record-type-prefix='BFT'"&gt;
                          &lt;sx:elementMap element="{record-type}s"&gt;
                            &lt;sx:onRecord&gt;
                              &lt;sx:elementMap element="{record-type}"&gt;
                                &lt;sx:fieldAttributeMap field="value" attribute="attr1"/&gt;
                              &lt;/sx:elementMap&gt;
                            &lt;/sx:onRecord&gt;
                          &lt;/sx:elementMap&gt;
                        &lt;/sx:innerGroup&gt;
                        &lt;sx:innerGroup startTest="sx:current//record-type-prefix='BCT'" 
                                       endTest="sx:previous//record-type-prefix='BCT'"&gt;
                          &lt;sx:elementMap element="{record-type}s"&gt;
                            &lt;sx:onRecord&gt;
                              &lt;sx:elementMap element="{record-type}"&gt;
                                &lt;sx:fieldAttributeMap field="value" attribute="attr1"/&gt;
                              &lt;/sx:elementMap&gt;
                            &lt;/sx:onRecord&gt;
                          &lt;/sx:elementMap&gt;
                        &lt;/sx:innerGroup&gt;
                        &lt;sx:innerGroup startTest="sx:current//record-type='BOT94'" 
                                       endTest="sx:previous//record-type='BOT94'"&gt;
                          &lt;sx:elementMap element="{record-type}s"&gt;
                            &lt;sx:onRecord&gt;
                              &lt;sx:elementMap element="{record-type}"&gt;
                                &lt;sx:fieldAttributeMap field="value" attribute="attr1"/&gt;
                              &lt;/sx:elementMap&gt;
                            &lt;/sx:onRecord&gt;
                          &lt;/sx:elementMap&gt;
                        &lt;/sx:innerGroup&gt;
                        &lt;sx:innerGroup startTest="sx:current//record-type='BCH02'" 
                                       endTest="sx:previous//record-type='BOH03'"&gt;
                          &lt;sx:elementMap element="{record-type}s"&gt;
                            &lt;sx:onRecord&gt;
                              &lt;sx:elementMap element="{record-type}"&gt;
                                &lt;sx:fieldAttributeMap field="value" attribute="attr1"/&gt;
                              &lt;/sx:elementMap&gt;
                            &lt;/sx:onRecord&gt;
                          &lt;/sx:elementMap&gt;
                        &lt;/sx:innerGroup&gt;
                        &lt;sx:innerGroup startTest="sx:current//record-type='BKT06'" 
                                       endTest="sx:previous//record-type='BOT93'"&gt;
                          &lt;sx:elementMap element="{type}s"&gt;
                            &lt;sx:groupChoice&gt;
                              &lt;sx:innerGroup startTest="sx:current//record-type='BKT06'"
                                             endTest="sx:previous//record-type='BKP84'"&gt;
                                &lt;sx:elementMap element="{type}"&gt;
                                  &lt;sx:onRecord recordType="bkt06"&gt;
                                    &lt;sx:elementMap element="{record-type}"&gt;
                                      &lt;sx:fieldAttributeMap field="value" attribute="attr1"/&gt;
                                    &lt;/sx:elementMap&gt;
                                  &lt;/sx:onRecord&gt;
                                  &lt;sx:onRecord recordType="bkp84"&gt;
                                    &lt;sx:elementMap element="{record-type}"&gt;
                                      &lt;sx:fieldAttributeMap field="value" attribute="attr1"/&gt;
                                      &lt;sx:fieldAttributeMap select="integer:valueOf(amount,16) div math:pow(10,precision)"  attribute="amount"/&gt;
                                      &lt;sx:fieldAttributeMap field="currency" attribute="currency"/&gt;
                                    &lt;/sx:elementMap&gt;
                                  &lt;/sx:onRecord&gt;
                                &lt;/sx:elementMap&gt;
                              &lt;/sx:innerGroup&gt;
                              &lt;sx:innerGroup startTest="sx:current//record-type-prefix='BOT'" 
                                             endTest="sx:previous//record-type-prefix='BOT'"&gt;
                                &lt;sx:elementMap element="{record-type}s"&gt;
                                  &lt;sx:onRecord&gt;
                                    &lt;sx:elementMap element="{record-type}"&gt;
                                      &lt;sx:fieldAttributeMap field="value" attribute="attr1"/&gt;
                                    &lt;/sx:elementMap&gt;
                                  &lt;/sx:onRecord&gt;
                                &lt;/sx:elementMap&gt;
                              &lt;/sx:innerGroup&gt;
                            &lt;/sx:groupChoice&gt;
                          &lt;/sx:elementMap&gt;
                        &lt;/sx:innerGroup&gt;
                      &lt;/sx:groupChoice&gt;
                    &lt;/agent&gt;
                  &lt;/sx:outerGroup&gt;
                &lt;/agents&gt;
              &lt;/sx:outerGroup&gt;
            &lt;/period&gt;
          &lt;/sx:outerGroup&gt;
        &lt;/periods&gt;
      &lt;/sx:outerGroup&gt;
    &lt;/hot&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-hot2.xml -i data/hot.txt -o output/hot2.xml hot2

        </pre><p>
      </p>
    </div>

    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="variable-field-widths"></a>Converting a positional flat file with variable field widths to
  XML</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1205"></a>
      <p>
The example below shows how to convert a
flat file with variable field widths to XML.
      </p>
      <p>
The input file is a positional flat file.
      </p>
      <div class="figure"><a name="testWidth.txt"></a><p class="title"><b>Figure&nbsp;80.&nbsp;Input flat file testWidth.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
TX#00000000010016This is a remarkXXXXXXXXXX
TX#0000000002              
TX#0000000003    YYYYYYYYYY
TX#00000000030004TestZZZZZZZZZZ

        </pre>
      </div></div><br class="figure-break">
      <p>
    This file contains an optional positional field called "remarksText".
    The field size varies and when the field exists it's width is specified
    using the value of its preceding field called "remarksSize". When no
    "remarksText" exists, 4 space characters
    are specified as "remarksSize" in the file directly followed by the value of
    "followingField".
      </p>
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="testWidth.xml"></a><p class="title"><b>Figure&nbsp;81.&nbsp;Output XML file testWidth.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;Doc&gt;
  &lt;Transaction&gt;
    &lt;Reference&gt;0000000001&lt;/Reference&gt;
    &lt;Remarks&gt;This is a remark&lt;/Remarks&gt;
    &lt;FollowingField&gt;XXXXXXXXXX&lt;/FollowingField&gt;
  &lt;/Transaction&gt;
  &lt;Transaction&gt;
    &lt;Reference&gt;0000000002&lt;/Reference&gt;
    &lt;Remarks/&gt;
    &lt;FollowingField/&gt;
  &lt;/Transaction&gt;
  &lt;Transaction&gt;
    &lt;Reference&gt;0000000003&lt;/Reference&gt;
    &lt;Remarks/&gt;
    &lt;FollowingField&gt;YYYYYYYYYY&lt;/FollowingField&gt;
  &lt;/Transaction&gt;
  &lt;Transaction&gt;
    &lt;Reference&gt;0000000003&lt;/Reference&gt;
    &lt;Remarks&gt;Test&lt;/Remarks&gt;
    &lt;FollowingField&gt;ZZZZZZZZZZ&lt;/FollowingField&gt;
  &lt;/Transaction&gt;
&lt;/Doc&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-testWidth.xml"></a><p class="title"><b>Figure&nbsp;82.&nbsp;Resources script resources-testWidth.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="testWidth"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="data"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="data"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile ref="flatFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="segmentsToXml"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="flatFile"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:positionalField name="tag" width="3"/&gt;
        &lt;sx:when test="tag='TX#'"&gt;
          &lt;sx:flatRecordType name="transaction"&gt;
            &lt;sx:positionalField name="recordType" width="3"/&gt;
            &lt;sx:positionalField name="reference" width="10"/&gt;
            &lt;sx:positionalField name="remarksSize" width="4"&gt;
              &lt;sx:defaultValue value="0"/&gt;
            &lt;/sx:positionalField&gt;
            &lt;sx:positionalField name="remarksText" width="{remarksSize}"/&gt;
            &lt;sx:positionalField name="followingField" width="10"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="segmentsToXml"&gt;
    &lt;Doc&gt;
      &lt;sx:innerGroup startTest="sx:current/transaction"&gt;
        &lt;Transaction&gt;
          &lt;sx:fieldElementMap field="reference"  element="Reference"/&gt;
          &lt;sx:fieldElementMap field="remarksText" element="Remarks"/&gt;
          &lt;sx:fieldElementMap field="followingField" element="FollowingField"/&gt;
        &lt;/Transaction&gt;
      &lt;/sx:innerGroup&gt;
    &lt;/Doc&gt;
  &lt;/sx:recordMapping&gt;
&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
Note the following.
        </p><div class="itemizedlist"><ul type="disc"><li>When the "remarksSize" is not specified as shown in row
2 and 3 of the flat file, the value for {remarksSize} must default to
            <code class="code">0</code>
. The "remarksSize" positional field definition therefore
  contains a
            <a class="link" href="../guide/index.html#sx:defaultValue" target="_top">sx:defaultValue</a>
element, which supplies the default.
          </li></ul></div><p>
      </p>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-testWidth.xml -i testWidth.txt -o output/testWidth.xml testWidth

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="repeat-header-info-eg"></a>Repeat Header Information in the XML</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1233"></a>
      <a class="indexterm" name="d4e1236"></a>
      <p>
The example below shows how to convert a
flat file to XML with header information repeated when processing the other
records.
      </p>
      <p>
The record input is
      </p>
      <div class="figure"><a name="repeated-header-info.txt"></a><p class="title"><b>Figure&nbsp;83.&nbsp;Record Input</b></p><div class="figure-contents">
        
        <pre class="programlisting">
         
1A
2B
3C
2D
3E

        </pre>
      </div></div><br class="figure-break">
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="repeated_header_info.xml"></a><p class="title"><b>Figure&nbsp;84.&nbsp;Output XML file repeated_header_info.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;doc&gt;
  &lt;b attr="B"&gt;
    &lt;c attr="C"&gt;A&lt;/c&gt;
  &lt;/b&gt;
  &lt;b attr="D"&gt;
    &lt;c attr="E"&gt;A&lt;/c&gt;
  &lt;/b&gt;
&lt;/doc&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-repeatHeader.xml"></a><p class="title"><b>Figure&nbsp;85.&nbsp;Resources script resources-repeatHeader.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="hut"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="HutContent"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="HutContent"&gt;
    &lt;sx:flatFileReader ref="HutFlatFileReader"/&gt;
    &lt;sx:recordMapping ref="hut2ToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="HutFlatFile"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:positionalField name="record-type" start="1" width="1"/&gt;
        &lt;sx:when test='record-type="1"'&gt;
          &lt;sx:flatRecordType id="R1" name="R1"&gt;
            &lt;sx:positionalField name="TOTO" start="2" width="1"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test='record-type="2"'&gt;
          &lt;sx:flatRecordType id="R2" name="R2"&gt;
            &lt;sx:positionalField name="TATA" start="2" width="1"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test='record-type="3"'&gt;
          &lt;sx:flatRecordType id="R3" name="R3"&gt;
            &lt;sx:positionalField name="TITI" start="2" width="1"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatFileReader id="HutFlatFileReader"&gt;
    &lt;sx:inlineSource&gt;1A
2B
3C
2D
3E&lt;/sx:inlineSource&gt;
    &lt;sx:flatFile ref="HutFlatFile"/&gt;
  &lt;/sx:flatFileReader&gt;

  &lt;sx:recordMapping id="hut2ToXmlMapping"&gt;
    &lt;doc&gt;
      &lt;sx:parameter name="temp" value="{TOTO}"/&gt;
      &lt;sx:outerGroup startTest="sx:current/R2"&gt;
        &lt;b&gt;
          &lt;sx:fieldAttributeMap value="{TATA}" attribute="attr"/&gt;
          &lt;sx:onRecord recordType="R3"&gt;
            &lt;sx:fieldElementMap value="{$temp}" element="c"&gt;
              &lt;sx:fieldAttributeMap value="{TITI}" attribute="attr"/&gt;
            &lt;/sx:fieldElementMap&gt;
          &lt;/sx:onRecord&gt;
        &lt;/b&gt;
      &lt;/sx:outerGroup&gt;
    &lt;/doc&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>Note the parameter declaration for "temp" in the record mapping 
        section.  This parameter declaration occurs immediately below the 
        document element, which represents a grouping of all records.  Within a
        group, <code class="code">ServingXML</code> ServingXML binds the parameter name to 
        the record that begins the grouping section, in this case the first 
        header record in the input.
      </p>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-repeatheader.xml -o output/repeated_header_info.xml hut 

        </pre><p>
      </p>
    </div>
  </div>
  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e1256"></a>Fixed Width Fields, Multiple Record Types, Repeating Groups, Line Delimited</h3></div></div></div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e1258"></a>Converting fixed position records with repeating groups to XML (segments)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1261"></a>
      <p>
This shows how to convert fixed position records that contain repeatable/optional fixed parts identified by tags.
      </p>
      <p>
The input file is a positional file.
      </p>
      <div class="figure"><a name="segments.txt"></a><p class="title"><b>Figure&nbsp;86.&nbsp;Input flat file segments.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
Z01xxxyyyZ02aaaabbccZ02aaaabbccZ01xxxyyy

        </pre>
      </div></div><br class="figure-break">
      <p>
Note the following:
        </p><div class="itemizedlist"><ul type="disc"><li>
The whole record is positional, but contains "segments" that do not have a terminator but a starting tag and a fixed length.
          </li><li>
Z01 and Z02 are "segment"-tags and a,b,x and y are positional fields within the "segment"
          </li></ul></div><p>
      </p>
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="segments.xml"></a><p class="title"><b>Figure&nbsp;87.&nbsp;Output XML file segments.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;Recs&gt;
  &lt;Rec&gt;
    &lt;Z01&gt;
      &lt;xxx&gt;xxx&lt;/xxx&gt;
      &lt;yyy&gt;yyy&lt;/yyy&gt;
    &lt;/Z01&gt;
    &lt;Z02&gt;
      &lt;aaaa&gt;aaaa&lt;/aaaa&gt;
      &lt;bb&gt;bb&lt;/bb&gt;
      &lt;cc&gt;cc&lt;/cc&gt;
    &lt;/Z02&gt;
    &lt;Z02&gt;
      &lt;aaaa&gt;aaaa&lt;/aaaa&gt;
      &lt;bb&gt;bb&lt;/bb&gt;
      &lt;cc&gt;cc&lt;/cc&gt;
    &lt;/Z02&gt;
    &lt;Z01&gt;
      &lt;xxx&gt;xxx&lt;/xxx&gt;
      &lt;yyy&gt;yyy&lt;/yyy&gt;
    &lt;/Z01&gt;
  &lt;/Rec&gt;
&lt;/Recs&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-segments.xml"></a><p class="title"><b>Figure&nbsp;88.&nbsp;Resources script resources-segments.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="segments"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="data"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="data"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:urlSource url="data/segments.txt"/&gt;
      &lt;sx:flatFile ref="flatFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="segmentsToXml"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="flatFile"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType name="rec"&gt;
        &lt;sx:repeatingGroup name="segments"&gt;
          &lt;sx:flatRecordTypeChoice&gt;
            &lt;sx:positionalField name="tag" width="3"/&gt;
            &lt;sx:when test="tag='Z01'"&gt;
              &lt;sx:flatRecordType name="Z01"&gt;
                &lt;sx:positionalField name="tag" width="3"/&gt;
                &lt;sx:positionalField name="xxx" width="3"/&gt;
                &lt;sx:positionalField name="yyy" width="3"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:when&gt;
            &lt;sx:otherwise&gt;
              &lt;sx:flatRecordType name="Z02"&gt;
                &lt;sx:positionalField name="tag" width="3"/&gt;
                &lt;sx:positionalField name="aaaa" width="4"/&gt;
                &lt;sx:positionalField name="bb" width="2"/&gt;
                &lt;sx:positionalField name="cc" width="2"/&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:otherwise&gt;
          &lt;/sx:flatRecordTypeChoice&gt;
        &lt;/sx:repeatingGroup&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="segmentsToXml"&gt;
    &lt;Recs&gt;
      &lt;sx:onRecord&gt;
        &lt;Rec&gt;
          &lt;sx:subrecordMapping repeatingGroup="segments"&gt;
            &lt;sx:onRecord recordType="Z01"&gt;
              &lt;Z01&gt;
                &lt;sx:fieldElementMap field="xxx" element="xxx"/&gt;
                &lt;sx:fieldElementMap field="yyy"  element="yyy"/&gt;
              &lt;/Z01&gt;
            &lt;/sx:onRecord&gt;
            &lt;sx:onRecord recordType="Z02"&gt;
              &lt;Z02&gt;
                &lt;sx:fieldElementMap field="aaaa" element="aaaa"/&gt;
                &lt;sx:fieldElementMap field="bb" element="bb"/&gt;
                &lt;sx:fieldElementMap field="cc" element="cc"/&gt;
              &lt;/Z02&gt;
            &lt;/sx:onRecord&gt;
          &lt;/sx:subrecordMapping&gt;
        &lt;/Rec&gt;
      &lt;/sx:onRecord&gt;
    &lt;/Recs&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -o output/segments.xml -r resources-segments.xml 
    segments 

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e1282"></a>Mapping multiple repeating groups to XML (students-fix)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1285"></a>
      <p>
Suppose you have the following positional file of students, their course grades, and their addresses.
      </p>
      <div class="figure"><a name="students-fix.txt"></a><p class="title"><b>Figure&nbsp;89.&nbsp;Input flat file students-fix.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
JANEENGLC-MATHA+1972BLUECHICAGOILATLANTAGA

        </pre>
      </div></div><br class="figure-break">
      <p>
The file has the following layout.
      </p>
      <table colsep="0">
        <tr>
          <td>name</td>
          <td>4 characters</td>
        </tr>
        <tr>
          <td>subject-grade</td>
          <td>repeating group, repeats twice</td>
        </tr>
        <tr>
          <td>year-born</td>
          <td>4 characters</td>
        </tr>
        <tr>
          <td>favorite-color</td>
          <td>4 characters</td>
        </tr>
        <tr>
          <td>address</td>
          <td>repeating group, repeats twice</td>
        </tr>
      </table>
      <p>
You want the XML output to look as follows.
      </p>
      <div class="figure"><a name="students-fix.xml"></a><p class="title"><b>Figure&nbsp;90.&nbsp;Output XML file students-fix.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;StudentGrades&gt;
  &lt;StudentGrade&gt;
    &lt;Name&gt;JANE&lt;/Name&gt;
    &lt;SubjectGrade&gt;
      &lt;Subject&gt;ENGL&lt;/Subject&gt;
      &lt;Grade&gt;C-&lt;/Grade&gt;
    &lt;/SubjectGrade&gt;
    &lt;SubjectGrade&gt;
      &lt;Subject&gt;MATH&lt;/Subject&gt;
      &lt;Grade&gt;A+&lt;/Grade&gt;
    &lt;/SubjectGrade&gt;
    &lt;YearBorn&gt;1972&lt;/YearBorn&gt;
    &lt;FavoriteColor&gt;BLUE&lt;/FavoriteColor&gt;
    &lt;Address&gt;
      &lt;City&gt;CHICAGO&lt;/City&gt;
      &lt;State&gt;IL&lt;/State&gt;
    &lt;/Address&gt;
    &lt;Address&gt;
      &lt;City&gt;ATLANTA&lt;/City&gt;
      &lt;State&gt;GA&lt;/State&gt;
    &lt;/Address&gt;
  &lt;/StudentGrade&gt;
&lt;/StudentGrades&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>The required resources script is
      </p>
      <div class="figure"><a name="resources-students-fix.xml"></a><p class="title"><b>Figure&nbsp;91.&nbsp;Resources script resources-students-fix.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="students"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="students-content"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="students-content"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile ref="students-file"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="students-mapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="students-file"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType name="student"&gt;
        &lt;sx:positionalField name="name" width="4"/&gt;
        &lt;sx:repeatingGroup name="grades" count="2"&gt;
          &lt;sx:flatRecordType name="subject-grade"&gt;
            &lt;sx:positionalField name="subject" width="4"/&gt;
            &lt;sx:positionalField name="grade" width="2"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:repeatingGroup&gt;
        &lt;sx:positionalField name="year-born" width="4"/&gt;
        &lt;sx:positionalField name="favorite-color" width="4"/&gt;
        &lt;sx:repeatingGroup name="addresses" count="2"&gt;
          &lt;sx:flatRecordType name="address"&gt;
            &lt;sx:positionalField name="city" width="7"/&gt;
            &lt;sx:positionalField name="state" width="2"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:repeatingGroup&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="students-mapping"&gt;
    &lt;StudentGrades&gt;
      &lt;sx:onRecord&gt;
        &lt;StudentGrade&gt;
          &lt;sx:fieldElementMap field="name" element="Name"/&gt;
          &lt;sx:subrecordMapping repeatingGroup="grades"&gt;
            &lt;sx:onRecord&gt;
              &lt;SubjectGrade&gt;
                &lt;sx:fieldElementMap field="subject" element="Subject"/&gt;
                &lt;sx:fieldElementMap field="grade" element="Grade"/&gt;
              &lt;/SubjectGrade&gt;
            &lt;/sx:onRecord&gt;
          &lt;/sx:subrecordMapping&gt;
          &lt;sx:fieldElementMap field="year-born" element="YearBorn"/&gt;
          &lt;sx:fieldElementMap field="favorite-color" element="FavoriteColor"/&gt;
          &lt;sx:subrecordMapping repeatingGroup="addresses"&gt;
            &lt;sx:onRecord&gt;
              &lt;Address&gt;
                &lt;sx:fieldElementMap field="city" element="City"/&gt;
                &lt;sx:fieldElementMap field="state" element="State"/&gt;
              &lt;/Address&gt;
            &lt;/sx:onRecord&gt;
          &lt;/sx:subrecordMapping&gt;
        &lt;/StudentGrade&gt;
      &lt;/sx:onRecord&gt;
    &lt;/StudentGrades&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml  -r resources-students-fix.xml -i data/students-fix.txt -o output/students-fix.xml 
    students

        </pre><p>
      </p>
    </div>

  </div>

  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e1319"></a>Fixed Width Fields, Single Record Type, No End-of-Line Delimiters</h3></div></div></div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="non_delimited_book_orders"></a>Converting a flat file with a single record type, but no end-of-line delimiters, to XML (non-delimited book orders)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1324"></a>
      <a class="indexterm" name="d4e1327"></a>
      <p>
The example below shows how to convert a
flat file with a single record format, but no end-of-line delimiters, to XML.
      </p>
      <p>
The input file is a fixed field width flat file.
      </p>
      <div class="figure"><a name="non_delimited_book_orders.txt"></a><p class="title"><b>Figure&nbsp;92.&nbsp;Input flat file non_delimited_book_orders.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
CAuthor                        Title                              Price InvoiceNo InvoiceDate       FCharles Bukowski              Factotum                           22.95 001  12/Mar/2005            FSergei Lukyanenko             The Night Watch                    17.99 002  13/Mar/2005            FAndrew Crumey                 Mr Mee                             22.00 003 14/June/2005            CSteven John Metsker           Building Parsers with Java         39.95 004 15/June/2005            This is a trailer record                                                                            

        </pre>
      </div></div><br class="figure-break">
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="non_delimited_book_orders.xml"></a><p class="title"><b>Figure&nbsp;93.&nbsp;Output XML file book_orders.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;book-orders&gt;
  &lt;book-type&gt;
    &lt;category&gt;F&lt;/category&gt;
    &lt;author&gt;Charles Bukowski&lt;/author&gt;
    &lt;title&gt;Factotum&lt;/title&gt;
    &lt;price&gt;22.95&lt;/price&gt;
    &lt;invoiceno&gt;001&lt;/invoiceno&gt;
    &lt;invoicedate&gt;12/Mar/2005&lt;/invoicedate&gt;
    &lt;filler/&gt;
  &lt;/book-type&gt;
  &lt;book-type&gt;
    &lt;category&gt;F&lt;/category&gt;
    &lt;author&gt;Sergei Lukyanenko&lt;/author&gt;
    &lt;title&gt;The Night Watch&lt;/title&gt;
    &lt;price&gt;17.99&lt;/price&gt;
    &lt;invoiceno&gt;002&lt;/invoiceno&gt;
    &lt;invoicedate&gt;13/Mar/2005&lt;/invoicedate&gt;
    &lt;filler/&gt;
  &lt;/book-type&gt;
  &lt;book-type&gt;
    &lt;category&gt;F&lt;/category&gt;
    &lt;author&gt;Andrew Crumey&lt;/author&gt;
    &lt;title&gt;Mr Mee&lt;/title&gt;
    &lt;price&gt;22.00&lt;/price&gt;
    &lt;invoiceno&gt;003&lt;/invoiceno&gt;
    &lt;invoicedate&gt;14/June/2005&lt;/invoicedate&gt;
    &lt;filler/&gt;
  &lt;/book-type&gt;
  &lt;book-type&gt;
    &lt;category&gt;C&lt;/category&gt;
    &lt;author&gt;Steven John Metsker&lt;/author&gt;
    &lt;title&gt;Building Parsers with Java&lt;/title&gt;
    &lt;price&gt;39.95&lt;/price&gt;
    &lt;invoiceno&gt;004&lt;/invoiceno&gt;
    &lt;invoicedate&gt;15/June/2005&lt;/invoicedate&gt;
    &lt;filler/&gt;
  &lt;/book-type&gt;
&lt;/book-orders&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-non_delimited_book_orders.xml"></a><p class="title"><b>Figure&nbsp;94.&nbsp;Resources script resources-non_delimited_book_orders.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;
   
  &lt;sx:service id="book-orders"&gt; 
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="book-orders"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="book-orders" name="book-orders"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile ref="books-flatfile"/&gt;
    &lt;/sx:flatFileReader&gt;
  &lt;/sx:recordContent&gt;
  
  &lt;sx:flatFile id="books-flatfile" lineDelimited="false"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="book-type"/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="book-type"/&gt;
    &lt;/sx:flatFileBody&gt;
    &lt;sx:flatFileTrailer&gt;
      &lt;sx:annotationRecord width="100"&gt;This is a trailer record&lt;/sx:annotationRecord&gt;
    &lt;/sx:flatFileTrailer&gt;
  &lt;/sx:flatFile&gt;      

  &lt;sx:flatRecordType id="book-type" name="book-type"&gt;
    &lt;sx:positionalField name="category" width="1"/&gt;
    &lt;sx:positionalField name="author" width="30"/&gt;
    &lt;sx:positionalField name="title" width="30"/&gt;
    &lt;sx:positionalField name="price" width="10" justify="right"/&gt;
    &lt;sx:positionalField name="invoiceno" width="4" justify="right"/&gt;
    &lt;sx:positionalField name="invoicedate" width="13" justify="right"/&gt;
    &lt;sx:positionalField name="filler" width="12"/&gt;
  &lt;/sx:flatRecordType&gt;
  
&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
Note the following points.
        </p><div class="itemizedlist"><ul type="disc"><li>
The
            <a class="link" href="../guide/index.html#sx:recordContent" target="_top">sx:recordContent</a>
element has a
            <code class="sgmltag-attribute">lineDelimited</code>
attribute set to
            <code class="code">false</code>
.
          </li></ul></div><p>
      </p>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-non_delimited_book_orders.xml 
  -i data/non_delimited_book_orders.txt
  -o output/book_orders.xml  book-orders

        </pre><p>
      </p>
    </div>
  </div>

  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e1351"></a>Fixed Width Fields, Multiple Record Types, No End-of-Line Delimiters</h3></div></div></div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="non_delimited_variant_trades"></a>Converting a flat file with multiple record formats, but no end-of-line delimiters, to XML (non-delimited trades)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1356"></a>
      <a class="indexterm" name="d4e1359"></a>
      <p>
The example below shows how to convert a
flat file with multiple record formats, but no end-of-line delimiters, to XML.
      </p>
      <p>
The input file is a fixed field width flat file.
      </p>
      <div class="figure"><a name="non_delimited_variant_trades.txt"></a><p class="title"><b>Figure&nbsp;95.&nbsp;Input flat file non_delimited_variant_trades.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
TR000103/25/2005 1:50:00This is a trade record        TN0002X1234A child transaction           TN0003X1235Another child transaction    

        </pre>
      </div></div><br class="figure-break">
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="non_delimited_variant_trades.xml"></a><p class="title"><b>Figure&nbsp;96.&nbsp;Output XML file trades.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;trades&gt;
  &lt;trade id="0001"&gt;
    &lt;trade-date&gt;2005-03-25T01:50:00.000-05:00&lt;/trade-date&gt;
    &lt;description&gt;This is a trade record&lt;/description&gt;
  &lt;/trade&gt;
  &lt;transaction id="0002"&gt;
    &lt;reference&gt;X1234&lt;/reference&gt;
    &lt;description&gt;A child transaction&lt;/description&gt;
  &lt;/transaction&gt;
  &lt;transaction id="0003"&gt;
    &lt;reference&gt;X1235&lt;/reference&gt;
    &lt;description&gt;Another child transaction&lt;/description&gt;
  &lt;/transaction&gt;
&lt;/trades&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-non_delimited_variant_trades.xml"></a><p class="title"><b>Figure&nbsp;97.&nbsp;Resources script resources-non_delimited_variant_trades.xm</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="trades"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="trades"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="trades"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:urlSource url="data/non_delimited_variant_trades.txt"/&gt;
      &lt;sx:flatFile ref="trades-flatfile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="trades-xml-mapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="trades-flatfile" name="trades" lineDelimited="false"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:positionalField name="record_type" width="2"/&gt;
        &lt;sx:when test="record_type='TR'"&gt;
          &lt;sx:flatRecordType name="trade"&gt;
            &lt;sx:positionalField name="record_type" width="2"/&gt;
            &lt;sx:positionalField name="id" width="4"/&gt;
            &lt;sx:positionalField name="trade_date" width="10"/&gt;
            &lt;sx:positionalField name="trade_time" width="8"/&gt;
            &lt;sx:positionalField name="description" width="30"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="record_type='TN'"&gt;
          &lt;sx:flatRecordType name="transaction"&gt;
            &lt;sx:positionalField name="record_type" width="2"/&gt;
            &lt;sx:positionalField name="id" width="4"/&gt;
            &lt;sx:positionalField name="reference" width="5"/&gt;
            &lt;sx:positionalField name="description" width="30"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="trades-xml-mapping"&gt;
    &lt;trades&gt;
      &lt;sx:onRecord recordType="trade"&gt;
        &lt;trade&gt;
          &lt;sx:fieldAttributeMap field="id" attribute="id"/&gt;
          &lt;sx:elementMap element="trade-date"&gt;
            &lt;sx:convertToDateTime format="MM/dd/yyyy H:mm:ss"&gt;
              &lt;sx:concat separator=" "&gt;
                &lt;sx:toString value="{trade_date}"/&gt;
                &lt;sx:toString value="{trade_time}"/&gt;
              &lt;/sx:concat&gt;
            &lt;/sx:convertToDateTime&gt;
          &lt;/sx:elementMap&gt;
          &lt;sx:fieldElementMap field="description" element="description"/&gt;
        &lt;/trade&gt;
      &lt;/sx:onRecord&gt;
      &lt;sx:onRecord recordType="transaction"&gt;
        &lt;transaction&gt;
          &lt;sx:fieldAttributeMap field="id" attribute="id"/&gt;
          &lt;sx:fieldElementMap field="reference" element="reference"/&gt;
          &lt;sx:fieldElementMap field="description" element="description"/&gt;
        &lt;/transaction&gt;
      &lt;/sx:onRecord&gt;
    &lt;/trades&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
Note the following points.
        </p><div class="itemizedlist"><ul type="disc"><li>
The
            <a class="link" href="../guide/index.html#sx:recordContent" target="_top">sx:recordContent</a>
element has a
            <code class="sgmltag-attribute">lineDelimited</code>
attribute set to
            <code class="code">false</code>
.
          </li></ul></div><p>
      </p>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-non_delimited_variant_trades.xml 
  -o output/trades.xml trades 

        </pre><p>
      </p>
    </div>

    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="special-char-eg"></a>Converting a flat file with special characters to XML (special char)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1386"></a>
      <a class="indexterm" name="d4e1388"></a>
      <p>
The example below shows how to convert a
flat file with special characters to XML.
      </p>
      <p>
The input file is a flat file with two adjacent records (no line delimiters):
        </p><div class="itemizedlist"><ul type="disc"><li>
            <p>A record beginning with the hexadecimal value 03, followed by the text "1111111"
            </p>
          </li><li>
            <p>A record beginning with the hexadecimal value 04, followed by the text "John Smith"
            </p>
          </li></ul></div><p>
The two hexadecimal values are needed to differentiate the record type, but these valued cannot be written as
        &amp;#x03; and&amp;#x04; in XML, as these are not valid XML characters.
      </p>

      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="specialChar.xml"></a><p class="title"><b>Figure&nbsp;98.&nbsp;Output XML file specialChar.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;transaction&gt;
  &lt;R03&gt;
    &lt;firstField&gt;03&lt;/firstField&gt;
    &lt;CLIENUM&gt;1111111&lt;/CLIENUM&gt;
  &lt;/R03&gt;
  &lt;R04&gt;
    &lt;firstField&gt;04&lt;/firstField&gt;
    &lt;NAME&gt;John Smith&lt;/NAME&gt;
  &lt;/R04&gt;
&lt;/transaction&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-specialChar.xml"></a><p class="title"><b>Figure&nbsp;99.&nbsp;Resources script resources-specialChar.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="transaction"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="transactionDoc"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="transactionDoc" name="transaction"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile ref="transactionFile"/&gt;
    &lt;/sx:flatFileReader&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="transactionFile" lineDelimited="false"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:binaryField name="firstField" width="1"/&gt;
        &lt;sx:when test="firstField='03'"&gt;
          &lt;sx:flatRecordType id="R03" name="R03"&gt;
            &lt;sx:binaryField name="firstField" label="firstField" width="1" /&gt;
            &lt;sx:positionalField name="CLIENUM" label="CLIENUM" width="007" /&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="firstField='04'"&gt;
          &lt;sx:flatRecordType id="R04" name="R04"&gt;
            &lt;sx:binaryField name="firstField" label="firstField" width="1" /&gt;
            &lt;sx:positionalField name="NAME" label="NAME" width="020" /&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;
&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
Note that the first field of each record is declared as an
        <a class="link" href="../guide/index.html#sx:binaryField" target="_top">sx:binaryField</a>
.
The string rendering of this field is as an hexidecimal value.
      </p>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml  -r resources-specialChar.xml -i data/specialChar.txt 
  -o output/specialChar.xml transaction

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="packed-decimal-to-xml"></a>Converting a flat file containing Cobol packed decimal data to XML (packed decimal to XML)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1413"></a>
      <p>
The example below shows how to convert a
non-delimited flat file containing Cobol packed decimal data to XML.
      </p>
      <p>
The input file, shown below, is encoded in ebcdic, except for the price field,
which is expressed as a Cobol packed decimal number
        <code class="code">99999999.99</code>
.
      </p>
      <div class="figure"><a name="books-positional.txt"></a><p class="title"><b>Figure&nbsp;100.&nbsp;Input positional flat file books.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
CAuthor                        Title                              Price

FCharles Bukowski              Factotum                           22.95
FSergei Lukyanenko             The Night Watch                    17.99
FAndrew Crumey                 Mr Mee                             22.00
CSteven John Metsker           Building Parsers with Java         39.95

This is a trailer record

        </pre>
      </div></div><br class="figure-break">

      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="books.xml"></a><p class="title"><b>Figure&nbsp;101.&nbsp;Output XML file books.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;myns:books xmlns:myns="http://mycompany.com/mynames/" 
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
  xsi:schemaLocation="url2"&gt;
  &lt;myns:book categoryCode="F"&gt;
    &lt;myns:title&gt;Factotum&lt;/myns:title&gt;
    &lt;myns:author&gt;Charles Bukowski&lt;/myns:author&gt;
    &lt;myns:price&gt;22.95&lt;/myns:price&gt;
  &lt;/myns:book&gt;
  &lt;myns:book categoryCode="F"&gt;
    &lt;myns:title&gt;The Night Watch&lt;/myns:title&gt;
    &lt;myns:author&gt;Sergei Lukyanenko&lt;/myns:author&gt;
    &lt;myns:price&gt;17.99&lt;/myns:price&gt;
  &lt;/myns:book&gt;
  &lt;myns:book categoryCode="F"&gt;
    &lt;myns:title&gt;Mr Mee&lt;/myns:title&gt;
    &lt;myns:author&gt;Andrew Crumey&lt;/myns:author&gt;
    &lt;myns:price&gt;22.00&lt;/myns:price&gt;
  &lt;/myns:book&gt;
  &lt;myns:book categoryCode="C"&gt;
    &lt;myns:title&gt;Building Parsers with Java&lt;/myns:title&gt;
    &lt;myns:author&gt;Steven John Metsker&lt;/myns:author&gt;
    &lt;myns:price&gt;39.95&lt;/myns:price&gt;
  &lt;/myns:book&gt;
&lt;/myns:books&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-books_ebcdic_packed.xml"></a><p class="title"><b>Figure&nbsp;102.&nbsp;Resources script resources-books_ebcdic_packed.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="books-ebcdic-packed2xml"&gt; 
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="books"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;
  
  &lt;!--
  This sx:flatFileReader element does not specify a stream source, so 
  the source will default to the file specified with the -i option on the command line.
  --&gt;
  &lt;sx:recordContent id="books"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile ref="booksFile"/&gt;
      &lt;sx:defaultStreamSource encoding="Cp1047"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="booksToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="booksFile" lineDelimited="false"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="bookType"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;      

  &lt;sx:flatRecordType id="bookType" name="bookType"&gt;
    &lt;sx:positionalField name="category" label="Category" width="1"/&gt;
    &lt;sx:positionalField name="author" label="Author" width="30"/&gt;
    &lt;sx:positionalField name="title" label="Title" width="30"/&gt;
    &lt;sx:packedDecimalField name="price" label="Price" digitCount="10" decimalPlaces="2"/&gt;
  &lt;/sx:flatRecordType&gt;
  
  &lt;sx:recordMapping id="booksToXmlMapping"&gt;
    &lt;myns:books xmlns:myns="http://mycompany.com/mynames/" 
                     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                     xsi:schemaLocation="url2"&gt;
      &lt;sx:onRecord&gt;
        &lt;myns:book&gt;
          &lt;sx:fieldAttributeMap field="category" attribute="categoryCode"/&gt;
          &lt;sx:fieldElementMap field="title" element="myns:title"/&gt;  
          &lt;sx:fieldElementMap field="author" element="myns:author"/&gt;
          &lt;sx:fieldElementMap field="price" element="myns:price"/&gt;
        &lt;/myns:book&gt;  
      &lt;/sx:onRecord&gt;
    &lt;/myns:books&gt;
  &lt;/sx:recordMapping&gt;  
  
&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
Note that the last field of each record is declared as an
        <a class="link" href="../guide/index.html#sx:packedDecimalField" target="_top">sx:packedDecimalField</a>
.
      </p>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml  -r resources-books_ebcdic_packed.xml 
  -i data/books_ebcdic_packed.dat 
  -o  output/books.xml    books-ebcdic-packed2xml

        </pre><p>
      </p>
    </div>
  </div>

  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e1434"></a>Logical Record Consists of Multiple Physical Records</h3></div></div></div>
    

    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="smf"></a>Converting a System Management Facilities (SMF) file to XML (Segment Concatenation)
      </h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1439"></a>
      <a class="indexterm" name="d4e1442"></a>
      <a class="indexterm" name="d4e1445"></a>
      <p>
The example below shows how to convert a System 
Management Facilities (SMF) file to XML.  The example includes support for 
variable
        block spanned (VBS) records. The format of an SMF file is described in
        <a class="ulink" href="http://publib.boulder.ibm.com/infocenter/zos/v1r9/index.jsp?topic=/com.ibm.zos.r9.ieag200/smfhdr.htm" target="_top">SMF records</a>.
      </p>

      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="smf.xml"></a><p class="title"><b>Figure&nbsp;103.&nbsp;Output XML file smf.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;smf&gt;
   &lt;smfRecord&gt;
      &lt;systemIndicator&gt;1E&lt;/systemIndicator&gt;
      &lt;type&gt;2&lt;/type&gt;
   &lt;/smfRecord&gt;
   &lt;smfRecord&gt;
      &lt;systemIndicator&gt;DE&lt;/systemIndicator&gt;
      &lt;type&gt;110&lt;/type&gt;
   &lt;/smfRecord&gt;
   &lt;smfRecord&gt;
      &lt;systemIndicator&gt;1E&lt;/systemIndicator&gt;
      &lt;type&gt;64&lt;/type&gt;
      &lt;jobName&gt;SMF&lt;/jobName&gt;
   &lt;/smfRecord&gt;
   &lt;smfRecord&gt;
      &lt;systemIndicator&gt;5E&lt;/systemIndicator&gt;
      &lt;type&gt;42&lt;/type&gt;
      &lt;subType&gt;6&lt;/subType&gt;
   &lt;/smfRecord&gt;
   &lt;smfRecord&gt;
      &lt;systemIndicator&gt;1E&lt;/systemIndicator&gt;
      &lt;type&gt;64&lt;/type&gt;
      &lt;jobName&gt;GPL1&lt;/jobName&gt;
   &lt;/smfRecord&gt;
   &lt;smfRecord&gt;
      &lt;systemIndicator&gt;1E&lt;/systemIndicator&gt;
      &lt;type&gt;64&lt;/type&gt;
      &lt;jobName&gt;GPL1&lt;/jobName&gt;
   &lt;/smfRecord&gt;
   &lt;smfRecord&gt;
      &lt;systemIndicator&gt;1E&lt;/systemIndicator&gt;
      &lt;type&gt;64&lt;/type&gt;
      &lt;jobName&gt;GPL1&lt;/jobName&gt;
   &lt;/smfRecord&gt;
   &lt;smfRecord&gt;
      &lt;systemIndicator&gt;1E&lt;/systemIndicator&gt;
      &lt;type&gt;3&lt;/type&gt;
   &lt;/smfRecord&gt;
&lt;/smf&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-smf.xml"></a><p class="title"><b>Figure&nbsp;104.&nbsp;Resources script resources-smf.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:xs="http://www.w3.org/2001/XMLSchema"
              xmlns:fn="http://www.w3.org/2005/xpath-functions"&gt;

  &lt;sx:service id="smf-xml"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:xsltSerializer&gt;
        &lt;sx:outputProperty name="indent" value="yes"/&gt;
      &lt;/sx:xsltSerializer&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="smf"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="smf"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:flatFile ref="smfFile"/&gt;
        &lt;sx:defaultStreamSource encoding="Cp1047"/&gt;
      &lt;/sx:flatFileReader&gt;
    &lt;/sx:recordStream&gt;
    &lt;sx:recordMapping ref="smfToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="smfFile" lineDelimited="false" countPositionsInBytes="true"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="smfType"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:vbsFlatRecordType id="smfType"&gt;
    &lt;sx:integerField name="recordLength" width="2"/&gt;
    &lt;sx:integerField name="segmentControlCode" width="1"/&gt;
    &lt;sx:integerField name="reserved" width="1"/&gt;
    &lt;sx:mergePhysicalSegments startTest = "number(sx:current//segmentControlCode) = 0 
                                          or number(sx:current//segmentControlCode) = 1"
                             segmentLength="{recordLength}"&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:integerField name="recordLength" width="2"/&gt;
        &lt;sx:integerField name="segmentControlCode" width="1"/&gt;
        &lt;sx:integerField name="reserved" width="1"/&gt;
        &lt;sx:binaryField name="systemIndicator" width="1"/&gt;
        &lt;sx:integerField name="recordType" width="1"/&gt;
        &lt;sx:when test="recordType=64"&gt;
          &lt;sx:flatRecordType name="smfType64"&gt;
            &lt;sx:integerField name="recordLength" width="2"/&gt;
            &lt;sx:integerField name="segmentControlCode" width="1"/&gt;
            &lt;sx:integerField name="reserved" width="1"/&gt;
            &lt;sx:binaryField name="systemIndicator" label="systemIndicator" width="1"/&gt;
            &lt;sx:integerField name="recordType" label="recordType" width="1"/&gt;
            &lt;sx:positionalField name="jobName" label="Job Name" start="19" width="8"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="recordType=42"&gt;
          &lt;sx:flatRecordType name="smfType42"&gt;
            &lt;sx:integerField name="recordLength" width="2"/&gt;
            &lt;sx:integerField name="segmentControlCode" width="1"/&gt;
            &lt;sx:integerField name="reserved" width="1"/&gt;
            &lt;sx:binaryField name="systemIndicator" label="systemIndicator" width="1"/&gt;
            &lt;sx:integerField name="recordType" label="recordType" width="1"/&gt;
            &lt;sx:integerField name="subType" label="Sub Type" start="23" width="2"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="recordType=110"&gt;
          &lt;sx:flatRecordType name="smfType110"&gt;
            &lt;sx:integerField name="recordLength" width="2"/&gt;
            &lt;sx:integerField name="segmentControlCode" width="1"/&gt;
            &lt;sx:integerField name="reserved" width="1"/&gt;
            &lt;sx:binaryField name="systemIndicator" label="systemIndicator" width="1"/&gt;
            &lt;sx:integerField name="recordType" label="recordType" width="1"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:otherwise&gt;
          &lt;sx:flatRecordType name="other"&gt;
            &lt;sx:integerField name="recordLength" width="2"/&gt;
            &lt;sx:integerField name="segmentControlCode" width="1"/&gt;
            &lt;sx:integerField name="reserved" width="1"/&gt;
            &lt;sx:binaryField name="systemIndicator" label="systemIndicator" width="1"/&gt;
            &lt;sx:integerField name="recordType" label="recordType" width="1"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:otherwise&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:mergePhysicalSegments&gt;
  &lt;/sx:vbsFlatRecordType&gt;

  &lt;sx:recordMapping id="smfToXmlMapping"&gt;
    &lt;smf&gt;
      &lt;sx:onRecord recordType="smfType64"&gt;
        &lt;smfRecord&gt;
          &lt;sx:fieldElementMap field="systemIndicator" element="systemIndicator"/&gt;
          &lt;sx:fieldElementMap field="recordType" element="type"/&gt;
          &lt;sx:fieldElementMap field="jobName" element="jobName"/&gt;
        &lt;/smfRecord&gt;
      &lt;/sx:onRecord&gt;
      &lt;sx:onRecord recordType="smfType42"&gt;
        &lt;smfRecord&gt;
          &lt;sx:fieldElementMap field="systemIndicator" element="systemIndicator"/&gt;
          &lt;sx:fieldElementMap field="recordType" element="type"/&gt;
          &lt;sx:fieldElementMap field="subType" element="subType"/&gt;
        &lt;/smfRecord&gt;
      &lt;/sx:onRecord&gt;
      &lt;sx:onRecord recordType="smfType110"&gt;
        &lt;smfRecord&gt;
          &lt;sx:fieldElementMap field="systemIndicator" element="systemIndicator"/&gt;
          &lt;sx:fieldElementMap field="recordType" element="type"/&gt;
        &lt;/smfRecord&gt;
      &lt;/sx:onRecord&gt;
      &lt;sx:onRecord recordType="other"&gt;
        &lt;smfRecord&gt;
          &lt;sx:fieldElementMap field="systemIndicator" element="systemIndicator"/&gt;
          &lt;sx:fieldElementMap field="recordType" element="type"/&gt;
        &lt;/smfRecord&gt;
      &lt;/sx:onRecord&gt;
    &lt;/smf&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt; </pre></div></div><br class="figure-break">
      <div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="d4e1458"></a>Remarks</h5></div></div></div>
        
        <div class="itemizedlist"><ul type="disc"><li>
            <p>The field definitions that appear as children of
              <a class="link" href="../guide/index.html#sx:vbsFlatRecordType" target="_top">sx:vbsFlatRecordType</a>
comprise the 4-byte segment descriptor word (SDW), which describes the segment.
The first 2 bytes contain the length of the segment, including the 4-byte SDW.
The third byte of the SDW contains the segment control code, a value of
              <code class="code">00</code>
indicates that the segment is a complete logical record, and
              <code class="code">01</code>
            indicates that the segment is the first segment of a multisegment
            record.  For more details, see
              <a class="ulink" href="http://publib.boulder.ibm.com/infocenter/zvm/v5r3/index.jsp?topic=/com.ibm.zvm.v53.dmsa5/dup0010.htm" target="_top">segment descriptor word</a>.
            </p>
          </li><li>
            <p>The
              <a class="link" href="../guide/index.html#sx:mergePhysicalSegments" target="_top">sx:mergePhysicalSegments</a>
            element controls the composition of the mulitple segments into a
            single logical record.  Note that a <code class="sgmltag-element">segmentControlCode</code>
               of either 
              <code class="code">00</code> or <code class="code">01</code> marks the beginning of a 
              logical record. By default, the first segment descriptor 
            word goes at the front of the logical record, in the place of a 
            record descriptor word (RDW), 
            subsequent segment descriptor words are discarded.  If the optional
              <code class="sgmltag-element">suppressRDW</code> attribute is set to "true", the 
              first segment descriptor word is discarded as well, the SDW fields 
              must be removed from the content of 
                             <a class="link" href="../guide/index.html#sx:mergePhysicalSegments" target="_top">sx:mergePhysicalSegments</a>, 
              and four bytes need to be subtracted from any positions specified 
              in the record definitions.
            </p>
          </li><li>
            <p>Note that ServingXML positions are one-based, while the 
              offsets in the IBM documentation are zero-based.
            </p>
          </li></ul></div>
      </div>

      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-smf.xml -i data/G6744V00.smf -o output/smf.xml smf-xml

        </pre><p>
      </p>
    </div>

    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="recordComposition"></a>Aggregating Multiple Physical Records into a Composite Record (Record Composition)
      </h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1482"></a>
      <p>
The input file is a fixed field width flat file.
      </p>
      <div class="figure"><a name="composite-records.txt"></a><p class="title"><b>Figure&nbsp;105.&nbsp;Input flat file composite-records.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
ODANIEL    356996699001 
A233ServingXML132433SAS 
B343443DD2322ARDE021101 
CDANIEL    029299839907    
B344233DD2322PREE021100 
D0000040000002300000001 
A233ServingXML132433AGS 
B3434432323000022021101 
CDANIEL    029299839907 
B3433132323000022021101 
CDANIEL    029299839907 
D0000040000002300000002 
E0030000000100009803600 

        </pre>
      </div></div><br class="figure-break">
      <p>
Note the following properties of this data:
      </p>
      <div class="itemizedlist"><ul type="disc"><li>The file begins with an "O" record and ends with an "E" 
          record.
        </li><li>An "A" record begins a group of records.
        </li><li>The last three character field of an A record (e.g. "SAS") 
          determines a variant format for a B record.
        </li></ul></div>
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="composite-records.xml"></a><p class="title"><b>Figure&nbsp;106.&nbsp;Output XML file composite-records.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;document&gt;
  &lt;header&gt;
    &lt;O&gt;
      &lt;recordType&gt;O&lt;/recordType&gt;
      &lt;name&gt;DANIEL&lt;/name&gt;
      &lt;id&gt;356&lt;/id&gt;
      &lt;code&gt;996699&lt;/code&gt;
      &lt;tracking&gt;001&lt;/tracking&gt;
    &lt;/O&gt;
  &lt;/header&gt;
  &lt;body&gt;
    &lt;A&gt;
      &lt;recordType&gt;A&lt;/recordType&gt;
      &lt;code&gt;233&lt;/code&gt;
      &lt;book&gt;ServingXML&lt;/book&gt;
      &lt;isbn&gt;132433&lt;/isbn&gt;
      &lt;identifier&gt;SAS&lt;/identifier&gt;
    &lt;/A&gt;
    &lt;B-SAS&gt;
      &lt;recordType&gt;B&lt;/recordType&gt;
      &lt;library&gt;343443&lt;/library&gt;
      &lt;shelf&gt;DD2322ARDE&lt;/shelf&gt;
      &lt;ebook&gt;021&lt;/ebook&gt;
      &lt;code&gt;101&lt;/code&gt;
    &lt;/B-SAS&gt;
    &lt;C&gt;
      &lt;recordType&gt;C&lt;/recordType&gt;
      &lt;author&gt;DANIEL&lt;/author&gt;
      &lt;publisher&gt;0292998399&lt;/publisher&gt;
      &lt;flag&gt;07&lt;/flag&gt;
    &lt;/C&gt;
    &lt;B-SAS&gt;
      &lt;recordType&gt;B&lt;/recordType&gt;
      &lt;library&gt;344233&lt;/library&gt;
      &lt;shelf&gt;DD2322PREE&lt;/shelf&gt;
      &lt;ebook&gt;021&lt;/ebook&gt;
      &lt;code&gt;100&lt;/code&gt;
    &lt;/B-SAS&gt;
    &lt;D&gt;
      &lt;recordType&gt;D&lt;/recordType&gt;
      &lt;count&gt;000004&lt;/count&gt;
      &lt;amount&gt;0000002300&lt;/amount&gt;
      &lt;tracking&gt;000001&lt;/tracking&gt;
    &lt;/D&gt;
    &lt;A&gt;
      &lt;recordType&gt;A&lt;/recordType&gt;
      &lt;code&gt;233&lt;/code&gt;
      &lt;book&gt;ServingXML&lt;/book&gt;
      &lt;isbn&gt;132433&lt;/isbn&gt;
      &lt;identifier&gt;AGS&lt;/identifier&gt;
    &lt;/A&gt;
    &lt;B-AGS&gt;
      &lt;recordType&gt;B&lt;/recordType&gt;
      &lt;store&gt;34344323&lt;/store&gt;
      &lt;cost&gt;23000022&lt;/cost&gt;
      &lt;code&gt;021&lt;/code&gt;
      &lt;make&gt;101&lt;/make&gt;
    &lt;/B-AGS&gt;
    &lt;C&gt;
      &lt;recordType&gt;C&lt;/recordType&gt;
      &lt;author&gt;DANIEL&lt;/author&gt;
      &lt;publisher&gt;0292998399&lt;/publisher&gt;
      &lt;flag&gt;07&lt;/flag&gt;
    &lt;/C&gt;
    &lt;B-AGS&gt;
      &lt;recordType&gt;B&lt;/recordType&gt;
      &lt;store&gt;34331323&lt;/store&gt;
      &lt;cost&gt;23000022&lt;/cost&gt;
      &lt;code&gt;021&lt;/code&gt;
      &lt;make&gt;101&lt;/make&gt;
    &lt;/B-AGS&gt;
    &lt;C&gt;
      &lt;recordType&gt;C&lt;/recordType&gt;
      &lt;author&gt;DANIEL&lt;/author&gt;
      &lt;publisher&gt;0292998399&lt;/publisher&gt;
      &lt;flag&gt;07&lt;/flag&gt;
    &lt;/C&gt;
    &lt;D&gt;
      &lt;recordType&gt;D&lt;/recordType&gt;
      &lt;count&gt;000004&lt;/count&gt;
      &lt;amount&gt;0000002300&lt;/amount&gt;
      &lt;tracking&gt;000002&lt;/tracking&gt;
    &lt;/D&gt;
  &lt;/body&gt;
  &lt;trailer&gt;
    &lt;E&gt;
      &lt;recordType&gt;E&lt;/recordType&gt;
      &lt;total&gt;00300&lt;/total&gt;
      &lt;amount&gt;0000010000&lt;/amount&gt;
      &lt;count&gt;9803&lt;/count&gt;
      &lt;tracking&gt;600&lt;/tracking&gt;
    &lt;/E&gt;
  &lt;/trailer&gt;
&lt;/document&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-recordComposition.xml"></a><p class="title"><b>Figure&nbsp;107.&nbsp;Resources script resources-recordComposition.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:fn="http://www.w3.org/2005/xpath-functions"&gt;

  &lt;sx:service id="composite-records-to-xml"&gt;
    &lt;sx:task ref="serialized-composite-records"/&gt;
  &lt;/sx:service&gt;

  &lt;sx:serialize id="serialized-composite-records"&gt;
    &lt;sx:transform&gt;
      &lt;sx:recordContent ref="composite-record-content"/&gt;
    &lt;/sx:transform&gt;
  &lt;/sx:serialize&gt;

  &lt;sx:recordContent id="composite-record-content"&gt;
    &lt;sx:flatFileReader ref="composite-record-reader"/&gt;
    &lt;sx:recordMapping ref="composite-record-mapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFileReader id="composite-record-reader"&gt;
    &lt;sx:flatFile&gt;
      &lt;sx:flatFileBody&gt;
        &lt;sx:flatRecordTypeChoice&gt;
          &lt;sx:positionalField name="recordType" width="1"/&gt;
          &lt;sx:when test="recordType='O'"&gt;
            &lt;sx:flatRecordType ref="O"/&gt;
          &lt;/sx:when&gt;
          &lt;sx:when test="recordType='E'"&gt;
            &lt;sx:flatRecordType ref="E"/&gt;
          &lt;/sx:when&gt;
          &lt;sx:otherwise&gt;
            &lt;sx:compositeFlatRecordType&gt;
              &lt;sx:positionalField name="recordType" width="1"/&gt;
              &lt;sx:positionalField name="code" width="3"/&gt;
              &lt;sx:positionalField name="book" width="10"/&gt;
              &lt;sx:positionalField name="isbn" width="6"/&gt;
              &lt;sx:positionalField name="identifier" width="3"/&gt;
              &lt;sx:combinePhysicalRecords recordType="composite" repeatingGroup="group"
                                    startTest = "sx:current//recordType = 'A' 
                                                 and sx:current//identifier = 'SAS'"
                                    endTest = "sx:current//recordType = 'A'"&gt;
                &lt;sx:flatRecordTypeChoice&gt;
                  &lt;sx:positionalField name="recordType" width="1"/&gt;
                  &lt;sx:when test="recordType='A'"&gt;
                    &lt;sx:flatRecordType ref="A"/&gt;
                  &lt;/sx:when&gt;
                  &lt;sx:when test="recordType='B'"&gt;
                    &lt;sx:flatRecordType ref="B-SAS"/&gt;
                  &lt;/sx:when&gt;
                  &lt;sx:when test="recordType='C'"&gt;
                    &lt;sx:flatRecordType ref="C"/&gt;
                  &lt;/sx:when&gt;
                  &lt;sx:when test="recordType='D'"&gt;
                    &lt;sx:flatRecordType ref="D"/&gt;
                  &lt;/sx:when&gt;
                &lt;/sx:flatRecordTypeChoice&gt;
              &lt;/sx:combinePhysicalRecords&gt;
              &lt;sx:combinePhysicalRecords recordType="composite" repeatingGroup="group"
                                    startTest = "sx:current//recordType = 'A' 
                                                 and sx:current//identifier = 'AGS'"
                                    endTest = "sx:current//recordType = 'A'"&gt;
                &lt;sx:flatRecordTypeChoice&gt;
                  &lt;sx:positionalField name="recordType" width="1"/&gt;
                  &lt;sx:when test="recordType='A'"&gt;
                    &lt;sx:flatRecordType ref="A"/&gt;
                  &lt;/sx:when&gt;
                  &lt;sx:when test="recordType='B'"&gt;
                    &lt;sx:flatRecordType ref="B-AGS"/&gt;
                  &lt;/sx:when&gt;
                  &lt;sx:when test="recordType='C'"&gt;
                    &lt;sx:flatRecordType ref="C"/&gt;
                  &lt;/sx:when&gt;
                  &lt;sx:when test="recordType='D'"&gt;
                    &lt;sx:flatRecordType ref="D"/&gt;
                  &lt;/sx:when&gt;
                &lt;/sx:flatRecordTypeChoice&gt;
              &lt;/sx:combinePhysicalRecords&gt;
            &lt;/sx:compositeFlatRecordType&gt;
          &lt;/sx:otherwise&gt;
        &lt;/sx:flatRecordTypeChoice&gt;
      &lt;/sx:flatFileBody&gt;
    &lt;/sx:flatFile&gt;
  &lt;/sx:flatFileReader&gt;

  &lt;sx:flatRecordType id="A" name="A"&gt;
    &lt;sx:positionalField name="recordType" width="1"/&gt;
    &lt;sx:positionalField name="code" width="3"/&gt;
    &lt;sx:positionalField name="book" width="10"/&gt;
    &lt;sx:positionalField name="isbn" width="6"/&gt;
    &lt;sx:positionalField name="identifier" width="3"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatRecordType id="C" name="C"&gt;
    &lt;sx:positionalField name="recordType" width="1"/&gt;
    &lt;sx:positionalField name="author" width="10"/&gt;
    &lt;sx:positionalField name="publisher" width="10"/&gt;
    &lt;sx:positionalField name="flag" width="2"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatRecordType id="D" name="D"&gt;
    &lt;sx:positionalField name="recordType" width="1"/&gt;
    &lt;sx:positionalField name="count" width="6"/&gt;
    &lt;sx:positionalField name="amount" width="10"/&gt;
    &lt;sx:positionalField name="tracking" width="6"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatRecordType id="E" name="E"&gt;
    &lt;sx:positionalField name="recordType" width="1"/&gt;
    &lt;sx:positionalField name="total" width="5"/&gt;
    &lt;sx:positionalField name="amount" width="10"/&gt;
    &lt;sx:positionalField name="count" width="4"/&gt;
    &lt;sx:positionalField name="tracking" width="3"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatRecordType id="B-SAS" name="B-SAS"&gt;
    &lt;sx:positionalField name="recordType" width="1"/&gt;
    &lt;sx:positionalField name="library" width="6"/&gt;
    &lt;sx:positionalField name="shelf" width="10"/&gt;
    &lt;sx:positionalField name="ebook" width="3"/&gt;
    &lt;sx:positionalField name="code" width="3"/&gt;
  &lt;/sx:flatRecordType&gt;
  &lt;sx:flatRecordType id="B-AGS" name="B-AGS"&gt;
    &lt;sx:positionalField name="recordType" width="1"/&gt;
    &lt;sx:positionalField name="store" width="8"/&gt;
    &lt;sx:positionalField name="cost" width="8"/&gt;
    &lt;sx:positionalField name="code" width="3"/&gt;
    &lt;sx:positionalField name="make" width="3"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatRecordType id="O" name="O"&gt;
    &lt;sx:positionalField name="recordType" width="1"/&gt;
    &lt;sx:positionalField name="name" width="10"/&gt;
    &lt;sx:positionalField name="id" width="3"/&gt;
    &lt;sx:positionalField name="code" width="6"/&gt;
    &lt;sx:positionalField name="tracking" width="3"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:recordMapping id="composite-record-mapping"&gt;
    &lt;document&gt;
      &lt;header&gt;
        &lt;sx:onRecord recordType="O"&gt;
          &lt;O&gt;
            &lt;sx:defaultFieldElementMap fields="*"/&gt;
          &lt;/O&gt;
        &lt;/sx:onRecord&gt;
      &lt;/header&gt;
      &lt;body&gt;
        &lt;sx:onRecord recordType="composite"&gt;
          &lt;sx:subrecordMapping repeatingGroup="group"&gt;
            &lt;sx:onRecord recordType="A"&gt;
              &lt;A&gt;
                &lt;sx:defaultFieldElementMap fields="*"/&gt;
              &lt;/A&gt;
            &lt;/sx:onRecord&gt;
            &lt;sx:onRecord recordType="B-SAS"&gt;
              &lt;B-SAS&gt;
                &lt;sx:defaultFieldElementMap fields="*"/&gt;
              &lt;/B-SAS&gt;
            &lt;/sx:onRecord&gt;
            &lt;sx:onRecord recordType="B-AGS"&gt;
              &lt;B-AGS&gt;
                &lt;sx:defaultFieldElementMap fields="*"/&gt;
              &lt;/B-AGS&gt;
            &lt;/sx:onRecord&gt;
            &lt;sx:onRecord recordType="C"&gt;
              &lt;C&gt;
                &lt;sx:defaultFieldElementMap fields="*"/&gt;
              &lt;/C&gt;
            &lt;/sx:onRecord&gt;
            &lt;sx:onRecord recordType="D"&gt;
              &lt;D&gt;
                &lt;sx:defaultFieldElementMap fields="*"/&gt;
              &lt;/D&gt;
            &lt;/sx:onRecord&gt;
            &lt;sx:onRecord recordType="O"&gt;
              &lt;O&gt;
                &lt;sx:defaultFieldElementMap fields="*"/&gt;
              &lt;/O&gt;
            &lt;/sx:onRecord&gt;
          &lt;/sx:subrecordMapping&gt;
        &lt;/sx:onRecord&gt;
      &lt;/body&gt;
      &lt;trailer&gt;
        &lt;sx:onRecord recordType="E"&gt;
          &lt;E&gt;
            &lt;sx:defaultFieldElementMap fields="*"/&gt;
          &lt;/E&gt;
        &lt;/sx:onRecord&gt;
      &lt;/trailer&gt;
    &lt;/document&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;
</pre></div></div><br class="figure-break">
      <div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="d4e1502"></a>Remarks</h5></div></div></div>
        
        <div class="itemizedlist"><ul type="disc"><li>
            <p>The field definitions that appear as children of
              <a class="link" href="../guide/index.html#sx:compositeFlatRecordType" target="_top">sx:compositeFlatRecordType</a>
              belong to the header of a group of related records.
            </p>
          </li><li>
            <p>The
              <a class="link" href="../guide/index.html#sx:combinePhysicalRecords" target="_top">sx:combinePhysicalRecords</a>
            element controls the aggregation of a group of physical records into a
            composite logical record. 
            </p>
          </li></ul></div>
      </div>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -r resources-recordComposition.xml -i data/composite-records.txt 
    -o output/composite-records.xml composite-records-to-xml

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e1513"></a>Computing an Aggregate Value over Multiple Records</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1516"></a>
      <p> This example shows a resources script that will concatenate the values of
  several records into a single XML element value.  It illustrates the use of
  the
        <a class="link" href="../guide/index.html#sx:combineRecords" target="_top">sx:combineRecords</a>
element.
      </p>
      <p>
The input file is
      </p>
      <div class="figure"><a name="orders.txt"></a><p class="title"><b>Figure&nbsp;108.&nbsp;Input flat file orders.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
HEADER
ORDER/CUS/CON/USD/
PO1/PAR1/MFR FADD1/5/
REM AAAAA
REM BBBBB
REM CCCCC
PO2/PAR2/MFR 30066/1/
PO3/PAR3/MFR PAGT2/2/
REM CCCCC
REM DDDDD
TRAILER

        </pre>
      </div></div><br class="figure-break">
      <p>
The desired output is
      </p>
      <div class="figure"><a name="order.xml"></a><p class="title"><b>Figure&nbsp;109.&nbsp;Output XML file order.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;Order&gt;
  &lt;OrderHeader&gt;
    &lt;CUS&gt;CUS&lt;/CUS&gt;
    &lt;CON&gt;CON&lt;/CON&gt;
    &lt;CUR&gt;USD&lt;/CUR&gt;
  &lt;/OrderHeader&gt;
  &lt;OrderPosition&gt;
    &lt;ORN&gt;PO1&lt;/ORN&gt;
    &lt;PAR&gt;PAR1&lt;/PAR&gt;
    &lt;QTY&gt;5&lt;/QTY&gt;
    &lt;MFR&gt;FADD1&lt;/MFR&gt;
    &lt;REM&gt;AAAAA BBBBB CCCCC&lt;/REM&gt;
  &lt;/OrderPosition&gt;
  &lt;OrderPosition&gt;
    &lt;ORN&gt;PO2&lt;/ORN&gt;
    &lt;PAR&gt;PAR2&lt;/PAR&gt;
    &lt;QTY&gt;1&lt;/QTY&gt;
    &lt;MFR&gt;30066&lt;/MFR&gt;
  &lt;/OrderPosition&gt;
  &lt;OrderPosition&gt;
    &lt;ORN&gt;PO3&lt;/ORN&gt;
    &lt;PAR&gt;PAR3&lt;/PAR&gt;
    &lt;QTY&gt;2&lt;/QTY&gt;
    &lt;MFR&gt;PAGT2&lt;/MFR&gt;
    &lt;REM&gt;CCCCC DDDDD&lt;/REM&gt;
  &lt;/OrderPosition&gt;
&lt;/Order&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>Note that the REM values are concatenated in a space separated list.
      </p>
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-order.xml"></a><p class="title"><b>Figure&nbsp;110.&nbsp;Resources script resources-order.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0"?&gt;
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:fn="http://www.w3.org/2005/xpath-functions"&gt;

  &lt;sx:service id="Order"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="Order"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="Order" name="Order"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:flatFile ref="OrderFile"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;sx:combineRecords recordType="composite" repeatingGroup="detail"
                        startTest="sx:current/orderRemarks"
                        endTest="not(sx:current/orderRemarks)"&gt;
        &lt;sx:newField name="remarks" select="detail/orderRemarks/REM"/&gt;
      &lt;/sx:combineRecords&gt;
    &lt;/sx:recordStream&gt;
    &lt;sx:recordMapping ref="OrderToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="OrderFile"&gt;
    &lt;sx:commentStarter value="#"/&gt;
    &lt;sx:fieldDelimiter value="/"/&gt;
    &lt;sx:flatFileHeader lineCount="1"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:positionalField name="tag" width="3"/&gt;
        &lt;sx:when test="tag='ORD'"&gt;
          &lt;sx:flatRecordType name="orderHeader"&gt;
            &lt;sx:delimitedField name="CMD" label="Command Code"/&gt;
            &lt;sx:delimitedField name="CUS" label="Customer"/&gt;
            &lt;sx:delimitedField name="CON" label="Contractor"/&gt;
            &lt;sx:delimitedField name="CUR" label="Currency Code"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="tag='REM'"&gt;
          &lt;sx:flatRecordType name="orderRemarks"&gt;
            &lt;sx:positionalField name="REMTEI" label="Remark" width="3"/&gt;
            &lt;sx:delimitedField name="REM" label="Remark"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="tag='TRA'"&gt;
          &lt;sx:flatRecordType name="orderTrailer"&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:otherwise&gt;
          &lt;sx:flatRecordType name="orderPosition"&gt;
            &lt;sx:delimitedField name="ORN" label="Order Number"/&gt;
            &lt;sx:delimitedField name="PAR" label="Part Number"/&gt;
            &lt;sx:delimitedField name="MFRTEI" maxWidth="3"/&gt;
            &lt;sx:delimitedField name="MFR" label="Manufacturer"/&gt;
            &lt;sx:delimitedField name="QTY" label="Order Quantity"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:otherwise&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="OrderToXmlMapping"&gt;
    &lt;Order&gt;
      &lt;sx:innerGroup startTest="sx:current/orderHeader"&gt;
        &lt;OrderHeader&gt;
          &lt;sx:fieldElementMap field="CUS" element="CUS"/&gt;
          &lt;sx:fieldElementMap field="CON" element="CON"/&gt;
          &lt;sx:fieldElementMap field="CUR" element="CUR"/&gt;
        &lt;/OrderHeader&gt;

        &lt;sx:innerGroup startTest="sx:current/orderPosition"&gt;
          &lt;OrderPosition&gt;
            &lt;sx:fieldElementMap field="ORN" element="ORN" minOccurs="1"/&gt;
            &lt;sx:fieldElementMap field="PAR" element="PAR"/&gt;
            &lt;sx:fieldElementMap field="QTY" element="QTY"/&gt;
            &lt;sx:fieldElementMap field="MFR" element="MFR" minOccurs="0"/&gt;
            &lt;sx:onRecord recordType="composite"&gt;
              &lt;sx:choose&gt;
                &lt;sx:when test="remarks != ''"&gt;
                  &lt;sx:fieldElementMap select="remarks" element="REM"/&gt;
                &lt;/sx:when&gt;
              &lt;/sx:choose&gt;
            &lt;/sx:onRecord&gt;
          &lt;/OrderPosition&gt;
        &lt;/sx:innerGroup&gt;
      &lt;/sx:innerGroup&gt;
    &lt;/Order&gt;
  &lt;/sx:recordMapping&gt;
&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The effect of
        <a class="link" href="../guide/index.html#sx:combineRecords" target="_top">sx:combineRecords</a>
is to collect all the
    adjacent
        <code class="sgmltag-element">orderRemarks</code>
records, where they become sub-records
    belonging to a field called "detail", and create one record of type
    "composite" that has the repeating group field "detail", plus another field
    "remarks" that is computed from "detail".
      </p>
      <p>
      The
        <code class="sgmltag-element">orderRemarks</code>
records flowing into
        <a class="link" href="../guide/index.html#sx:combineRecords" target="_top">sx:combineRecords</a>
look like, in their
      XML representation,
      </p>
      <pre class="programlisting">
        
&lt;orderRemarks&gt;&lt;REMTEI&gt;REM&lt;/REMTEI&gt;&lt;REM&gt;AAAA&lt;/REM&gt;&lt;/orderRemarks&gt; 
&lt;orderRemarks&gt;&lt;REMTEI&gt;REM&lt;/REMTEI&gt;&lt;REM&gt;BBBB&lt;/REM&gt;&lt;/orderRemarks&gt; 
&lt;orderRemarks&gt;&lt;REMTEI&gt;REM&lt;/REMTEI&gt;&lt;REM&gt;CCCC&lt;/REM&gt;&lt;/orderRemarks&gt; 

      </pre>
      <p>
  The composite record flowing out looks like
      </p>
 

      <pre class="programlisting">
        
&lt;composite&gt; 
  &lt;detail&gt; 
    &lt;orderRemarks&gt;&lt;REMTEI&gt;REM&lt;/REMTEI&gt;&lt;REM&gt;AAAA&lt;/REM&gt;&lt;/orderRemarks&gt; 
    &lt;orderRemarks&gt;&lt;REMTEI&gt;REM&lt;/REMTEI&gt;&lt;REM&gt;BBBB&lt;/REM&gt;&lt;/orderRemarks&gt; 
    &lt;orderRemarks&gt;&lt;REMTEI&gt;REM&lt;/REMTEI&gt;&lt;REM&gt;CCCC&lt;/REM&gt;&lt;/orderRemarks&gt; 
  &lt;/detail&gt; 
  &lt;remarks&gt;AAAA BBBB CCCC&lt;/remarks&gt; 
&lt;/composite&gt; 

      </pre>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -i data/order.txt -r resources-order.xml -o output/order.xml Order

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e1545"></a>Mapping Two Records at the Top of a File to a Header Element in the
  XML Output</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1548"></a>
      <p> This example shows a resources script that maps two records at the top of
  a file to a header element in the XML output.
To map fields from multiple records to the attributes of a single element, you
first need to compose an aggregate of the two records with the
        <a class="link" href="../guide/index.html#sx:combineRecords" target="_top">sx:combineRecords</a>
instruction.  You
  can then select against the composite record with an
        <a class="link" href="../guide/index.html#sx:fieldAttributeMap" target="_top">sx:fieldAttributeMap</a>
  and populate the attributes of the parent element.
      </p>
      <p>
The input file is
      </p>
      <div class="figure"><a name="files.txt"></a><p class="title"><b>Figure&nbsp;111.&nbsp;Input flat file files.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
DP1 458293048kd02 
*****2LV 2008070132 EX9 
E0000015498273 
F0000014938294 
G000001E7839201 
D0000024839305

        </pre>
      </div></div><br class="figure-break">
      <p>The rules for mapping the third through last records are as follows.
      </p>
      <div class="itemizedlist"><ul type="disc"><li>
          <p>If a "D" record is found, start a new
            <code class="sgmltag-element">file</code>
element, but "D" records are optional.
          </p>
        </li><li>
          <p>If an "E" record is found, start a new
            <code class="sgmltag-element">file</code>
element, unless
         one has already been started because of a
         "D" record.
          </p>
        </li></ul></div>
      <p>
The desired output is
      </p>
      <div class="figure"><a name="files.xml"></a><p class="title"><b>Figure&nbsp;112.&nbsp;Output XML file files.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;output date="20080701" sequence="32" 
        code="EX9" reference="458293048kd0"&gt;
  &lt;file filenumber="000001"/&gt;
  &lt;file filenumber="000002"/&gt;
&lt;/output&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-files.xml"></a><p class="title"><b>Figure&nbsp;113.&nbsp;Resources script resources-files.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="files"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="filesContent"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="filesContent"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:flatFile ref="fileFlatFile"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;sx:combineRecords recordType="header" repeatingGroup="headerRecords"
                        startTest="sx:current/header1" endTest="sx:previous/header2"&gt;
      &lt;/sx:combineRecords&gt;
    &lt;/sx:recordStream&gt;
    &lt;sx:recordMapping ref="fileToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="fileFlatFile"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:positionalField name="tag" width="1"/&gt;
        &lt;sx:positionalField name="tag2" width="2"/&gt;
        &lt;sx:when test="tag='D' and tag2='P1'"&gt;
          &lt;sx:flatRecordType name="header1"&gt;
            &lt;sx:positionalField name="reference" start="5" width="13"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="tag='*'"&gt;
          &lt;sx:flatRecordType name="header2"&gt;
            &lt;sx:positionalField name="date" start="10" width="8"/&gt;
            &lt;sx:positionalField name="sequence" width="2"/&gt;
            &lt;sx:positionalField name="code" start="21" width="3"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="tag='E'"&gt;
          &lt;sx:flatRecordType name="E"&gt;
            &lt;sx:positionalField name="filenumber" start="2" width="6"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="tag='D'"&gt;
          &lt;sx:flatRecordType name="D"&gt;
            &lt;sx:positionalField name="filenumber" start="2" width="6"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="fileToXmlMapping"&gt;
    &lt;output&gt;
      &lt;sx:fieldAttributeMap select="headerRecords/header2/date" attribute="date"/&gt;
      &lt;sx:fieldAttributeMap select="headerRecords/header2/sequence" attribute="sequence"/&gt;
      &lt;sx:fieldAttributeMap select="headerRecords/header2/code" attribute="code"/&gt;
      &lt;sx:fieldAttributeMap select="headerRecords/header1/reference" attribute="reference"/&gt;
      &lt;sx:groupChoice&gt;
        &lt;sx:innerGroup startTest="sx:current/D" endTest="sx:current/D"&gt;
          &lt;file&gt;
            &lt;sx:fieldAttributeMap field="filenumber" attribute="filenumber"/&gt;
          &lt;/file&gt;
        &lt;/sx:innerGroup&gt;
        &lt;sx:innerGroup startTest="sx:current/E" endTest="sx:current/D or sx:current/E"&gt;
          &lt;file&gt;
            &lt;sx:fieldAttributeMap field="filenumber" attribute="filenumber"/&gt;
          &lt;/file&gt;
        &lt;/sx:innerGroup&gt;
      &lt;/sx:groupChoice&gt;
    &lt;/output&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The effect of
        <a class="link" href="../guide/index.html#sx:combineRecords" target="_top">sx:combineRecords</a>
    is to collect the top two header records,
        <code class="sgmltag-element">header1</code>
and
        <code class="sgmltag-element">header2</code>
, where they become sub-records belonging to a
    field called "headerRecords", and create one record of type "header" that
    has the repeating group field "headerRecords".
      </p>
      <p>
      The
        <code class="sgmltag-element">header</code>
record has the following
      XML representation,
      </p>
      <pre class="programlisting">
        
&lt;header&gt;
  &lt;headerRecords&gt;
    &lt;header1&gt;
      &lt;reference&gt;458293048kd0&lt;/reference&gt;
    &lt;/header1&gt;
    &lt;header2&gt;
      &lt;date&gt;20080701&lt;/date&gt;
      &lt;sequence&gt;32&lt;/sequence&gt;
      &lt;code&gt;EX9&lt;/code&gt;
    &lt;/header2&gt;
  &lt;/headerRecords&gt;
&lt;/header&gt;

      </pre>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -i data/files.txt -r resources-files.xml -o output/files.xml files

        </pre><p>
      </p>
    </div>
  </div>

  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e1583"></a>Start/End Delimited Records.</h3></div></div></div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e1585"></a>Converting flat files with start/end record delimiters (opdef)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1588"></a>
      <a class="indexterm" name="d4e1590"></a>
      <p>
The example below shows how to convert a
flat file with start/end record delimiters.
      </p>
      <p>
The input file is shown below.
      </p>
      <div class="figure"><a name="opdef.txt"></a><p class="title"><b>Figure&nbsp;114.&nbsp;Input file opdef.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
1 20050505 121205 xtyzzya 
{:HJSED 
:20:886452311980706 
:23:CREDDFED 
:32:030612USD5443,99 
:33:USD5443,99 
:50K:GIAN 
NNPLLS 
:52A:B0 
:53A:B33 
:54A:I3N 
:57A:BRE 
:59:/20041010050500001M02606 
KKL S.A 
GNRBBL 
:70:/FF/INV 559661 
:71:SAH 
-} 
3 20050505 121205 bahthy 

        </pre>
      </div></div><br class="figure-break">
      <p>
This file has a number of features.
        </p><div class="itemizedlist"><ul type="disc"><li>
            <p>The first and last lines are header and footers, delimited by new line symbols.
            </p>
          </li><li>
            <p>The middle part must be taken as a whole chunk, starting from the opening
              <code class="code">{</code>
and ending at the closing
              <code class="code">}</code>
.</p>
          </li></ul></div><p>
      </p>
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="opdef.xml"></a><p class="title"><b>Figure&nbsp;115.&nbsp;Output XML file opdef.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;opdef&gt;
  &lt;start&gt;
    &lt;opdate&gt;20050505&lt;/opdate&gt;
    &lt;optime&gt;121205&lt;/optime&gt;
    &lt;optarget&gt;xtyzzya&lt;/optarget&gt;
  &lt;/start&gt;
:HJSED
:20:886452311980706
:23:CREDDFED
:32:030612USD5443,99
:33:USD5443,99
:50K:GIAN
NNPLLS
:52A:B0
:53A:B33
:54A:I3N
:57A:BRE
:59:/20041010050500001M02606
KKL S.A
GNRBBL
:70:/FF/INV 559661
:71:SAH
-
  &lt;end&gt;
    &lt;tpdate&gt;20050505&lt;/tpdate&gt;
    &lt;tptime&gt;121205&lt;/tptime&gt;
    &lt;tptarget&gt;bahthy&lt;/tptarget&gt;
  &lt;/end&gt;
&lt;/opdef&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-opdef.xml"></a><p class="title"><b>Figure&nbsp;116.&nbsp;Resources script resources-opdef.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="opdef"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="opdef"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="opdef"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile ref="opdefFlatFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="opdefRecordMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="opdefFlatFile" name="opdef"&gt;
    &lt;sx:recordDelimiter value="\r\n"/&gt;
    &lt;sx:recordDelimiter value="\n"/&gt;
    &lt;sx:recordDelimiter start="{" end="}"/&gt;
    &lt;sx:flatFileBody trim="true"&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:positionalField name="tag" width="1"/&gt;
        &lt;sx:when test="tag='1'"&gt;
          &lt;sx:flatRecordType name="start"&gt;
            &lt;sx:positionalField name="tag" width="2"/&gt;
            &lt;sx:positionalField name="opdate" width="9"/&gt;
            &lt;sx:positionalField name="optime" width="7"/&gt;
            &lt;sx:positionalField name="optarget" width="7"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="tag='3'"&gt;
          &lt;sx:flatRecordType name="end"&gt;
            &lt;sx:positionalField name="tag" width="2"/&gt;
            &lt;sx:positionalField name="tpdate" width="9"/&gt;
            &lt;sx:positionalField name="tptime" width="7"/&gt;
            &lt;sx:positionalField name="tptarget" width="7"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:otherwise&gt;
          &lt;sx:flatRecordType name="data"&gt;
            &lt;sx:delimitedField name="field1"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:otherwise&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="opdefRecordMapping"&gt;
    &lt;opdef&gt;
      &lt;sx:onRecord recordType="start"&gt;
        &lt;start&gt;
          &lt;sx:defaultFieldElementMap fields="opdate optime optarget"/&gt;
        &lt;/start&gt;  
      &lt;/sx:onRecord&gt;
      &lt;sx:onRecord recordType="end"&gt;
        &lt;end&gt;
          &lt;sx:defaultFieldElementMap fields="tpdate tptime tptarget"/&gt;
        &lt;/end&gt;  
      &lt;/sx:onRecord&gt;
      &lt;sx:onRecord recordType="data"&gt;
        &lt;sx:cdata&gt;
          &lt;sx:toString value="{field1}"/&gt;
        &lt;/sx:cdata&gt;
      &lt;/sx:onRecord&gt;
    &lt;/opdef&gt;
  &lt;/sx:recordMapping&gt;  

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
Note the following points about this script.
        </p><div class="itemizedlist"><ul type="disc"><li>
            <p>
There are three record delimiters, which are checked sequentially.  The third record delimiter specifies both start and end values.
When the start value is found, the matching end value is looked for, taking account of nesting, and the whole returned as one
record.  The chunk returned may contain occurances of the other two delimiters.
            </p>
          </li><li>
            <p>
The data is mapped to a single field by using a
              <a class="link" href="../guide/index.html#sx:delimitedField" target="_top">sx:delimitedField</a>
element, taking the default field delimiter, which is the
end of the record.  The data is enclosed in a
              <code class="code">CDATA</code>
section, using the
              <a class="link" href="../guide/index.html#sx:cdata" target="_top">sx:cdata</a>
element.
            </p>
          </li></ul></div><p>
      </p>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -i data/opdef.txt -r resources-opdef.xml 
  -o output/opdef.xml opdef

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e1625"></a>Converting flat files with nested start/end record and segment delimiters and name/value pairs (transaction)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1628"></a>
      <a class="indexterm" name="d4e1631"></a>
      <a class="indexterm" name="d4e1633"></a>
      <p>
The example below shows how to convert a
flat file with nested start/end record and segment delimiters and name/value pairs.
      </p>
      <p>
The input file is shown below.
      </p>
      <div class="figure"><a name="transaction.txt"></a><p class="title"><b>Figure&nbsp;117.&nbsp;Input file transaction.txt</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
{TRAN:trantype=PRIN#origin=Toronto#
{TRANREF:reftype=TREF#ref=1234567890123456B#}
{TRANREF:reftype=FOTR#ref=1234567890123456#}
{DRIVER:drivertype=OPER#drivercode=SELL#}
{DRIVER:drivertype=STRM#drivercode=FOP#}
{INSTR:instrtype=PINS#instrreftype=INT#instrref=PTEQTY1#qty=1000000#}
{INSTR:instrtype=TCCY#instrreftype=ISO#instrref=USD#}
{INSTR:instrtype=SINS#instrreftype=ISO#instrref=USD#}
{PARTY:partytype=COMP#partyreftype=X3#partyref=CMP1#}
{PARTY:partytype=SECP#partyreftype=X3#partyref=PTSECP1#}
{DATE:datetype=TDAT#date=01-Jan-2007#}
{DATE:datetype=VDAT#date=01-Jan-2007#}
{CHARGE:chargetype=COMM#calctype=NONE#chargeamount=50.00#instrreftype=ISO#instrref=USD}
{PRICE:ratetype=TPRC#price=4.9#multdiv=X1#pricetype=YP#}
}

        </pre>
      </div></div><br class="figure-break">
      <p>
This file has a number of features.
        </p><div class="itemizedlist"><ul type="disc"><li>
            <p>The entire record is contained inside "{" - "}" record delimiters.
            </p>
          </li><li>
            <p>The first field in the record is delimited by a ":" and identifies the type of the record.
            </p>
          </li><li>
            <p>The record contains a number of name/value pairs, with names and values separated
by the character "=", and fields terminated by the character "#".
            </p>
          </li><li>
            <p>The record contains a number of segments enclosed in "{" - "}" segment delimiters.
            </p>
          </li><li>
            <p>The first field in each segment is delimited by a ":" and identifies the type of the segment.
            </p>
          </li><li>
            <p>Each segment contains a number of name/value pairs, with names and values separated
by the character "=", and fields terminated by the character "#".
            </p>
          </li></ul></div><p>
      </p>
      <p>
The desired output is shown below.
      </p>
      <div class="figure"><a name="transaction.xml"></a><p class="title"><b>Figure&nbsp;118.&nbsp;Output XML file transaction.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;transaction&gt;
  &lt;TRAN&gt;
    &lt;record-type&gt;TRAN&lt;/record-type&gt;
    &lt;trantype&gt;PRIN&lt;/trantype&gt;
    &lt;origin&gt;Toronto&lt;/origin&gt;
    &lt;segments&gt;
      &lt;TRANREF&gt;
        &lt;record-type&gt;TRANREF&lt;/record-type&gt;
        &lt;reftype&gt;TREF&lt;/reftype&gt;
        &lt;ref&gt;1234567890123456B&lt;/ref&gt;
      &lt;/TRANREF&gt;
      &lt;TRANREF&gt;
        &lt;record-type&gt;TRANREF&lt;/record-type&gt;
        &lt;reftype&gt;FOTR&lt;/reftype&gt;
        &lt;ref&gt;1234567890123456&lt;/ref&gt;
      &lt;/TRANREF&gt;
      &lt;DRIVER&gt;
        &lt;record-type&gt;DRIVER&lt;/record-type&gt;
        &lt;drivertype&gt;OPER&lt;/drivertype&gt;
        &lt;drivercode&gt;SELL&lt;/drivercode&gt;
      &lt;/DRIVER&gt;
      &lt;DRIVER&gt;
        &lt;record-type&gt;DRIVER&lt;/record-type&gt;
        &lt;drivertype&gt;STRM&lt;/drivertype&gt;
        &lt;drivercode&gt;FOP&lt;/drivercode&gt;
      &lt;/DRIVER&gt;
      &lt;INSTR&gt;
        &lt;record-type&gt;INSTR&lt;/record-type&gt;
        &lt;instrtype&gt;PINS&lt;/instrtype&gt;
        &lt;instrreftype&gt;INT&lt;/instrreftype&gt;
        &lt;instrref&gt;PTEQTY1&lt;/instrref&gt;
        &lt;qty&gt;1000000&lt;/qty&gt;
      &lt;/INSTR&gt;
      &lt;INSTR&gt;
        &lt;record-type&gt;INSTR&lt;/record-type&gt;
        &lt;instrtype&gt;TCCY&lt;/instrtype&gt;
        &lt;instrreftype&gt;ISO&lt;/instrreftype&gt;
        &lt;instrref&gt;USD&lt;/instrref&gt;
      &lt;/INSTR&gt;
      &lt;INSTR&gt;
        &lt;record-type&gt;INSTR&lt;/record-type&gt;
        &lt;instrtype&gt;SINS&lt;/instrtype&gt;
        &lt;instrreftype&gt;ISO&lt;/instrreftype&gt;
        &lt;instrref&gt;USD&lt;/instrref&gt;
      &lt;/INSTR&gt;
      &lt;PARTY&gt;
        &lt;record-type&gt;PARTY&lt;/record-type&gt;
        &lt;partytype&gt;COMP&lt;/partytype&gt;
        &lt;partyreftype&gt;X3&lt;/partyreftype&gt;
        &lt;partyref&gt;CMP1&lt;/partyref&gt;
      &lt;/PARTY&gt;
      &lt;PARTY&gt;
        &lt;record-type&gt;PARTY&lt;/record-type&gt;
        &lt;partytype&gt;SECP&lt;/partytype&gt;
        &lt;partyreftype&gt;X3&lt;/partyreftype&gt;
        &lt;partyref&gt;PTSECP1&lt;/partyref&gt;
      &lt;/PARTY&gt;
      &lt;DATE&gt;
        &lt;record-type&gt;DATE&lt;/record-type&gt;
        &lt;datetype&gt;TDAT&lt;/datetype&gt;
        &lt;date&gt;01-Jan-2007&lt;/date&gt;
      &lt;/DATE&gt;
      &lt;DATE&gt;
        &lt;record-type&gt;DATE&lt;/record-type&gt;
        &lt;datetype&gt;VDAT&lt;/datetype&gt;
        &lt;date&gt;01-Jan-2007&lt;/date&gt;
      &lt;/DATE&gt;
      &lt;CHARGE&gt;
        &lt;record-type&gt;CHARGE&lt;/record-type&gt;
        &lt;chargetype&gt;COMM&lt;/chargetype&gt;
        &lt;calctype&gt;NONE&lt;/calctype&gt;
        &lt;chargeamount&gt;50.00&lt;/chargeamount&gt;
        &lt;instrreftype&gt;ISO&lt;/instrreftype&gt;
        &lt;instrref&gt;USD&lt;/instrref&gt;
      &lt;/CHARGE&gt;
      &lt;PRICE&gt;
        &lt;record-type&gt;PRICE&lt;/record-type&gt;
        &lt;ratetype&gt;TPRC&lt;/ratetype&gt;
        &lt;price&gt;4.9&lt;/price&gt;
        &lt;multdiv&gt;X1&lt;/multdiv&gt;
        &lt;pricetype&gt;YP&lt;/pricetype&gt;
      &lt;/PRICE&gt;
    &lt;/segments&gt;
  &lt;/TRAN&gt;
&lt;/transaction&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-transaction.xml"></a><p class="title"><b>Figure&nbsp;119.&nbsp;Resources script resources-transaction.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="transaction"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="transaction-content"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="transaction-content" name="transaction"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:flatFile ref="transaction-flat-file"/&gt;
    &lt;/sx:flatFileReader&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="transaction-flat-file"&gt;
    &lt;sx:recordDelimiter start="{" end="}"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:repeatDelimiter start="{" end="}"/&gt;
      &lt;sx:nameDelimiter value="="/&gt;
      &lt;sx:flatRecordType name="TRAN"&gt;
        &lt;sx:delimitedField name="record-type"&gt;
          &lt;sx:fieldDelimiter value=":"/&gt;
        &lt;/sx:delimitedField&gt;
        &lt;sx:repeatingField&gt;
          &lt;sx:fieldDelimiter value="#"/&gt;
          &lt;sx:segmentDelimiter value="{"/&gt; 
          &lt;sx:delimitedNamedField/&gt;
        &lt;/sx:repeatingField&gt;
        &lt;sx:repeatingGroup name="segments"&gt;
          &lt;sx:flatRecordTypeChoice&gt;
            &lt;sx:delimitedField name="record-type"&gt;
              &lt;sx:fieldDelimiter value=":"/&gt;
            &lt;/sx:delimitedField&gt;
            &lt;sx:when test="1=1"&gt;
              &lt;sx:flatRecordType name="{record-type}"&gt;
                &lt;sx:delimitedField name="record-type"&gt;
                  &lt;sx:fieldDelimiter value=":"/&gt;
                &lt;/sx:delimitedField&gt;
                &lt;sx:repeatingField&gt; 
                  &lt;sx:delimitedNamedField/&gt;
                  &lt;sx:fieldDelimiter value="#"/&gt;
                &lt;/sx:repeatingField&gt;
              &lt;/sx:flatRecordType&gt;
            &lt;/sx:when&gt;
          &lt;/sx:flatRecordTypeChoice&gt;
        &lt;/sx:repeatingGroup&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
Note the following points about this script.
        </p><div class="itemizedlist"><ul type="disc"><li>
            <p>
The value of the first field in the segment, terminated by ":", is assigned as the record type name of the segment.
            </p>
          </li><li>
            <p>
All the name/value pairs within a segment are read with a single
              <a class="link" href="../guide/index.html#sx:repeatingField" target="_top">sx:repeatingField</a>
element.
            </p>
          </li></ul></div><p>
      </p>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -i data/transaction.txt -r resources-transaction.xml 
  -o output/transaction.xml transaction

        </pre><p>
      </p>
    </div>
  </div>

  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e1671"></a>Custom Record Reader</h3></div></div></div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="custom_record_reader"></a>Converting the output of a custom record reader to XML (custom record reader)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1676"></a>
      <p>
The example below shows how to convert the
the output of a custom record reader to XML.
      </p>
      <p>
The input records are generated by the following Java class.
      </p>
      <div class="figure"><a name="TradeRecordReader.java"></a><p class="title"><b>Figure&nbsp;120.&nbsp;TradeRecordReader Java class</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
package flat2xml;

import com.servingxml.app.ServiceContext;
import com.servingxml.components.recordio.AbstractRecordReader;
import com.servingxml.app.Flow;
import com.servingxml.util.Name;
import com.servingxml.util.QualifiedName;
import com.servingxml.util.ServingXmlException;
import com.servingxml.util.record.Record;
import com.servingxml.util.record.RecordBuilder;

public class TradeRecordReader extends AbstractRecordReader {
  private static final Name TRADE_RECORD_TYPE = new QualifiedName("trade");
  private static final Name TRANSACTION_RECORD_TYPE = new QualifiedName("transaction");
  private static final Name RECORD_TYPE_NAME = new QualifiedName("record_type");
  private static final Name ID_NAME = new QualifiedName("id");
  private static final Name TRADE_DATE_NAME = new QualifiedName("trade_date");
  private static final Name TRADE_TIME_NAME = new QualifiedName("trade_time");
  private static final Name DESCRIPTION_NAME = new QualifiedName("description");
  private static final Name REFERENCE_NAME = new QualifiedName("reference");
  
  public void readRecords(ServiceContext context, Flow flow) 
   {

    //  Start the record stream
    startRecordStream(context, flow);

    RecordBuilder trRecordBuilder = new RecordBuilder(TRADE_RECORD_TYPE);
    RecordBuilder tnRecordBuilder = new RecordBuilder(TRANSACTION_RECORD_TYPE);

    Record record;

    trRecordBuilder.setString(RECORD_TYPE_NAME,"TR");
    trRecordBuilder.setString(ID_NAME,"0001");
    trRecordBuilder.setString(TRADE_DATE_NAME,"03/25/2005");
    trRecordBuilder.setString(TRADE_TIME_NAME,"01:50:00");
    trRecordBuilder.setString(DESCRIPTION_NAME,"This is a trade record");
    record = trRecordBuilder.toRecord();
    trRecordBuilder.clear();

    //  Write the "trade" record
    writeRecord(context, flow, record);

    tnRecordBuilder.setString(RECORD_TYPE_NAME,"TN");
    tnRecordBuilder.setString(ID_NAME,"0002");
    tnRecordBuilder.setString(REFERENCE_NAME,"X1234");
    tnRecordBuilder.setString(DESCRIPTION_NAME,"A child transaction");
    record = tnRecordBuilder.toRecord();   
    tnRecordBuilder.clear();

    //  Write the first "transaction" record
    writeRecord(context, flow, record);

    tnRecordBuilder.setString(RECORD_TYPE_NAME,"TN");
    tnRecordBuilder.setString(ID_NAME,"0003");
    tnRecordBuilder.setString(REFERENCE_NAME,"X1235");
    tnRecordBuilder.setString(DESCRIPTION_NAME,"Another child transaction");
    record = tnRecordBuilder.toRecord();
    tnRecordBuilder.clear();

    //  Write the second "transaction" record
    writeRecord(context, flow, record);

    //  End the record stream
    endRecordStream(context, flow);
  }
}

        </pre>
      </div></div><br class="figure-break">
      <p>The
        <code class="code">TradeRecordReader</code>
class will generate the following stream of records.
      </p>
      <div class="informaltable">
        <table border="1"><colgroup><col><col><col><col></colgroup><thead><tr><th align="left">record_type</th><th align="left">id</th><th align="left">trade_date</th><th align="left">trade_time</th><th align="left">description</th></tr></thead><tbody><tr><td align="left">TR</td><td align="left">0001</td><td align="left">03/25/2005</td><td align="left"> 1:50:00</td><td align="left">This is a trade record</td></tr></tbody></table>
      </div>
      <p></p>
      <div class="informaltable">
        <table border="1"><colgroup><col><col><col><col></colgroup><thead><tr><th align="left">record_type</th><th align="left">id</th><th align="left">reference</th><th align="left">description</th></tr></thead><tbody><tr><td align="left">TN</td><td align="left">0002</td><td align="left">X1234</td><td align="left">A child transaction</td></tr><tr><td align="left">TN</td><td align="left">0003</td><td align="left">X1235</td><td align="left">Another child transaction</td></tr></tbody></table>
      </div>

      <p>
The desired output is the same as for the trades example.
      </p>
      <div class="figure"><a name="custom_trade_reader_trades.xmll"></a><p class="title"><b>Figure&nbsp;121.&nbsp;Output XML file trades.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;trades feed="LONDON"&gt;
  &lt;trade id="0001"&gt;
    &lt;trade-date&gt;2005-03-25T01:50:00.000-05:00&lt;/trade-date&gt;
    &lt;description&gt;This is a trade record&lt;/description&gt;
  &lt;/trade&gt;
  &lt;transaction id="0002"&gt;
    &lt;reference&gt;X1234&lt;/reference&gt;
    &lt;description&gt;A child transaction&lt;/description&gt;
  &lt;/transaction&gt;
  &lt;transaction id="0003"&gt;
    &lt;reference&gt;X1235&lt;/reference&gt;
    &lt;description&gt;Another child transaction&lt;/description&gt;
  &lt;/transaction&gt;
&lt;/trades&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script does the transformation.
      </p>
      <div class="figure"><a name="resources-custom_trade_reader.xml"></a><p class="title"><b>Figure&nbsp;122.&nbsp;Resources script resources-custom_trade_reader.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="trades"&gt;
    &lt;sx:parameter name="feed"&gt;
      &lt;sx:defaultValue&gt;NY&lt;/sx:defaultValue&gt;
    &lt;/sx:parameter&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="trades"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="trades"&gt;
    &lt;sx:customRecordReader class="flat2xml.TradeRecordReader"/&gt;
    &lt;sx:recordMapping ref="tradesToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:recordMapping id="tradesToXmlMapping"&gt;
    &lt;trades&gt;
      &lt;sx:fieldAttributeMap value="{$feed}" attribute="feed"/&gt;
      &lt;sx:onRecord recordType="trade"&gt;
        &lt;trade&gt;
          &lt;sx:fieldAttributeMap field="id" attribute="id"/&gt;
          &lt;sx:elementMap element="trade-date"&gt;
            &lt;sx:convertToDateTime format="MM/dd/yyyy H:mm:ss"&gt;
              &lt;sx:concat separator=" "&gt;
                &lt;sx:toString value="{trade_date}"/&gt;
                &lt;sx:toString value="{trade_time}"/&gt;
              &lt;/sx:concat&gt;
            &lt;/sx:convertToDateTime&gt;
          &lt;/sx:elementMap&gt;
          &lt;sx:fieldElementMap field="description" element="description"/&gt;
        &lt;/trade&gt;
      &lt;/sx:onRecord&gt;
      &lt;sx:onRecord recordType="transaction"&gt;
        &lt;transaction&gt;
          &lt;sx:fieldAttributeMap field="id" attribute="id"/&gt;
          &lt;sx:fieldElementMap field="reference" element="reference"/&gt;
          &lt;sx:fieldElementMap field="description" element="description"/&gt;
        &lt;/transaction&gt;
      &lt;/sx:onRecord&gt;
    &lt;/trades&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
Note the following points.
        </p><div class="itemizedlist"><ul type="disc"><li>
The record content is defined by a custom record reader, implemented in the Java class
            <code class="code">TradeRecordReader</code>
.
          </li></ul></div><p>
      </p>
      <p>
You can run this example on the command line by
        </p><div class="itemizedlist"><ul type="disc"><li>
Compiling the Java class
            <code class="code">TradeRecordReader</code>
and copying
the resulting
            <code class="filename">.class</code>
file into the
            <code class="filename">dir/classes</code>
directory
          </li><li>
Entering the command
            <pre class="programlisting">
              
servingxml -r resources-custom_trade_reader.xml
  -o output/trades.xml trades feed=LONDON

            </pre>
          </li></ul></div><p>
      </p>
    </div>
  </div>

  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e1742"></a>Batching XML Output</h3></div></div></div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e1744"></a>Serializing XML in Batches</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1747"></a>
      <p>This example shows how to 
serialize an XML document in batches.  It illustrates the use of
  the
        <a class="link" href="../guide/index.html#sx:batchedSerializer" target="_top">sx:batchedSerializer</a>
        element.
      </p>
      <p>Suppose you want to read the CSV file countries.csv and serialize it to
  XML, but you also want the following:
      </p>
      <div class="itemizedlist"><ul type="disc"><li>
          <p>Country subtrees to be split over multiple documents, no
                more than 50 to any one file.
          </p>
          <pre class="programlisting">
            
          06/12/2007  07:37 PM    &lt;DIR&gt;          .
          06/12/2007  07:37 PM    &lt;DIR&gt;          ..
          06/12/2007  07:37 PM             3,773 countries-1.xml
          06/12/2007  07:37 PM             3,758 countries-2.xml
          06/12/2007  07:37 PM             3,747 countries-3.xml
          06/12/2007  07:37 PM             3,753 countries-4.xml
          06/12/2007  07:37 PM             3,416 countries-5.xml
          
          </pre>

        </li><li>
          <p>Each document to begin with all the XML nodes up to the
                  occurance of the first country subtree.
          </p>
        </li></ul></div>

      <p>
The following resources script produces the desired output.
      </p>
      <pre class="programlisting">
        
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:msv="http://www.servingxml.com/extensions/msv"&gt;

  &lt;sx:service id="countries"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="countries"/&gt;
      &lt;/sx:transform&gt;
      &lt;sx:batchedSerializer path="country" batchSize="50"&gt;
        &lt;sx:xsltSerializer&gt;
          &lt;sx:fileSink file="output/countries-{$sx:batchSequenceNumber}.xml"/&gt;
        &lt;/sx:xsltSerializer&gt;
      &lt;/sx:batchedSerializer&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="countries" name="countries"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:urlSource url="data/countries.csv"/&gt;
        &lt;sx:flatFile ref="countriesFile"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;msv:recordValidator&gt;
        &lt;sx:urlSource url="data/country-record.xsd"/&gt;
      &lt;/msv:recordValidator&gt;
      &lt;sx:discardHandler&gt;
        &lt;sx:log message="{$sx:message}"/&gt;
      &lt;/sx:discardHandler&gt;
    &lt;/sx:recordStream&gt;
    &lt;sx:recordMapping ref="countriesToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="countriesFile"&gt;
    &lt;sx:commentStarter value="#"/&gt;
    &lt;sx:flatFileHeader lineCount="1"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType name="country"&gt;
        &lt;sx:fieldDelimiter value=","/&gt;
        &lt;sx:delimitedField name="code"/&gt;
        &lt;sx:delimitedField name="name" trimLeading="true"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="countriesToXmlMapping"&gt;
    &lt;countries&gt;
      &lt;sx:onRecord&gt;
        &lt;country&gt;
          &lt;sx:fieldElementMap field="name" element="countryName"/&gt;
          &lt;sx:fieldAttributeMap field="code" attribute="countryCode"/&gt;
        &lt;/country&gt;
      &lt;/sx:onRecord&gt;
    &lt;/countries&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

      </pre>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml  -r resources-batches.xml countries 
  rootName=countries

        </pre><p>
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e1763"></a>Writing Records to Batch Files, and Converting the Batches to Separate
  XML Files
      </h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1766"></a>
      <a class="indexterm" name="d4e1769"></a>
      <p>
The example illustrates an alternative way of producing XML in batches, in two
steps:
      </p>
      <div class="itemizedlist"><ul type="disc"><li>
          <p>First, split a large flat file into a number of smaller
                  flat files.
          </p>
        </li><li>
          <p>Second, convert each of the smaller flat files to XML.
          </p>
        </li></ul></div>
      <p>Suppose you want to convert the countries.csv file containing 245 country
records to XML, each country record mapped to one country subtree, and the
output spilt over multiple XML files.
      </p>
      <p>
The first step is to produce the batched csv files and output them to an
intermediate directory.
      </p>
      <div class="figure"><a name="countries-d.csv"></a><p class="title"><b>Figure&nbsp;123.&nbsp;Batched intermediate CSV files.</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
06/12/2007  07:24 PM    &lt;DIR&gt;          .
06/12/2007  07:24 PM    &lt;DIR&gt;          ..
06/12/2007  07:24 PM               814 countries-1.csv
06/12/2007  07:24 PM               795 countries-2.csv
06/12/2007  07:24 PM               786 countries-3.csv
06/12/2007  07:24 PM               784 countries-4.csv
06/12/2007  07:24 PM               793 countries-5.csv

        </pre>
      </div></div><br class="figure-break">
      <p>
The second step is to read all the csv files in the intermediate directory and serialize them to XML.
      </p>

      <div class="figure"><a name="countries-d.xml"></a><p class="title"><b>Figure&nbsp;124.&nbsp;Batched XML files.</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
06/12/2007  07:37 PM    &lt;DIR&gt;          .
06/12/2007  07:37 PM    &lt;DIR&gt;          ..
06/12/2007  07:37 PM             3,773 countries-1.xml
06/12/2007  07:37 PM             3,758 countries-2.xml
06/12/2007  07:37 PM             3,747 countries-3.xml
06/12/2007  07:37 PM             3,753 countries-4.xml
06/12/2007  07:37 PM             3,416 countries-5.xml

        </pre>
      </div></div><br class="figure-break">
      <p>
The following resources script performs both steps.
      </p>
      <pre class="programlisting">
        
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="countries"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:fileSource file="data/{$rootName}.csv"/&gt;
        &lt;sx:flatFile ref="countriesFile"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;sx:batchedRecordWriter batchSize="50"&gt;
        &lt;sx:flatFileWriter&gt;
          &lt;sx:fileSink file="intermediate/{$rootName}-{$sx:batchSequenceNumber}.csv"/&gt;
          &lt;sx:flatFile ref="countriesFile"/&gt;
        &lt;/sx:flatFileWriter&gt;
      &lt;/sx:batchedRecordWriter&gt;
    &lt;/sx:recordStream&gt;

    &lt;sx:recordStream&gt;
      &lt;sx:directoryReader directory="intermediate"&gt;
        &lt;sx:fileFilter pattern="countries.*[.]csv"/&gt;
      &lt;/sx:directoryReader&gt;
      &lt;sx:processRecord&gt;
        &lt;sx:parameter name="output-file"&gt;
          &lt;sx:findAndReplace searchFor ="(countries.*)[.]csv" replaceWith ="$1.xml"&gt;
            &lt;sx:toString value="{name}"/&gt;
          &lt;/sx:findAndReplace&gt;
        &lt;/sx:parameter&gt;
        &lt;sx:serialize&gt;
          &lt;sx:xsltSerializer&gt;
            &lt;sx:fileSink directory="output" file="{$output-file}"/&gt;
          &lt;/sx:xsltSerializer&gt;
          &lt;sx:transform&gt;
            &lt;sx:content ref="countries"/&gt;
          &lt;/sx:transform&gt;
        &lt;/sx:serialize&gt;
      &lt;/sx:processRecord&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="countries"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:fileSource directory="{parentDirectory}" file="{name}"/&gt;
      &lt;sx:flatFile ref="countriesFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="countriesToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="countriesFile"&gt;
    &lt;sx:commentStarter value="#"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType name="country"&gt;
        &lt;sx:fieldDelimiter value=","/&gt;
        &lt;sx:delimitedField name="code"/&gt;
        &lt;sx:delimitedField name="name" trimLeading="true"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="countriesToXmlMapping"&gt;
    &lt;countries&gt;
      &lt;sx:onRecord&gt;
        &lt;country&gt;
          &lt;sx:fieldElementMap field="name" element="countryName"/&gt;
          &lt;sx:fieldAttributeMap field="code" attribute="countryCode"/&gt;
        &lt;/country&gt;
      &lt;/sx:onRecord&gt;
    &lt;/countries&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

      </pre>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml  -r resources-batchRecords.xml countries 
  rootName=countries

        </pre><p>
      </p>
    </div>
  </div>

  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e1791"></a>Many XML Documents</h3></div></div></div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e1793"></a>Flat File to Summary and Detail XML Documents (eobclaims)</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1796"></a>
      <p> This example requires reading the flat file
      </p>
      <pre class="programlisting">
        
  ADM2301EOBS
  HDR06/13/08200815501300101MEMBER01          BISHOP         
  ADR1234 TEST DR                                                                                       ARVADA            
  HDR06/13/08200815501300102MEMBER02          BISHOP         
  ADR5678 TEST DR                                                                                       ARVADA            
  TLRTOTAL EOBS GENERATED: 0000001000000000000010000018                                                                                                                                                                                                                                                       
  
      </pre>
      <p>and producing this output:
      </p>
      <div class="itemizedlist"><ul type="disc"><li>
          <p>One summary XML document capturing the header ("ADM") and
        trailer ("TLR") records
          </p>
          <pre class="programlisting">
            <code class="filename">eobinputoutput.xml</code>
          </pre>
        </li><li>
          <p>Separate XML documents for each pair of "HDR" and "ADR"
                records
          </p>
          <pre class="programlisting">
            <code class="filename">eobinputoutput-061308200815501300101.xml</code>
            <code class="filename">eobinputoutput-061308200815501300102.xml</code>
          </pre>
        </li></ul></div>
      <p>The summary XML document is to look like
      </p>
      <pre class="programlisting">
        
  &lt;?xml version="1.0" encoding="UTF-8"?&gt;
  &lt;eobs&gt;
     &lt;ADMIN_RECTYPE record_type="ADM"&gt;
        &lt;ADM_0001_TEXT&gt;2301EOBS&lt;/ADM_0001_TEXT&gt;
     &lt;/ADMIN_RECTYPE&gt;
     &lt;TLR-REC-TYPE record_type="TLR"&gt;
        &lt;TLR_0001_TEXT&gt;TOTAL EOBS GENERATED: 0&lt;/TLR_0001_TEXT&gt;
        &lt;TLR_0001_COUNT&gt;0000010&lt;/TLR_0001_COUNT&gt;
        &lt;FILLER&gt;00000000000010000018&lt;/FILLER&gt;
     &lt;/TLR-REC-TYPE&gt;
  &lt;/eobs&gt;
  
      </pre>
      <p>and the first detail documents as
      </p>
      <pre class="programlisting">
        
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;eob&gt;
   &lt;HEADER_RECTYPE record_type="HDR"&gt;
      &lt;HDR_STMT_DATE&gt;06/13/08&lt;/HDR_STMT_DATE&gt;
      &lt;HDR_CLAIM_NUMBER&gt;200815501300101&lt;/HDR_CLAIM_NUMBER&gt;
      &lt;HDR_PATIENT_NAME_FIRST&gt;MEMBER01&lt;/HDR_PATIENT_NAME_FIRST&gt;
      &lt;HDR_PATIENT_NAME_MIDDLE/&gt;
      &lt;HDR_PATIENT_NAME_LAST&gt;BISHOP&lt;/HDR_PATIENT_NAME_LAST&gt;
   &lt;/HEADER_RECTYPE&gt;
   &lt;ADR_REC_TYPE record_type="ADR"&gt;
      &lt;ADR_8512_ATTN&gt;1234 TEST DR&lt;/ADR_8512_ATTN&gt;
      &lt;ADR_8513_STREET1/&gt;
      &lt;ADR_8513_STREET2/&gt;
      &lt;ADR_8514_CITY&gt;ARVADA&lt;/ADR_8514_CITY&gt;
   &lt;/ADR_REC_TYPE&gt;
&lt;/eob&gt;
  
      </pre>
      <p>Below is the required resources script.  Since the structure of the
    record input will be shared with another example, we'll collect that in a
    separate script and include it in the main one.
      </p>
      <div class="figure"><a name="resource-eobclaims-flatfile.xml"></a><p class="title"><b>Figure&nbsp;125.&nbsp;Record structure resource-eobclaims-flatfile.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:flatFile id="eobclaims-file"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="eobclaims-record"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatRecordTypeChoice id="eobclaims-record"&gt;
    &lt;sx:positionalField name="record_type" width="3"/&gt;
    &lt;sx:when test="record_type='ADM'"&gt;
      &lt;sx:flatRecordType ref="adm"/&gt;
    &lt;/sx:when&gt;
    &lt;sx:when test="record_type='HDR'"&gt;
      &lt;sx:flatRecordType ref="hdr"/&gt;
    &lt;/sx:when&gt;
    &lt;sx:when test="record_type='ADR'"&gt;
      &lt;sx:flatRecordType ref="adr"/&gt;
    &lt;/sx:when&gt;
    &lt;sx:when test="record_type='TLR'"&gt;
      &lt;sx:flatRecordType ref="tlr"/&gt;
    &lt;/sx:when&gt;
  &lt;/sx:flatRecordTypeChoice&gt;

  &lt;sx:flatRecordType id="adm" name="ADM"&gt;
    &lt;sx:positionalField name="record_type" width="3"/&gt;
    &lt;sx:positionalField name="ADM_0001_TEXT" width="20"/&gt;
    &lt;sx:positionalField name="ADM_0001_RUN_DATE" width="249"/&gt;
    &lt;sx:positionalField name="FILLER" width="8"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatRecordType id="tlr" name="TLR"&gt;
    &lt;sx:positionalField name="record_type" width="3"/&gt;
    &lt;sx:positionalField name="TLR_0001_TEXT" width="23"/&gt;
    &lt;sx:positionalField name="TLR_0001_COUNT" width="7"/&gt;
    &lt;sx:positionalField name="FILLER" width="268"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatRecordType id="hdr" name="HDR"&gt;
    &lt;sx:positionalField name="record_type" width="3"/&gt;
    &lt;sx:positionalField name="HDR_STMT_DATE" width="8"/&gt;
    &lt;sx:positionalField name="HDR_CLAIM_NUMBER" width="15"/&gt;
    &lt;sx:positionalField name="HDR_PATIENT_NAME_FIRST" width="18"/&gt;
    &lt;sx:positionalField name="HDR_PATIENT_NAME_LAST" width="15"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatRecordType id="adr" name="ADR"&gt;
    &lt;sx:positionalField name="record_type" width="3"/&gt;
    &lt;sx:positionalField name="ADR_8512_ATTN" width="99"/&gt;
    &lt;sx:positionalField name="ADR_8514_CITY" start="103" width="18"/&gt;
  &lt;/sx:flatRecordType&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <div class="figure"><a name="resource-eobclaims.xml"></a><p class="title"><b>Figure&nbsp;126.&nbsp;Main resources script resource-eobclaims.xml</b></p><div class="figure-contents">
        
        <pre class="programlisting">
          
&lt;?xml version="1.0"?&gt;

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:include href="resources-eobclaims-flatfile.xml"/&gt;

  &lt;sx:service id="eobclaims-to-xml"&gt;
    &lt;!-- Do the header/trailer first --&gt;
    &lt;sx:serialize&gt;
      &lt;sx:xsltSerializer&gt;
        &lt;sx:fileSink directory="output" file="eobinputoutput.xml"/&gt;
        &lt;sx:outputProperty name="indent" value="yes"/&gt;
      &lt;/sx:xsltSerializer&gt;
      &lt;sx:transform&gt;
        &lt;sx:recordContent&gt;
          &lt;sx:flatFileReader&gt;
            &lt;sx:flatFile ref="eobclaims-file"/&gt;
          &lt;/sx:flatFileReader&gt;
          &lt;sx:recordMapping ref="eobclaims-header-trailer-mapping"/&gt;
        &lt;/sx:recordContent&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;

    &lt;!-- Now do the body --&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:flatFile ref="eobclaims-file"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;!-- Compose a composite record out of each HDR-ADR pair --&gt;
      &lt;sx:combineRecords recordType="composite" repeatingGroup="eob"
                  startTest="sx:current/HDR"
                  endTest="sx:previous/ADR"&gt;
        &lt;sx:newField name="HDR_STMT_DATE" select="eob/HDR/HDR_STMT_DATE"/&gt;
        &lt;sx:newField name="HDR_CLAIM_NUMBER" select="eob/HDR/HDR_CLAIM_NUMBER"/&gt;
      &lt;/sx:combineRecords&gt;
      &lt;!-- Discard the records that are not HDR-ADR pairs --&gt;
      &lt;sx:restrictRecordFilter&gt;
        &lt;sx:recordRestriction recordType="composite"/&gt;
      &lt;/sx:restrictRecordFilter&gt;
      &lt;!-- Process each HDR-ADR composite record --&gt;
      &lt;sx:processRecord&gt;
        &lt;!-- Construct and store the output filename in the parameter "output-file" --&gt;
        &lt;sx:parameter name="output-file"&gt;
          &lt;sx:findAndReplace searchFor="/" replaceWith =""&gt;
            &lt;sx:toString value="eobinputoutput-{HDR_STMT_DATE}{HDR_CLAIM_NUMBER}.xml"/&gt;
          &lt;/sx:findAndReplace&gt;
        &lt;/sx:parameter&gt;

        &lt;sx:serialize&gt;
          &lt;sx:xsltSerializer&gt;
            &lt;sx:fileSink directory="output" file="{$output-file}"/&gt;
            &lt;sx:outputProperty name="indent" value="yes"/&gt;
          &lt;/sx:xsltSerializer&gt;
          &lt;sx:transform&gt;
            &lt;sx:recordContent&gt;
              &lt;sx:recordMapping ref="eobclaims-body-mapping"/&gt;
            &lt;/sx:recordContent&gt;
          &lt;/sx:transform&gt;
        &lt;/sx:serialize&gt;
      &lt;/sx:processRecord&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordMapping id="eobclaims-header-trailer-mapping"&gt;
    &lt;eobs&gt;
      &lt;sx:onRecord recordType="ADM"&gt;
        &lt;ADMIN_RECTYPE record_type="ADM"&gt;
          &lt;sx:fieldElementMap field="ADM_0001_TEXT" element="ADM_0001_TEXT"/&gt;
        &lt;/ADMIN_RECTYPE&gt;
      &lt;/sx:onRecord&gt;
      &lt;sx:onRecord recordType="TLR"&gt;
        &lt;TLR-REC-TYPE record_type="TLR"&gt;
          &lt;sx:fieldElementMap field="TLR_0001_TEXT" element="TLR_0001_TEXT"/&gt;
          &lt;sx:fieldElementMap field="TLR_0001_COUNT" element="TLR_0001_COUNT"/&gt;
          &lt;sx:fieldElementMap field="FILLER" element="FILLER"/&gt;
        &lt;/TLR-REC-TYPE&gt;
      &lt;/sx:onRecord&gt;
    &lt;/eobs&gt;
  &lt;/sx:recordMapping&gt;

  &lt;sx:recordMapping id="eobclaims-body-mapping"&gt;
    &lt;eob&gt;
      &lt;!-- Our composite record has a repeating group field, "eob", 
           that has two sub-records, "HDR" and "ADR" --&gt;
      &lt;sx:onRecord recordType="composite"&gt;
        &lt;sx:subrecordMapping repeatingGroup="eob"&gt;
          &lt;sx:onRecord recordType="HDR"&gt;
            &lt;HEADER_RECTYPE&gt;
              &lt;sx:fieldAttributeMap field="record_type" attribute="record_type"/&gt;
              &lt;sx:fieldElementMap field="HDR_STMT_DATE" element="HDR_STMT_DATE"/&gt;
              &lt;sx:fieldElementMap field="HDR_CLAIM_NUMBER" element="HDR_CLAIM_NUMBER"/&gt;
              &lt;sx:fieldElementMap field="HDR_PATIENT_NAME_FIRST" element="HDR_PATIENT_NAME_FIRST"/&gt;
              &lt;sx:fieldElementMap field="HDR_PATIENT_NAME_MIDDLE" element="HDR_PATIENT_NAME_MIDDLE"/&gt;
              &lt;sx:fieldElementMap field="HDR_PATIENT_NAME_LAST" element="HDR_PATIENT_NAME_LAST"/&gt;
            &lt;/HEADER_RECTYPE&gt;
          &lt;/sx:onRecord&gt;
          &lt;sx:onRecord recordType="ADR"&gt;
            &lt;ADR_REC_TYPE&gt;
              &lt;sx:fieldAttributeMap field="record_type" attribute="record_type"/&gt;
              &lt;sx:fieldElementMap field="ADR_8512_ATTN" element="ADR_8512_ATTN"/&gt;
              &lt;sx:fieldElementMap field="ADR_8513_STREET1" element="ADR_8513_STREET1"/&gt;
              &lt;sx:fieldElementMap field="ADR_8513_STREET2" element="ADR_8513_STREET2"/&gt;
              &lt;sx:fieldElementMap field="ADR_8514_CITY" element="ADR_8514_CITY"/&gt;
            &lt;/ADR_REC_TYPE&gt;
          &lt;/sx:onRecord&gt;
        &lt;/sx:subrecordMapping&gt;
      &lt;/sx:onRecord&gt;
    &lt;/eob&gt;
  &lt;/sx:recordMapping&gt;

&lt;/sx:resources&gt;

        </pre>
      </div></div><br class="figure-break">
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -i data/eobclaims.txt -r resources-eobclaims.xml eobclaims-to-xml

        </pre><p>
      </p>
    </div>
  </div>
  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e1825"></a>Many Flat Input Files</h3></div></div></div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e1827"></a>Multiple XML Readers</h4></div></div></div>
      
      
      <a class="indexterm" name="d4e1830"></a>
      <p>This example shows a resources script that maps a primary input file
        to XML, with lookups from a secondary file.
      </p>
      <p>
The primary input file is the pipe delimited file,
<code class="filename">primary-input.txt</code>.
      </p>
        <pre class="programlisting">
          
HDR|a|b 
DET|a|b 
DET|a|b 
MSG|1|a 
MSG|3|a 
END 

        </pre>
      <p>
The secondary input file is the pipe delimited file,                                                
<code class="filename">messages.txt</code>,
      </p>
        <pre class="programlisting">
          
1|test message 1 
2|test message 2 
3|test message 3 

        </pre>
      <p>
You need to read the primary input file and replace the <code class="sgmltag-element">id</code> 
        tag values under 
message with the message corresponding to the id. The expected output is
      </p>
        <pre class="programlisting">
          
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;mytest&gt;
  &lt;field1&gt;a&lt;/field1&gt;
  &lt;field2&gt;b&lt;/field2&gt;
  &lt;detail&gt;
    &lt;field1&gt;a&lt;/field1&gt;
    &lt;field2&gt;b&lt;/field2&gt;
  &lt;/detail&gt;
  &lt;detail&gt;
    &lt;field1&gt;a&lt;/field1&gt;
    &lt;field2&gt;b&lt;/field2&gt;
  &lt;/detail&gt;
  &lt;message&gt;
    &lt;message&gt;test message 1&lt;/message&gt;
    &lt;field2&gt;a&lt;/field2&gt;
  &lt;/message&gt;
  &lt;message&gt;
    &lt;message&gt;test message 3&lt;/message&gt;
    &lt;field2&gt;a&lt;/field2&gt;
  &lt;/message&gt;
&lt;/mytest&gt;

        </pre>
      <p>
      </p>
      <p>The required resources script is
      </p>
      <pre class="programlisting">
        
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:msv="http://www.servingxml.com/extensions/msv"&gt;

  &lt;sx:service id="multiple-reader-test"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:xsltSerializer&gt;
        &lt;sx:outputProperty name="indent" value="yes"/&gt;
      &lt;/sx:xsltSerializer&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="multiple-reader-content"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="multiple-reader-content"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:flatFile ref="primary-file"/&gt;
      &lt;/sx:flatFileReader&gt;
    &lt;/sx:recordStream&gt;
    &lt;sx:recordMapping ref="primary-file-to-xml"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="primary-file"&gt;
    &lt;sx:commentStarter value="#"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:fieldDelimiter value="|"/&gt;
        &lt;sx:delimitedField name="tag"/&gt;
        &lt;sx:when test="tag='HDR'"&gt;
          &lt;sx:flatRecordType name="header"&gt;
            &lt;sx:delimitedField name="tag"/&gt;
            &lt;sx:delimitedField name="field1"/&gt;
            &lt;sx:delimitedField name="field2"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="tag='DET'"&gt;
          &lt;sx:flatRecordType name="detail"&gt;
            &lt;sx:delimitedField name="tag"/&gt;
            &lt;sx:delimitedField name="field1"/&gt;
            &lt;sx:delimitedField name="field2"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="tag='MSG'"&gt;
          &lt;sx:flatRecordType name="message"&gt;
            &lt;sx:delimitedField name="tag"/&gt;
            &lt;sx:delimitedField name="field1"/&gt;
            &lt;sx:delimitedField name="field2"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:recordMapping id="primary-file-to-xml"&gt;
    &lt;mytest&gt;
      &lt;sx:onRecord recordType="header"&gt;
        &lt;sx:fieldElementMap field="field1" element="field1"/&gt;
        &lt;sx:fieldElementMap field="field2" element="field2"/&gt;
      &lt;/sx:onRecord&gt;
      &lt;sx:onRecord recordType="detail"&gt;
        &lt;detail&gt;
          &lt;sx:fieldElementMap field="field1" element="field1"/&gt;
          &lt;sx:fieldElementMap field="field2" element="field2"/&gt;
        &lt;/detail&gt;
      &lt;/sx:onRecord&gt;
      &lt;sx:onRecord recordType="message"&gt;
        &lt;message&gt;
          &lt;sx:parameter name="my-id" value="{field1}"/&gt;
          &lt;sx:fieldElementMap select="document('messageContent')/messages/message[id=$my-id]/description" element="message"/&gt;
          &lt;sx:fieldElementMap field="field2" element="field2"/&gt;
        &lt;/message&gt;
      &lt;/sx:onRecord&gt;
    &lt;/mytest&gt;
  &lt;/sx:recordMapping&gt;

  &lt;sx:recordContent id="messageContent" name="messages"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:urlSource url="messages.txt"/&gt;
        &lt;sx:flatFile ref="messagesFile"/&gt;
      &lt;/sx:flatFileReader&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="messagesFile" name="messages"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:fieldDelimiter value="|"/&gt;
      &lt;sx:flatRecordType name="message"&gt;
        &lt;sx:delimitedField name="id"/&gt;
        &lt;sx:delimitedField name="description"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

&lt;/sx:resources&gt;

      </pre>
      <p>
You can run this example on the command line by entering
        </p><pre class="programlisting">
          
servingxml -i primary-input.txt -r resources.xml -o output.xml multiple-reader-test

        </pre><p>
      </p>
    </div>
  </div>
</div>



<div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d4e1848"></a>XML to Flat File</h2></div></div></div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e1850"></a>Converting an XML document to a positional flat file with record count in trailer (books-positional)</h3></div></div></div>


<a class="indexterm" name="d4e1853"></a>
<a class="indexterm" name="d4e1856"></a>
<p>
The example below illustrates how to prepare a resources script that will convert an 
XML document into a positional flat file, and include the record count in a trailer section.  
</p>
<p>
The input file is an XML file.
</p>
<div class="figure"><a name="books.xml"></a><p class="title"><b>Figure&nbsp;127.&nbsp;Input XML file books.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;myns:books xmlns:myns="http://mycompany.com/mynames/"&gt;
  &lt;myns:book categoryCode="F"&gt;
    &lt;myns:title&gt;Kafka on the Shore&lt;/myns:title&gt;
    &lt;myns:author&gt;Haruki Murakami&lt;/myns:author&gt;
    &lt;myns:price&gt;25.17&lt;/myns:price&gt;
  &lt;/myns:book&gt;
  &lt;myns:book categoryCode="C"&gt;
    &lt;myns:title&gt;Concurrent Programming in Java&lt;/myns:title&gt;
    &lt;myns:author&gt;Doug Lea&lt;/myns:author&gt;
    &lt;myns:price&gt;77.13&lt;/myns:price&gt;
  &lt;/myns:book&gt;
&lt;/myns:books&gt;

</pre>
</div></div><br class="figure-break">
<p>
The desired output is shown below.
</p>
<div class="figure"><a name="books.txt"></a><p class="title"><b>Figure&nbsp;128.&nbsp;Output positional flat file books.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

CAuthor                        Title                              Price

FHaruki Murakami               Kafka on the Shore                 25.17
CDoug Lea                      Concurrent Programming in Java     77.13


Number of records: 2

</pre>
</div></div><br class="figure-break">
<p>
  The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-books.xml"></a><p class="title"><b>Figure&nbsp;129.&nbsp;Resources script resources-books.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:myns="http://mycompany.com/mynames/"&gt;

  &lt;sx:service id="books2pos"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:subtreeRecordReader&gt;
        &lt;sx:inverseRecordMapping ref="booksToFileMapping"/&gt;
        &lt;sx:transform&gt;
          &lt;sx:document/&gt;
        &lt;/sx:transform&gt;
      &lt;/sx:subtreeRecordReader&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="booksFile"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="booksFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="bookType"/&gt;
      &lt;sx:annotationRecord/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="bookType"/&gt;
    &lt;/sx:flatFileBody&gt;
    &lt;sx:flatFileTrailer&gt;
      &lt;sx:annotationRecord&gt;&lt;/sx:annotationRecord&gt;
      &lt;sx:flatRecordType ref="trailer"/&gt;
    &lt;/sx:flatFileTrailer&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatRecordType id="bookType" name="bookType"&gt;
    &lt;sx:positionalField name="category" label="Category" width="1"/&gt;
    &lt;sx:positionalField name="author" label="Author" width="30"/&gt;
    &lt;sx:positionalField name="title" label="Title" width="30"/&gt;
    &lt;sx:positionalField name="price" label="Price" width="10" justify="right"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatRecordType id="trailer" name="trailer"&gt;
    &lt;sx:positionalField name="recordCountLabel" width="19" label="Number of records: "/&gt;
    &lt;sx:positionalField name="recordCount"  width="10" label="{$sx:recordCount}"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:inverseRecordMapping id="booksToFileMapping"&gt;
    &lt;sx:onSubtree path="/myns:books/myns:book"&gt;
      &lt;sx:flattenSubtree recordType="book"&gt;
        &lt;sx:subtreeFieldMap select="myns:title" field="title"/&gt;
        &lt;sx:subtreeFieldMap select="@categoryCode" field="category"/&gt;
        &lt;sx:subtreeFieldMap select="myns:author" field="author"/&gt;
        &lt;sx:subtreeFieldMap select="myns:price" field="price"/&gt;
      &lt;/sx:flattenSubtree&gt;
    &lt;/sx:onSubtree&gt;
  &lt;/sx:inverseRecordMapping&gt;
&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>
Note the following:
</p><div class="itemizedlist"><ul type="disc"><li><p>In header and trailer sections, the <code class="sgmltag-attribute">label</code> attributes of fields are treated as data values.
  </p></li><li><p>In a <a class="link" href="../guide/index.html#sx:positionalField" target="_top">sx:positionalField</a> element, the value of the <code class="sgmltag-attribute">label</code> 
  attribute can contain references to parameters, in
  particular to <code class="code">$sx:recordCount</code>, which is a parameter that the file record writer adds after finishing writing records.
  </p></li></ul></div><p>
</p>
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources-books2pos.xml -i data/books.xml 
    -o output/books.txt books2pos

</pre><p>
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e1884"></a>Converting an XML document with multiple occurances of an element to a CSV file (books-csv)</h3></div></div></div>


<a class="indexterm" name="d4e1887"></a>
<p>
This example shows one way to prepare a resources script that will convert an 
XML document having multiple occurances of an element into a CSV file.  
</p>
<p>
The input file is an XML file with multiple occurances of the element <code class="sgmltag-element">myns:review</code>.
</p>
<div class="figure"><a name="books-with-reviews.xml"></a><p class="title"><b>Figure&nbsp;130.&nbsp;Input XML file books.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;myns:books xmlns:myns="http://mycompany.com/mynames/"&gt;
  &lt;myns:book categoryCode="F"&gt;
    &lt;myns:title&gt;Factotum&lt;/myns:title&gt;
    &lt;myns:author&gt;Charles Bukowski&lt;/myns:author&gt;
    &lt;myns:price/&gt;
    &lt;myns:reviews&gt;
      &lt;myns:review&gt;*****&lt;/myns:review&gt;
      &lt;myns:review&gt;*&lt;/myns:review&gt;
    &lt;/myns:reviews&gt;
  &lt;/myns:book&gt;
  &lt;myns:book categoryCode="F"&gt;
    &lt;myns:title&gt;Kafka on the Shore&lt;/myns:title&gt;
    &lt;myns:author&gt;Haruki Murakami&lt;/myns:author&gt;
    &lt;myns:price&gt;25.17&lt;/myns:price&gt;
    &lt;myns:reviews&gt;
      &lt;myns:review&gt;*****&lt;/myns:review&gt;
      &lt;myns:review&gt;****&lt;/myns:review&gt;
    &lt;/myns:reviews&gt;
  &lt;/myns:book&gt;
  &lt;myns:book categoryCode="F"&gt;
    &lt;myns:title&gt;Mr Mee&lt;/myns:title&gt;
    &lt;myns:author&gt;Andrew Crumey&lt;/myns:author&gt;
    &lt;myns:price&gt;22.00&lt;/myns:price&gt;
    &lt;myns:reviews&gt;
      &lt;myns:review&gt;*****&lt;/myns:review&gt;
      &lt;myns:review&gt;*&lt;/myns:review&gt;
    &lt;/myns:reviews&gt;
  &lt;/myns:book&gt;
  &lt;myns:book categoryCode="C"&gt;
    &lt;myns:title&gt;Concurrent Programming in Java&lt;/myns:title&gt;
    &lt;myns:author&gt;Doug Lea&lt;/myns:author&gt;
    &lt;myns:price&gt;77.13&lt;/myns:price&gt;
    &lt;myns:reviews&gt;
      &lt;myns:review&gt;****&lt;/myns:review&gt;
    &lt;/myns:reviews&gt;
  &lt;/myns:book&gt;
  &lt;myns:book categoryCode="B"&gt;
    &lt;myns:title&gt;Sex, Lies, and Headlocks&lt;/myns:title&gt;
    &lt;myns:author&gt;Shaun Assael&lt;/myns:author&gt;
    &lt;myns:price&gt;7.24 &lt;/myns:price&gt;
    &lt;myns:reviews&gt;
      &lt;myns:review&gt;****&lt;/myns:review&gt;
    &lt;/myns:reviews&gt;
  &lt;/myns:book&gt;
&lt;/myns:books&gt;

</pre>
</div></div><br class="figure-break">
<p>
The desired output is shown below.
</p>
<div class="figure"><a name="books-csv.txt"></a><p class="title"><b>Figure&nbsp;131.&nbsp;Output CSV file books.csv</b></p><div class="figure-contents">
  
<pre class="programlisting">

Category,Author,Title,Price,Review 1,Review 2
F,Charles Bukowski,Factotum,,*****,*
F,Haruki Murakami,Kafka on the Shore,25.17,*****,****
F,Andrew Crumey,Mr Mee,22.00,*****,*
C,Doug Lea,Concurrent Programming in Java,77.13,****,
B,Shaun Assael,"Sex, Lies, and Headlocks",7.24 ,****,

</pre>
</div></div><br class="figure-break">
<p>Note that, because it contains embedded commas,
 the title of the last book must be enclosed in quote marks.
</p>
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-books.xml"></a><p class="title"><b>Figure&nbsp;132.&nbsp;Resources script resources-books2csv.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:myns="http://mycompany.com/mynames/"&gt;

  &lt;sx:service id="books2csv"&gt; 
    &lt;sx:recordStream&gt;
      &lt;sx:subtreeRecordReader&gt;
        &lt;sx:inverseRecordMapping ref="booksToFileMapping"/&gt;
        &lt;sx:transform&gt;
          &lt;sx:document/&gt;
        &lt;/sx:transform&gt;
      &lt;/sx:subtreeRecordReader&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="booksFile"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="booksFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="bookType"/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="bookType"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;      

  &lt;sx:flatRecordType id="bookType" name="bookType"&gt;
    &lt;sx:fieldDelimiter value=","/&gt;
    &lt;sx:delimitedField name="category" label="Category"/&gt;
    &lt;sx:delimitedField name="author" label="Author"/&gt;
    &lt;sx:delimitedField name="title" label="Title"/&gt;
    &lt;sx:delimitedField name="price" label="Price"/&gt;
    &lt;sx:delimitedField name="review1" label="Review 1"/&gt;
    &lt;sx:delimitedField name="review2" label="Review 2"/&gt;
  &lt;/sx:flatRecordType&gt;
  
  &lt;sx:inverseRecordMapping id="booksToFileMapping"&gt;
    &lt;sx:onSubtree path="/myns:books/myns:book"&gt;
      &lt;sx:flattenSubtree recordType="book"&gt;
        &lt;sx:subtreeFieldMap select="myns:title" field="title"/&gt;
        &lt;sx:subtreeFieldMap select="@categoryCode" field="category"/&gt;
        &lt;sx:subtreeFieldMap select="myns:author" field="author"/&gt;
        &lt;sx:subtreeFieldMap select="myns:price" field="price"/&gt;
        &lt;sx:subtreeFieldMap select="myns:reviews/myns:review[1]" field="review1"/&gt;
        &lt;sx:subtreeFieldMap select="myns:reviews/myns:review[2]" field="review2"/&gt;
      &lt;/sx:flattenSubtree&gt;
    &lt;/sx:onSubtree&gt;
  &lt;/sx:inverseRecordMapping&gt;
  
&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -o output/persons.xml -r resources-persons.xml 
    personsAddresses 

</pre><p>
</p>
</div>

<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e1907"></a>Converting an XML document with multiple occurances of an element to a flat file with subfield delimiters (books-pipe)</h3></div></div></div>


<a class="indexterm" name="d4e1910"></a>
<a class="indexterm" name="d4e1913"></a>
<a class="indexterm" name="d4e1916"></a>
<p>
This example shows another way of writing a resources script that will convert an 
XML document having multiple occurances of an element into a delimited flat file.  
</p>
<p>
The <a class="xref" href="#books-with-reviews.xml" title="Figure&nbsp;130.&nbsp;Input XML file books.xml">XML input file</a> is the same as the previous example.
The desired output, though, is slightly different.
</p>
<div class="figure"><a name="books-pipe.txt"></a><p class="title"><b>Figure&nbsp;133.&nbsp;Output pipe delimited flat file books-pipe.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

Category|Author|Title|Price|review
Fiction|Charles Bukowski|Factotum||*****;*
Fiction|Haruki Murakami|Kafka on the Shore|25.17|*****;****
Fiction|Andrew Crumey|Mr Mee|22.00|*****;*
Computers|Doug Lea|Concurrent Programming in Java|77.13|****
Biography|Shaun Assael|Sex, Lies, and Headlocks|7.24 |****

</pre>
</div></div><br class="figure-break">
<p>
Note the following features of this output.
</p><div class="itemizedlist"><ul type="disc"><li><p>Fields are separated by the pipe delimiter.</p></li><li><p>Ratings appear in a multivalued field separated by semi-colon subfield delimiters.</p></li><li><p>"Fiction" has been substituted for "F", "Computers" for "C", etc.</p></li></ul></div><p>
</p>
<p>
This time the resources script looks like this.
</p>
<div class="figure"><a name="resources-books.xml"></a><p class="title"><b>Figure&nbsp;134.&nbsp;Resources script resources-books2pipe.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:myns="http://mycompany.com/mynames/"&gt;

  &lt;sx:service id="books2pipe"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:subtreeRecordReader&gt;
        &lt;sx:inverseRecordMapping ref="booksToFileMapping"/&gt;
        &lt;sx:transform&gt;
          &lt;sx:document/&gt;
        &lt;/sx:transform&gt;
      &lt;/sx:subtreeRecordReader&gt;

      &lt;sx:choose&gt;
        &lt;sx:when test="category='F'"&gt;
          &lt;sx:modifyRecord&gt;
            &lt;sx:newField name="category" value="Fiction"/&gt;
          &lt;/sx:modifyRecord&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="category='C'"&gt;
          &lt;sx:modifyRecord&gt;
            &lt;sx:newField name="category" value="Computers"/&gt;
          &lt;/sx:modifyRecord&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="category='B'"&gt;
          &lt;sx:modifyRecord&gt;
            &lt;sx:newField name="category" value="Biography"/&gt;
          &lt;/sx:modifyRecord&gt;
        &lt;/sx:when&gt;
      &lt;/sx:choose&gt;
      
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="booksFile"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="booksFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="bookType"/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="bookType"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatRecordType id="bookType" name="bookType"&gt;
    &lt;sx:fieldDelimiter value="|"/&gt;
    &lt;sx:delimitedField name="category" label="Category"/&gt;
    &lt;sx:delimitedField name="author" label="Author"/&gt;
    &lt;sx:delimitedField name="title" label="Title"/&gt;
    &lt;sx:delimitedField name="price" label="Price"/&gt;
    &lt;sx:delimitedField name="review" label="review"&gt;
      &lt;sx:subfieldDelimiter value=";"/&gt;
    &lt;/sx:delimitedField&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:inverseRecordMapping id="booksToFileMapping"&gt;
    &lt;sx:onSubtree path="/myns:books/myns:book"&gt;
      &lt;sx:flattenSubtree recordType="book"&gt;
        &lt;sx:subtreeFieldMap select="myns:title" field="title"/&gt;
        &lt;sx:subtreeFieldMap select="@categoryCode" field="category"/&gt;
        &lt;sx:subtreeFieldMap select="myns:author" field="author"/&gt;
        &lt;sx:subtreeFieldMap select="myns:price" field="price"/&gt;
        &lt;sx:subtreeFieldMap match="myns:reviews/myns:review" select="text()" field="review"/&gt;
      &lt;/sx:flattenSubtree&gt;
    &lt;/sx:onSubtree&gt;                              
  &lt;/sx:inverseRecordMapping&gt;

&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources-books2pipe.xml -i data/books.xml 
    -o output/books-pipe.txt books2pipe

</pre><p>
</p>
</div>

<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e1939"></a>Converting each book entry in books.xml to a list of three records (book-listing)</h3></div></div></div>


<a class="indexterm" name="d4e1942"></a>
<a class="indexterm" name="d4e1945"></a>
<a class="indexterm" name="d4e1948"></a>
<p>
This example shows how to write a resources script that will convert each book entry
in the <code class="filename">books.xml</code> document into a list of three records, the 
first comma separated, and the last two space separated.  
</p>
<p>
The <a class="xref" href="#books-with-reviews.xml" title="Figure&nbsp;130.&nbsp;Input XML file books.xml">XML input file</a> is the same as the previous example.
</p>
<p>
The desired output is follows.
</p>
<div class="figure"><a name="book_listing.txt"></a><p class="title"><b>Figure&nbsp;135.&nbsp;Output flat file book_lisiting.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

"Factotum", Charles Bukowski
Category Fiction
Price $
"Kafka on the Shore", Haruki Murakami
Category Fiction
Price $25.17
"Mr Mee", Andrew Crumey
Category Fiction
Price $22.00
"Concurrent Programming in Java", Doug Lea
Category Computers
Price $77.13
"Sex, Lies, and Headlocks", Shaun Assael
Category Biography
Price $7.24 

</pre>
</div></div><br class="figure-break">
<p>
Note the following features of this output.
</p><div class="itemizedlist"><ul type="disc"><li><p>The categoryCode 'F' is mapped to "Fiction", 'C' to "Computers", 'B' to "Biography".</p></li><li><p>A dollar sign '$' is prepended to the price (even if the price is empty.)</p></li><li><p>Each book title is enclosed in quotation marks.</p></li><li><p>Each book subtree is output as three records; the first delimited by ", ", the second delimited by a space character.</p></li></ul></div><p>
</p>
<p>
This time the resources script looks like this.
</p>
<div class="figure"><a name="resources-book_lisiting.xml"></a><p class="title"><b>Figure&nbsp;136.&nbsp;Resources script resources-book_listing.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:myns="http://mycompany.com/mynames/"&gt;

  &lt;sx:service id="book-listing"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:subtreeRecordReader&gt;
        &lt;sx:inverseRecordMapping ref="booksToFileMapping"/&gt;
        &lt;sx:transform&gt;
          &lt;sx:document/&gt;
        &lt;/sx:transform&gt;
      &lt;/sx:subtreeRecordReader&gt;

      &lt;!-- Convert category code to label --&gt;
      &lt;sx:choose&gt;
        &lt;sx:when test="category='F'"&gt;
          &lt;sx:modifyRecord&gt;
            &lt;sx:newField name="category" value="Fiction"/&gt;
          &lt;/sx:modifyRecord&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="category='C'"&gt;
          &lt;sx:modifyRecord&gt;
            &lt;sx:newField name="category" value="Computers"/&gt;
          &lt;/sx:modifyRecord&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="category='B'"&gt;
          &lt;sx:modifyRecord&gt;
            &lt;sx:newField name="category" value="Biography"/&gt;
          &lt;/sx:modifyRecord&gt;
        &lt;/sx:when&gt;
      &lt;/sx:choose&gt;

      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="booksFile"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="booksFile"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="bookType"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatRecordTypeChoice id="bookType"&gt;
    &lt;sx:delimitedField name="xxx"/&gt;  &lt;!-- unused here, used for input only --&gt;
    &lt;sx:when test="/book"&gt;  &lt;!-- matches against record type "book" --&gt;
      &lt;sx:flatRecordType name="book"&gt;
        &lt;sx:fieldDelimiter value=", "/&gt;
        &lt;sx:delimitedField name="title" quote="always"/&gt;
        &lt;sx:delimitedField name="author"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:when&gt;
    &lt;sx:when test="/bookCategory"&gt;  &lt;!-- matches against record type "bookCategory" --&gt;
      &lt;sx:flatRecordType name="book"&gt;
        &lt;sx:fieldDelimiter value=" "/&gt;
        &lt;sx:delimitedField name="label"/&gt;
        &lt;sx:delimitedField name="category"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:when&gt;
    &lt;sx:when test="/bookPrice"&gt;  &lt;!-- matches against record type "bookPrice" --&gt;
      &lt;sx:flatRecordType name="book"&gt;
        &lt;sx:fieldDelimiter value=" "/&gt;
        &lt;sx:delimitedField name="label"/&gt;
        &lt;sx:delimitedField name="price"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:when&gt;
  &lt;/sx:flatRecordTypeChoice&gt;

  &lt;sx:inverseRecordMapping id="booksToFileMapping"&gt;
    &lt;sx:onSubtree path="/myns:books/myns:book"&gt;
      &lt;sx:flattenSubtree recordType="book"&gt;
        &lt;sx:subtreeFieldMap select="myns:title" field="title"/&gt;
        &lt;sx:subtreeFieldMap select="myns:author" field="author"/&gt;
      &lt;/sx:flattenSubtree&gt;
      &lt;sx:flattenSubtree recordType="bookCategory"&gt;
        &lt;sx:subtreeFieldMap select="'Category'" field="label"/&gt;
        &lt;sx:subtreeFieldMap select="@categoryCode" field="category"/&gt;
      &lt;/sx:flattenSubtree&gt;
      &lt;sx:flattenSubtree recordType="bookPrice"&gt;
        &lt;sx:subtreeFieldMap select="'Price'" field="label"/&gt;
        &lt;!-- Append dollar sign to price --&gt;
        &lt;sx:subtreeFieldMap select="concat('$',myns:price)" field="price"/&gt;
      &lt;/sx:flattenSubtree&gt;
    &lt;/sx:onSubtree&gt;
  &lt;/sx:inverseRecordMapping&gt;

&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources-book_listing.xml -i data/books.xml 
    -o output/book_listing.txt book-listing

</pre><p>
</p>
</div>

<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e1975"></a>Converting an XML document into flat file records with multi-valued fields (swath)</h3></div></div></div>


<a class="indexterm" name="d4e1978"></a>
<a class="indexterm" name="d4e1981"></a>
<p>
This example shows another way of writing a resources script that will convert an 
XML document into flat file records with multi-valued fields.  
</p>
<p>
The input file is an XML file with multiple occurances of the element <code class="sgmltag-element">GeoPoint</code> inside a <code class="sgmltag-element">Swath</code> element.
</p>
<div class="figure"><a name="swath.xml"></a><p class="title"><b>Figure&nbsp;137.&nbsp;Input XML file swath.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;Swath&gt;
  &lt;Shape&gt;Polygon&lt;/Shape&gt;
  &lt;GeoPoint&gt;
    &lt;lat&gt;1&lt;/lat&gt;
    &lt;lon&gt;2&lt;/lon&gt;
  &lt;/GeoPoint&gt;
  &lt;GeoPoint&gt;
    &lt;lat&gt;3&lt;/lat&gt;
    &lt;lon&gt;4&lt;/lon&gt;
  &lt;/GeoPoint&gt;
  &lt;GeoPoint&gt;
    &lt;lat&gt;5&lt;/lat&gt;
    &lt;lon&gt;6&lt;/lon&gt;
  &lt;/GeoPoint&gt;
&lt;/Swath&gt;

</pre>
</div></div><br class="figure-break">
<p>
The desired output is shown below.
</p>
<div class="figure"><a name="swath.txt"></a><p class="title"><b>Figure&nbsp;138.&nbsp;Output pipe delimited flat file swath.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

Shape|GeoPoint
Polygon|1 2;3 4;5 6

</pre>
</div></div><br class="figure-break">
<p>
This time the resources script looks like this.
</p>
<div class="figure"><a name="resources-swath.xml"></a><p class="title"><b>Figure&nbsp;139.&nbsp;Resources script resources-swath2pipe.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="swath"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:subtreeRecordReader&gt;
        &lt;sx:inverseRecordMapping &gt;
          &lt;sx:onSubtree  path="/Swath"&gt;
            &lt;sx:flattenSubtree recordType="hdrType"&gt;
              &lt;sx:subtreeFieldMap select="Shape" field="Shape"/&gt;
              &lt;sx:subtreeFieldMap match="GeoPoint" select="concat(lat,' ',lon)" field="GeoPoint"/&gt;
            &lt;/sx:flattenSubtree&gt;
          &lt;/sx:onSubtree&gt;
        &lt;/sx:inverseRecordMapping&gt;
        &lt;sx:transform&gt;
          &lt;sx:document/&gt;
        &lt;/sx:transform&gt;
      &lt;/sx:subtreeRecordReader&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="swathFlatFile"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="swathFlatFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="hdrType"/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="hdrType"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatRecordType id="hdrType" name="hdrType"&gt;
    &lt;sx:delimitedField name="Shape"&gt;
      &lt;sx:fieldDelimiter value="|"/&gt;
    &lt;/sx:delimitedField&gt;
    &lt;sx:delimitedField name="GeoPoint"&gt;
      &lt;sx:subfieldDelimiter value=";"/&gt;
    &lt;/sx:delimitedField&gt;
  &lt;/sx:flatRecordType&gt;

&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources-swath.xml -i data/swath.xml 
    -o output/swath.txt swath

</pre><p>
</p>
</div>

<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2001"></a>Converting an XML document into a flat file with header and multiple detail records (XML-flat header-detail)</h3></div></div></div>


<a class="indexterm" name="d4e2004"></a>
<a class="indexterm" name="d4e2007"></a>
<p>
This example shows how to write a resources script that will convert an 
XML document into a flat file records with header and multiple detail records.  
</p>
<p>
The input file is an XML file with multiple occurances of the element <code class="sgmltag-element">myns:review</code> inside a <code class="sgmltag-element">myns:book/myns:reviews</code> path.
</p>
<div class="figure"><a name="bookReviews.xml"></a><p class="title"><b>Figure&nbsp;140.&nbsp;Input XML file bookReviews.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;myns:books xmlns:myns="http://mycompany.com/mynames/"&gt;
  &lt;myns:book id="002" categoryCode="F"&gt;
    &lt;myns:title&gt;Kafka on the Shore&lt;/myns:title&gt;
    &lt;myns:author&gt;Haruki Murakami&lt;/myns:author&gt;
    &lt;myns:price&gt;25.17&lt;/myns:price&gt;
    &lt;myns:reviews&gt;
      &lt;myns:review&gt;
        &lt;myns:reviewer&gt;Curley&lt;/myns:reviewer&gt;
        &lt;myns:rating&gt;*****&lt;/myns:rating&gt;
      &lt;/myns:review&gt;
      &lt;myns:review&gt;
        &lt;myns:reviewer&gt;Larry&lt;/myns:reviewer&gt;
        &lt;myns:rating&gt;***&lt;/myns:rating&gt;
      &lt;/myns:review&gt;
      &lt;myns:review&gt;
        &lt;myns:reviewer&gt;Moe&lt;/myns:reviewer&gt;
        &lt;myns:rating&gt;*&lt;/myns:rating&gt;
      &lt;/myns:review&gt;
    &lt;/myns:reviews&gt;
  &lt;/myns:book&gt;
&lt;/myns:books&gt;

</pre>
</div></div><br class="figure-break">
<p>
The desired output is shown below.
</p>
<div class="figure"><a name="bookReviews.txt"></a><p class="title"><b>Figure&nbsp;141.&nbsp;Output positional flat file bookReviews.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

TID CAuthor                        Title                              Price

H002FHaruki Murakami               Kafka on the Shore                 25.17
L002Curley    *****
L002Larry     ***  
L002Moe       *    

This is a trailer record

</pre>
</div></div><br class="figure-break">
<p>
The following resources script does the job.
</p>
<div class="figure"><a name="resources-bookReviews.xml"></a><p class="title"><b>Figure&nbsp;142.&nbsp;Resources script resources-bookReviews.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:myns="http://mycompany.com/mynames/"&gt;

  &lt;sx:service id="bookReviews"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:subtreeRecordReader&gt;
        &lt;sx:inverseRecordMapping ref="booksToFileMapping"/&gt;
        &lt;sx:transform&gt;
          &lt;sx:document/&gt;
        &lt;/sx:transform&gt;
      &lt;/sx:subtreeRecordReader&gt;
    &lt;/sx:recordStream&gt;
    &lt;sx:flatFileWriter&gt;
      &lt;sx:flatFile ref="booksFile"/&gt;
    &lt;/sx:flatFileWriter&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="booksFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="book"/&gt;
      &lt;sx:annotationRecord/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:positionalField name="tag"  width="1"/&gt;
        &lt;sx:when test="tag='H'"&gt;
          &lt;sx:flatRecordType ref="book"/&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="tag='L'"&gt;
          &lt;sx:flatRecordType ref="review"/&gt;
        &lt;/sx:when&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:flatFileBody&gt;
    &lt;sx:flatFileTrailer&gt;
      &lt;sx:annotationRecord&gt;&lt;/sx:annotationRecord&gt;
      &lt;sx:annotationRecord&gt;This is a trailer record&lt;/sx:annotationRecord&gt;
    &lt;/sx:flatFileTrailer&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatRecordType id="book" name="book"&gt;
    &lt;sx:positionalField name="tag" label="Tag" width="1"/&gt;
    &lt;sx:positionalField name="id" label="ID" width="3"/&gt;
    &lt;sx:positionalField name="category" label="Category" width="1"/&gt;
    &lt;sx:positionalField name="author" label="Author" width="30"/&gt;
    &lt;sx:positionalField name="title" label="Title" width="30"/&gt;
    &lt;sx:positionalField name="price" label="Price" width="10" justify="right"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatRecordType id="review" name="review"&gt;
    &lt;sx:positionalField name="tag" label="Tag" width="1"/&gt;
    &lt;sx:positionalField name="id" label="ID" width="3"/&gt;
    &lt;sx:positionalField name="reviewer" label="Reviewer" width="10"/&gt;
    &lt;sx:positionalField name="rating" label="Rating" width="5"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:inverseRecordMapping id="booksToFileMapping"&gt;
    &lt;sx:onSubtree path="/myns:books/myns:book"&gt;
      &lt;sx:parameter name="id" select="@id"/&gt;
      &lt;sx:flattenSubtree recordType="book"&gt;
        &lt;sx:subtreeFieldMap select="'H'" field="tag"/&gt;
        &lt;sx:subtreeFieldMap select="$id" field="id"/&gt;
        &lt;sx:subtreeFieldMap select="myns:title" field="title"/&gt;
        &lt;sx:subtreeFieldMap select="@categoryCode" field="category"/&gt;
        &lt;sx:subtreeFieldMap select="myns:author" field="author"/&gt;
        &lt;sx:subtreeFieldMap select="myns:price" field="price"/&gt;
      &lt;/sx:flattenSubtree&gt;
      &lt;sx:flattenSubtree match="myns:reviews/myns:review" recordType="review"&gt;
        &lt;sx:subtreeFieldMap select="'L'" field="tag"/&gt;
        &lt;sx:subtreeFieldMap select="$id" field="id"/&gt;
        &lt;sx:subtreeFieldMap select="myns:reviewer" field="reviewer"/&gt;
        &lt;sx:subtreeFieldMap select="myns:rating" field="rating"/&gt;
      &lt;/sx:flattenSubtree&gt;
    &lt;/sx:onSubtree&gt;
  &lt;/sx:inverseRecordMapping&gt;
&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml  -r resources-bookReviews.xml -i data/bookReviews.xml 
    -o output/bookReviews.txt bookReviews

</pre><p>
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2027"></a>Breaking up a sequence of elements into flat file records ("sequence")</h3></div></div></div>


<a class="indexterm" name="d4e2030"></a>
<p>
The example below illustrates how to use an XSLT stylesheet in an XML-flat pipeline
to transform the XML into a form that is easier to map.
</p>
<p>
The input file is an XML file containing a sequence of elements.
</p>
<div class="figure"><a name="sequence.xml"></a><p class="title"><b>Figure&nbsp;143.&nbsp;Input XML file sequence.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;root&gt;
  &lt;first&gt;1111&lt;/first&gt;
  &lt;second&gt;AD&lt;/second&gt;
  &lt;third&gt;1111&lt;/third&gt;
  &lt;fourth&gt;1111&lt;/fourth&gt;
  &lt;first&gt;2222&lt;/first&gt;
  &lt;second&gt;MO&lt;/second&gt;
  &lt;third&gt;2222&lt;/third&gt;
  &lt;fourth&gt;2222&lt;/fourth&gt;
&lt;/root&gt;

</pre>
</div></div><br class="figure-break">
<p>The desired output file is shown below.
</p>
<div class="figure"><a name="sequence.csv"></a><p class="title"><b>Figure&nbsp;144.&nbsp;Output CSV file sequence.csv.</b></p><div class="figure-contents">
  
<pre class="programlisting">

1111,AD,1111,1111
2222,MO,2222,2222

</pre>
</div></div><br class="figure-break">
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-sequence.xml"></a><p class="title"><b>Figure&nbsp;145.&nbsp;Resources script resources-sequence.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="sequence-csv"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:subtreeRecordReader&gt;
        &lt;sx:transform&gt;
          &lt;sx:document&gt;
            &lt;sx:fileSource file="data/sequence.xml"/&gt;
          &lt;/sx:document&gt;
          &lt;sx:xslt ref="sequence-hierarchy"/&gt;
        &lt;/sx:transform&gt;
        &lt;sx:inverseRecordMapping ref="sequenceToFileMapping"/&gt;
      &lt;/sx:subtreeRecordReader&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="sequenceFile"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:xslt id="sequence-hierarchy"&gt;
    &lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
      &lt;xsl:template match="/root"&gt;
        &lt;xsl:copy&gt;
          &lt;xsl:apply-templates select="first"/&gt;
        &lt;/xsl:copy&gt;
      &lt;/xsl:template&gt;
      &lt;xsl:template match="first"&gt;
        &lt;PivotNode&gt;
          &lt;first&gt;
            &lt;xsl:value-of select="."/&gt;
          &lt;/first&gt;
          &lt;second&gt;
            &lt;xsl:value-of select="following-sibling::second[1]"/&gt;
          &lt;/second&gt;
          &lt;third&gt;
            &lt;xsl:value-of select="following-sibling::third[1]"/&gt;
          &lt;/third&gt;
          &lt;fourth&gt;
            &lt;xsl:value-of select="following-sibling::fourth[1]"/&gt;
          &lt;/fourth&gt;
        &lt;/PivotNode&gt;
      &lt;/xsl:template&gt;
    &lt;/xsl:stylesheet&gt;
  &lt;/sx:xslt&gt;

  &lt;sx:flatFile id="sequenceFile"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType name="sequence"&gt;
        &lt;sx:fieldDelimiter value=","/&gt;
        &lt;sx:delimitedField name="first"/&gt;
        &lt;sx:delimitedField name="second"/&gt;
        &lt;sx:delimitedField name="third"/&gt;
        &lt;sx:delimitedField name="fourth"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:inverseRecordMapping id="sequenceToFileMapping"&gt;
    &lt;sx:onSubtree path="/root/PivotNode"&gt;
      &lt;sx:flattenSubtree  recordType="sequence"&gt;
        &lt;sx:subtreeFieldMap select="first" field="first"/&gt;
        &lt;sx:subtreeFieldMap select="second" field="second"/&gt;
        &lt;sx:subtreeFieldMap select="third" field="third"/&gt;
        &lt;sx:subtreeFieldMap select="fourth" field="fourth"/&gt;
      &lt;/sx:flattenSubtree&gt;
    &lt;/sx:onSubtree&gt;
  &lt;/sx:inverseRecordMapping&gt;                           

&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml  -o output/sequence.csv -r resources-sequence.xml sequence-csv

</pre><p>
</p>
</div>

<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="special-char-eg"></a>Converting an XML file with hexidecimal encoded values to a flat file with special characters</h3></div></div></div>


<a class="indexterm" name="d4e2051"></a>
<a class="indexterm" name="d4e2053"></a>
<p>                     
The example below illustrates how to prepare a resources script that will convert an 
XML document with hexadecimal encoded values to a flat file with special characters. 
</p>                                                      
<p>
The input XML document is shown below.
</p><div class="figure"><a name="transaction.xml"></a><p class="title"><b>Figure&nbsp;146.&nbsp;Input XML file transaction.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;transaction&gt;
  &lt;R03&gt;
    &lt;firstField&gt;03&lt;/firstField&gt;
    &lt;CLIENUM&gt;1111111&lt;/CLIENUM&gt;
  &lt;/R03&gt;
  &lt;R04&gt;
    &lt;firstField&gt;04&lt;/firstField&gt;
    &lt;NAME&gt;John Smith&lt;/NAME&gt;
  &lt;/R04&gt;
&lt;/transaction&gt;

</pre>
</div></div><p><br class="figure-break">

</p>

<p>
The desired output file is a flat file with two adjacent records (no line delimiters):
</p><div class="itemizedlist"><ul type="disc"><li><p>A record beginning with the hexadecimal value 03, followed by the text "1111111"
  </p></li><li><p>A record beginning with the hexadecimal value 04, followed by the text "John Smith"
  </p></li></ul></div><p>
</p>
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-specialChar.xml"></a><p class="title"><b>Figure&nbsp;147.&nbsp;Resources script resources-specialChar.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="transaction"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:subtreeRecordReader&gt;
        &lt;sx:inverseRecordMapping ref="fieldsMapping"/&gt;
        &lt;sx:transform&gt;
          &lt;sx:document/&gt;
        &lt;/sx:transform&gt;
      &lt;/sx:subtreeRecordReader&gt;
      &lt;sx:flatFileWriter &gt;
        &lt;sx:flatFile ref="transactionFile"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="transactionFile" lineDelimited="false"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:binaryField name="firstField" width="1"/&gt;
        &lt;sx:when test="firstField='03'"&gt;
          &lt;sx:flatRecordType id="R03" name="R03"&gt;
            &lt;sx:binaryField name="firstField" label="firstField" width="1" /&gt;
            &lt;sx:positionalField name="CLIENUM" label="CLIENUM" width="007" /&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="firstField='04'"&gt;
          &lt;sx:flatRecordType id="R04" name="R04"&gt;
            &lt;sx:binaryField name="firstField" label="firstField" width="1" /&gt;
            &lt;sx:positionalField name="NAME" label="NAME" width="020" /&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:inverseRecordMapping id="fieldsMapping"&gt;
    &lt;sx:onSubtree path="/transaction/R03"&gt;
      &lt;sx:flattenSubtree match="/R03" recordType="R03"&gt;
        &lt;sx:subtreeFieldMap select="firstField" field="firstField"/&gt;
        &lt;sx:subtreeFieldMap select="CLIENUM" field="CLIENUM"/&gt;
      &lt;/sx:flattenSubtree&gt;
    &lt;/sx:onSubtree&gt;
    &lt;sx:onSubtree path="/transaction/R04"&gt;
      &lt;sx:flattenSubtree match="/R04" recordType="R04"&gt;
        &lt;sx:subtreeFieldMap select="firstField" field="firstField"/&gt;
        &lt;sx:subtreeFieldMap select="NAME" field="NAME"/&gt;
      &lt;/sx:flattenSubtree&gt;
    &lt;/sx:onSubtree&gt;
  &lt;/sx:inverseRecordMapping&gt;
&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>
Note that the first field of each record is declared as an <a class="link" href="../guide/index.html#sx:binaryField" target="_top">sx:binaryField</a>.
The string rendering of this field is as an hexidecimal value.
</p>
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml  -r resources-specialChar.xml -i data/transaction.xml 
  -o output/transaction.txt transaction

</pre><p>
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2075"></a>Converting an XML document to a positional flat file and ungrouping an XML element (ungrouping)</h3></div></div></div>


<a class="indexterm" name="d4e2078"></a>
<p>
The example below illustrates how to prepare a resources script that will convert an 
XML document into a positional flat file and ungroup an XML element.  
</p>
<p>
The input file is an XML file.
</p>
<div class="figure"><a name="grouped.xml"></a><p class="title"><b>Figure&nbsp;148.&nbsp;Input XML file grouped.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;RT_STLMT&gt;
  &lt;OPERATING_DATE&gt;03/04/2003&lt;/OPERATING_DATE&gt;
  &lt;SETTLEMENT_CODE&gt;S14&lt;/SETTLEMENT_CODE&gt;
  &lt;LINE_ITEMS&gt;
    &lt;CHG_TYP&gt;
      &lt;CHG_TYP_ID&gt;RT_ADMIN1&lt;/CHG_TYP_ID&gt;
      &lt;CHG_TYP_NM&gt;Market Administration Amount1&lt;/CHG_TYP_NM&gt;
      &lt;TOTAL&gt;
        &lt;AMT&gt;288.81&lt;/AMT&gt;
        &lt;INT&gt;
          &lt;INT_NUM&gt;1&lt;/INT_NUM&gt;
          &lt;VAL&gt;54.4&lt;/VAL&gt;
        &lt;/INT&gt;
        &lt;INT&gt;
          &lt;INT_NUM&gt;2&lt;/INT_NUM&gt;
          &lt;VAL&gt;31.16&lt;/VAL&gt;
        &lt;/INT&gt;
        &lt;INT&gt;
          &lt;INT_NUM&gt;3&lt;/INT_NUM&gt;
          &lt;VAL&gt;81.48&lt;/VAL&gt;
        &lt;/INT&gt;
        &lt;INT&gt;
          &lt;INT_NUM&gt;4&lt;/INT_NUM&gt;
          &lt;VAL&gt;121.77&lt;/VAL&gt;
        &lt;/INT&gt;
      &lt;/TOTAL&gt;
    &lt;/CHG_TYP&gt;
    &lt;CHG_TYP&gt;
      &lt;CHG_TYP_ID&gt;RT_ADMIN2&lt;/CHG_TYP_ID&gt;
      &lt;CHG_TYP_NM&gt;Market Administration Amount2&lt;/CHG_TYP_NM&gt;
      &lt;TOTAL&gt;
        &lt;AMT&gt;288.81&lt;/AMT&gt;
        &lt;INT&gt;
          &lt;INT_NUM&gt;1&lt;/INT_NUM&gt;
          &lt;VAL&gt;54.4&lt;/VAL&gt;
        &lt;/INT&gt;
        &lt;INT&gt;
          &lt;INT_NUM&gt;2&lt;/INT_NUM&gt;
          &lt;VAL&gt;31.16&lt;/VAL&gt;
        &lt;/INT&gt;
        &lt;INT&gt;
          &lt;INT_NUM&gt;3&lt;/INT_NUM&gt;
          &lt;VAL&gt;81.48&lt;/VAL&gt;
        &lt;/INT&gt;
        &lt;INT&gt;
          &lt;INT_NUM&gt;4&lt;/INT_NUM&gt;
          &lt;VAL&gt;121.77&lt;/VAL&gt;
        &lt;/INT&gt;
      &lt;/TOTAL&gt;
    &lt;/CHG_TYP&gt;
  &lt;/LINE_ITEMS&gt;
&lt;/RT_STLMT&gt;

</pre>
</div></div><br class="figure-break">
<p>
The desired output is shown below.
</p>
<div class="figure"><a name="ungrouped.csv"></a><p class="title"><b>Figure&nbsp;149.&nbsp;Output positional flat file ungrouped.csv</b></p><div class="figure-contents">
  
<pre class="programlisting">

OPERATING_DATE,SETTLEMENT_CODE,DETERMINANT_ID,DETERMINANT_NAME,TOTAL_AMT,INT01,INT02,INT03,INT04
03/04/2003,S14,RT_ADMIN1,Market Administration Amount1,288.81,54.4,31.16,81.48,121.77
03/04/2003,S14,RT_ADMIN2,Market Administration Amount2,288.81,54.4,31.16,81.48,121.77

</pre>
</div></div><br class="figure-break">
<p>
  The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-ungrouping.xml"></a><p class="title"><b>Figure&nbsp;150.&nbsp;Resources script resources-ungrouping.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core" xmlns:myns="http://mycompany.com/mynames/"&gt;

  &lt;sx:service id="settlements2csv"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:subtreeRecordReader&gt;
        &lt;sx:parameter name="foo"&gt;bar&lt;/sx:parameter&gt;
        &lt;sx:inverseRecordMapping ref="settlementsToFileMapping"/&gt;
        &lt;sx:transform&gt;
          &lt;sx:document/&gt;
        &lt;/sx:transform&gt;
      &lt;/sx:subtreeRecordReader&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="settlementsFile"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="settlementsFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="settlementType"/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="settlementType"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatRecordType id="settlementType" name="settlementType"&gt;
    &lt;sx:fieldDelimiter value=","/&gt;
    &lt;sx:delimitedField name="OPERATING_DATE" label="OPERATING_DATE"/&gt;
    &lt;sx:delimitedField name="SETTLEMENT_CODE" label="SETTLEMENT_CODE"/&gt;
    &lt;sx:delimitedField name="DETERMINANT_ID" label="DETERMINANT_ID"/&gt;
    &lt;sx:delimitedField name="DETERMINANT_NAME" label="DETERMINANT_NAME"/&gt;
    &lt;sx:delimitedField name="TOTAL_AMT" label="TOTAL_AMT"/&gt;
    &lt;sx:delimitedField name="INT01" label="INT01"/&gt;
    &lt;sx:delimitedField name="INT02" label="INT02"/&gt;
    &lt;sx:delimitedField name="INT03" label="INT03"/&gt;
    &lt;sx:delimitedField name="INT04" label="INT04"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:inverseRecordMapping id="settlementsToFileMapping"&gt;
    &lt;sx:onSubtree path="/RT_STLMT"&gt;
      &lt;sx:parameter name="OPERATING_DATE" select="OPERATING_DATE"/&gt;
      &lt;sx:parameter name="SETTLEMENT_CODE" select="SETTLEMENT_CODE"/&gt;
      &lt;sx:parameter name="id" select="@id"/&gt;
      &lt;sx:onSubtree path="LINE_ITEMS/CHG_TYP"&gt;
        &lt;sx:flattenSubtree recordType="settlement"&gt;
          &lt;sx:subtreeFieldMap select="$OPERATING_DATE" field="OPERATING_DATE"/&gt;
          &lt;sx:subtreeFieldMap select="$SETTLEMENT_CODE" field="SETTLEMENT_CODE"/&gt;
          &lt;sx:subtreeFieldMap select="'RT'" field="STLMT_TYP"/&gt;
          &lt;sx:subtreeFieldMap select="CHG_TYP_ID" field="DETERMINANT_ID"/&gt;
          &lt;sx:subtreeFieldMap select="CHG_TYP_NM" field="DETERMINANT_NAME"/&gt;
          &lt;sx:subtreeFieldMap select="TOTAL/AMT" field="TOTAL_AMT"/&gt;
          &lt;sx:subtreeFieldMap select="TOTAL/INT[1]/VAL" field="INT01"/&gt;
          &lt;sx:subtreeFieldMap select="TOTAL/INT[2]/VAL" field="INT02"/&gt;
          &lt;sx:subtreeFieldMap select="TOTAL/INT[3]/VAL" field="INT03"/&gt;
          &lt;sx:subtreeFieldMap select="TOTAL/INT[4]/VAL" field="INT04"/&gt;
        &lt;/sx:flattenSubtree&gt;
      &lt;/sx:onSubtree&gt;
    &lt;/sx:onSubtree&gt;
  &lt;/sx:inverseRecordMapping&gt;
&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>Note the use of nested <a class="link" href="../guide/index.html#sx:onSubtree" target="_top">sx:onSubtree</a> elements, and the <a class="link" href="../guide/index.html#sx:parameter" target="_top">sx:parameter</a>
elements appearing in the outermost <a class="link" href="../guide/index.html#sx:onSubtree" target="_top">sx:onSubtree</a>.  The <code class="sgmltag-attribute">select</code>
attribute in these parameter declarations can refer to the outer tags in the XML document under "/RT_STLMT", but not the
inner tags handled by the inner <a class="link" href="../guide/index.html#sx:onSubtree" target="_top">sx:onSubtree</a> elements.
</p>
<p>An alternative inverse record mapping, which will produce the same output, is shown below.
</p>
<pre class="programlisting">

  &lt;sx:inverseRecordMapping id="settlementsToFileMapping"&gt;
    &lt;sx:onSubtree path="/RT_STLMT"&gt;
      &lt;sx:parameter name="OPERATING_DATE" select="OPERATING_DATE"/&gt;
      &lt;sx:parameter name="SETTLEMENT_CODE" select="SETTLEMENT_CODE"/&gt;
      &lt;sx:parameter name="id" select="@id"/&gt;
      &lt;sx:flattenSubtree match="LINE_ITEMS/CHG_TYP" recordType="settlement"&gt;
        &lt;sx:subtreeFieldMap select="$OPERATING_DATE" field="OPERATING_DATE"/&gt; 
        &lt;sx:subtreeFieldMap select="$SETTLEMENT_CODE" field="SETTLEMENT_CODE"/&gt; 
        &lt;sx:subtreeFieldMap select="'RT'" field="STLMT_TYP"/&gt;
        &lt;sx:subtreeFieldMap select="CHG_TYP_ID" field="DETERMINANT_ID"/&gt;
        &lt;sx:subtreeFieldMap select="CHG_TYP_NM" field="DETERMINANT_NAME"/&gt;
        &lt;sx:subtreeFieldMap select="TOTAL/AMT" field="TOTAL_AMT"/&gt;
        &lt;sx:subtreeFieldMap select="TOTAL/INT[1]/VAL" field="INT01"/&gt;
        &lt;sx:subtreeFieldMap select="TOTAL/INT[2]/VAL" field="INT02"/&gt;
        &lt;sx:subtreeFieldMap select="TOTAL/INT[3]/VAL" field="INT03"/&gt;
        &lt;sx:subtreeFieldMap select="TOTAL/INT[4]/VAL" field="INT04"/&gt;
      &lt;/sx:flattenSubtree&gt;
    &lt;/sx:onSubtree&gt;
  &lt;/sx:inverseRecordMapping&gt;

</pre>
<p>This mapping allows for more flexibility in the <a class="link" href="../guide/index.html#sx:parameter" target="_top">sx:parameter</a> declarations, as the 
<code class="sgmltag-attribute">select</code> attribute can now refer to any content in the XML document 
under "/RT_STLMT", but at the expense of keeping more of the document in memory.
</p>
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources-ungrouping.xml -i data/grouped.xml 
    -o output/ungrouped.csv  settlements2csv

</pre><p>
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2107"></a>XML to Flat Repeating Group (all)</h3></div></div></div>                                              


<a class="indexterm" name="d4e2110"></a>
<a class="indexterm" name="d4e2113"></a>
<p>
The example below illustrates how to prepare a resources script that will convert an 
XML document into a positional flat file with repeating groups.  
</p>
<p>
The input file is an XML file.
</p>
<div class="figure"><a name="all.xml"></a><p class="title"><b>Figure&nbsp;151.&nbsp;Input XML file all.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;all&gt;
    &lt;field1&gt;val1&lt;/field1&gt;
    &lt;field2&gt;val2&lt;/field2&gt;
    &lt;field3&gt;val3&lt;/field3&gt;
    &lt;compositeA attr1="av11" attr2="av21" attr3="av31"/&gt; 
    &lt;compositeA attr1="av21" attr2="av22" attr3="av23"/&gt;
    &lt;compositeA attr1="av31" attr2="av32" attr3="av33"/&gt;
    &lt;compositeB attrx="avx" attry="avy"/&gt; 
&lt;/all&gt;

</pre>
</div></div><br class="figure-break">
<p>
The desired output is shown below.
</p>
<div class="figure"><a name="all.csv"></a><p class="title"><b>Figure&nbsp;152.&nbsp;Output positional flat file all.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

val1      val2      val3      av11 av21 av31 av21 av22 av23 av31 av32 av33 avx  avy  

</pre>
</div></div><br class="figure-break">
<p>
  The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-all.xml"></a><p class="title"><b>Figure&nbsp;153.&nbsp;Resources script resources-all.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="all2flat"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:subtreeRecordReader&gt;
        &lt;sx:inverseRecordMapping ref="allToFileMapping"/&gt;
        &lt;sx:transform&gt;
          &lt;sx:document/&gt;
        &lt;/sx:transform&gt;
      &lt;/sx:subtreeRecordReader&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="allFile"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="allFile"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="allType"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatRecordType id="allType" name="allType"&gt;
    &lt;sx:positionalField name="f1" label="F1" width="10"/&gt;
    &lt;sx:positionalField name="f2" label="F2" width="10"/&gt;
    &lt;sx:positionalField name="f3" label="F3" width="10"/&gt;
    &lt;sx:repeatingGroup name="compA"&gt;
      &lt;sx:flatRecordType name="compARecord"&gt;
        &lt;sx:positionalField name="ca1"  width="5"/&gt;
        &lt;sx:positionalField name="ca2"  width="5"/&gt;
        &lt;sx:positionalField name="ca3"  width="5"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:repeatingGroup&gt;
    &lt;sx:repeatingGroup name="compB"&gt;
      &lt;sx:flatRecordType name="compBRecord"&gt;
        &lt;sx:positionalField name="cb1"  width="5"/&gt;
        &lt;sx:positionalField name="cb2"  width="5"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:repeatingGroup&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:inverseRecordMapping id="allToFileMapping"&gt;
    &lt;sx:onSubtree path="/all"&gt;
      &lt;sx:flattenSubtree recordType="allType"&gt;
        &lt;sx:subtreeFieldMap select="field1" field="f1"/&gt;
        &lt;sx:subtreeFieldMap select="field2" field="f2"/&gt;
        &lt;sx:subtreeFieldMap select="field3" field="f3"/&gt;
        &lt;sx:subtreeFieldMap match="compositeA" field="compA"&gt;
          &lt;sx:flattenSubtree  recordType="compARecord"&gt;
            &lt;sx:subtreeFieldMap select="@attr1" field="ca1"/&gt;
            &lt;sx:subtreeFieldMap select="@attr2" field="ca2"/&gt;
            &lt;sx:subtreeFieldMap select="@attr3" field="ca3"/&gt;
          &lt;/sx:flattenSubtree&gt;
        &lt;/sx:subtreeFieldMap&gt;
        &lt;sx:subtreeFieldMap match="compositeB" field="compB"&gt;
          &lt;sx:flattenSubtree  recordType="compBRecord"&gt;
            &lt;sx:subtreeFieldMap select="@attrx" field="cb1"/&gt;
            &lt;sx:subtreeFieldMap select="@attry" field="cb2"/&gt;
          &lt;/sx:flattenSubtree&gt;
        &lt;/sx:subtreeFieldMap&gt;
      &lt;/sx:flattenSubtree&gt;
    &lt;/sx:onSubtree&gt;
  &lt;/sx:inverseRecordMapping&gt;

&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p></p>
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources-all.xml -i data/all.xml 
    -o output/all.txt  all2flat

</pre><p>
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2132"></a>Formating Distinct Record Lines (blocks)</h3></div></div></div>                                              


<a class="indexterm" name="d4e2135"></a>
<p>
The example below illustrates how to prepare a resources script that will convert an 
XML document into a positional flat file with different record types corresponding to
different XML subtrees.  
</p>
<p>
The input file is an XML file.
</p>
<div class="figure"><a name="blocks.xml"></a><p class="title"><b>Figure&nbsp;154.&nbsp;Input XML file blocks.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;BLOCKS&gt;
  &lt;BLOCK1&gt;
    &lt;FIELD1&gt;XXXX&lt;/FIELD1&gt;
    &lt;FIELD2&gt;YYYY&lt;/FIELD2&gt;
    &lt;FIELD3&gt;ZZZZ&lt;/FIELD3&gt;
    &lt;FIELD4&gt;WWWW&lt;/FIELD4&gt;
  &lt;/BLOCK1&gt;
  &lt;BLOCK2&gt;
    &lt;TEXT1&gt;AAAA&lt;/TEXT1&gt;
    &lt;TEXT2&gt;BBBB&lt;/TEXT2&gt;
    &lt;TEXT3&gt;CCCC&lt;/TEXT3&gt;
    &lt;TEXT4&gt;DDDD&lt;/TEXT4&gt;
  &lt;/BLOCK2&gt;
  &lt;BLOCK3&gt;
    &lt;INTEGER1&gt;1111&lt;/INTEGER1&gt;
    &lt;INTEGER2&gt;2222&lt;/INTEGER2&gt;
    &lt;INTEGER3&gt;3333&lt;/INTEGER3&gt;
  &lt;/BLOCK3&gt;
&lt;/BLOCKS&gt;

</pre>
</div></div><br class="figure-break">
<p>
The desired output is shown below.
</p>
<div class="figure"><a name="blocks.csv"></a><p class="title"><b>Figure&nbsp;155.&nbsp;Output positional flat file blocks.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

XXXXYYYYZZZZWWWW
AAAABBBBCCCCDDDD
111122223333

</pre>
</div></div><br class="figure-break">
<p>
  The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-blocks.xml"></a><p class="title"><b>Figure&nbsp;156.&nbsp;Resources script resources-blocks.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="blocks"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:subtreeRecordReader&gt;
        &lt;sx:transform&gt;
          &lt;sx:document/&gt;
        &lt;/sx:transform&gt;
        &lt;sx:inverseRecordMapping ref="blocksToFileMapping"/&gt;
      &lt;/sx:subtreeRecordReader&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile&gt;
          &lt;sx:flatFileBody&gt;
            &lt;sx:flatRecordType ref="blockType"/&gt;
          &lt;/sx:flatFileBody&gt;
        &lt;/sx:flatFile&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatRecordTypeChoice id="blockType" name="blockType"&gt;
    &lt;sx:positionalField name="dummy" width="1"/&gt;
    &lt;sx:when test="/Block1Record"&gt;
      &lt;sx:flatRecordType name="BLOCK1"&gt;
        &lt;sx:positionalField name="Field1" width="4"/&gt;
        &lt;sx:positionalField name="Field2" width="4"/&gt;
        &lt;sx:positionalField name="Field3" width="4"/&gt;
        &lt;sx:positionalField name="Field4" width="4"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:when&gt;
    &lt;sx:when test="/Block2Record"&gt;
      &lt;sx:flatRecordType name="BLOCK2"&gt;
        &lt;sx:positionalField name="Text1" width="4"/&gt;
        &lt;sx:positionalField name="Text2" width="4"/&gt;
        &lt;sx:positionalField name="Text3" width="4"/&gt;
        &lt;sx:positionalField name="Text4" width="4"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:when&gt;
    &lt;sx:when test="/Block3Record"&gt;
      &lt;sx:flatRecordType name="BLOCK3"&gt;
        &lt;sx:positionalField name="Integer1" width="4"/&gt;
        &lt;sx:positionalField name="Integer2" width="4"/&gt;
        &lt;sx:positionalField name="Integer3" width="4"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:when&gt;
  &lt;/sx:flatRecordTypeChoice&gt;

  &lt;sx:inverseRecordMapping id="blocksToFileMapping"&gt;
    &lt;sx:onSubtree path="/BLOCKS"&gt;
      &lt;sx:onSubtree path="BLOCK1"&gt;
        &lt;sx:flattenSubtree recordType="Block1Record"&gt;
          &lt;sx:subtreeFieldMap select="FIELD1" field="Field1"/&gt;
          &lt;sx:subtreeFieldMap select="FIELD2" field="Field2"/&gt;
          &lt;sx:subtreeFieldMap select="FIELD3" field="Field3"/&gt;
          &lt;sx:subtreeFieldMap select="FIELD4" field="Field4"/&gt;
        &lt;/sx:flattenSubtree&gt;
      &lt;/sx:onSubtree&gt;
      &lt;sx:onSubtree path="BLOCK2"&gt;
        &lt;sx:flattenSubtree recordType="Block2Record"&gt;
          &lt;sx:subtreeFieldMap select="TEXT1" field="Text1"/&gt;
          &lt;sx:subtreeFieldMap select="TEXT2" field="Text2"/&gt;
          &lt;sx:subtreeFieldMap select="TEXT3" field="Text3"/&gt;
          &lt;sx:subtreeFieldMap select="TEXT4" field="Text4"/&gt;
        &lt;/sx:flattenSubtree&gt;
      &lt;/sx:onSubtree&gt;
      &lt;sx:onSubtree path="BLOCK3"&gt;
        &lt;sx:flattenSubtree recordType="Block3Record"&gt;
          &lt;sx:subtreeFieldMap select="INTEGER1" field="Integer1"/&gt;
          &lt;sx:subtreeFieldMap select="INTEGER2" field="Integer2"/&gt;
          &lt;sx:subtreeFieldMap select="INTEGER3" field="Integer3"/&gt;
        &lt;/sx:flattenSubtree&gt;
      &lt;/sx:onSubtree&gt;
    &lt;/sx:onSubtree&gt;
  &lt;/sx:inverseRecordMapping&gt;

&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p></p>
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources-blocks.xml -i data/blocks.xml 
    -o output/blocks.txt  blocks

</pre><p>
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2154"></a>Block Subsequences in XML to One Line</h3></div></div></div>                                              


<a class="indexterm" name="d4e2157"></a>
<p> This example illustrates a resources script that will map subsequences of 
blocks in the XML to a single line in the flat file.
</p>
<p>
The input file is an XML file.
</p>
<div class="figure"><a name="block_subsequences"></a><p class="title"><b>Figure&nbsp;157.&nbsp;Input XML file block_subsequences.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;BLOCKS&gt;
  &lt;BLOCK1&gt;
    &lt;FIELD1&gt;XXXX1&lt;/FIELD1&gt;
    &lt;FIELD2&gt;YYYY1&lt;/FIELD2&gt;
    &lt;FIELD3&gt;ZZZZ1&lt;/FIELD3&gt;
    &lt;FIELD4&gt;WWWW1&lt;/FIELD4&gt;
  &lt;/BLOCK1&gt;
  &lt;BLOCK2&gt;
    &lt;TEXT1&gt;AAAA1&lt;/TEXT1&gt;
    &lt;TEXT2&gt;BBBB1&lt;/TEXT2&gt;
    &lt;TEXT3&gt;CCCC1&lt;/TEXT3&gt;
    &lt;TEXT4&gt;DDDD1&lt;/TEXT4&gt;
  &lt;/BLOCK2&gt;
  &lt;BLOCK1&gt;
    &lt;FIELD1&gt;XXXX2&lt;/FIELD1&gt;
    &lt;FIELD2&gt;YYYY2&lt;/FIELD2&gt;
    &lt;FIELD3&gt;ZZZZ2&lt;/FIELD3&gt;
    &lt;FIELD4&gt;WWWW2&lt;/FIELD4&gt;
  &lt;/BLOCK1&gt;
  &lt;BLOCK2&gt;
    &lt;TEXT1&gt;AAAA2&lt;/TEXT1&gt;
    &lt;TEXT2&gt;BBBB2&lt;/TEXT2&gt;
    &lt;TEXT3&gt;CCCC2&lt;/TEXT3&gt;
    &lt;TEXT4&gt;DDDD2&lt;/TEXT4&gt;
  &lt;/BLOCK2&gt;
&lt;/BLOCKS&gt;

</pre>
</div></div><br class="figure-break">
  <p> Note that BLOCK1 and BLOCK2 repeat. 
  </p>
<p>
The desired output is shown below.
</p>
<div class="figure"><a name="block_subsequences.txt"></a><p class="title"><b>Figure&nbsp;158.&nbsp;Output positional flat file block_subsequences.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

XXXX1YYYY1ZZZZ1WWWW1AAAA1BBBB1CCCC1DDDD1
XXXX2YYYY2ZZZZ2WWWW2AAAA2BBBB2CCCC2DDDD2

</pre>
</div></div><br class="figure-break">
  <p> Note that BLOCK1 and BLOCK2 form a single line in the Flat output file,
and then BLOCK1 and BLOCK2 repeat. 
  </p>
<p>
  The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-subsequences.xml"></a><p class="title"><b>Figure&nbsp;159.&nbsp;Resources script resources-subsequences.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="blocks"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:subtreeRecordReader&gt;
        &lt;sx:transform&gt;
          &lt;sx:document/&gt;
        &lt;/sx:transform&gt;
        &lt;sx:inverseRecordMapping ref="blocksToFileMapping"/&gt;
      &lt;/sx:subtreeRecordReader&gt;
      &lt;sx:combineRecords recordType="BLOCKS" repeatingGroup="blocks" 
                        beginTest="sx:current/BLOCK1"
                        endTest="sx:current/BLOCK1"&gt;
      &lt;/sx:combineRecords&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile&gt;
          &lt;sx:flatFileBody&gt;
            &lt;sx:flatRecordType ref="blockType"/&gt;
          &lt;/sx:flatFileBody&gt;
        &lt;/sx:flatFile&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatRecordType id="blockType" name="blockType"&gt;
    &lt;sx:repeatingGroup name="blocks"&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:when test="/BLOCK1"&gt;
          &lt;sx:flatRecordType name="BLOCK1"&gt;
            &lt;sx:positionalField name="Field1" width="5"/&gt;
            &lt;sx:positionalField name="Field2" width="5"/&gt;
            &lt;sx:positionalField name="Field3" width="5"/&gt;
            &lt;sx:positionalField name="Field4" width="5"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="/BLOCK2"&gt;
          &lt;sx:flatRecordType name="BLOCK2"&gt;
            &lt;sx:positionalField name="Text1" width="5"/&gt;
            &lt;sx:positionalField name="Text2" width="5"/&gt;
            &lt;sx:positionalField name="Text3" width="5"/&gt;
            &lt;sx:positionalField name="Text4" width="5"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:repeatingGroup&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:inverseRecordMapping id="blocksToFileMapping"&gt;
    &lt;sx:onSubtree path="/BLOCKS"&gt;
      &lt;sx:onSubtree path="BLOCK1"&gt;
        &lt;sx:flattenSubtree recordType="BLOCK1"&gt;
          &lt;sx:subtreeFieldMap select="FIELD1" field="Field1"/&gt;
          &lt;sx:subtreeFieldMap select="FIELD2" field="Field2"/&gt;
          &lt;sx:subtreeFieldMap select="FIELD3" field="Field3"/&gt;
          &lt;sx:subtreeFieldMap select="FIELD4" field="Field4"/&gt;
        &lt;/sx:flattenSubtree&gt;
      &lt;/sx:onSubtree&gt;
      &lt;sx:onSubtree path="BLOCK2"&gt;
        &lt;sx:flattenSubtree recordType="BLOCK2"&gt;
          &lt;sx:subtreeFieldMap select="TEXT1" field="Text1"/&gt;
          &lt;sx:subtreeFieldMap select="TEXT2" field="Text2"/&gt;
          &lt;sx:subtreeFieldMap select="TEXT3" field="Text3"/&gt;
          &lt;sx:subtreeFieldMap select="TEXT4" field="Text4"/&gt;
        &lt;/sx:flattenSubtree&gt;
      &lt;/sx:onSubtree&gt;
    &lt;/sx:onSubtree&gt;
  &lt;/sx:inverseRecordMapping&gt;

&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>The strategy is to map the BLOCK1 and BLOCK2 subtrees to BLOCK1 and 
  BLOCK2 records, compose the BLOCK1 and BLOCK2 records into a composite record,
  and to map the composite record to a single line in the flat file.</p>
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources-subsequences.xml -i data/block_subsequences.xml
    -o output/block_subsequences.txt blocks 

</pre><p>
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2178"></a>Ungrouping Elements with Multiple Levels (book hierarchy)</h3></div></div></div>                                              


<a class="indexterm" name="d4e2181"></a>
<p>
The example below illustrates how to prepare a resources script that will convert an 
XML document into a delimited flat file with different record types corresponding to
different XML subtrees.  
</p>
<p>
The input file is an XML file.
</p>
<div class="figure"><a name="book_hierarchy.xml"></a><p class="title"><b>Figure&nbsp;160.&nbsp;Input XML file book_hierarchy.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;myns:rootNode xmlns:myns="http://mycompany.com/mynames/"&gt;
  &lt;myns:name&gt;root&lt;/myns:name&gt;
  &lt;attribute&gt;
    &lt;myns:name&gt;NONE&lt;/myns:name&gt;
    &lt;myns:value&gt;NONE&lt;/myns:value&gt;
  &lt;/attribute&gt;
  &lt;myns:childNode&gt;
    &lt;myns:name&gt;Entity.LONDON&lt;/myns:name&gt;
    &lt;attribute&gt;
      &lt;myns:name&gt;Entity&lt;/myns:name&gt;
      &lt;myns:value&gt;LONDON&lt;/myns:value&gt;
    &lt;/attribute&gt;
    &lt;myns:childNode&gt;
      &lt;myns:name&gt;BookName.EQUITIES_NY&lt;/myns:name&gt;
      &lt;attribute&gt;
        &lt;myns:name&gt;BookName&lt;/myns:name&gt;
        &lt;myns:value&gt;EQUITIES_NY&lt;/myns:value&gt;
      &lt;/attribute&gt;
      &lt;myns:childNode&gt;
        &lt;myns:name&gt;BookName.EQUITIES_NY_TR_JAYME&lt;/myns:name&gt;
        &lt;attribute&gt;
          &lt;myns:name&gt;BookName&lt;/myns:name&gt;
          &lt;myns:value&gt;EQUITIES_NY_TR_JAYME&lt;/myns:value&gt;
        &lt;/attribute&gt;
        &lt;myns:childNode&gt;
          &lt;myns:name&gt;BookName.PR_EQUITY_NY&lt;/myns:name&gt;
          &lt;attribute&gt;
            &lt;myns:name&gt;BookName&lt;/myns:name&gt;
            &lt;myns:value&gt;PR_EQUITY_NY&lt;/myns:value&gt;
          &lt;/attribute&gt;
        &lt;/myns:childNode&gt;
        &lt;myns:childNode&gt;
          &lt;myns:name&gt;BookName.PR_EQUITY_NY1&lt;/myns:name&gt;
          &lt;attribute&gt;
            &lt;myns:name&gt;BookName&lt;/myns:name&gt;
            &lt;myns:value&gt;PR_EQUITY_NY1&lt;/myns:value&gt;
          &lt;/attribute&gt;
        &lt;/myns:childNode&gt;
      &lt;/myns:childNode&gt;
    &lt;/myns:childNode&gt;
    &lt;myns:childNode&gt;
      &lt;myns:name&gt;BookName.EQUITIES_LONDON&lt;/myns:name&gt;
      &lt;attribute&gt;
        &lt;myns:name&gt;BookName&lt;/myns:name&gt;
        &lt;myns:value&gt;EQUITIES_LONDON&lt;/myns:value&gt;
      &lt;/attribute&gt;
      &lt;myns:childNode&gt;
        &lt;myns:name&gt;BookName.EQUITIES_NY_TR_JAYME&lt;/myns:name&gt;
        &lt;attribute&gt;
          &lt;myns:name&gt;BookName&lt;/myns:name&gt;
          &lt;myns:value&gt;EQUITIES_NY_TR_JAYME&lt;/myns:value&gt;
        &lt;/attribute&gt;
        &lt;myns:childNode&gt;
          &lt;myns:name&gt;BookName.PR_EQUITY_NY&lt;/myns:name&gt;
          &lt;attribute&gt;
            &lt;myns:name&gt;BookName&lt;/myns:name&gt;
            &lt;myns:value&gt;PR_EQUITY_NY&lt;/myns:value&gt;
          &lt;/attribute&gt;
        &lt;/myns:childNode&gt;
      &lt;/myns:childNode&gt;
    &lt;/myns:childNode&gt;
  &lt;/myns:childNode&gt;
&lt;/myns:rootNode&gt;

</pre>
</div></div><br class="figure-break">
<p>
The desired output is shown below.
</p>
<div class="figure"><a name="book_hierarchy.txt"></a><p class="title"><b>Figure&nbsp;161.&nbsp;Output delimited flat file book_hierarchy.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

root,NONE,,Entity.LONDON,Entity,LONDON,,BookName,EQUITIES_NY,BookName,EQUITIES_NY_TR_JAYME,BookName,PR_EQUITY_NY,BookName,PR_EQUITY_NY1
root,NONE,,Entity.LONDON,Entity,LONDON,,BookName,EQUITIES_LONDON,BookName,EQUITIES_NY_TR_JAYME,BookName,PR_EQUITY_NY

</pre>
</div></div><br class="figure-break">
<p>
  The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-bookHierarchy.xml"></a><p class="title"><b>Figure&nbsp;162.&nbsp;Resources script resources-bookHierarchy.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
  xmlns:myns="http://mycompany.com/mynames/"&gt;

  &lt;sx:service id="bookHierarchyToFile"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:subtreeRecordReader&gt;
        &lt;sx:transform&gt;
          &lt;sx:document/&gt;
        &lt;/sx:transform&gt;
        &lt;sx:inverseRecordMapping ref="bookHierarchyToFileMapping"/&gt;
      &lt;/sx:subtreeRecordReader&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile&gt;
          &lt;sx:flatFileBody&gt;
            &lt;sx:flatRecordType ref="settlementType"/&gt;
          &lt;/sx:flatFileBody&gt;
        &lt;/sx:flatFile&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatRecordType id="settlementType" name="settlementType"&gt;
    &lt;sx:fieldDelimiter value=","/&gt;
    &lt;sx:repeatDelimiter value=","/&gt;
    &lt;sx:segmentDelimiter value="|"/&gt;
    &lt;sx:delimitedField name="root" label="root"/&gt;
    &lt;sx:delimitedField name="bookCode" label="bookCode"/&gt;
    &lt;sx:delimitedField name="bookValue" label="bookValue"/&gt;
    &lt;sx:delimitedField name="level1" label="level1"/&gt;
    &lt;sx:delimitedField name="level1Code" label="level1Code"/&gt;
    &lt;sx:delimitedField name="level1Value" label="level1Value"/&gt;
    &lt;sx:delimitedField name="level2" label="level2"/&gt;
    &lt;sx:delimitedField name="level2Code" label="level2Code"/&gt;
    &lt;sx:delimitedField name="level2Value" label="level2Value"/&gt;
    &lt;sx:repeatingGroup name="level3" label="level3"&gt;
      &lt;sx:flatRecordType name="level3Record"&gt;
        &lt;sx:delimitedField name="code" label="code"/&gt;
        &lt;sx:delimitedField name="value" label="value"/&gt;
        &lt;sx:repeatingGroup name="level4" label="level4"&gt;
          &lt;sx:flatRecordType name="level4Record"&gt;
            &lt;sx:delimitedField name="code" label="code"/&gt;
            &lt;sx:delimitedField name="value" label="value"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:repeatingGroup&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:repeatingGroup&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:inverseRecordMapping id="bookHierarchyToFileMapping"&gt;
    &lt;sx:onSubtree path="/myns:rootNode"&gt;
      &lt;sx:parameter name="root" select="myns:name"/&gt;
      &lt;sx:parameter name="bookCode" select="attribute/myns:name"/&gt;
      &lt;sx:parameter name="bookValue" select="attribute/value"/&gt;

      &lt;sx:onSubtree path="/myns:rootNode/myns:childNode"&gt;
        &lt;sx:parameter name="level1" select="myns:name"/&gt;
        &lt;sx:parameter name="level1Code" select="attribute/myns:name"/&gt;
        &lt;sx:parameter name="level1Value" select="attribute/myns:value"/&gt;
        &lt;sx:onSubtree path="/myns:childNode/myns:childNode"&gt;
          &lt;sx:flattenSubtree recordType="settlement"&gt;
            &lt;sx:subtreeFieldMap select="$root" field="root"/&gt;
            &lt;sx:subtreeFieldMap select="$bookCode" field="bookCode"/&gt;
            &lt;sx:subtreeFieldMap select="$bookValue" field="bookValue"/&gt;
            &lt;sx:subtreeFieldMap select="$level1" field="level1"/&gt;
            &lt;sx:subtreeFieldMap select="$level1Code" field="level1Code"/&gt;
            &lt;sx:subtreeFieldMap select="$level1Value" field="level1Value"/&gt;
            &lt;sx:subtreeFieldMap select="name" field="level2"/&gt;
            &lt;sx:subtreeFieldMap select="attribute/myns:name" field="level2Code"/&gt;
            &lt;sx:subtreeFieldMap select="attribute/myns:value" field="level2Value"/&gt;
            &lt;sx:subtreeFieldMap match="myns:childNode" field="level3"&gt;
              &lt;sx:flattenSubtree  recordType="level3Record"&gt;
                &lt;sx:subtreeFieldMap select="attribute/myns:name" field="code"/&gt;
                &lt;sx:subtreeFieldMap select="attribute/myns:value" field="value"/&gt;
                &lt;sx:subtreeFieldMap match="myns:childNode" field="level4"&gt;
                  &lt;sx:flattenSubtree  recordType="level4Record"&gt;
                    &lt;sx:subtreeFieldMap select="attribute/myns:name" field="code"/&gt;
                    &lt;sx:subtreeFieldMap select="attribute/myns:value" field="value"/&gt;
                  &lt;/sx:flattenSubtree&gt;
                &lt;/sx:subtreeFieldMap&gt;
              &lt;/sx:flattenSubtree&gt;
            &lt;/sx:subtreeFieldMap&gt;
          &lt;/sx:flattenSubtree&gt;
        &lt;/sx:onSubtree&gt;
      &lt;/sx:onSubtree&gt;
    &lt;/sx:onSubtree&gt;
  &lt;/sx:inverseRecordMapping&gt;

&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p></p>
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources-bookHierarchy.xml -i data/book_hierarchy.xml 
    -o output/book_hierarchy.txt bookHierarchyToFile

</pre><p>
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2200"></a>X12 XML to Flat File using XSLT</h3></div></div></div>                                              


<a class="indexterm" name="d4e2203"></a>
<p>
The example below illustrates how to prepare a resources script that will convert an 
XML representation of an X12 file into a positional flat file.  Different record
types correspond to different subtrees in the XML document.  
</p>
<p>
The input file is an XML file.
</p>
<div class="figure"><a name="Edi517M2xml.xml"></a><p class="title"><b>Figure&nbsp;163.&nbsp;Input file Edi517M2xml.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;X12&gt;
  &lt;!-- Reapting group with in the x12 document --&gt;
  &lt;ST&gt;
    &lt;ST01&gt;517&lt;/ST01&gt;
    &lt;ST02&gt;0006&lt;/ST02&gt;
  &lt;/ST&gt;
  &lt;BR&gt;
    &lt;BR01&gt;00&lt;/BR01&gt;
    &lt;BR02&gt;AN&lt;/BR02&gt;
    &lt;BR03&gt;20071019&lt;/BR03&gt;
    &lt;BR04/&gt;
    &lt;BR05/&gt;
    &lt;BR06/&gt;
    &lt;BR07&gt;X7&lt;/BR07&gt;
    &lt;BR08&gt;0101&lt;/BR08&gt;
    &lt;BR09&gt;150401&lt;/BR09&gt;
    &lt;BR10&gt;XM&lt;/BR10&gt;
    &lt;BR11&gt;003&lt;/BR11&gt;
    &lt;BR12&gt;0101003&lt;/BR12&gt;
  &lt;/BR&gt;
  &lt;G62&gt;
    &lt;G6201&gt;CA&lt;/G6201&gt;
    &lt;G6202&gt;20070720&lt;/G6202&gt;
  &lt;/G62&gt;
  &lt;G62&gt;
    &lt;G6201&gt;64&lt;/G6201&gt;
    &lt;G6202&gt;20070903&lt;/G6202&gt;
  &lt;/G62&gt;
  &lt;LM&gt;
    &lt;LM01&gt;DF&lt;/LM01&gt;
  &lt;/LM&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;0&lt;/LQ01&gt;
    &lt;LQ02&gt;AN9&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;N1&gt;
    &lt;N101&gt;Z4&lt;/N101&gt;
    &lt;N102/&gt;
    &lt;N103&gt;M4&lt;/N103&gt;
    &lt;N104&gt;GSA&lt;/N104&gt;
    &lt;N105/&gt;
    &lt;N106&gt;FR&lt;/N106&gt;
  &lt;/N1&gt;
  &lt;N1&gt;
    &lt;N101&gt;ZR&lt;/N101&gt;
    &lt;N102/&gt;
    &lt;N103&gt;10&lt;/N103&gt;
    &lt;N104&gt;N23194&lt;/N104&gt;
    &lt;N105/&gt;
    &lt;N106&gt;TO&lt;/N106&gt;
  &lt;/N1&gt;
  &lt;!-- Repating group with in ST, nmber of times based on value in BR11( current value =3) --&gt;
  &lt;QTY&gt;
    &lt;QTY01&gt;63&lt;/QTY01&gt;
    &lt;QTY02&gt;4&lt;/QTY02&gt;
    &lt;QTY03&gt;BX&lt;/QTY03&gt;
    &lt;QTY04&gt;BX4&lt;/QTY04&gt;
  &lt;/QTY&gt;
  &lt;N9&gt;
    &lt;N901&gt;TN&lt;/N901&gt;
    &lt;N902&gt;N2319471430196&lt;/N902&gt;
  &lt;/N9&gt;
  &lt;N9&gt;
    &lt;N901&gt;NS&lt;/N901&gt;
    &lt;N902&gt;7920006199162&lt;/N902&gt;
  &lt;/N9&gt;
  &lt;G62&gt;
    &lt;G6201&gt;17&lt;/G6201&gt;
    &lt;G6202&gt;20070718&lt;/G6202&gt;
  &lt;/G62&gt;
  &lt;LM&gt;
    &lt;LM01&gt;DF&lt;/LM01&gt;
  &lt;/LM&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;0&lt;/LQ01&gt;
    &lt;LQ02&gt;AN1&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;81&lt;/LQ01&gt;
    &lt;LQ02&gt;BV&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;COG&lt;/LQ01&gt;
    &lt;LQ02&gt;9Q&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;DE&lt;/LQ01&gt;
    &lt;LQ02&gt;C&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;DF&lt;/LQ01&gt;
    &lt;LQ02&gt;S&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;A9&lt;/LQ01&gt;
    &lt;LQ02&gt;N23194&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;78&lt;/LQ01&gt;
    &lt;LQ02&gt;ZQ0&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;79&lt;/LQ01&gt;
    &lt;LQ02&gt;03&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;FA1&gt;
    &lt;FA101&gt;DN&lt;/FA101&gt;
    &lt;FA102&gt;D340&lt;/FA102&gt;
  &lt;/FA1&gt;
  &lt;FA2&gt;
    &lt;FA201&gt;B5&lt;/FA201&gt;
    &lt;FA202&gt;RC&lt;/FA202&gt;
  &lt;/FA2&gt;
  &lt;QTY&gt;
    &lt;QTY01&gt;63&lt;/QTY01&gt;
    &lt;QTY02&gt;1&lt;/QTY02&gt;
    &lt;QTY03&gt;EA&lt;/QTY03&gt;
    &lt;QTY04&gt;EA1&lt;/QTY04&gt;
  &lt;/QTY&gt;
  &lt;N9&gt;
    &lt;N901&gt;TN&lt;/N901&gt;
    &lt;N902&gt;N2319471430158&lt;/N902&gt;
  &lt;/N9&gt;
  &lt;N9&gt;
    &lt;N901&gt;NS&lt;/N901&gt;
    &lt;N902&gt;5140003694927&lt;/N902&gt;
  &lt;/N9&gt;
  &lt;G62&gt;
    &lt;G6201&gt;17&lt;/G6201&gt;
    &lt;G6202&gt;20070725&lt;/G6202&gt;
  &lt;/G62&gt;
  &lt;LM&gt;
    &lt;LM01&gt;DF&lt;/LM01&gt;
  &lt;/LM&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;0&lt;/LQ01&gt;
    &lt;LQ02&gt;AN1&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;81&lt;/LQ01&gt;
    &lt;LQ02&gt;BB&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;COG&lt;/LQ01&gt;
    &lt;LQ02&gt;9Q&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;DE&lt;/LQ01&gt;
    &lt;LQ02&gt;C&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;DF&lt;/LQ01&gt;
    &lt;LQ02&gt;S&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;A9&lt;/LQ01&gt;
    &lt;LQ02&gt;N23194&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;78&lt;/LQ01&gt;
    &lt;LQ02&gt;ZQ0&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;79&lt;/LQ01&gt;
    &lt;LQ02&gt;03&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;FA1&gt;
    &lt;FA101&gt;DN&lt;/FA101&gt;
    &lt;FA102&gt;D340&lt;/FA102&gt;
  &lt;/FA1&gt;
  &lt;FA2&gt;
    &lt;FA201&gt;B5&lt;/FA201&gt;
    &lt;FA202&gt;RC&lt;/FA202&gt;
  &lt;/FA2&gt;
  &lt;QTY&gt;
    &lt;QTY01&gt;63&lt;/QTY01&gt;
    &lt;QTY02&gt;6&lt;/QTY02&gt;
    &lt;QTY03&gt;BG&lt;/QTY03&gt;
    &lt;QTY04&gt;BG6&lt;/QTY04&gt;
  &lt;/QTY&gt;
  &lt;N9&gt;
    &lt;N901&gt;TN&lt;/N901&gt;
    &lt;N902&gt;N2319471430272&lt;/N902&gt;
  &lt;/N9&gt;
  &lt;N9&gt;
    &lt;N901&gt;NS&lt;/N901&gt;
    &lt;N902&gt;5610009851800&lt;/N902&gt;
  &lt;/N9&gt;
  &lt;G62&gt;
    &lt;G6201&gt;17&lt;/G6201&gt;
    &lt;G6202&gt;20070703&lt;/G6202&gt;
  &lt;/G62&gt;
  &lt;LM&gt;
    &lt;LM01&gt;DF&lt;/LM01&gt;
  &lt;/LM&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;0&lt;/LQ01&gt;
    &lt;LQ02&gt;AN1&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;81&lt;/LQ01&gt;
    &lt;LQ02&gt;BV&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;COG&lt;/LQ01&gt;
    &lt;LQ02&gt;9Q&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;DE&lt;/LQ01&gt;
    &lt;LQ02&gt;C&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;DF&lt;/LQ01&gt;
    &lt;LQ02&gt;S&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;A9&lt;/LQ01&gt;
    &lt;LQ02&gt;N23194&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;78&lt;/LQ01&gt;
    &lt;LQ02&gt;ZQ0&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;LQ&gt;
    &lt;LQ01&gt;79&lt;/LQ01&gt;
    &lt;LQ02&gt;03&lt;/LQ02&gt;
  &lt;/LQ&gt;
  &lt;FA1&gt;
    &lt;FA101&gt;DN&lt;/FA101&gt;
    &lt;FA102&gt;D340&lt;/FA102&gt;
  &lt;/FA1&gt;
  &lt;FA2&gt;
    &lt;FA201&gt;B5&lt;/FA201&gt;
    &lt;FA202&gt;RC&lt;/FA202&gt;
  &lt;/FA2&gt;
  &lt;SE&gt;
    &lt;SE01&gt;54&lt;/SE01&gt;
    &lt;SE02&gt;0006&lt;/SE02&gt;
  &lt;/SE&gt;
&lt;/X12&gt;

</pre>
</div></div><br class="figure-break">
<p>
The desired output is shown below.
</p>
<div class="figure"><a name="Edi517M.txt"></a><p class="title"><b>Figure&nbsp;164.&nbsp;Output delimited flat file Edi517M.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

AN9GSA0101003               N23194           
AN1  7920006199162 CBX4N2319471430196N23194SRC9QZQ003  BV       
AN1  5140003694927 CEA1N2319471430158N23194SRC9QZQ003  BB       
AN1  5610009851800 CBG6N2319471430272N23194SRC9QZQ003  BV       

</pre>
</div></div><br class="figure-break">
<p>
  The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-xml-517M.xml"></a><p class="title"><b>Figure&nbsp;165.&nbsp;Resources script resources-xml-517M.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="xmltodlss"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:subtreeRecordReader&gt;
        &lt;sx:transform&gt;
          &lt;sx:document/&gt;
          &lt;sx:xslt ref="dlss-layout"/&gt;
        &lt;/sx:transform&gt;
        &lt;sx:inverseRecordMapping ref="dlssToFileMapping"/&gt;
      &lt;/sx:subtreeRecordReader&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="dlssFile"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:xslt id="dlss-layout"&gt;
    &lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
      &lt;xsl:strip-space elements="*"/&gt;
      &lt;xsl:template match="/X12"&gt;
        &lt;xsl:copy&gt;
          &lt;xsl:apply-templates/&gt;
        &lt;/xsl:copy&gt;
      &lt;/xsl:template&gt;
      
      &lt;xsl:template match="ST"&gt;
        &lt;PivotNode1&gt;
          &lt;ST&gt;
            &lt;xsl:value-of select="."/&gt;
          &lt;/ST&gt;
          &lt;BR&gt;
            &lt;xsl:value-of select="following-sibling::BR/BR08"/&gt;
          &lt;/BR&gt;
          &lt;BR01&gt;
            &lt;xsl:value-of select="following-sibling::BR/BR11"/&gt;
          &lt;/BR01&gt;
          &lt;G62Sub1&gt;
            &lt;xsl:value-of select="following-sibling::G62[1]/G6203"/&gt;
          &lt;/G62Sub1&gt;
          &lt;G62Sub2&gt;
            &lt;xsl:value-of select="following-sibling::G62[1]/G6204"/&gt;
          &lt;/G62Sub2&gt;
          &lt;G62Sub3&gt;
            &lt;xsl:value-of select="following-sibling::G62[2]/G6203"/&gt;
          &lt;/G62Sub3&gt;
          &lt;G62Sub4&gt;
            &lt;xsl:value-of select="following-sibling::G62[2]/G6204"/&gt;
          &lt;/G62Sub4&gt;
          &lt;LMSub1&gt;
            &lt;xsl:value-of select="following-sibling::LM[1]/LM01"/&gt;
          &lt;/LMSub1&gt;
          &lt;LQSub1&gt;
            &lt;xsl:value-of select="following-sibling::LQ[1]/LQ02"/&gt;
          &lt;/LQSub1&gt;
          &lt;N1Sub1&gt;
            &lt;xsl:value-of select="following-sibling::N1[1]/N104"/&gt;
          &lt;/N1Sub1&gt;
          &lt;N1Sub2&gt;
            &lt;xsl:value-of select="following-sibling::N1[2]/N104"/&gt;
          &lt;/N1Sub2&gt;
          &lt;SE&gt;
            &lt;xsl:value-of select="following-sibling::SE/SE01"/&gt;
          &lt;/SE&gt;
          &lt;xsl:apply-templates /&gt;
        &lt;/PivotNode1&gt;
      &lt;/xsl:template&gt;

      &lt;xsl:template match="QTY"&gt;
        &lt;PivotNode&gt;
          &lt;QTY&gt;
            &lt;xsl:value-of select="."/&gt;
          &lt;/QTY&gt;
          &lt;QTY01&gt;
            &lt;xsl:value-of select="QTY04"/&gt;
          &lt;/QTY01&gt;
          &lt;N104Sub&gt;
            &lt;xsl:value-of select="QTY05"/&gt;
          &lt;/N104Sub&gt;
          &lt;N9Sub1&gt;
            &lt;xsl:value-of select="following-sibling::N9[1]/N902"/&gt;
          &lt;/N9Sub1&gt;
          &lt;N9Sub2&gt;
            &lt;xsl:value-of select="following-sibling::N9[2]/N902"/&gt;
          &lt;/N9Sub2&gt;
          &lt;G62Sub5&gt;
            &lt;xsl:value-of select="following-sibling::G62/G6203"/&gt;
          &lt;/G62Sub5&gt;
          &lt;G62Sub6&gt;
            &lt;xsl:value-of select="following-sibling::G62/G6204"/&gt;
          &lt;/G62Sub6&gt;
          &lt;G62Sub7&gt;
            &lt;xsl:value-of select="following-sibling::G62/G6205"/&gt;
          &lt;/G62Sub7&gt;
          &lt;G62Sub8&gt;
            &lt;xsl:value-of select="following-sibling::G62/G6206"/&gt;
          &lt;/G62Sub8&gt;
          &lt;LMSub2&gt;
            &lt;xsl:value-of select="following-sibling::LM[1]/LM01"/&gt;
          &lt;/LMSub2&gt;
          &lt;LQSub2&gt;
            &lt;xsl:value-of select="following-sibling::LQ[1]/LQ02"/&gt;
          &lt;/LQSub2&gt;
          &lt;LQSub3&gt;
            &lt;xsl:value-of select="following-sibling::LQ[2]/LQ02"/&gt;
          &lt;/LQSub3&gt;
          &lt;LQSub4&gt;
            &lt;xsl:value-of select="following-sibling::LQ[3]/LQ02"/&gt;
          &lt;/LQSub4&gt;
          &lt;LQSub5&gt;
            &lt;xsl:value-of select="following-sibling::LQ[4]/LQ02"/&gt;
          &lt;/LQSub5&gt;
          &lt;LQSub6&gt;
            &lt;xsl:value-of select="following-sibling::LQ[5]/LQ02"/&gt;
          &lt;/LQSub6&gt;
          &lt;LQSub7&gt;
            &lt;xsl:value-of select="following-sibling::LQ[6]/LQ02"/&gt;
          &lt;/LQSub7&gt;
          &lt;LQSub8&gt;
            &lt;xsl:value-of select="following-sibling::LQ[7]/LQ02"/&gt;
          &lt;/LQSub8&gt;
          &lt;LQSub9&gt;
            &lt;xsl:value-of select="following-sibling::LQ[8]/LQ02"/&gt;
          &lt;/LQSub9&gt;
          &lt;FA1&gt;
            &lt;xsl:value-of select="following-sibling::FA1/FA102"/&gt;
          &lt;/FA1&gt;
          &lt;FA2&gt;
            &lt;xsl:value-of select="following-sibling::FA2/FA202"/&gt;
          &lt;/FA2&gt;
        &lt;/PivotNode&gt;
      &lt;/xsl:template&gt;

    &lt;/xsl:stylesheet&gt;
  &lt;/sx:xslt&gt;

  &lt;sx:flatFile id="dlssFile"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordTypeChoice&gt;
        &lt;sx:positionalField name="placeholder" width="1"/&gt;
        &lt;sx:when test="/dlss1"&gt;
          &lt;sx:flatRecordType name="dlss1"&gt;
            &lt;sx:positionalField name="LQSub1" width="3"/&gt;
            &lt;sx:positionalField name="N1Sub1" width="3"/&gt;
            &lt;sx:positionalField name="BR" width="4"/&gt;
            &lt;sx:positionalField name="BR01" width="3"/&gt;
            &lt;sx:positionalField name="spaces1" width="15"/&gt;
            &lt;sx:positionalField name="N1Sub2" width="6"/&gt;
            &lt;sx:positionalField name="G62Sub1" width="2"/&gt;
            &lt;sx:positionalField name="G62Sub2" width="3"/&gt;
            &lt;sx:positionalField name="G62Sub3" width="4"/&gt;
            &lt;sx:positionalField name="G62Sub4" width="2"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="/dlss2"&gt;
          &lt;sx:flatRecordType name="dlss2"&gt;
            &lt;sx:positionalField name="LQSub2" width="3"/&gt;
            &lt;sx:positionalField name="N104Sub" width="2"/&gt;
            &lt;sx:positionalField name="N9Sub2" width="14"/&gt;
            &lt;sx:positionalField name="LQSub5" width="1"/&gt;
            &lt;sx:positionalField name="QTY01" width="3"/&gt;
            &lt;sx:positionalField name="N9Sub1" width="14"/&gt;
            &lt;sx:positionalField name="LQSub7" width="6"/&gt;
            &lt;sx:positionalField name="LQSub6" width="1"/&gt;
            &lt;sx:positionalField name="FA2" width="2"/&gt;
            &lt;sx:positionalField name="LQSub4" width="2"/&gt;
            &lt;sx:positionalField name="LQSub8" width="3"/&gt;
            &lt;sx:positionalField name="LQSub9" width="2"/&gt;
            &lt;sx:positionalField name="G62Sub6" width="2"/&gt;
            &lt;sx:positionalField name="LQSub3" width="3"/&gt;
            &lt;sx:positionalField name="G62Sub7" width="3"/&gt;
            &lt;sx:positionalField name="G62Sub8" width="3"/&gt;
          &lt;/sx:flatRecordType&gt;
        &lt;/sx:when&gt;
      &lt;/sx:flatRecordTypeChoice&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:inverseRecordMapping id="dlssToFileMapping"&gt;
    &lt;sx:onSubtree path="/X12/PivotNode1"&gt;
      &lt;sx:flattenSubtree recordType="dlss1"&gt;
        &lt;sx:subtreeFieldMap select="LQSub1" field="LQSub1"/&gt;
        &lt;sx:subtreeFieldMap select="N1Sub1" field="N1Sub1"/&gt;
        &lt;sx:subtreeFieldMap select="BR" field="BR"/&gt;
        &lt;sx:subtreeFieldMap select="BR01" field="BR01"/&gt;
        &lt;sx:subtreeFieldMap select="N1Sub2" field="N1Sub2"/&gt;
        &lt;sx:subtreeFieldMap select="G62Sub1" field="G62Sub1"/&gt;
        &lt;sx:subtreeFieldMap select="G62Sub2" field="G62Sub2"/&gt;
        &lt;sx:subtreeFieldMap select="G62Sub3" field="G62Sub3"/&gt;
        &lt;sx:subtreeFieldMap select="G62Sub4" field="G62Sub4"/&gt;
      &lt;/sx:flattenSubtree&gt;
    &lt;/sx:onSubtree&gt;
    &lt;sx:onSubtree path="/X12/PivotNode"&gt;
      &lt;sx:flattenSubtree recordType="dlss2"&gt;
        &lt;sx:subtreeFieldMap select="LQSub2" field="LQSub2"/&gt;
        &lt;sx:subtreeFieldMap select="N104Sub" field="N104Sub"/&gt;
        &lt;sx:subtreeFieldMap select="N9Sub2" field="N9Sub2"/&gt;
        &lt;sx:subtreeFieldMap select="LQSub5" field="LQSub5"/&gt;
        &lt;sx:subtreeFieldMap select="QTY01" field="QTY01"/&gt;
        &lt;sx:subtreeFieldMap select="N9Sub1" field="N9Sub1"/&gt;
        &lt;sx:subtreeFieldMap select="LQSub7" field="LQSub7"/&gt;
        &lt;sx:subtreeFieldMap select="LQSub6" field="LQSub6"/&gt;
        &lt;sx:subtreeFieldMap select="FA2" field="FA2"/&gt;
        &lt;sx:subtreeFieldMap select="LQSub4" field="LQSub4"/&gt;
        &lt;sx:subtreeFieldMap select="LQSub8" field="LQSub8"/&gt;
        &lt;sx:subtreeFieldMap select="LQSub9" field="LQSub9"/&gt;
        &lt;sx:subtreeFieldMap select="G62Sub6" field="G62Sub6"/&gt;
        &lt;sx:subtreeFieldMap select="LQSub3" field="LQSub3"/&gt;
        &lt;sx:subtreeFieldMap select="G62Sub7" field="G62Sub7"/&gt;
        &lt;sx:subtreeFieldMap select="G62Sub8" field="G62Sub8"/&gt;
      &lt;/sx:flattenSubtree&gt;
    &lt;/sx:onSubtree&gt;
  &lt;/sx:inverseRecordMapping&gt;

&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p></p>
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -i Edi517M2xml.xml -r resources-xml-517M.xml -o Edi517M.txt xmltodlss 

</pre><p>
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2221"></a>A Directory of XML Documents to a Flat File</h3></div></div></div>


<a class="indexterm" name="d4e2224"></a>
<p> This example shows a resources script that will read a number of XML 
  documents in a directory and transform them into a single CSV file.  It 
  illustrates the use of the 
      <a class="link" href="../guide/index.html#sx:documentSequence" target="_top">sx:documentSequence</a> 
        element. 
</p>
<p>
The input is a directory of XML documents.
</p>
<pre class="programlisting">

  countries-1.xml
  countries-2.xml
  countries-3.xml
  countries-4.xml
  countries-5.xml

</pre>
<p>
The desired output is one CSV file containing all of the country entries.
</p>
<pre class="programlisting">

country_code,country_name
ABW,ARUBA
ADH,UNITED ARAB EMIRATES
...
ZWE,ZIMBABWE

</pre>
<p> The resources script <code class="filename">resources-countrySequence.xml</code> 
  does the transformation.
</p>
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:msv="http://www.servingxml.com/extensions/msv"&gt;

  &lt;sx:service id="countries-to-csv"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:subtreeRecordReader&gt;
        &lt;sx:inverseRecordMapping ref="countriesToFileMapping"/&gt;
        &lt;sx:transform&gt;
          &lt;sx:documentSequence wrapWith="result"&gt;
            &lt;sx:recordStream&gt;
              &lt;sx:directoryReader directory="data"&gt;
                &lt;sx:fileFilter pattern="countries.*[.]xml"/&gt;
              &lt;/sx:directoryReader&gt;
            &lt;/sx:recordStream&gt;
            &lt;sx:transform&gt;
              &lt;sx:document&gt;
                &lt;sx:fileSource directory="{parentDirectory}" file="{name}"/&gt;
              &lt;/sx:document&gt; 
              &lt;msv:schemaValidator&gt;
                &lt;sx:urlSource url="data/countries.xsd"/&gt;
              &lt;/msv:schemaValidator&gt;
            &lt;/sx:transform&gt;
          &lt;/sx:documentSequence&gt;
        &lt;/sx:transform&gt;
      &lt;/sx:subtreeRecordReader&gt;

      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="countriesFile"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="countriesFile"&gt;
    &lt;sx:commentStarter value="#"/&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="countryType"/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="countryType"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatRecordType name="country" id="countryType"&gt;
    &lt;sx:fieldDelimiter value=","/&gt;
    &lt;sx:delimitedField name="code" label="country_code"/&gt;
    &lt;sx:delimitedField name="name" label="country_name"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:inverseRecordMapping id="countriesToFileMapping"&gt;
    &lt;sx:onSubtree path="/result/countries/country"&gt;
      &lt;sx:flattenSubtree  recordType="country"&gt;
        &lt;sx:subtreeFieldMap select="countryName" field="name"/&gt;
        &lt;sx:subtreeFieldMap select="@countryCode" field="code"/&gt;
      &lt;/sx:flattenSubtree&gt;
    &lt;/sx:onSubtree&gt;
  &lt;/sx:inverseRecordMapping&gt;

&lt;/sx:resources&gt;

</pre>
  <p>
The effect of the <a class="link" href="../guide/index.html#sx:documentSequence" target="_top">sx:documentSequence</a> 
    instruction is to read all the documents in the <code class="filename">data</code>
    directory whose file names match the regular expression "countries.*[.]xml".
    The content of these documents is wrapped in the root element 
    <code class="sgmltag-element">result</code>.
  </p>
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources-countrySequence.xml -o output/countries.csv countries-to-csv

</pre><p>
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2242"></a>Summary and Detail XML Documents to a Flat File (eobclaims)</h3></div></div></div>


<a class="indexterm" name="d4e2245"></a>
<p> This example shows a resources script that will read a number of XML 
  documents in a directory and transform them into a single CSV file.  It 
  illustrates the use of the 
      <a class="link" href="../guide/index.html#sx:documentSequence" target="_top">sx:documentSequence</a> and
      <a class="link" href="../guide/index.html#saxon:xquery" target="_top">saxon:xquery</a>, 
        elements. 
</p>
<p>
The input is a directory of XML documents.
</p>
<pre class="programlisting">

eobclaims1.xml
eobclaims2.xml
eobclaimshdrtlr.xml

</pre>
<p>
The desired output is one CSV file containing all of the country entries.
</p>
<pre class="programlisting">

ADM2301EOBS GENERATED ON 06/1 3/08                                                                                                                                                                                                                                                     
HDR06/13/08200815501300101MEMBER01          BISHOP         
ADR1234 TEST DR                                                                                       ARVADA            
HDR06/13/08200815501300102MEMBER02          BISHOP         
ADR5678 TEST DR                                                                                       ARVADA                                 
TLRTOTAL EOBS GENERATED: 0000001000000000000010000018                                                                                                                                                                                                                                                       

</pre>
<p> The resources script <code class="filename">resources-eobclaims.xml</code> 
  does the transformation.  Note that this script includes the shared <a class="xref" href="#resource-eobclaims-flatfile.xml" title="Figure&nbsp;125.&nbsp;Record structure resource-eobclaims-flatfile.xml">eobclaims record structure declarations</a>.
</p>
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:saxon="http://www.servingxml.com/extensions/saxon"&gt;

  &lt;sx:include href="resources-eobclaims-flatfile.xml"/&gt;

  &lt;sx:service id="eobclaims-to-flat"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:subtreeRecordReader&gt;
        &lt;sx:inverseRecordMapping ref="eobclaims-to-flat-mapping"/&gt;
        &lt;sx:transform&gt;
          &lt;sx:documentSequence wrapWith="result"&gt;
            &lt;sx:content ref="eobclaims-document-header"/&gt;
            &lt;sx:content ref="eobclaims-document-body"/&gt;
            &lt;sx:content ref="eobclaims-document-trailer"/&gt;
          &lt;/sx:documentSequence&gt;
        &lt;/sx:transform&gt;
      &lt;/sx:subtreeRecordReader&gt;

      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="eobclaims-file"/&gt;
        &lt;sx:fileSink file="output/eobclaims.txt"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;saxon:xquery id="eobclaims-document-header"&gt;
    &lt;sx:preserveMarkup&gt;
      &lt;header&gt;
          {doc('data/eobclaimshdrtlr.xml')/headertrailer/ADMIN_RECTYPE}
      &lt;/header&gt;
    &lt;/sx:preserveMarkup&gt;
  &lt;/saxon:xquery&gt;

  &lt;saxon:xquery id="eobclaims-document-trailer"&gt;
    &lt;sx:preserveMarkup&gt;
        &lt;trailer&gt;
            {doc('data/eobclaimshdrtlr.xml')/headertrailer/TLR-REC-TYPE}
        &lt;/trailer&gt;
    &lt;/sx:preserveMarkup&gt;
  &lt;/saxon:xquery&gt;

  &lt;sx:documentSequence id="eobclaims-document-body"&gt;
    &lt;sx:directoryReader directory="data"&gt;
      &lt;sx:fileFilter pattern=".*[1-9].xml"/&gt;
    &lt;/sx:directoryReader&gt;
    &lt;sx:document&gt;
      &lt;sx:fileSource directory="{parentDirectory}" file="{name}"/&gt;
    &lt;/sx:document&gt;
  &lt;/sx:documentSequence&gt;

  &lt;sx:inverseRecordMapping id="eobclaims-to-flat-mapping"&gt;
    &lt;sx:onSubtree path="header/ADMIN_RECTYPE"&gt;
      &lt;sx:flattenSubtree recordType="ADM"&gt;
        &lt;sx:subtreeFieldMap select="@record_type" field="record_type"/&gt;
        &lt;sx:subtreeFieldMap select="ADM_0001_TEXT" field="ADM_0001_TEXT"/&gt;
        &lt;sx:subtreeFieldMap select="ADM_0001_RUN_DATE" field="ADM_0001_RUN_DATE"/&gt;
        &lt;sx:subtreeFieldMap select="FILLER" field="FILLER"/&gt;
      &lt;/sx:flattenSubtree&gt;
    &lt;/sx:onSubtree&gt;
    &lt;sx:onSubtree path="eob/HEADER_RECTYPE"&gt;
      &lt;sx:flattenSubtree recordType="HDR"&gt;
        &lt;sx:subtreeFieldMap select="@record_type" field="record_type"/&gt;
        &lt;sx:subtreeFieldMap select="HDR_STMT_DATE" field="HDR_STMT_DATE"/&gt;
        &lt;sx:subtreeFieldMap select="HDR_CLAIM_NUMBER" field="HDR_CLAIM_NUMBER"/&gt;
        &lt;sx:subtreeFieldMap select="HDR_PATIENT_NAME_FIRST" field="HDR_PATIENT_NAME_FIRST"/&gt;
        &lt;sx:subtreeFieldMap select="HDR_PATIENT_NAME_LAST" field="HDR_PATIENT_NAME_LAST"/&gt;
      &lt;/sx:flattenSubtree&gt;
    &lt;/sx:onSubtree&gt;
    &lt;sx:onSubtree path="eob/ADR_REC_TYPE"&gt;
      &lt;sx:flattenSubtree recordType="HDR"&gt;
        &lt;sx:subtreeFieldMap select="@record_type" field="record_type"/&gt;
        &lt;sx:subtreeFieldMap select="ADR_8512_ATTN" field="ADR_8512_ATTN"/&gt;
        &lt;sx:subtreeFieldMap select="HDR_CLAIM_NUMBER" field="HDR_CLAIM_NUMBER"/&gt;
        &lt;sx:subtreeFieldMap select="ADR_8514_CITY" field="ADR_8514_CITY"/&gt;
      &lt;/sx:flattenSubtree&gt;
    &lt;/sx:onSubtree&gt;
    &lt;sx:onSubtree path="trailer/TLR-REC-TYPE"&gt;
      &lt;sx:flattenSubtree recordType="TLR"&gt;
        &lt;sx:subtreeFieldMap select="@record_type" field="record_type"/&gt;
        &lt;sx:subtreeFieldMap select="TLR_0001_TEXT" field="TLR_0001_TEXT"/&gt;
        &lt;sx:subtreeFieldMap select="TLR_0001_COUNT" field="TLR_0001_COUNT"/&gt;
        &lt;sx:subtreeFieldMap select="FILLER" field="FILLER"/&gt;
      &lt;/sx:flattenSubtree&gt;
    &lt;/sx:onSubtree&gt;
  &lt;/sx:inverseRecordMapping&gt;

&lt;/sx:resources&gt;

</pre>
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources-eobclaims.xml -o output/eobclaims.txt eobclaims-to-flat

</pre><p>
</p>
</div>
</div>

 
  <div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d4e2261"></a>Flat File to Flat File</h2></div></div></div>

<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2263"></a>Converting a positional file to a pipe delimited file with header (positional to delimited)</h3></div></div></div>


<a class="indexterm" name="d4e2266"></a>
<p>
The example below illustrates how to prepare a resources script that will convert the 
positional flat file <code class="filename">books.txt</code> into the delimited flat file 
<code class="filename">new-books.txt</code>.  
</p>
<p>
The input file is a positional file.
</p>
<div class="figure"><a name="books-positional.txt"></a><p class="title"><b>Figure&nbsp;166.&nbsp;Input positional flat file books.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

CAuthor                        Title                              Price

FCharles Bukowski              Factotum                           22.95
FSergei Lukyanenko             The Night Watch                    17.99
FAndrew Crumey                 Mr Mee                             22.00
CSteven John Metsker           Building Parsers with Java         39.95

This is a trailer record

</pre>
</div></div><br class="figure-break">
<p>
The desired output file is a pipe delimited flat file.
</p>
<div class="figure"><a name="books-output.txt"></a><p class="title"><b>Figure&nbsp;167.&nbsp;Output pipe delimited flat file new-books.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

Author|Category|Title|Price
Charles Bukowski|F|Factotum|22.95
Sergei Lukyanenko|F|The Night Watch|17.99
Andrew Crumey|F|Mr Mee|22.00
Steven John Metsker|C|Building Parsers with Java|39.95

</pre>
</div></div><br class="figure-break">
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-conversion.xml"></a><p class="title"><b>Figure&nbsp;168.&nbsp;Resources script resources-conversion.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;
   
  &lt;sx:service id="new-books"&gt; 
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:flatFile ref="oldBooksFlatFile"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="newBooksFlatFile"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="newBooksFlatFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="newBookType"/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="newBookType"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;      

  &lt;sx:flatRecordType id="newBookType" name="newBookType"&gt;
    &lt;sx:fieldDelimiter value="|"/&gt;
    &lt;sx:delimitedField name="author" label="Author"/&gt;
    &lt;sx:delimitedField name="category" label="Category"/&gt;
    &lt;sx:delimitedField name="title" label= "Title"/&gt;
    &lt;sx:delimitedField name="price" label="Price"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatFile id="oldBooksFlatFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="oldBookType"/&gt;
      &lt;sx:annotationRecord/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="oldBookType"/&gt;
    &lt;/sx:flatFileBody&gt;
    &lt;sx:flatFileTrailer&gt;
      &lt;sx:annotationRecord&gt;&lt;/sx:annotationRecord&gt;
      &lt;sx:annotationRecord&gt;This is a trailer record&lt;/sx:annotationRecord&gt;
    &lt;/sx:flatFileTrailer&gt;
  &lt;/sx:flatFile&gt;      

  &lt;sx:flatRecordType id="oldBookType" name="oldBookType"&gt;
    &lt;sx:positionalField name="category" width="1"/&gt;
    &lt;sx:positionalField name="author" width="30"/&gt;
    &lt;sx:positionalField name="title" width="30"/&gt;
    &lt;sx:positionalField name="price" width="10" justify="right"/&gt;
  &lt;/sx:flatRecordType&gt;
  
&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources-conversion.xml  -i data/books.txt 
    -o output/new-books.txt new-books

</pre><p>
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2286"></a>Converting a positional file to a new positional file with default field values (positional defaults)</h3></div></div></div>


<a class="indexterm" name="d4e2289"></a>
<p>
The example below illustrates how to prepare a resources script that will convert the 
positional flat file <code class="filename">books.txt</code> into the new positional flat file 
<code class="filename">book-defaults.txt</code>.  
</p>
<p>
The input file is a positional file.
</p>
<div class="figure"><a name="books.txt-def"></a><p class="title"><b>Figure&nbsp;169.&nbsp;Input positional flat file books.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

CAuthor                        Title                              Price

FCharles Bukowski              Factotum                           22.95
FSergei Lukyanenko             The Night Watch                    17.99
FAndrew Crumey                 Mr Mee                             22.00
CSteven John Metsker           Building Parsers with Java         39.95

This is a trailer record

</pre>
</div></div><br class="figure-break">
<p>
The desired output file is a new positional flat file with a different field ordering,
a comma instead of a period in "Price", a new "Pub Date" field initialized to
spaces, and a new Publisher field initialized to "Acme".
</p>
<div class="figure"><a name="book-defaults.txt"></a><p class="title"><b>Figure&nbsp;170.&nbsp;Output positional flat file books-defaults.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

Author                        Title                         CPub Date  Publisher           Price
Charles Bukowski              Factotum                      F          Acme                22,95
Sergei Lukyanenko             The Night Watch               F          Acme                17,99
Andrew Crumey                 Mr Mee                        F          Acme                22,00
Steven John Metsker           Building Parsers with Java    C          Acme                39,95

</pre>
</div></div><br class="figure-break">
<p>
This can be accomplished with the following resources script..
</p>
<div class="figure"><a name="resources-bookDefaults.xml"></a><p class="title"><b>Figure&nbsp;171.&nbsp;Resources script resources-bookDefaults.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="book-defaults"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:flatFile ref="oldBooksFlatFile"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="newBooksFlatFile"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="newBooksFlatFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="newBookType"/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="newBookType"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatRecordType id="newBookType" name="newBookType"&gt;
    &lt;sx:positionalField name="author" width="30" label="Author"/&gt;
    &lt;sx:positionalField name="title" width="30" label="Title"/&gt;
    &lt;sx:positionalField name="category" width="1" label="C"/&gt;
    &lt;sx:positionalField name="pubDate" width="10" label="Pub Date"/&gt;
    &lt;sx:positionalField name="publisher" width="15" label="Publisher"&gt;
      &lt;sx:defaultValue&gt;Acme&lt;/sx:defaultValue&gt;
    &lt;/sx:positionalField&gt;
    &lt;sx:positionalField name="price2" width="10" justify="right" label="Price"&gt;
      &lt;sx:defaultValue&gt;
        &lt;sx:findAndReplace searchFor ="." replaceWith="," useRegex="false"&gt;
          &lt;sx:toString value="{price}"/&gt;    
        &lt;/sx:findAndReplace&gt;
      &lt;/sx:defaultValue&gt;
    &lt;/sx:positionalField&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatFile id="oldBooksFlatFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="oldBookType"/&gt;
      &lt;sx:annotationRecord/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="oldBookType"/&gt;
    &lt;/sx:flatFileBody&gt;
    &lt;sx:flatFileTrailer&gt;
      &lt;sx:annotationRecord&gt;&lt;/sx:annotationRecord&gt;
      &lt;sx:annotationRecord&gt;This is a trailer record&lt;/sx:annotationRecord&gt;
    &lt;/sx:flatFileTrailer&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatRecordType id="oldBookType" name="oldBookType"&gt;
    &lt;sx:positionalField name="category" width="1"/&gt;
    &lt;sx:positionalField name="author" width="30"/&gt;
    &lt;sx:positionalField name="title" width="30"/&gt;
    &lt;sx:positionalField name="price" width="10" justify="right"/&gt;
  &lt;/sx:flatRecordType&gt;

&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources-bookDefaults.xml  -i data/books.txt 
    -o output/book-defaults.txt book-defaults

</pre><p>
</p>
</div>

<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2310"></a>Converting an ASCII Positional File to an EBCDIC Delimited File, and Vice Versa (ASCII-EBCDIC)</h3></div></div></div>


<a class="indexterm" name="d4e2313"></a>
<p>
The example below illustrates how to prepare a resources script that will convert the 
ASCII <a class="xref" href="#books-positional.txt" title="Figure&nbsp;100.&nbsp;Input positional flat file books.txt">books.txt</a> file of the last example to an EBCDIC file, and vice versa.
</p>
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-ascii-ebcdic.xml"></a><p class="title"><b>Figure&nbsp;172.&nbsp;Resources script resources-ascii-ebcdic.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;
   
  &lt;sx:service id="ascii2ebcdic"&gt; 
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:flatFile ref="asciiBooksFile"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="ebcdicBooksFile"/&gt;
        &lt;sx:defaultStreamSink encoding="Cp1047"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:service id="ebcdic2ascii"&gt; 
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:flatFile ref="ebcdicBooksFile"/&gt;
        &lt;sx:defaultStreamSource encoding="Cp1047"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="asciiBooksFile"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;
  
  &lt;sx:flatFile id="ebcdicBooksFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="ebcdicBookType"/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="ebcdicBookType"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;      

  &lt;sx:flatRecordType id="ebcdicBookType" name="ebcdicBookType"&gt;
    &lt;sx:fieldDelimiter value="|"/&gt;
    &lt;sx:delimitedField name="author" label="Author"/&gt;
    &lt;sx:delimitedField name="category" label="Category"/&gt;
    &lt;sx:delimitedField name="title" label= "Title"/&gt;
    &lt;sx:delimitedField name="price" label="Price"/&gt;
  &lt;/sx:flatRecordType&gt;
  
  &lt;sx:flatFile id="asciiBooksFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="asciiBookType"/&gt;
      &lt;sx:annotationRecord/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="asciiBookType"/&gt;
    &lt;/sx:flatFileBody&gt;
    &lt;sx:flatFileTrailer&gt;
      &lt;sx:annotationRecord&gt;&lt;/sx:annotationRecord&gt;
      &lt;sx:annotationRecord&gt;This is a trailer record&lt;/sx:annotationRecord&gt;
    &lt;/sx:flatFileTrailer&gt;
  &lt;/sx:flatFile&gt;      

  &lt;sx:flatRecordType id="asciiBookType" name="asciiBookType"&gt;
    &lt;sx:positionalField name="category" width="1"/&gt;
    &lt;sx:positionalField name="author" width="30"/&gt;
    &lt;sx:positionalField name="title" width="30"/&gt;
    &lt;sx:positionalField name="price" width="10" justify="right"/&gt;
  &lt;/sx:flatRecordType&gt;
  
&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>
You can run convert the ASCII file books.txt to the EBCDIC file books-ebcdic.dat with the command
</p>
<pre class="programlisting">

servingxml -r resources-ascii-ebcdic.xml -i data/books.txt 
    -o output/books-ebcdic.dat ascii2ebcdic

</pre>
<p>
You can run convert the EBCDIC file books-ebcdic.dat to the ASCII file books-ascii.txt with the command
</p>
<pre class="programlisting">

servingxml -r resources-ascii-ebcdic.xml -i data/books-ebcdic.dat 
    -o output/books-ascii.txt ebcdic2ascii

</pre>
</div>

<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2326"></a>Converting an ASCII Positional File to an EBCDIC Positional File with a Cobol Packed Decimal Field, and Vice Versa (ASCII-Packed)</h3></div></div></div>


<a class="indexterm" name="d4e2329"></a>
<p>
The example below illustrates how to prepare a resources script that will convert the 
ASCII <a class="xref" href="#books-positional.txt" title="Figure&nbsp;100.&nbsp;Input positional flat file books.txt">books.txt</a> file to an EBCDIC positional file with a Cobol packed decimal field, and vice versa.
</p>
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-ascii-ebcdic.xml"></a><p class="title"><b>Figure&nbsp;173.&nbsp;Resources script resources-ascii-ebcdic.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="books2ebcdic-packed"&gt; 
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:flatFile ref="booksFile"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="booksFile2"/&gt;
        &lt;sx:defaultStreamSink encoding="Cp1047"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:service id="ebcdic-packed2books"&gt; 
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:flatFile ref="booksFile2"/&gt;
        &lt;sx:defaultStreamSource encoding="Cp1047"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="booksFile"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;
  
  &lt;sx:flatFile id="booksFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="bookType"/&gt;
      &lt;sx:annotationRecord/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="bookType"/&gt;
    &lt;/sx:flatFileBody&gt;
    &lt;sx:flatFileTrailer&gt;
      &lt;sx:annotationRecord&gt;&lt;/sx:annotationRecord&gt;
      &lt;sx:annotationRecord&gt;This is a trailer record&lt;/sx:annotationRecord&gt;
    &lt;/sx:flatFileTrailer&gt;
  &lt;/sx:flatFile&gt;      

  &lt;sx:flatFile id="booksFile2" lineDelimited="false"&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="bookType2"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;      

  &lt;sx:flatRecordType id="bookType" name="bookType"&gt;
    &lt;sx:positionalField name="category" label="Category" width="1"/&gt;
    &lt;sx:positionalField name="author" label="Author" width="30"/&gt;
    &lt;sx:positionalField name="title" label="Title" width="30"/&gt;
    &lt;sx:positionalField name="price" label="Price" width="10" justify="right"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatRecordType id="bookType2" name="bookType"&gt;
    &lt;sx:positionalField name="category" label="Category" width="1"/&gt;
    &lt;sx:positionalField name="author" label="Author" width="30"/&gt;
    &lt;sx:positionalField name="title" label="Title" width="30"/&gt;
    &lt;sx:packedDecimalField name="price" label="Price" digitCount="10" decimalPlaces="2"/&gt;
  &lt;/sx:flatRecordType&gt;
  
&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>
You can run convert the ASCII file, books.txt, to the EBCDIC file with the packed decimal price field, books-ebcdic.dat, with the command
</p>
<pre class="programlisting">

servingxml -r resources-books_ebcdic_packed.xml -i data/books.txt 
    -o output/books_ebcdic_packed.dat   books2ebcdic-packed

</pre>
<p>
You can run convert the EBCDIC file with the packed decimal price field, books_ebcdic_packed.dat,
 to the ASCII file, books-ascii_unpacked.txt, with the command
</p>
<pre class="programlisting">

servingxml -r resources-books_ebcdic_packed.xml -i data/books_ebcdic_packed.dat 
    -o output/books_ascii_unpacked.txt   ebcdic-packed2books

</pre>
</div>

<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2342"></a>Converting a positional file to a pipe delimited file with record filtering (book orders)</h3></div></div></div>


<a class="indexterm" name="d4e2345"></a>
<a class="indexterm" name="d4e2348"></a>
<a class="indexterm" name="d4e2351"></a>
<p>
The example below illustrates how to prepare a resources script that will convert the 
positional flat file <code class="filename">bookorders-pos.txt</code> into the pipe-delimited flat file 
<code class="filename">bookorders-delim.txt</code>.  
</p>
<p>
The input file is a positional file.
</p>
<div class="figure"><a name="bookorders-pos.xml"></a><p class="title"><b>Figure&nbsp;174.&nbsp;Input positional flat file bookorders-pos.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

CAuthor                        Title                              Price InvoiceNo InvoiceDate

FCharles Bukowski              Factotum                           22.95 001  12/Mar/2005
FSergei Lukyanenko             The Night Watch                    17.99 002  13/Mar/2005
FAndrew Crumey                 Mr Mee                             22.00 003 14/June/2005
CSteven John Metsker           Building Parsers with Java         39.95 004 15/June/2005

This is a trailer record

</pre>
</div></div><br class="figure-break">
<p>
The desired output file is a pipe delimited flat file.
</p>
<div class="figure"><a name="bookorders-delim.txt"></a><p class="title"><b>Figure&nbsp;175.&nbsp;Output pipe delimited flat file bookorders-delim.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

Author|Category|Title|Price|InvoiceNo|InvoiceDate
Charles Bukowski|F|Factotum|22.95|INV001|12/03/2005
Sergei Lukyanenko|F|The Night Watch|17.99|INV002|13/03/2005
Andrew Crumey|F|Mr Mee|22.00|INV003|14/06/2005
Steven John Metsker|C|Building Parsers with Java|39.95|INV004|15/06/2005

</pre>
</div></div><br class="figure-break">
<p>
Note the following:
</p><div class="itemizedlist"><ul type="disc"><li><p>The invoice number has the text "INV" prepended, e.g. "001" becomes "INV001"
</p></li><li><p>The month labels Mar, June etc. have been converted to numbers.
</p></li></ul></div><p>
</p>
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-bookorders.xml"></a><p class="title"><b>Figure&nbsp;176.&nbsp;Resources script resources-bookorders.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;
   
  &lt;sx:service id="orders-pos-delim"&gt; 
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:flatFile ref="posBooksFlatFile"/&gt;                                                                                          
      &lt;/sx:flatFileReader&gt;
      &lt;sx:replaceRecord ref="changeBookOrder"/&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="delimBooksFlatFile"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:replaceRecord id="changeBookOrder"&gt;
    &lt;sx:newRecord fields="*"&gt;
      &lt;sx:newField name="invoiceno"&gt;
        &lt;sx:findAndReplace searchFor ="([0-9]{3})" replaceWith ="INV$1"&gt;&lt;sx:toString value="{invoiceno}"/&gt;&lt;/sx:findAndReplace&gt;
      &lt;/sx:newField&gt;
      &lt;sx:newField name="invoicedate"&gt;
        &lt;sx:convertDate fromFormat="dd/MMM/yyyy"
                        toFormat="dd/MM/yyyy"&gt;
          &lt;sx:toString value="{invoicedate}"/&gt;
        &lt;/sx:convertDate&gt;
      &lt;/sx:newField&gt;
    &lt;/sx:newRecord&gt;
  &lt;/sx:replaceRecord&gt;

   &lt;sx:flatFile id="delimBooksFlatFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="delimBookType"/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="delimBookType"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;      

  &lt;sx:flatRecordType id="delimBookType" name="delimBookType"&gt;
    &lt;sx:fieldDelimiter value="|"/&gt;
    &lt;sx:delimitedField name="author" label="Author"/&gt;
    &lt;sx:delimitedField name="category" label="Category"/&gt;
    &lt;sx:delimitedField name="title" label= "Title"/&gt;
    &lt;sx:delimitedField name="price" label="Price"/&gt;
    &lt;sx:delimitedField name="invoiceno" label="InvoiceNo"/&gt;
    &lt;sx:delimitedField name="invoicedate" label="InvoiceDate"/&gt;
  &lt;/sx:flatRecordType&gt;
  
  &lt;sx:flatFile id="posBooksFlatFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="posBookType"/&gt;
      &lt;sx:annotationRecord/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="posBookType"/&gt;
    &lt;/sx:flatFileBody&gt;
    &lt;sx:flatFileTrailer&gt;
      &lt;sx:annotationRecord&gt;&lt;/sx:annotationRecord&gt;
      &lt;sx:annotationRecord&gt;This is a trailer record&lt;/sx:annotationRecord&gt;
    &lt;/sx:flatFileTrailer&gt;
  &lt;/sx:flatFile&gt;      

  &lt;sx:flatRecordType id="posBookType" name="posBookType"&gt;
    &lt;sx:positionalField name="category" width="1"/&gt;
    &lt;sx:positionalField name="author" width="30"/&gt;
    &lt;sx:positionalField name="title" width="30"/&gt;
    &lt;sx:positionalField name="price" width="10" justify="right"/&gt;
    &lt;sx:positionalField name="invoiceno" width="4" justify="right"/&gt;
    &lt;sx:positionalField name="invoicedate" width="13" justify="right"/&gt;
  &lt;/sx:flatRecordType&gt;
  
&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by entering
</p>
<pre class="programlisting">

servingxml  -i data/bookorders-pos.txt -r resources-bookorders.xml 
    -o output/bookorders-delim.txt orders-pos-delim 

</pre>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2377"></a>Checking the Integrity of a Flat File ("checked books")</h3></div></div></div>


<a class="indexterm" name="d4e2380"></a>
<a class="indexterm" name="d4e2383"></a>
<a class="indexterm" name="d4e2386"></a>
<p>
The example below illustrates how to prepare a resources script for checking and signing flat files
with CRC values and byte counts.  Here, the input file is the 
positional flat file <code class="filename">checkedBooks.txt</code>, to be converted into the pipe-delimited flat file 
<code class="filename">signedBooks.txt</code>.  
</p>
<p>
The input file is a positional file.
</p>
<div class="figure"><a name="checkedBooks.txt"></a><p class="title"><b>Figure&nbsp;177.&nbsp;Input positional flat file checkedBooks.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

356      2360012630

FCharles Bukowski              Factotum                           22.95 001  12/Mar/2005
FSergei Lukyanenko             The Night Watch                    17.99 002  13/Mar/2005
FAndrew Crumey                 Mr Mee                             22.00 003  14/Jun/2005
CSteven John Metsker           Building Parsers with Java         39.95 004  15/Jun/2005

This is a trailer record

</pre>
</div></div><br class="figure-break">
<p>
Note the following.
</p>
<div class="itemizedlist"><ul type="disc"><li><p>The file has a two line header section, followed by a data section, followed by a two line trailer section.
  </p></li><li><p>The first line of the header contains two positional fields, the size of the data section in bytes, 
  followed by the CRC for the data section.
  </p></li></ul></div>
<p>
The desired output file is a pipe delimited flat file.
</p>
<div class="figure"><a name="signedBooks.txt"></a><p class="title"><b>Figure&nbsp;178.&nbsp;Output pipe delimited flat file signedBooks.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

Author|Category|Title|Price|InvoiceNo|InvoiceDate
237|1661800843
Charles Bukowski|F|Factotum|22.95|001|12/Mar/2005
Sergei Lukyanenko|F|The Night Watch|17.99|002|13/Mar/2005
Andrew Crumey|F|Mr Mee|22.00|003|14/Jun/2005
Steven John Metsker|C|Building Parsers with Java|39.95|004|15/Jun/2005

</pre>
</div></div><br class="figure-break">
<p>The output file has a two line header section.  The two delimited fields 
in the second line store the size and CRC of the data section below.
</p>
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-checkedBooks.xml"></a><p class="title"><b>Figure&nbsp;179.&nbsp;Resources script resources-checkedBooks.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="books-pos-delim"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:flatFile ref="posBooksFlatFile"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="delimBooksFlatFile"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="delimBooksFlatFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="delimBookType"/&gt;
      &lt;sx:flatRecordType ref="delimBookHeaderType"/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="delimBookType"/&gt;
    &lt;/sx:flatFileBody&gt;
    &lt;sx:flatFileSignature recordType="bookHeaderType" field="filecrc" method="crc"/&gt;
    &lt;sx:flatFileSignature recordType="bookHeaderType" field="filesize" method="size"/&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatRecordType id="delimBookType" name="delimBookType"&gt;
    &lt;sx:fieldDelimiter value="|"/&gt;
    &lt;sx:delimitedField name="author" label="Author"/&gt;
    &lt;sx:delimitedField name="category" label="Category"/&gt;
    &lt;sx:delimitedField name="title" label= "Title"/&gt;
    &lt;sx:delimitedField name="price" label="Price"/&gt;
    &lt;sx:delimitedField name="invoiceno" label="InvoiceNo"/&gt;
    &lt;sx:delimitedField name="invoicedate" label="InvoiceDate"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatRecordType id="delimBookHeaderType" name="bookHeaderType"&gt;
    &lt;sx:fieldDelimiter value="|"/&gt;
    &lt;sx:delimitedField name="filesize"/&gt;
    &lt;sx:delimitedField name="filecrc"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatFile id="posBooksFlatFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="posBookHeaderType"/&gt;
      &lt;sx:annotationRecord/&gt;
    &lt;/sx:flatFileHeader&gt;

    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="posBookType"/&gt;
    &lt;/sx:flatFileBody&gt;

    &lt;sx:flatFileTrailer&gt;
      &lt;sx:annotationRecord&gt;&lt;/sx:annotationRecord&gt;
      &lt;sx:annotationRecord&gt;This is a trailer record&lt;/sx:annotationRecord&gt;
    &lt;/sx:flatFileTrailer&gt;

    &lt;sx:flatFileSignature recordType="bookHeaderType" field="filesize" method="size"/&gt;
    &lt;sx:flatFileSignature recordType="bookHeaderType" field="filecrc" method="crc"/&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatRecordType id="posBookHeaderType" name="bookHeaderType"&gt;
    &lt;sx:positionalField name="filesize" width="9"/&gt;
    &lt;sx:positionalField name="filecrc" width="10"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatRecordType id="posBookType" name="posBookType"&gt;
    &lt;sx:positionalField name="category" width="1"/&gt;
    &lt;sx:positionalField name="author" width="30"/&gt;
    &lt;sx:positionalField name="title" width="30"/&gt;
    &lt;sx:positionalField name="price" width="10" justify="right"/&gt;
    &lt;sx:positionalField name="invoiceno" width="4" justify="right"/&gt;
    &lt;sx:positionalField name="invoicedate" width="13" justify="right"/&gt;
  &lt;/sx:flatRecordType&gt;

&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>Note the following.
</p>
<div class="itemizedlist"><ul type="disc"><li><p>The <a class="link" href="../guide/index.html#sx:recordContent" target="_top">sx:recordContent</a> element contains two <a class="link" href="../guide/index.html#sx:flatFileSignature" target="_top">sx:flatFileSignature</a> elements,
  which define the rules for checking the CRC and size when reading the file, and signing the header or trailer with a CRC and size when writing the file.
  </p></li><li><p>The <a class="link" href="../guide/index.html#sx:flatFileSignature" target="_top">sx:flatFileSignature</a> element has attributes 
  <code class="sgmltag-attribute">recordType</code> and <code class="sgmltag-attribute">field</code>, which 
  identify where in the header or trailer the signature value belongs.
  </p></li></ul></div>
<p>
You can run this example on the command line by entering
</p>
<pre class="programlisting">

servingxml  -i data/checkedBooks.txt -r resources-checkedBooks.xml 
    -o output/checkedBooks-delim.txt books-pos-delim 

</pre>
<p>If the CRC value in the header does not match the computed CRC value for the data, processing will be stopped
and a message will be written to the log:
</p>
<pre class="programlisting">

CRC integrity check failed.  Expected 2360012630, found 252430032.

</pre>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2426"></a>Converting a directory of book positional files to pipe delimited files (new format)</h3></div></div></div>


<a class="indexterm" name="d4e2429"></a>
<a class="indexterm" name="d4e2432"></a>
<a class="indexterm" name="d4e2435"></a>
<a class="indexterm" name="d4e2438"></a>
<p>
The example below illustrates how to prepare a resources script that will process
all the files in the <code class="filename">data</code> directory matching the regular expression "books.*[.]txt",
convert them from positional flat file formats to pipe delimited formats, and write them out to the 
<code class="filename">output</code> directory.
</p>
<p>
This time the input is a directory of files.
</p>
<div class="figure"><a name="books.xml"></a><p class="title"><b>Figure&nbsp;180.&nbsp;Directory containing books fixed record length input files</b></p><div class="figure-contents">
  
<pre class="programlisting">

[.]                     countries.csv           multivalued-field.csv
[..]                    countries.xsd           plans.txt
3545_JH4DA3_4_H_.xml    country-record.xsd      tasks.csv
bad-countries.csv       exotics.txt             timesheets.csv
books.20040613.txt      hot-record.xsd          trades.txt
books.20040802.txt      hot-record.xsx
books.txt               hot.txt
books.xml               messages.properties
</pre>
</div></div><br class="figure-break">
<p>
We want to take the positional files whose names match the regular expression <code class="code">"(books.*)[.]txt"</code>
and convert them all into pipe delimited files.
</p>

<div class="figure"><a name="books.txt"></a><p class="title"><b>Figure&nbsp;181.&nbsp;Books pipe delimited output files.</b></p><div class="figure-contents">
  
<pre class="programlisting">

books-new.txt            books.20040802-new.txt
books.20040613-new.txt

</pre>
</div></div><br class="figure-break">

<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-books2csv.xml"></a><p class="title"><b>Figure&nbsp;182.&nbsp;Resources script resources-books2csv.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="all-books"&gt; 
    &lt;sx:recordStream&gt;
      &lt;sx:directoryReader directory="data"&gt;
        &lt;sx:fileFilter pattern="books.*[.]txt"/&gt;
      &lt;/sx:directoryReader&gt;
      &lt;sx:processRecord&gt;
        &lt;sx:parameter name="output-file"&gt;
          &lt;sx:findAndReplace searchFor ="(books.*)[.]txt" replaceWith ="$1-new.txt"&gt;&lt;sx:toString value="{name}"/&gt;&lt;/sx:findAndReplace&gt;
        &lt;/sx:parameter&gt;   
        &lt;sx:recordStream&gt;
          &lt;sx:flatFileReader&gt;
            &lt;sx:fileSource directory="{parentDirectory}" file="{name}"/&gt;
            &lt;sx:flatFile ref="oldBooksFlatFile"/&gt;
          &lt;/sx:flatFileReader&gt;
          &lt;sx:flatFileWriter&gt;
            &lt;sx:fileSink directory="output" file="{$output-file}"/&gt; 
            &lt;sx:flatFile ref="newBooksFlatFile"/&gt;
          &lt;/sx:flatFileWriter&gt;
        &lt;/sx:recordStream&gt;
      &lt;/sx:processRecord&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatRecordType name="newBookType"&gt;
    &lt;sx:fieldDelimiter value="|"/&gt;
    &lt;sx:delimitedField name="author" label="Author"/&gt;
    &lt;sx:delimitedField name="category" label="Category"/&gt;
    &lt;sx:delimitedField name="title" label= "Title"/&gt;
    &lt;sx:delimitedField name="price" label="Price"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatFile id="oldBooksFlatFile"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="oldBookType"/&gt;
      &lt;sx:annotationRecord/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="oldBookType"/&gt;
    &lt;/sx:flatFileBody&gt;
    &lt;sx:flatFileTrailer&gt;
      &lt;sx:annotationRecord&gt;&lt;/sx:annotationRecord&gt;
      &lt;sx:annotationRecord&gt;This is a trailer record&lt;/sx:annotationRecord&gt;
    &lt;/sx:flatFileTrailer&gt;
  &lt;/sx:flatFile&gt;      

  &lt;sx:flatRecordType id="oldBookType" name="oldBookType"&gt;
    &lt;sx:positionalField name="category" width="1"/&gt;
    &lt;sx:positionalField name="author" width="30"/&gt;
    &lt;sx:positionalField name="title" width="30"/&gt;
    &lt;sx:positionalField name="price" width="10" justify="right"/&gt;
  &lt;/sx:flatRecordType&gt;

&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml  -r resources-conversion.xml all-books

</pre><p>
</p>
</div>

<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="multiple_output_files"></a>Generated records to multiple files (multiple_output_files)</h3></div></div></div>


<a class="indexterm" name="d4e2462"></a>
<a class="indexterm" name="d4e2465"></a>
<p>                     
The example below illustrates how to prepare a resources script that will send the
the output of a custom record reader to multiple output files, depending on
parameter and record field values supplied by the custom record reader. 
</p>
<p>
The input records are generated by the following Java class.
</p>
<div class="figure"><a name="TradeRecordReader.java"></a><p class="title"><b>Figure&nbsp;183.&nbsp;TradeRecordReader Java class</b></p><div class="figure-contents">
  
<pre class="programlisting">

package flat2flat;

import com.servingxml.app.ServiceContext;
import com.servingxml.components.recordio.AbstractRecordReader;
import com.servingxml.app.Flow;
import com.servingxml.util.Name;
import com.servingxml.util.QualifiedName;
import com.servingxml.util.ServingXmlException;
import com.servingxml.util.record.Record;
import com.servingxml.util.record.RecordBuilder;
import com.servingxml.util.record.ParameterBuilder;

public class TradeRecordReader extends AbstractRecordReader {
  private static final Name FEED_NAME = new QualifiedName("feed");
  private static final Name TRADE_RECORD_TYPE = new QualifiedName("trade");
  private static final Name TRANSACTION_RECORD_TYPE = new QualifiedName("transaction");
  private static final Name RECORD_TYPE_NAME = new QualifiedName("record_type");
  private static final Name ID_NAME = new QualifiedName("id");
  private static final Name TRADE_DATE_NAME = new QualifiedName("trade_date");
  private static final Name TRADE_TIME_NAME = new QualifiedName("trade_time");
  private static final Name DESCRIPTION_NAME = new QualifiedName("description");
  private static final Name REFERENCE_NAME = new QualifiedName("reference");
  
  public void readRecords(ServiceContext context, Flow flow) 
   {

    //  Start the record stream
    startRecordStream(context, flow);

    ParameterBuilder parameterBuilder = new ParameterBuilder(flow.getParameters());

    RecordBuilder trRecordBuilder = new RecordBuilder(TRADE_RECORD_TYPE);
    RecordBuilder tnRecordBuilder = new RecordBuilder(TRANSACTION_RECORD_TYPE);

    Record newParameters;
    Record record;

    //  Load London trades
    //  Set the parameter feed=LONDON
    parameterBuilder.setString(FEED_NAME,"LONDON");
    newParameters = parameterBuilder.toRecord();

    trRecordBuilder.setString(RECORD_TYPE_NAME,"TR");
    trRecordBuilder.setString(ID_NAME,"0001");
    trRecordBuilder.setString(TRADE_DATE_NAME,"03/25/2005");
    trRecordBuilder.setString(TRADE_TIME_NAME,"01:50:00");
    trRecordBuilder.setString(DESCRIPTION_NAME,"This is a trade record");
    record = trRecordBuilder.toRecord();
    trRecordBuilder.clear();

    //  Write the London "trade" record
    Flow newFlow = flow.replaceParameters(context, newParameters).replaceRecord(context, record);
    writeRecord(context, newFlow);

    tnRecordBuilder.setString(RECORD_TYPE_NAME,"TN");
    tnRecordBuilder.setString(ID_NAME,"0002");
    tnRecordBuilder.setString(REFERENCE_NAME,"X1234");
    tnRecordBuilder.setString(DESCRIPTION_NAME,"A child transaction");
    record = tnRecordBuilder.toRecord();   
    tnRecordBuilder.clear();

    //  Write the first London "transaction" record
    newFlow = flow.replaceRecord(context, record);
    writeRecord(context, newFlow);

    tnRecordBuilder.setString(RECORD_TYPE_NAME,"TN");
    tnRecordBuilder.setString(ID_NAME,"0003");
    tnRecordBuilder.setString(REFERENCE_NAME,"X1235");
    tnRecordBuilder.setString(DESCRIPTION_NAME,"Another child transaction");
    record = tnRecordBuilder.toRecord();
    tnRecordBuilder.clear();

    //  Write the second London "transaction" record
    newFlow = flow.replaceRecord(context, record);
    writeRecord(context, newFlow);

    //  Load Toronto trades
    //  Set the parameter feed=TORONTO
    parameterBuilder.setString(FEED_NAME,"TORONTO");
    newParameters = parameterBuilder.toRecord();

    trRecordBuilder.setString(RECORD_TYPE_NAME,"TR");
    trRecordBuilder.setString(ID_NAME,"0004");
    trRecordBuilder.setString(TRADE_DATE_NAME,"03/25/2005");
    trRecordBuilder.setString(TRADE_TIME_NAME,"04:50:00");
    trRecordBuilder.setString(DESCRIPTION_NAME,"This is a trade record");
    record = trRecordBuilder.toRecord();
    trRecordBuilder.clear();

    //  Write the Toronto "trade" record
    newFlow = flow.replaceParameters(context, newParameters).replaceRecord(context, record);
    writeRecord(context, newFlow);

    tnRecordBuilder.setString(RECORD_TYPE_NAME,"TN");
    tnRecordBuilder.setString(ID_NAME,"0005");
    tnRecordBuilder.setString(REFERENCE_NAME,"X1236");
    tnRecordBuilder.setString(DESCRIPTION_NAME,"A child transaction");
    record = tnRecordBuilder.toRecord();   
    tnRecordBuilder.clear();

    //  Write the first Tronto "transaction" record
    newFlow = flow.replaceRecord(context, record);
    writeRecord(context, newFlow);

    tnRecordBuilder.setString(RECORD_TYPE_NAME,"TN");
    tnRecordBuilder.setString(ID_NAME,"0006");
    tnRecordBuilder.setString(REFERENCE_NAME,"X1237");
    tnRecordBuilder.setString(DESCRIPTION_NAME,"Another child transaction");
    record = tnRecordBuilder.toRecord();
    tnRecordBuilder.clear();

    //  Write the second Toronto "transaction" record
    newFlow = flow.replaceRecord(context, record);
    writeRecord(context, newFlow);

    //  End the record stream
    endRecordStream(context, flow);
  }
}

</pre>
</div></div><br class="figure-break">
<p>With parameter <code class="varname">feed</code>=<code class="code">LONDON</code>,
the <code class="code">TradeRecordReader</code> class will generate the following stream of records.
</p>
<div class="informaltable">
<table border="1"><colgroup><col><col><col><col><col></colgroup><thead><tr><th align="left">record_type</th><th align="left">id</th><th align="left">&nbsp;</th><th align="left">&nbsp;</th><th align="left">&nbsp;</th></tr></thead><tbody><tr><td align="left">TR</td><td align="left">0001</td><td align="left">03/25/2005</td><td align="left"> 1:50:00</td><td align="left">This is a trade record</td></tr><tr><td align="left">TN</td><td align="left">0002</td><td align="left">X1234</td><td align="left">A child transaction</td><td align="left">&nbsp;</td></tr><tr><td align="left">TN</td><td align="left">0003</td><td align="left">X1235</td><td align="left">Another child transaction</td><td align="left">&nbsp;</td></tr></tbody></table>
</div>
<p>With parameter <code class="varname">feed</code>=<code class="code">TORONTO</code>,
the <code class="code">TradeRecordReader</code> class will generate the following stream of records.
</p>
<div class="informaltable">
<table border="1"><colgroup><col><col><col><col><col></colgroup><thead><tr><th align="left">record_type</th><th align="left">id</th><th align="left">&nbsp;</th><th align="left">&nbsp;</th><th align="left">&nbsp;</th></tr></thead><tbody><tr><td align="left">TR</td><td align="left">0004</td><td align="left">03/25/2005</td><td align="left"> 4:50:00</td><td align="left">This is a trade record</td></tr><tr><td align="left">TN</td><td align="left">0005</td><td align="left">X1236</td><td align="left">A child transaction</td><td align="left">&nbsp;</td></tr><tr><td align="left">TN</td><td align="left">0006</td><td align="left">X1237</td><td align="left">Another child transaction</td><td align="left">&nbsp;</td></tr></tbody></table>
</div>

<p>
The LONDON master trades need to be written to the file <code class="filename">trades-London.txt</code>.
</p>
<div class="figure"><a name="trades-London.txt"></a><p class="title"><b>Figure&nbsp;184.&nbsp;Output flat file trades-London.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

000103/25/200501:50:00This is a trade record        

</pre>
<p>
The LONDON transaction details need to be written to the file <code class="filename">transaction-London.txt</code>.
</p>

</div></div><br class="figure-break">
<div class="figure"><a name="transactions-London.txt"></a><p class="title"><b>Figure&nbsp;185.&nbsp;Output flat file transactions-London.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

0002X1234A child transaction           
0003X1235Another child transaction     

</pre>
</div></div><br class="figure-break">

<p>
The TORONTO master trades need to be written to the file <code class="filename">trades-Toronto.txt</code>.
</p>
<div class="figure"><a name="trades-Toronto.txt"></a><p class="title"><b>Figure&nbsp;186.&nbsp;Output flat file trades-Toronto.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

000403/25/200504:50:00This is a trade record        

</pre>
<p>
The TORONTO transaction details need to be written to the file <code class="filename">transaction-Toronto.txt</code>.
</p>

</div></div><br class="figure-break">
<div class="figure"><a name="transactions-Toronto.txt"></a><p class="title"><b>Figure&nbsp;187.&nbsp;Output flat file transactions-Toronto.txt</b></p><div class="figure-contents">
  
<pre class="programlisting">

0005X1236A child transaction           
0006X1237Another child transaction     

</pre>
</div></div><br class="figure-break">
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-multiple_output_files.xml"></a><p class="title"><b>Figure&nbsp;188.&nbsp;Resources script resources-multiple_output_files.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="trades"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:customRecordReader class="flat2flat.TradeRecordReader"/&gt;
      &lt;!-- Which output file is determined by the parameter "feed"
            and the record field "record_type", which are both
            supplied in the custom record reader.
      --&gt;
      &lt;sx:choose&gt;
        &lt;sx:when test="$feed='LONDON' and record_type = 'TR'"&gt;
          &lt;sx:flatFileWriter&gt;
            &lt;sx:fileSink directory="output" file="trades-London.txt"/&gt;
            &lt;sx:flatFile ref="trades"/&gt;
          &lt;/sx:flatFileWriter&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="$feed = 'LONDON' and record_type = 'TN'"&gt;
          &lt;sx:flatFileWriter&gt;
            &lt;sx:fileSink directory="output" file="transactions-London.txt"/&gt;
            &lt;sx:flatFile ref="transactions"/&gt;
          &lt;/sx:flatFileWriter&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="$feed='TORONTO' and record_type = 'TR'"&gt;
          &lt;sx:flatFileWriter&gt;
            &lt;sx:fileSink directory="output" file="trades-Toronto.txt"/&gt;
            &lt;sx:flatFile ref="trades"/&gt;
          &lt;/sx:flatFileWriter&gt;
        &lt;/sx:when&gt;
        &lt;sx:when test="$feed = 'TORONTO' and record_type = 'TN'"&gt;
          &lt;sx:flatFileWriter&gt;
            &lt;sx:fileSink directory="output" file="transactions-Toronto.txt"/&gt;
            &lt;sx:flatFile ref="transactions"/&gt;
          &lt;/sx:flatFileWriter&gt;
        &lt;/sx:when&gt;
      &lt;/sx:choose&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="trades"&gt;
    &lt;sx:flatFileBody&gt;
          &lt;sx:flatRecordType name="trade"&gt;
            &lt;sx:positionalField name="id" width="4"/&gt;
            &lt;sx:positionalField name="trade_date" width="10"/&gt;
            &lt;sx:positionalField name="trade_time" width="8"/&gt;
            &lt;sx:positionalField name="description" width="30"/&gt;
          &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

  &lt;sx:flatFile id="transactions"&gt;
    &lt;sx:flatFileBody&gt;
          &lt;sx:flatRecordType name="transaction"&gt;
            &lt;sx:positionalField name="id" width="4"/&gt;
            &lt;sx:positionalField name="reference" width="5"/&gt;
            &lt;sx:positionalField name="description" width="30"/&gt;
          &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>
Note the following points.
</p><div class="itemizedlist"><ul type="disc"><li>
The record content is defined by a custom record reader, implemented in the Java class <code class="code">TradeRecordReader</code>.
</li></ul></div><p>
</p>
<p>
You can run this example on the command line by 
</p><div class="itemizedlist"><ul type="disc"><li>
Compiling the Java class <code class="code">TradeRecordReader</code> and copying 
the resulting <code class="filename">.class</code> file into the <code class="filename">dir/classes</code> directory
</li><li>
Entering the command
<pre class="programlisting">

servingxml -r resources-multiple_output_files.xml trades

</pre>
</li></ul></div><p>
</p>
</div>

<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2573"></a>Reading remote directories</h3></div></div></div>


<a class="indexterm" name="d4e2576"></a>
<a class="indexterm" name="d4e2579"></a>
<p>
This example shows how to read a remote directory and write a listing of its contents to a flat file.
</p>
<p>
The desired output is a positional flat file showing a remote directory listing.
</p>
<div class="figure"><a name="out-ftp.txt"></a><p class="title"><b>Figure&nbsp;189.&nbsp;Output flat file with directory listing</b></p><div class="figure-contents">
  
<pre class="programlisting">

Parent                        Name                          Size      Date Modified                 

/                             incoming                      28672     Mon Dec 20 03:27:00 PST 2004  
/                             lost+found                    16384     Wed Feb 07 00:00:00 PST 2001  
/                             pub                           4096      Sun Oct 17 23:45:00 PDT 2004  
/pub                          sf-overflow                   17        Sun Oct 17 23:45:00 PDT 2004  
/pub                          sourceforge                   581632    Mon Nov 15 18:34:00 PST 2004  
/pub/sourceforge              a                             28672     Fri Mar 19 00:00:00 PST 2004  
/pub/sourceforge/a            a-                            4096      Wed Oct 06 18:36:00 PDT 2004  
/pub/sourceforge/a/a-         a-4                           4096      Tue Dec 16 00:00:00 PST 2003  
/pub/sourceforge/a/a-/a-4     a4-0.01777.tar.gz             173990    Thu Feb 13 00:00:00 PST 2003  
/pub/sourceforge/a/a-/a-4     a4-0.03109.tar.gz             175327    Tue May 06 00:00:00 PDT 2003  
</pre>
</div></div><br class="figure-break">
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-ftp.xml"></a><p class="title"><b>Figure&nbsp;190.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:edt="http://www.servingxml.com/extensions/edtftp"&gt;
  
  &lt;edt:ftpClient id="sourceforge" host="upload.sourceforge.net" 
                 user="anonymous" password="xxx"/&gt;

  &lt;sx:service id="remote-dir-listing"&gt;
    &lt;sx:recordStream&gt;
      &lt;edt:ftpDirectoryReader remoteDirectory="." recurse="true" maxItems="10"&gt;
        &lt;edt:ftpClient ref="sourceforge"/&gt;
      &lt;/edt:ftpDirectoryReader&gt;
      &lt;sx:flatFileWriter&gt;
        &lt;sx:flatFile ref="directory-flat-file"/&gt;
      &lt;/sx:flatFileWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatRecordType id="directory-record-type" name="directory-record-type"&gt;
    &lt;sx:positionalField name="parentDirectory" label="Parent" width="30"/&gt;
    &lt;sx:positionalField name="name" label="Name" width="30"/&gt;
    &lt;sx:positionalField name="size" label="Size" width="10"/&gt;
    &lt;sx:positionalField name="lastModified" label="Date Modified" width="30"/&gt;
  &lt;/sx:flatRecordType&gt;

  &lt;sx:flatFile id="directory-flat-file"&gt;
    &lt;sx:flatFileHeader&gt;
      &lt;sx:flatRecordType ref="directory-record-type"/&gt;
      &lt;sx:annotationRecord/&gt;
    &lt;/sx:flatFileHeader&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType ref="directory-record-type"/&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;      
  
&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources.xml -o output/remote-dir-listing.txt remote-dir-listing

</pre><p>
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2593"></a>Converting a sequential stream of records into multiple batch files</h3></div></div></div>


<a class="indexterm" name="d4e2596"></a>
<p>
The example below illustrates how to prepare a resources script that wil break up a stream of records into
multiple batches.
</p>
<p>
We want to read the CSV file countries.csv containing 245 country records and produce five files containing 
50, 50, 50, 50 and 45 country records.
</p>

<div class="figure"><a name="countries-d.csv"></a><p class="title"><b>Figure&nbsp;191.&nbsp;Batched countries files.</b></p><div class="figure-contents">
  
<pre class="programlisting">

06/12/2007  07:24 PM    &lt;DIR&gt;          .
06/12/2007  07:24 PM    &lt;DIR&gt;          ..
06/12/2007  07:24 PM               814 countries-1.csv
06/12/2007  07:24 PM               795 countries-2.csv
06/12/2007  07:24 PM               786 countries-3.csv
06/12/2007  07:24 PM               784 countries-4.csv
06/12/2007  07:24 PM               793 countries-5.csv

</pre>
</div></div><br class="figure-break">

<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-batchRecords.xml"></a><p class="title"><b>Figure&nbsp;192.&nbsp;Resources script resources-batchRecords.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="countries"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:fileSource file="data/{$rootName}.csv"/&gt;
        &lt;sx:flatFile ref="countriesFile"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;sx:batchedRecordWriter batchSize="50"&gt;
        &lt;sx:flatFileWriter&gt;
          &lt;sx:fileSink file="output/{$rootName}-{$sx:batchSequenceNumber}.csv"/&gt;
          &lt;sx:flatFile ref="countriesFile"/&gt;
        &lt;/sx:flatFileWriter&gt;
      &lt;/sx:batchedRecordWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:flatFile id="countriesFile"&gt;
    &lt;sx:commentStarter value="#"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType name="country"&gt;
        &lt;sx:fieldDelimiter value=","/&gt;
        &lt;sx:delimitedField name="code"/&gt;
        &lt;sx:delimitedField name="name" trimLeading="true"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml  -r resources-batchRecords.xml countries 
  rootName=countries

</pre><p>
</p>
</div>

<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2610"></a>Batched Flat Files</h3></div></div></div>
  
<div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e2612"></a>Batched sequences of records</h4></div></div></div>


<a class="indexterm" name="d4e2615"></a>
<p>
The example below illustrates how to prepare a resources script that wil break up a flat file into
smaller batches.
</p>
<p>Suppose you want to read the CSV file countries.csv containing 245 country 
records and write it out as five files containing 50, 50, 50, 50 and 45 records.
</p>
<div class="figure"><a name="countries-d.csv"></a><p class="title"><b>Figure&nbsp;193.&nbsp;Batched CSV files.</b></p><div class="figure-contents">
  
<pre class="programlisting">

06/12/2007  07:24 PM    &lt;DIR&gt;          .
06/12/2007  07:24 PM    &lt;DIR&gt;          ..
06/12/2007  07:24 PM               814 countries-1.csv
06/12/2007  07:24 PM               795 countries-2.csv
06/12/2007  07:24 PM               786 countries-3.csv
06/12/2007  07:24 PM               784 countries-4.csv
06/12/2007  07:24 PM               793 countries-5.csv

</pre>
</div></div><br class="figure-break">
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="countries"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:flatFileReader&gt;
        &lt;sx:fileSource file="data/{$rootName}.csv"/&gt;
        &lt;sx:flatFile ref="countriesFile"/&gt;
      &lt;/sx:flatFileReader&gt;
      &lt;sx:batchedRecordWriter batchSize="50"&gt;
        &lt;sx:flatFileWriter&gt;
          &lt;sx:fileSink file="intermediate/{$rootName}-{$sx:batchSequenceNumber}.csv"/&gt;
          &lt;sx:flatFile ref="countriesFile"/&gt;
        &lt;/sx:flatFileWriter&gt;
      &lt;/sx:batchedRecordWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="countries"&gt;
    &lt;sx:flatFileReader&gt;
      &lt;sx:fileSource directory="{parentDirectory}" file="{name}"/&gt;
      &lt;sx:flatFile ref="countriesFile"/&gt;
    &lt;/sx:flatFileReader&gt;
    &lt;sx:recordMapping ref="countriesToXmlMapping"/&gt;
  &lt;/sx:recordContent&gt;

  &lt;sx:flatFile id="countriesFile"&gt;
    &lt;sx:commentStarter value="#"/&gt;
    &lt;sx:flatFileBody&gt;
      &lt;sx:flatRecordType name="country"&gt;
        &lt;sx:fieldDelimiter value=","/&gt;
        &lt;sx:delimitedField name="code"/&gt;
        &lt;sx:delimitedField name="name" trimLeading="true"/&gt;
      &lt;/sx:flatRecordType&gt;
    &lt;/sx:flatFileBody&gt;
  &lt;/sx:flatFile&gt;

&lt;/sx:resources&gt;

</pre>
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml  -r resources-batchRecords.xml countries 
  rootName=countries

</pre><p>
</p>
</div>
</div>

</div>

 
  <div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d4e2626"></a>XML to XML</h2></div></div></div>

<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2628"></a>Extracting subtrees and wrapping them in containing tags</h3></div></div></div>
  
<p>
This example shows how to extract a set of subtrees from an XML document according to some
  criteria and wrap them in containing tags.
  </p>
<p>
The input file is an XML document.
</p>
<div class="figure"><a name="books.xml"></a><p class="title"><b>Figure&nbsp;194.&nbsp;Input XML document books.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;myns:books xmlns:myns="http://mycompany.com/mynames/" 
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
            xsi:schemaLocation="url2"&gt;
  &lt;myns:book categoryCode="F"&gt;
    &lt;myns:title&gt;Factotum&lt;/myns:title&gt;
    &lt;myns:author&gt;Charles Bukowski&lt;/myns:author&gt;
    &lt;myns:price&gt;22.95&lt;/myns:price&gt;
    &lt;myns:isbn&gt;0876852630&lt;/myns:isbn&gt;
  &lt;/myns:book&gt;
  &lt;myns:book categoryCode="F"&gt;
    &lt;myns:title&gt;The Night Watch&lt;/myns:title&gt;
    &lt;myns:author&gt;Sergei Lukyanenko&lt;/myns:author&gt;
    &lt;myns:price&gt;17.99&lt;/myns:price&gt;
    &lt;myns:isbn&gt;0434014125&lt;/myns:isbn&gt;
  &lt;/myns:book&gt;
  &lt;myns:book categoryCode="F"&gt;
    &lt;myns:title&gt;Mr Mee&lt;/myns:title&gt;
    &lt;myns:author&gt;Andrew Crumey&lt;/myns:author&gt;
    &lt;myns:price&gt;22.00&lt;/myns:price&gt;
    &lt;myns:isbn&gt;0312282354&lt;/myns:isbn&gt;
  &lt;/myns:book&gt;
  &lt;myns:book categoryCode="C"&gt;
    &lt;myns:title&gt;Building Parsers with Java&lt;/myns:title&gt;
    &lt;myns:author&gt;Steven John Metsker&lt;/myns:author&gt;
    &lt;myns:price&gt;39.95&lt;/myns:price&gt;
    &lt;myns:isbn&gt;0201719622&lt;/myns:isbn&gt;
  &lt;/myns:book&gt;
&lt;/myns:books&gt;

</pre>
</div></div><br class="figure-break">
<p>
The desired output is.
</p>
<pre class="programlisting">

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;envelope&gt;
  &lt;header mode="xml"&gt;
    &lt;creationDate&gt;2007-12-03T21:39:48.265-05:00&lt;/creationDate&gt;
  &lt;/header&gt;
  &lt;body&gt;
    &lt;myns:books xmlns:myns="http://mycompany.com/mynames/" 
                xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
                xsi:schemaLocation="url2"&gt;
      &lt;myns:book categoryCode="F"&gt;
        &lt;myns:title&gt;Factotum&lt;/myns:title&gt;
        &lt;myns:author&gt;Charles Bukowski&lt;/myns:author&gt;
        &lt;myns:price&gt;22.95&lt;/myns:price&gt;
        &lt;myns:isbn&gt;0876852630&lt;/myns:isbn&gt;
      &lt;/myns:book&gt;
      &lt;myns:book categoryCode="F"&gt;
        &lt;myns:title&gt;The Night Watch&lt;/myns:title&gt;
        &lt;myns:author&gt;Sergei Lukyanenko&lt;/myns:author&gt;
        &lt;myns:price&gt;17.99&lt;/myns:price&gt;
        &lt;myns:isbn&gt;0434014125&lt;/myns:isbn&gt;
      &lt;/myns:book&gt;
      &lt;myns:book categoryCode="F"&gt;
        &lt;myns:title&gt;Mr Mee&lt;/myns:title&gt;
        &lt;myns:author&gt;Andrew Crumey&lt;/myns:author&gt;
        &lt;myns:price&gt;22.00&lt;/myns:price&gt;
        &lt;myns:isbn&gt;0312282354&lt;/myns:isbn&gt;
      &lt;/myns:book&gt;
    &lt;/myns:books&gt;
  &lt;/body&gt;
  &lt;trailer&gt;This is a trailer element&lt;/trailer&gt;
&lt;/envelope&gt;

</pre>
<p>The resources script below does the transformation.
</p>
<div class="figure"><a name="resources-wrap.xml"></a><p class="title"><b>Figure&nbsp;195.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:myns="http://mycompany.com/mynames/"&gt;

  &lt;sx:service id="wrap"&gt;
    &lt;sx:wrap&gt;
      &lt;sx:xsltSerializer/&gt;
      &lt;envelope&gt;
        &lt;header&gt;
          &lt;sx:attribute name="mode" value="xml"/&gt;
          &lt;creationDate&gt;
            &lt;sx:currentDateTime/&gt;
          &lt;/creationDate&gt;
        &lt;/header&gt;
        &lt;body&gt;
          &lt;myns:books xmlns:myns="http://mycompany.com/mynames/"
                      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                      xsi:schemaLocation="url2"&gt;
            &lt;sx:transform&gt;
              &lt;sx:document/&gt;
              &lt;sx:processSubtree path="/myns:books/myns:book"&gt;
                &lt;sx:choose&gt;
                  &lt;sx:when test="@categoryCode='F'"&gt;
                    &lt;sx:transform/&gt;
                  &lt;/sx:when&gt;
                &lt;/sx:choose&gt;
              &lt;/sx:processSubtree&gt;
            &lt;/sx:transform&gt;
          &lt;/myns:books&gt;
        &lt;/body&gt;
        &lt;trailer&gt;This is a trailer element&lt;/trailer&gt;
      &lt;/envelope&gt;
    &lt;/sx:wrap&gt;
  &lt;/sx:service&gt;

&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by entering
</p>
<pre class="programlisting">

servingxml -r resources-wrap.xml -i documents/books.xml -o output/wrap.xml wrap

</pre>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2643"></a>Unwrapping subtrees in an XML document</h3></div></div></div>
  
<p>
Continuing from the previous example, the input file is the same, but
you want to produce multiple files like the one shown below, with filenames
differentiated by the isbn number.
</p>
<div class="figure"><a name="book-0876852630.xml"></a><p class="title"><b>Figure&nbsp;196.&nbsp;Book XML output file book-0876852630.xml.</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;myns:book xmlns:myns="http://mycompany.com/mynames/" 
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
           categoryCode="F"&gt;
  &lt;myns:title&gt;Factotum&lt;/myns:title&gt;
  &lt;myns:author&gt;Charles Bukowski&lt;/myns:author&gt;
  &lt;myns:price&gt;22.95&lt;/myns:price&gt;
  &lt;myns:isbn&gt;0876852630&lt;/myns:isbn&gt;
&lt;/myns:book&gt;

</pre>
</div></div><br class="figure-break">
<p>The resources script below does the transformation.
</p>
<div class="figure"><a name="resources-unwrap.xml"></a><p class="title"><b>Figure&nbsp;197.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
                     xmlns:myns="http://mycompany.com/mynames/" &gt;

  &lt;sx:service id="unwrap"&gt;
    &lt;sx:transform&gt;
      &lt;sx:document/&gt;
      &lt;sx:processSubtree path="/myns:books/myns:book"&gt;
        &lt;sx:choose&gt;
          &lt;sx:when test="@categoryCode='F'"&gt;
            &lt;sx:parameter name="isbn" select="myns:isbn"/&gt;
            &lt;sx:transform&gt;
              &lt;sx:xsltSerializer&gt;
                &lt;sx:fileSink file="output/book-{$isbn}.xml"/&gt;
              &lt;/sx:xsltSerializer&gt;
            &lt;/sx:transform&gt;
          &lt;/sx:when&gt;
        &lt;/sx:choose&gt;
      &lt;/sx:processSubtree&gt;
    &lt;/sx:transform&gt;
  &lt;/sx:service&gt;

&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by entering
</p>
<pre class="programlisting">

servingxml -r resources-unwrap.xml -i documents/books.xml unwrap

</pre>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2655"></a>Streaming a file through a pipeline</h3></div></div></div>
  
<p>
This example shows an implementation of the SAX Pipeline example in Michael Kay's 
<a class="ulink" href="http://www.amazon.com/exec/obidos/ASIN/0764543814/102-5652674-7751330" target="_top">XSLT 2nd Edition Programmer's Reference</a>, Appendix F, Example 5.  
</p>
<div class="figure"><a name="resources-pipeline.xml"></a><p class="title"><b>Figure&nbsp;198.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;
  
  &lt;sx:service id="pipeline"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:saxFilter class="PreFilter"/&gt;
        &lt;sx:xslt&gt;&lt;sx:urlSource url="styles/filter.xsl"/&gt;&lt;/sx:xslt&gt;
        &lt;sx:saxFilter class="PostFilter"/&gt;     
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
<code class="code">PreFilter</code> and <code class="code">PostFilter</code> are the names of Java classes that
implement the <code class="code">org.xml.sax.XMLFilter</code> interface.  The listings below show the
Java code for the <code class="code">PreFilter</code> and <code class="code">PostFilter</code> classes
(from Kay's book.)
</p>
<div class="figure"><a name="PreFilter"></a><p class="title"><b>Figure&nbsp;199.&nbsp;PreFilter class</b></p><div class="figure-contents">
  
<pre class="programlisting">

public class PreFilter extends XMLFilterImpl {

  public void startElement (String uri, String localName, String qName,
  Attributes atts) throws SAXException {
        
    String newLocalName = localName.toLowerCase();
    String newQName = qName.toUpperCase();
    AttributesImpl newAtts =
      (atts.getLength()&gt;0 ?
       new AttributesImpl(atts) :
       new AttributesImpl());
    newAtts.addAttribute("", "old-local-name", "old-local-name", "CDATA", localName);
    newAtts.addAttribute("", "old-qname", "old-qname", "CDATA", qName);
    super.startElement(uri, newLocalName, newQName, newAtts);
  }

  public void endElement (String uri, String localName, String qName)
  throws SAXException {
    String newLocalName = localName.toLowerCase();
    String newQName = qName.toUpperCase();
    super.endElement(uri, newLocalName, newQName);
  }
}
</pre>
</div></div><br class="figure-break">
<div class="figure"><a name="PostFilter"></a><p class="title"><b>Figure&nbsp;200.&nbsp;PostFilter class</b></p><div class="figure-contents">
  
<pre class="programlisting">

public class PostFilter extends XMLFilterImpl {

  public Stack stack;

  public void startDocument() throws SAXException {
    stack = new Stack();
    super.startDocument();
  }

  public void startElement (String uri, String localName, String qName,
                            Attributes atts)
  throws SAXException {

    String originalLocalName = localName;
    String originalQName = qName;
    AttributesImpl newAtts = new AttributesImpl();
    for (int i=0; i&lt;atts.getLength(); i++) {
      String name = atts.getQName(i);
      String val = atts.getValue(i);
      if (name.equals("old-local-name")) {
        originalLocalName = val;
      } else if (name.equals("old-qname")) {
        originalQName = val;
      } else {
        newAtts.addAttribute(atts.getURI(i),
          atts.getLocalName(i),
          name,
          atts.getType(i),
          val);
      }
    }
    super.startElement(uri, originalLocalName, originalQName, newAtts);
    stack.push(originalLocalName);
    stack.push(originalQName);
  }

  public void endElement (String uri, String localName, String qName)
  throws SAXException {
    String originalQName = (String)stack.pop();
    String originalLocalName = (String)stack.pop();
    super.endElement(uri, originalLocalName, originalQName);
  }
}
</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by
</p><div class="itemizedlist"><ul type="disc"><li>Running the sample build script at the command line, to compile
  the pre and post Java <code class="code">XMLFilter</code> classes and copy them into 
  the <code class="filename">dir/classes</code> directory.
</li><li>Entering the following command to produce the XML output file.
<pre class="programlisting">

servingxml -r resources-file.xml -i documents/mixed-up.xml 
    -o output/original-file.html pipeline

</pre>
</li></ul></div><p>
</p>
</div>

<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2681"></a>Streaming dynamically generated SAX events through a pipeline</h3></div></div></div>
  

<a class="indexterm" name="d4e2684"></a>
<p>
This example produces the same output as the previous, but this time, instead of reading an
XML document from a file, we generate the SAX events dynamically in a custom SAX reader. 
</p>
<div class="figure"><a name="resources-pipeline.xml"></a><p class="title"><b>Figure&nbsp;201.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;
  
  &lt;sx:service id="pipeline"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:document&gt;
          &lt;sx:saxReader class="MySaxReader"/&gt;
        &lt;/sx:document&gt;
        &lt;sx:saxFilter class="PreFilter"/&gt;
        &lt;sx:xslt&gt;&lt;sx:urlSource url="styles/filter.xsl"/&gt;&lt;/sx:xslt&gt;
        &lt;sx:saxFilter class="PostFilter"/&gt;     
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
The Java class <code class="code">MySaxReader</code> looks like this.
</p>
<pre class="programlisting">

public class MySaxReader implements XMLReader ...                                                             

  private static final AttributesImpl NO_ATTRIBUTES = new AttributesImpl();

  public void parse(String systemId)
  throws IOException, SAXException {
    if (contentHandler != null) {
      contentHandler.startDocument();
      contentHandler.startElement("","HTML","HTML",NO_ATTRIBUTES);
      contentHandler.startElement("","Head","Head",NO_ATTRIBUTES);
      contentHandler.startElement("","TITLE","TITLE",NO_ATTRIBUTES);
      char[] title = "This is a mixed-case HTML-like XML document".toCharArray();
      contentHandler.characters(title,0,title.length);
      contentHandler.endElement("","TITLE","TITLE");
      contentHandler.endElement("","Head","Head");
      contentHandler.startElement("","Body","Body");
      
      ...
      
      contentHandler.endElement("","Body","Body");
      contentHandler.endElement("","HTML","HTML");
      contentHandler.endDocument();
    }  
  }



</pre>
<p>
You can run this example on the command line by
</p><div class="itemizedlist"><ul type="disc"><li>Run the sample build script at the command line, to compile
  the pre and post Java <code class="code">XMLFilter</code> classes and copy them into 
  the <code class="filename">dir/classes</code> directory.
</li><li>Entering the following command to produce the XML output file.
<pre class="programlisting">

servingxml -r resources-sax.xml -o output/original-sax.html pipeline

</pre>
</li></ul></div><p>
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="invoices-eg"></a>Processing document subtrees and serializing them to separate files (invoices.)</h3></div></div></div>
  

<a class="indexterm" name="d4e2703"></a>
<a class="indexterm" name="d4e2705"></a>
<a class="indexterm" name="d4e2707"></a>
<a class="indexterm" name="d4e2710"></a>
<p>
This example shows how to serialize individual document subtrees to separate html and pdf files.
</p>
<p>
The input file is an XML document containing a number of invoices.
</p>
<div class="figure"><a name="invoices"></a><p class="title"><b>Figure&nbsp;202.&nbsp;Input XML file invoices.xml</b></p><div class="figure-contents">
                                                                                              
<pre class="programlisting">

&lt;?xml version="1.0" encoding="iso-8859-1"?&gt;
&lt;inv:invoices xmlns:inv="http://www.telio.be/ns/2002/invoice"&gt;
  &lt;inv:invoice currency="EUR" id="200302-01" paid="false"&gt;
  	&lt;inv:client id="test"&gt;
      &lt;inv:email&gt;john@abc.com&lt;/inv:email&gt;
    &lt;/inv:client&gt;
  	&lt;inv:date&gt;2003-02-03&lt;/inv:date&gt;
  	&lt;inv:description&gt;Test description&lt;/inv:description&gt;
  	&lt;inv:item&gt;
  	&lt;inv:quantity&gt;67.5&lt;/inv:quantity&gt;
  	&lt;inv:unit&gt;h&lt;/inv:unit&gt;
  	&lt;inv:description&gt;January&nbsp;2004&lt;/inv:description&gt;
  	&lt;inv:unitprice&gt;400&lt;/inv:unitprice&gt;
  	&lt;inv:tax&gt;21.00&lt;/inv:tax&gt;
  	&lt;/inv:item&gt;
  &lt;/inv:invoice&gt;
  &lt;inv:invoice currency="EUR" id="200302-02" paid="true"&gt;
    &lt;inv:client id="test"&gt;
      &lt;inv:email&gt;jane@efg.com&lt;/inv:email&gt;
    &lt;/inv:client&gt;
    &lt;inv:date&gt;2003-02-03&lt;/inv:date&gt;
    &lt;inv:description&gt;Test description&lt;/inv:description&gt;
    &lt;inv:item&gt;
    &lt;inv:quantity&gt;67.5&lt;/inv:quantity&gt;
    &lt;inv:unit&gt;h&lt;/inv:unit&gt;
    &lt;inv:description&gt;January&nbsp;2004&lt;/inv:description&gt;
    &lt;inv:unitprice&gt;400&lt;/inv:unitprice&gt;
    &lt;inv:tax&gt;21.00&lt;/inv:tax&gt;
    &lt;/inv:item&gt;
  &lt;/inv:invoice&gt;
&lt;/inv:invoices&gt;

</pre>
</div></div><br class="figure-break">
<p>
The desired output is a set of HTML and PDF invoice documents, 
one pair for each inv:invoice element in the master XML document.
</p>
<div class="figure"><a name="out-invoices.txt"></a><p class="title"><b>Figure&nbsp;203.&nbsp;Directory listing of output files</b></p><div class="figure-contents">
  
<pre class="programlisting">

invoice200302-01.html
invoice200302-01.pdf
invoice200302-02.html
invoice200302-02.pdf

</pre>
</div></div><br class="figure-break">
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-invoices.xml"></a><p class="title"><b>Figure&nbsp;204.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:fop="http://www.servingxml.com/extensions/fop"
              xmlns:inv="http://www.telio.be/ns/2002/invoice"&gt;

  &lt;sx:service id="invoices"&gt;
    &lt;sx:transform&gt;
      &lt;sx:document/&gt;
      &lt;!-- Here we extract a document subtree from the SAX stream --&gt;
      &lt;sx:processSubtree path="/inv:invoices/inv:invoice"&gt;
        &lt;!-- Main pipeline - invoice document subtree to pdf--&gt;
        &lt;sx:transform&gt;
          &lt;!-- We initialize a parameter with an XPATH expression
               applied to the document subtree --&gt;
          &lt;sx:parameter name="invoice-name" select="@id"/&gt;
          &lt;fop:foSerializer&gt;
            &lt;sx:fileSink file="output/invoice{$invoice-name}.pdf"/&gt;
          &lt;/fop:foSerializer&gt;
          &lt;sx:transform&gt;
            &lt;sx:transform ref="steps1-4"/&gt;
            &lt;!-- Tee - invoice document subtree to html--&gt;
            &lt;sx:tagTee&gt;
              &lt;sx:xslt documentBase="documents/"&gt;
                &lt;sx:urlSource url="styles/invoice2html.xsl"/&gt;
              &lt;/sx:xslt&gt;
              &lt;sx:xsltSerializer&gt;
                &lt;sx:fileSink file="output/invoice{$invoice-name}.html"/&gt;
              &lt;/sx:xsltSerializer&gt;
            &lt;/sx:tagTee&gt;
            &lt;sx:xslt documentBase="documents/"&gt;
              &lt;sx:urlSource url="styles/invoice2fo.xsl"/&gt;
            &lt;/sx:xslt&gt;
          &lt;/sx:transform&gt;
        &lt;/sx:transform&gt;
      &lt;/sx:processSubtree&gt;
    &lt;/sx:transform&gt;
  &lt;/sx:service&gt;

  &lt;sx:transform id="steps1-4"&gt;
    &lt;sx:xslt&gt;&lt;sx:urlSource url="styles/step1.xsl"/&gt;&lt;/sx:xslt&gt;
    &lt;sx:xslt&gt;&lt;sx:urlSource url="styles/step2.xsl"/&gt;&lt;/sx:xslt&gt;
    &lt;sx:xslt&gt;&lt;sx:urlSource url="styles/step3.xsl"/&gt;&lt;/sx:xslt&gt;
    &lt;sx:xslt documentBase="documents/"&gt;
      &lt;sx:urlSource url="styles/step4.xsl"/&gt;
    &lt;/sx:xslt&gt;
  &lt;/sx:transform&gt;

&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>Not the <a class="link" href="../guide/index.html#sx:tagTee" target="_top">sx:tagTee</a> element, which forks the SAX event stream, and serializes this stream as HTML.
</p>
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources-invoices.xml -i documents/invoices.xml invoices

</pre><p>
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="mailInvoices"></a>Processing document subtrees and serializing them as mail attachments ("mail invoices")</h3></div></div></div>
  

<a class="indexterm" name="d4e2733"></a>
<a class="indexterm" name="d4e2735"></a>
<a class="indexterm" name="d4e2737"></a>
<p>
Continuing with the previous example, suppose you want to send the invoices as pdf mail attachments.
Then you need the following resources script.
</p>
<div class="figure"><a name="resources-mailInvoices.xml"></a><p class="title"><b>Figure&nbsp;205.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:fop="http://www.servingxml.com/extensions/fop"
              xmlns:inv="http://www.telio.be/ns/2002/invoice"
              xmlns:jm="http://www.servingxml.com/extensions/javamail"&gt;

  &lt;sx:service id="invoices"&gt;
    &lt;sx:transform&gt;
      &lt;sx:document/&gt;
      &lt;!-- Here we extract a document subtree from the SAX stream --&gt;
      &lt;sx:processSubtree path="/inv:invoices/inv:invoice"&gt;                        
        &lt;sx:parameter name="email" select="inv:client/inv:email"/&gt;

        &lt;!--  We want to send an email with the PDF invoice as an attachment   --&gt;
        &lt;jm:sendMail subject="Invoice" to="{$email}"&gt;
          &lt;sx:parameter name="invoice-name" select="@id"/&gt;

          &lt;jm:mailAccount ref="myMailAccount"/&gt;
          &lt;jm:message&gt;
            &lt;jm:attachment filename="{$invoice-name}.pdf"&gt;
              &lt;sx:serialize&gt;
                &lt;!-- We initialize a parameter with an XPATH expression
                     applied to the document subtree --&gt;
                &lt;fop:foSerializer/&gt;
                &lt;sx:transform&gt;
                  &lt;sx:transform ref="steps1-4"/&gt;
                  &lt;sx:xslt documentBase="documents/"&gt;
                    &lt;sx:urlSource url="styles/invoice2fo.xsl"/&gt;
                  &lt;/sx:xslt&gt;
                &lt;/sx:transform&gt;
              &lt;/sx:serialize&gt;
            &lt;/jm:attachment&gt;
          &lt;/jm:message&gt;
          &lt;sx:onError&gt;
            &lt;!-- If send mail fails (e.g. no smtp host), just proceed with the next action --&gt;
            &lt;!-- (the error will still be logged) --&gt;
          &lt;/sx:onError&gt;
        &lt;/jm:sendMail&gt;
      &lt;/sx:processSubtree&gt;
    &lt;/sx:transform&gt;
  &lt;/sx:service&gt;

  &lt;sx:transform id="steps1-4"&gt;
    &lt;sx:xslt&gt;
      &lt;sx:urlSource url="styles/step1.xsl"/&gt;
    &lt;/sx:xslt&gt;
    &lt;sx:xslt&gt;
      &lt;sx:urlSource url="styles/step2.xsl"/&gt;
    &lt;/sx:xslt&gt;
    &lt;sx:xslt&gt;
      &lt;sx:urlSource url="styles/step3.xsl"/&gt;
    &lt;/sx:xslt&gt;
    &lt;sx:xslt documentBase="documents/"&gt;
      &lt;sx:urlSource url="styles/step4.xsl"/&gt;
    &lt;/sx:xslt&gt;
  &lt;/sx:transform&gt;

  &lt;!-- Set up this mail account, substituting your smtp host, display name, and email address --&gt;
  &lt;!-- You will also need to enter the 'to' and 'cc' recipient addresses in the  jm:sendMail element --&gt;
  &lt;jm:mailAccount id="myMailAccount"
                  smtpHost="smtp1.abc.ca"&gt;
    &lt;jm:sender displayName="Daniel"
                 emailAddress="danielaparker@abc.ca"/&gt;
  &lt;/jm:mailAccount&gt;

&lt;/sx:resources&gt;

</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources-mailInvoices.xml -i documents/invoices.xml invoices

</pre><p>
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2746"></a>Reading dynamic content</h3></div></div></div>


<a class="indexterm" name="d4e2749"></a>
<p>
This example shows an implementation of dynamic content handlers.  
</p>
<p>
Running this example requires the following steps:  
</p><div class="itemizedlist"><ul type="disc"><li><p>Run the sample build script at the command line, to compile
  the DynamicContentHandler classes and copy them into 
  the distribution classes directory. </p></li><li><p>Enter the following command to produce a page of books in the fiction (F) category,
</p><pre class="programlisting">

servingxml -r resources.xml -o output/books.html books category=F

</pre><p>
</p></li></ul></div><p>
</p>
<div class="figure"><a name="resources-dynamic.xml"></a><p class="title"><b>Figure&nbsp;206.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources&gt;

  &lt;sx:service id="swath"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:transform&gt;
        &lt;sx:content ref="swath"/&gt;
        &lt;sx:xslt ref="swath"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;
  
  &lt;sx:xslt id="swath"&gt;
    &lt;sx:urlSource url="styles/books.xsl"/&gt;
    &lt;sx:parameter name="category"/&gt;
  &lt;/sx:xslt&gt;
  
  &lt;!-- BookCatalog is the name of a Java class used to produce dynamic content for the primary document --&gt;
  &lt;sx:dynamicContent name="swath" class="dynamiccontent.BookCatalog"/&gt;
  
  &lt;!-- Categories is the name of a Java class used to produce dynamic content in a 
        document function in the stylesheet --&gt;
  &lt;sx:dynamicContent name="categories" class="dynamiccontent.Categories"/&gt;

&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
<code class="code">BookCatalog</code> and <code class="code">Categories</code> are the names of Java classes that
implement the <code class="code">com.servingxml.components.content.dynamic.DynamicContentHandler</code> interface.
The listing below shows the Java code for the <code class="code">Categories</code> class.
</p>
<div class="figure"><a name="categories"></a><p class="title"><b>Figure&nbsp;207.&nbsp;Categories</b></p><div class="figure-contents">
  
<pre class="programlisting">

package dynamiccontent;

public class Categories implements DynamicContentHandler {

  static class Category {
    private final String code;
    private final String description;

    public Category(String code, String description) {
      this.code = code;
      this.description = description;
    }

    public String getCode() {
      return code;
    }

    public String getDescription() {
      return description;
    }
  }

  private final HashMap categoryMap;
  private final String namespace = "";

  public Categories() {
    categoryMap = new HashMap();
    categoryMap.put("S", new Category("S","Science"));
    categoryMap.put("C", new Category("C","Computing"));
    categoryMap.put("CHILD", new Category("CHILD","Children"));
    categoryMap.put("F", new Category("F","Fiction"));
    categoryMap.put("P", new Category("P","Philospohy"));
    categoryMap.put("R", new Category("R","Religion"));
  }
  
  //  The onRequest method must be reentrant
  public void onRequest(ServiceContext context, Book parameters, 
  ContentWriter contentWriter)  {

    contentWriter.startElement(namespace,"categories");             
      
    String id = parameters.getCategory();

    if (id != null &amp;&amp; id.length() != 0) {
      if (id.equals("all")) {
        Collection values = categoryMap.values();
        Iterator iter = values.iterator();
        while (iter.hasNext()) {
          Category category = (Category)iter.next();
          writeCategory(category,contentWriter);
        }
      } else {
        Category category = (Category)categoryMap.get(id);
        writeCategory(category,contentWriter);
      }
    }

    contentWriter.endElement(namespace,"categories");
  }

  private void writeCategory(Category category, ContentWriter contentWriter) 
   {
    AttributeSet attributes = contentWriter.newAttributeSet();
    attributes.addAttribute(namespace,"code",category.getCode());
    attributes.addAttribute(namespace,"desc",category.getDescription());
    contentWriter.startEndElement(namespace,"category",attributes); 
  }
}</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by 
</p><div class="itemizedlist"><ul type="disc"><li>Running the sample build script at the command line, to compile
  the DynamicContentHandler classes and copy them into 
  the distribution classes directory.</li><li>Entering the following command to produce a page of swath in the fiction (F) category,
<pre class="programlisting">

servingxml -r resources.xml -o output/books.html swath category=F

</pre>
</li></ul></div><p>
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2775"></a>XML to Mail</h3></div></div></div>


<a class="indexterm" name="d4e2778"></a>
<p>
The example below illustrates how to prepare a resources script that will transform an XML document to XSL-FO,
format it to PDF, and send the result as an attachment in a mail message.  
</p>
<p>
This example requires the mail module.
</p>
<p>
Once you have everything configured, rebuild the ServingXML jar file
in the servingxml directory.  
</p>
<div class="figure"><a name="resources-mail.xml"></a><p class="title"><b>Figure&nbsp;208.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:fop="http://www.servingxml.com/extensions/fop"
              xmlns:jm="http://www.servingxml.com/extensions/javamail"&gt;
  
  &lt;sx:service id="pulp"&gt;                         
      &lt;!--  Our first action is to send an email with the pulp novel as an attachment   --&gt;
      &lt;jm:sendMail subject="test" to="john@yyy.com" cc="linda@zzz.com"&gt;
        &lt;jm:mailAccount ref="myMailAccount"/&gt;
        &lt;jm:message&gt;

          &lt;!-- Put some HTML in the message body --&gt; 
          &lt;jm:part type="alternative"&gt;
            &lt;sx:transform&gt;           
              &lt;sx:document&gt;&lt;xxx/&gt;&lt;/sx:document&gt;
              &lt;sx:xslt ref="welcome/html"/&gt;
            &lt;/sx:transform&gt;        
          &lt;/jm:part&gt;
          
          &lt;jm:attachment filename="pulp.pdf"&gt;
            &lt;fop:foSerializer/&gt;
            &lt;sx:transform&gt;
               &lt;sx:content ref="pulp"/&gt;
               &lt;sx:xslt ref="novel/fo"/&gt;
            &lt;/sx:transform&gt;
          &lt;/jm:attachment&gt;      
        &lt;/jm:message&gt;
        &lt;sx:onError&gt;
            &lt;!-- If send mail fails (e.g. no smtp host), just proceed with the next action --&gt;
            &lt;!-- (the error will still be logged) --&gt;
        &lt;/sx:onError&gt;
      &lt;/jm:sendMail&gt; 
                                        
      &lt;!--  Our second action is to write the pulp novel to a file   --&gt;
      &lt;sx:serialize&gt;
        &lt;fop:foSerializer/&gt;
        &lt;sx:transform&gt;
           &lt;sx:content ref="pulp"/&gt;
           &lt;sx:xslt ref="novel/fo"/&gt;
        &lt;/sx:transform&gt;
      &lt;/sx:serialize&gt;
    
  &lt;/sx:service&gt;                                                                                                             

  &lt;!-- Set up this mail account, substituting your smtp host, display name, and email address --&gt;
  &lt;!-- You will also need to enter the 'to' and 'cc' recipient addresses in the  jm:sendMail element --&gt;
  &lt;jm:mailAccount id="myMailAccount" 
                           smtpHost="smtp1.abc.ca"&gt; 
    &lt;jm:sender displayName="DP" 
                     emailAddress="danielaparker@abc.ca"/&gt;
  &lt;/jm:mailAccount&gt;

  &lt;sx:document id="pulp"&gt;        
    &lt;sx:urlSource url="data/pulp.xml"/&gt;
  &lt;/sx:document&gt;

  &lt;sx:xslt id="novel/fo"&gt;
    &lt;sx:urlSource url="data/novel.xsl"/&gt;
  &lt;/sx:xslt&gt;

  &lt;sx:xslt id="welcome/html"&gt;
    &lt;sx:urlSource url="data/welcome.xsl"/&gt;
  &lt;/sx:xslt&gt;
  
&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
This example produces two outputs:
</p><div class="itemizedlist"><ul type="disc"><li><p>
A mail message with an HTML body part displaying "Welcome to Presenting Books" and
a PDF attachment.
</p></li><li><p>
A PDF file pulp.pdf written to the output directory.
</p></li></ul></div><p>
</p>
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources.xml -o output/pulp.pdf pulp

</pre><p>
</p>
</div> 
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2795"></a>Writing an XML file to an FTP sink</h3></div></div></div>



<a class="indexterm" name="d4e2799"></a>
<p>
This example shows how to send stream output to an FTP host.
</p>
<div class="figure"><a name="resources-ftp.xml"></a><p class="title"><b>Figure&nbsp;209.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:edt="http://www.servingxml.com/extensions/edtftp"&gt;
  
  &lt;edt:ftpClient id="myFtpSite" host="myFtpHost" 
                 user="anonymous" password="xxx"/&gt;
  
  &lt;sx:service id="books"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:xsltSerializer&gt;
        &lt;edt:ftpSink remoteDirectory="incoming" remoteFile="books{$version}.xml"&gt;
          &lt;edt:ftpClient ref="myFtpSite"/&gt;
        &lt;/edt:ftpSink&gt;
      &lt;/sx:xsltSerializer/&gt;
        
      &lt;sx:transform&gt;
        &lt;sx:content ref="books"/&gt;
      &lt;/sx:transform&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:document id="books"&gt;
    &lt;sx:urlSource url="documents/books.xml"/&gt;
  &lt;/sx:document&gt;
  
&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by 
</p><div class="itemizedlist"><ul type="disc"><li><p>Updating the resources.xml file with a valid FTP host</p></li><li><p>Entering the following command to send an XML file to the FTP host,
</p><pre class="programlisting">

servingxml -r resources.xml books version=1.0

</pre><p>
</p></li></ul></div><p>
</p>
</div>
  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2813"></a>Comparing Two XML Documents with fn:deep-equal</h3></div></div></div>
    
          <p>The example below shows how to compare two XML documents for equality with
          the XPATH fn:deep-equal function.
          </p>
        <pre class="programlisting">

&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
              xmlns:fn="http://www.w3.org/2005/xpath-functions"&gt;

  &lt;sx:service id="compare-documents"&gt;
    &lt;sx:task ref="test-documents-are-equal"/&gt;
  &lt;/sx:service&gt;

  &lt;sx:document id="odd-element-document"&gt;
    &lt;document&gt;
      &lt;title&gt;Title&lt;/title&gt;
      &lt;para&gt;First paragraph.&lt;/para&gt;
    &lt;/document&gt;
  &lt;/sx:document&gt;

  &lt;sx:document id="another-odd-element-document"&gt;
    &lt;document&gt;
      &lt;title&gt;Title&lt;/title&gt;
      &lt;para&gt;First paragraph.&lt;/para&gt;
    &lt;/document&gt;
  &lt;/sx:document&gt;

  &lt;sx:serialize id="test-documents-are-equal"&gt;
    &lt;sx:transform&gt;
      &lt;sx:choose&gt;
        &lt;sx:when test="fn:deep-equal(fn:document('odd-element-document'),
                     fn:document('another-odd-element-document'))"&gt;
          &lt;sx:document&gt;
            &lt;result&gt;equal&lt;/result&gt;
          &lt;/sx:document&gt;
        &lt;/sx:when&gt;
        &lt;sx:otherwise&gt;
          &lt;sx:document&gt;
            &lt;result&gt;unequal&lt;/result&gt;
          &lt;/sx:document&gt;
        &lt;/sx:otherwise&gt;
      &lt;/sx:choose&gt;
    &lt;/sx:transform&gt;
  &lt;/sx:serialize&gt;

&lt;/sx:resources&gt;

        </pre>
<p>
The documents are equal, so the script produces the output  

&lt;result&gt;equal&lt;/result&gt;

</p>
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources-compare.xml -o output/compare-documents.xml 
  compare-documents

</pre><p>
</p>
  </div>
</div>


<div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d4e2820"></a>SQL Examples</h2></div></div></div>
<div class="section" lang="en"><div class="titlepage"></div>
<p>
The java run time needs to be able to find the database driver.  
The examples in this section are set up for the Oracle driver, 
oracle.jdbc.driver.OracleDriver.  To configure ServingXML to recognize 
this driver, copy the Oracle classes12.jar file (not distributed) to 
the <code class="filename">lib/local</code> directory, and then rebuild.  Of course, you can specify a different driver, 
making the appropriate changes in the sample resources script and copying the right
jar file to the <code class="filename">lib/local</code> directory.
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2826"></a>SQL Query to Flat File</h3></div></div></div>
<div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e2828"></a>Writing the results of a SQL query to a CSV file (employees-csv)</h4></div></div></div>


<a class="indexterm" name="d4e2831"></a>
<a class="indexterm" name="d4e2834"></a>
<p>
This example shows how to prepare a resources script that will write the results of a SQL query to a
CSV file, using a default flat file writer.
</p>
<p>
The desired CSV file is shown below.
</p>

<div class="figure"><a name="employees.csv"></a><p class="title"><b>Figure&nbsp;210.&nbsp;Output XML file employees.csv</b></p><div class="figure-contents">
  
<pre class="programlisting">

EMPNO,NAME,JOB
7902,FORD,ANALYST
7788,SCOTT,ANALYST
7876,ADAMS,CLERK
7900,JAMES,CLERK
7934,MILLER,CLERK
7369,SMITH,CLERK
</pre>
</div></div><br class="figure-break">
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources_employee_csv.xml"></a><p class="title"><b>Figure&nbsp;211.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="employees-to-csv"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:recordReader ref="employees"/&gt;
      &lt;sx:flatFileWriter/&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:sqlReader id="employees"&gt;
    &lt;sx:sqlConnectionPool ref="jdbcPool"/&gt;

    &lt;sx:parameter name="jobList"&gt;
      &lt;sx:toString value="{$job}" separator=","&gt;
        &lt;sx:quoteSymbol character="'" escapeCharacter="'"/&gt;
      &lt;/sx:toString&gt;
    &lt;/sx:parameter&gt;

    &lt;sx:sqlQuery recordType = "employee"&gt;
        SELECT EMPNO, ENAME AS NAME,JOB FROM EMP WHERE 1=1
      &lt;sx:choose&gt;
        &lt;sx:when test="$jobList"&gt;
            AND JOB IN ({$jobList})
        &lt;/sx:when&gt;
      &lt;/sx:choose&gt;
        ORDER BY JOB,ENAME
    &lt;/sx:sqlQuery&gt;

  &lt;/sx:sqlReader&gt;

  &lt;sx:sqlConnectionPool id="jdbcPool"
                        driver="oracle.jdbc.driver.OracleDriver"
                        databaseUrl="jdbc:oracle:thin:@127.0.0.1:1521:dev"
                        user="{$user}"
                        password="{$password}"
                        minConnections="2"
                        testStatement="SELECT * FROM DUAL"/&gt;

&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
Executing the <code class="code">employees</code> service with two <code class="code">job</code> parameters, like this
</p><pre class="programlisting">

    servingxml  -r resources-employees_csv.xml -o output/employees.csv employees-to-csv
         user=scott password=spring job=ANALYST job=CLERK

</pre><p>
results in the following SQL statement being sent to the Oracle server:
</p><pre class="programlisting">

SELECT EMPNO, ENAME AS NAME,JOB 
  FROM EMP 
  WHERE 1=1 AND JOB IN ('ANALYST','CLERK') 
  ORDER BY JOB,ENAME
</pre><p>
</p>
<p>
The attribute names EMPNO, NAME and JOB become the headings of the CSV file, and the 
values in each row are written out below.
</p>
</div>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2851"></a>SQL Query to XML</h3></div></div></div>
<div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e2853"></a>Mapping the results of a parameterized SQL query into XML (analysts)</h4></div></div></div>

<p>
The example below illustrates how to prepare a resources script that will convert the results of 
a SQL query into an XML document.  
</p>
<p>
</p>
<p>
The desired output is shown below.
</p><div class="figure"><a name="employees.xml"></a><p class="title"><b>Figure&nbsp;212.&nbsp;Output XML file employees.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;employees&gt;
  &lt;employee employee-no="7788"&gt;
    &lt;name&gt;SCOTT&lt;/name&gt;
    &lt;job&gt;ANALYST&lt;/job&gt;
  &lt;/employee&gt;
  &lt;employee employee-no="7902"&gt;
    &lt;name&gt;FORD&lt;/name&gt;
    &lt;job&gt;ANALYST&lt;/job&gt;
  &lt;/employee&gt;
&lt;/employees&gt;
</pre>
</div></div><p><br class="figure-break">
</p>
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="sql-resources.xml"></a><p class="title"><b>Figure&nbsp;213.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;                   
                                                                   
  &lt;sx:service id="employees"&gt;                         
    &lt;sx:serialize&gt;
      &lt;sx:content ref="employees"/&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="employees"&gt;
    &lt;sx:sqlReader&gt;
      &lt;sx:sqlConnectionPool ref="jdbcPool"/&gt;
      
      &lt;sx:parameter name="jobList"&gt;
        &lt;sx:toString value="{$job}" separator=","&gt;
          &lt;sx:quoteSymbol character="'" escapeCharacter="'"/&gt;
        &lt;/sx:toString&gt;
      &lt;/sx:parameter&gt;
      
      &lt;sx:sqlQuery recordType = "employee"&gt;
        SELECT EMPNO, ENAME AS NAME,JOB FROM EMP WHERE JOB = '{$job}' 
      &lt;/sx:sqlQuery&gt;
        
    &lt;/sx:sqlReader&gt;
    
    &lt;sx:recordMapping ref="employeesToXml"/&gt;
    
  &lt;/sx:recordContent&gt;
  
  &lt;sx:recordMapping id="employeesToXml"&gt;
    &lt;employees&gt;
      &lt;sx:groupBy fields="JOB"&gt;
        &lt;sx:elementMap element="{JOB}"&gt;
          &lt;sx:onRecord&gt;
            &lt;employee&gt;
              &lt;sx:fieldAttributeMap field="EMPNO" attribute="employee-no"/&gt;
              &lt;sx:fieldElementMap field="NAME" element="name"/&gt;
            &lt;/employee&gt;
          &lt;/sx:onRecord&gt;
        &lt;/sx:elementMap&gt;
      &lt;/sx:groupBy&gt;
    &lt;/employees&gt;
  &lt;/sx:recordMapping&gt;

  &lt;sx:sqlConnectionPool id="jdbcPool"
                        driver="oracle.jdbc.driver.OracleDriver"
                        databaseUrl="jdbc:oracle:thin:@127.0.0.1:1521:dev"
                        user="{$user}"
                        password="{$password}"
                        minConnections="2"
                        testStatement="SELECT * FROM DUAL"/&gt;
                         
  &lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

  servingxml -r resources.xml employees -o output/employees.txt employees 
       user=scott password=spring job=ANALYST

</pre><p>
</p>
</div>

<div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e2867"></a>Mapping the results of an ad hoc SQL query into XML (employees)</h4></div></div></div>

<p>
The example below illustrates how to prepare a resources script that will generate and execute 
a different SQL statement depending on passed parameters.
</p>
<p>
The desired output is shown below.
</p>

<div class="figure"><a name="adhoc-analysts.xml"></a><p class="title"><b>Figure&nbsp;214.&nbsp;Output XML file employees.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;employees&gt;
   &lt;ANALYST&gt;
      &lt;employee employee-no="7902"&gt;
         &lt;name&gt;FORD&lt;/name&gt;
      &lt;/employee&gt;
      &lt;employee employee-no="7788"&gt;
         &lt;name&gt;SCOTT&lt;/name&gt;
      &lt;/employee&gt;
   &lt;/ANALYST&gt;
   &lt;CLERK&gt;
      &lt;employee employee-no="7876"&gt;
         &lt;name&gt;ADAMS&lt;/name&gt;
      &lt;/employee&gt;
      &lt;employee employee-no="7900"&gt;
         &lt;name&gt;JAMES&lt;/name&gt;
      &lt;/employee&gt;
      &lt;employee employee-no="7934"&gt;
         &lt;name&gt;MILLER&lt;/name&gt;
      &lt;/employee&gt;
      &lt;employee employee-no="7369"&gt;
         &lt;name&gt;SMITH&lt;/name&gt;
      &lt;/employee&gt;
   &lt;/CLERK&gt;
&lt;/employees&gt;
</pre>
</div></div><br class="figure-break">
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources.xml"></a><p class="title"><b>Figure&nbsp;215.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="employees"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:content ref="employeesDoc"/&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="employeesDoc"&gt;
    &lt;sx:sqlReader&gt;
      &lt;sx:sqlConnectionPool ref="jdbcPool"/&gt;
      
      &lt;sx:parameter name="jobList"&gt;
        &lt;sx:toString value="{$job}" separator=","&gt;
          &lt;sx:quoteSymbol character="'" escapeCharacter="'"/&gt;
        &lt;/sx:toString&gt;
      &lt;/sx:parameter&gt;
      
      &lt;sx:sqlQuery recordType = "employee"&gt;
        SELECT EMPNO, ENAME AS NAME,JOB FROM EMP WHERE 1=1 
        &lt;sx:choose&gt;
          &lt;sx:when test="$jobList"&gt;
            AND JOB IN ({$jobList})
          &lt;/sx:when&gt;
        &lt;/sx:choose&gt;
        ORDER BY JOB,ENAME
      &lt;/sx:sqlQuery&gt;
        
    &lt;/sx:sqlReader&gt;
    
    &lt;sx:recordMapping ref="employeesToXml"/&gt;
    
  &lt;/sx:recordContent&gt;
  
  &lt;sx:recordMapping id="employeesToXml"&gt;
    &lt;employees&gt;
      &lt;sx:groupBy fields="JOB"&gt;
        &lt;sx:elementMap element="{JOB}"&gt;
          &lt;sx:onRecord&gt;
            &lt;employee&gt;
              &lt;sx:fieldAttributeMap field="EMPNO" attribute="employee-no"/&gt;
              &lt;sx:fieldElementMap field="NAME" element="name"/&gt;
            &lt;/employee&gt;
          &lt;/sx:onRecord&gt;
        &lt;/sx:elementMap&gt;
      &lt;/sx:groupBy&gt;
    &lt;/employees&gt;
  &lt;/sx:recordMapping&gt;

  &lt;sx:sqlConnectionPool id="jdbcPool"
                         driver="oracle.jdbc.driver.OracleDriver"
                         databaseUrl="jdbc:oracle:thin:@127.0.0.1:1521:dev"
                         user="scott"
                         password="spring"
                         minConnections="2"
                         testStatement="SELECT * FROM DUAL"/&gt;

&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
Executing the <code class="code">employees</code> service with two <code class="code">job</code> parameters, like this
</p><pre class="programlisting">

    servingxml -r resources.xml employees -o output/employees.xml employees 
        job=ANALYST job=CLERK

</pre><p>
results in the following SQL statement being sent to the Oracle server:
</p><pre class="programlisting">

SELECT EMPNO, ENAME AS NAME,JOB 
  FROM EMP 
  WHERE 1=1 AND JOB IN ('ANALYST','CLERK') 
  ORDER BY JOB,ENAME
</pre><p>
</p>
<p>
But executing the <code class="code">employees</code> service with no parameters results in a SQL select
statement that returns all employees for all job categories.
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e2885"></a>Using multiple readers to join data across different data sources (chained readers)</h4></div></div></div>

<a class="indexterm" name="d4e2887"></a>
<p>
The example below illustrates how to prepare a resources script that will execute 
two queries to two different databases, where the second is joined with the first.
</p>
<p>
The desired output is shown below.
</p>

<div class="figure"><a name="adhoc-analysts.xml"></a><p class="title"><b>Figure&nbsp;216.&nbsp;Output XML file deptEmployees.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;employees&gt;
  &lt;department dept-no="10" dept-name="ACCOUNTING"&gt;
    &lt;employee employee-no="7782"&gt;
      &lt;name&gt;CLARK&lt;/name&gt;
    &lt;/employee&gt;
    &lt;employee employee-no="7839"&gt;
      &lt;name&gt;KING&lt;/name&gt;
    &lt;/employee&gt;
  &lt;/department&gt;
  &lt;department dept-no="30" dept-name="SALES"&gt;
    &lt;employee employee-no="7499"&gt;
      &lt;name&gt;ALLEN&lt;/name&gt;
    &lt;/employee&gt;
    &lt;employee employee-no="7698"&gt;
      &lt;name&gt;BLAKE&lt;/name&gt;
    &lt;/employee&gt;
  &lt;/department&gt;
&lt;/employees&gt;
</pre>
</div></div><br class="figure-break">
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources.xml"></a><p class="title"><b>Figure&nbsp;217.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="employees"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:content ref="employeesDoc"/&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="employeesDoc"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:sqlReader&gt;
        &lt;sx:sqlConnectionPool ref="devPool"/&gt;
        &lt;sx:sqlQuery recordType = "employee"&gt;
        SELECT DEPTNO, DNAME FROM DEPT ORDER BY DNAME
        &lt;/sx:sqlQuery&gt;
      &lt;/sx:sqlReader&gt;
                                                                                            
      &lt;!-- for each row from the previous reader, run this reader --&gt;
      &lt;sx:sqlReader&gt;
        &lt;sx:sqlConnectionPool ref="dev2Pool"/&gt;
        &lt;sx:sqlQuery recordType = "employee"&gt;
        SELECT EMPNO, ENAME AS NAME,JOB, {DEPTNO} AS DEPTNO, '{DNAME}' AS DEPT FROM EMP  WHERE DEPTNO = {DEPTNO}
        ORDER BY ENAME
        &lt;/sx:sqlQuery&gt;
      &lt;/sx:sqlReader&gt;
    &lt;/sx:recordStream&gt;

    &lt;sx:recordMapping ref="employeesToXml"/&gt;

  &lt;/sx:recordContent&gt;

  &lt;sx:recordMapping id="employeesToXml"&gt;
    &lt;employees&gt;
      &lt;sx:groupBy fields="DEPT"&gt;
        &lt;department&gt;
          &lt;sx:fieldAttributeMap field="DEPTNO" attribute="dept-no"/&gt;
          &lt;sx:fieldAttributeMap field="DEPT" attribute="dept-name"/&gt;
          &lt;sx:onRecord&gt;
            &lt;employee&gt;
              &lt;sx:fieldAttributeMap field="EMPNO" attribute="employee-no"/&gt;
              &lt;sx:fieldElementMap field="NAME" element="name"/&gt;
            &lt;/employee&gt;
          &lt;/sx:onRecord&gt;
        &lt;/department&gt;
      &lt;/sx:groupBy&gt;
    &lt;/employees&gt;
  &lt;/sx:recordMapping&gt;

  &lt;sx:sqlConnectionPool id="devPool"
                        driver="oracle.jdbc.driver.OracleDriver"
                        databaseUrl="jdbc:oracle:thin:@127.0.0.1:1521:dev"
                        user="scott"
                        password="spring"
                        minConnections="2"
                        testStatement="SELECT * FROM DUAL"/&gt;

  &lt;sx:sqlConnectionPool id="dev2Pool"
                        driver="oracle.jdbc.driver.OracleDriver"
                        databaseUrl="jdbc:oracle:thin:@127.0.0.1:1521:dev2"
                        user="scott"
                        password="spring"
                        minConnections="2"
                        testStatement="SELECT * FROM DUAL"/&gt;

&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
Executing the <code class="code">employees</code> service, like this
</p><pre class="programlisting">

    servingxml -r resources-multipleReaders.xml employees -o output/deptEmployees.xml employees 

</pre><p>
results in the following two SQL statements being sent to the Oracle "dev2" database by the second reader:
</p><pre class="programlisting">

SELECT EMPNO, ENAME AS NAME, 10 AS DEPTNO, 'ACCOUNTING' AS DEPT 
  FROM EMP WHERE DEPTNO = 10
  ORDER ENAME

SELECT EMPNO, ENAME AS NAME, 30 AS DEPTNO, 'SALES' AS DEPT 
  FROM EMP WHERE DEPTNO = 30
  ORDER ENAME
</pre><p>
</p>
</div>
</div>

<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2903"></a>XML to Database</h3></div></div></div>
<div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e2905"></a>Load Master Detail</h4></div></div></div>


<a class="indexterm" name="d4e2908"></a>
<p>
This example shows how to prepare a resources script that will insert
master/detail records into separate master and detail tables
    as a single transaction.
</p>
<p>
The input file is an XML file.
</p>
<div class="figure"><a name="masterDetail.xml"></a><p class="title"><b>Figure&nbsp;218.&nbsp;Input XML file masterDetail.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;masterDetail&gt;
  &lt;master id="1"&gt;
    &lt;name&gt;aName&lt;/name&gt;
    &lt;detail id="11"&gt;
      &lt;date&gt;2008-09-03&lt;/date&gt;
      &lt;type&gt;aType&lt;/type&gt;
    &lt;/detail&gt;
    &lt;detail id="12"&gt;
      &lt;date&gt;2008-09-06&lt;/date&gt;
      &lt;type&gt;aType&lt;/type&gt;
    &lt;/detail&gt;
    &lt;detail id="13"&gt;
      &lt;date&gt;2008-09-10&lt;/date&gt;
      &lt;type&gt;aType&lt;/type&gt;
    &lt;/detail&gt;
  &lt;/master&gt;
  &lt;master id="2"&gt;
    &lt;name&gt;anotherName&lt;/name&gt;
    &lt;detail id="21"&gt;
      &lt;date&gt;2008-10-03&lt;/date&gt;
      &lt;type&gt;aType&lt;/type&gt;
    &lt;/detail&gt;
    &lt;detail id="22"&gt;
      &lt;date&gt;2008-10-06&lt;/date&gt;
      &lt;type&gt;aType&lt;/type&gt;
    &lt;/detail&gt;
    &lt;detail id="23"&gt;
      &lt;date&gt;2008-10-07&lt;/date&gt;
      &lt;type&gt;anotherType&lt;/type&gt;
    &lt;/detail&gt;
  &lt;/master&gt;
&lt;/masterDetail&gt;

</pre>
</div></div><br class="figure-break">
<p>
The following resources script performs the update.
</p>
<div class="figure"><a name="resources-masterDetail.xml"></a><p class="title"><b>Figure&nbsp;219.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="loadMasterDetail"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:subtreeRecordReader&gt;
        &lt;sx:transform&gt;
          &lt;sx:document/&gt;
        &lt;/sx:transform&gt;
        &lt;sx:inverseRecordMapping ref="masterDetailMapping"/&gt;
      &lt;/sx:subtreeRecordReader&gt;
      &lt;!-- You should validate the record with an sx:recordValidator here --&gt;
      &lt;sx:sqlWriter ref="masterDetailWriter"/&gt;
      &lt;sx:discardHandler&gt;
        &lt;sx:log message="{$sx:message}"/&gt;
        &lt;!-- You can set up a record pipeline here to write bad records to a file or database table --&gt;
      &lt;/sx:discardHandler&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:inverseRecordMapping id="masterDetailMapping"&gt;
    &lt;sx:onSubtree path="/masterDetail/master"&gt;
      &lt;sx:flattenSubtree recordType="master"&gt;
        &lt;sx:subtreeFieldMap select="@id" field="masterId"/&gt;
        &lt;sx:subtreeFieldMap select="name" field="name"/&gt;
        &lt;sx:subtreeFieldMap match="detail" field="details"&gt;
          &lt;sx:flattenSubtree recordType="detail"&gt;
            &lt;sx:subtreeFieldMap select="@id" field="detailId"/&gt;
            &lt;sx:subtreeFieldMap select="date" field="date"/&gt;
            &lt;sx:subtreeFieldMap select="type" field="type"/&gt;
          &lt;/sx:flattenSubtree&gt;
        &lt;/sx:subtreeFieldMap&gt;
      &lt;/sx:flattenSubtree&gt;
    &lt;/sx:onSubtree&gt;
  &lt;/sx:inverseRecordMapping&gt;

  &lt;sx:sqlWriter id="masterDetailWriter"&gt;                          
    &lt;sx:sqlConnectionPool ref="jdbcPool"/&gt;
    &lt;sx:sqlUpdate&gt;
        INSERT INTO master(master_id,name) VALUES({masterId},'{name}')
      &lt;sx:sqlUpdateDetail field="details"&gt;
        &lt;sx:sqlUpdate&gt;
          INSERT INTO detail(detail_id,detail_date,detail_type) 
          VALUES({detailId},to_date('{date}','yyyy-mm-dd'),'{type}')
        &lt;/sx:sqlUpdate&gt;
      &lt;/sx:sqlUpdateDetail&gt;
    &lt;/sx:sqlUpdate&gt;
  &lt;/sx:sqlWriter&gt;

  &lt;sx:sqlConnectionPool id="jdbcPool"
                        driver="oracle.jdbc.driver.OracleDriver"
                        databaseUrl="jdbc:oracle:thin:@127.0.0.1:1521:dev"
                        user="scott"
                        password="spring"
                        minConnections="2"
                        testStatement="SELECT * FROM DUAL"/&gt;

&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
  <p>
    The inverse record mapping instructions in the script will produce a stream 
    of composite records of type "master" that contain a repeating group field 
    named "details" having subrecords of type "detail".
  </p>
<p>
Executing the <code class="code">loadMasterDetail</code> service, like this,
</p><pre class="programlisting">

servingxml -i data/masterDetail.xml -r resources-masterDetail.xml loadMasterDetail
</pre><p>
results in the following update statements being sent to the RDMS and committed 
to the database:
</p>
<pre class="programlisting">

  INSERT INTO master(master_id,name) VALUES(1,'aName')
  INSERT INTO detail(detail_id,detail_date,detail_type) 
  VALUES(11,to_date('2008-09-03','yyyy-mm-dd'),'aType')
  INSERT INTO detail(detail_id,detail_date,detail_type) 
  VALUES(12,to_date('2008-09-06','yyyy-mm-dd'),'aType')
  INSERT INTO detail(detail_id,detail_date,detail_type) 
  VALUES(13,to_date('2008-09-10','yyyy-mm-dd'),'aType')
</pre>
<p>
The second set of master/detail records fails, however,
because the last detail has a value for <code class="code">detail_type</code>,
  "anotherType", that 
exceeds the length of the column, 10.  The following error message
is written to the log:
</p>
<pre class="programlisting">

SEVERE: ORA-12899: value too large for column "SCOTT"."DETAIL"."DETAIL_TYPE" 
(actual: 11, maximum: 10) 
</pre>
  </div>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e2929"></a>SQL Query to Database</h3></div></div></div>
<div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e2931"></a>SQL inserts</h4></div></div></div>


<a class="indexterm" name="d4e2934"></a>
<p>
This example shows how to prepare a resources script that will read rows from one database table
and write them to another.
</p>
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-insert_employees.xml"></a><p class="title"><b>Figure&nbsp;220.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
               xmlns:msv="http://www.servingxml.com/extensions/msv"&gt;

  &lt;sx:service id="loadEmployees"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:sqlReader ref="employeesReader"/&gt;
      &lt;msv:recordValidator&gt;
        &lt;xsd:schema xmlns:xsd="http://www.w3.org/2001/XMLSchema"&gt;
          &lt;!-- This element's name matches the value of the name attribute in the sx:sqlQuery element. --&gt;
          &lt;xsd:element name="employee" type="EmployeeType"/&gt;
          &lt;xsd:complexType name="EmployeeType"&gt;
            &lt;xsd:sequence&gt;
              &lt;xsd:element name="EMPNO" type="xsd:integer"/&gt;
              &lt;xsd:element name="NAME" type="xsd:string"/&gt;
              &lt;xsd:element name="JOB" type="xsd:string"/&gt;
            &lt;/xsd:sequence&gt;
          &lt;/xsd:complexType&gt;
        &lt;/xsd:schema&gt;
      &lt;/msv:recordValidator&gt;

      &lt;sx:sqlWriter ref="employeesWriter"/&gt;
      &lt;sx:discardHandler&gt;
        &lt;sx:log message="{$sx:message}"/&gt;
        &lt;!-- You can include a record pipeline here to write bad records to a file or database table --&gt;
      &lt;/sx:discardHandler&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:sqlWriter id="employeesWriter"&gt;                          
    &lt;sx:sqlConnectionPool ref="jdbcPool"/&gt;
    &lt;sx:sqlUpdate&gt;
        INSERT INTO EMP_HISTORY(EMPNO, ENAME) VALUES({EMPNO},'{NAME}')
    &lt;/sx:sqlUpdate&gt;
  &lt;/sx:sqlWriter&gt;

  &lt;sx:sqlReader id="employeesReader"&gt;
    &lt;sx:sqlConnectionPool ref="jdbcPool"/&gt;

    &lt;sx:parameter name="jobList"&gt;
      &lt;sx:toString value="{$job}" separator=","&gt;
        &lt;sx:quoteSymbol character="'" escapeCharacter="'"/&gt;
      &lt;/sx:toString&gt;
    &lt;/sx:parameter&gt;

    &lt;sx:sqlQuery recordType = "employee"&gt;
        SELECT EMPNO, ENAME AS NAME,JOB FROM EMP WHERE 1=1
      &lt;sx:choose&gt;
        &lt;sx:when test="$jobList"&gt;
            AND JOB IN ({$jobList})
        &lt;/sx:when&gt;
      &lt;/sx:choose&gt;
        ORDER BY JOB,ENAME
    &lt;/sx:sqlQuery&gt;

  &lt;/sx:sqlReader&gt;

  &lt;sx:sqlConnectionPool id="jdbcPool"
                        driver="oracle.jdbc.driver.OracleDriver"
                        databaseUrl="jdbc:oracle:thin:@127.0.0.1:1521:dev"
                        user="scott"
                        password="spring"
                        minConnections="2"
                        testStatement="SELECT * FROM DUAL"/&gt;

&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
Executing the <code class="code">loadEmployees</code> service with two <code class="code">job</code> parameters, like this
</p><pre class="programlisting">

    servingxml -r resources-insert_employees.xml loadEmployees 
        job=ANALYST job=CLERK

</pre><p>
results in the following SQL statement being sent to the Oracle server:
</p><pre class="programlisting">

SELECT EMPNO, ENAME AS NAME,JOB 
  FROM EMP 
  WHERE 1=1 AND JOB IN ('ANALYST','CLERK') 
  ORDER BY JOB,ENAME
</pre><p>
</p>
<p>
These results are then written to the database table <code class="code">EMP_HISTORY</code>.
</p>
</div>

<div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e2949"></a>Batched SQL inserts</h4></div></div></div>


<a class="indexterm" name="d4e2952"></a>
<a class="indexterm" name="d4e2955"></a>
<p>
This example shows how to prepare a resources script that will read rows from one database table
and write them in batches to another.
</p>
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-batch_insert_employees.xml"></a><p class="title"><b>Figure&nbsp;221.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
               xmlns:msv="http://www.servingxml.com/extensions/msv"&gt;

  &lt;sx:service id="loadEmployees"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:sqlReader ref="employeesReader"/&gt;
      &lt;msv:recordValidator&gt;
        &lt;xsd:schema xmlns:xsd="http://www.w3.org/2001/XMLSchema"&gt;
          &lt;!-- This element's name matches the value of the name attribute in the sx:sqlQuery element. --&gt;
          &lt;xsd:element name="employee" type="EmployeeType"/&gt;
          &lt;xsd:complexType name="EmployeeType"&gt;
            &lt;xsd:sequence&gt;
              &lt;xsd:element name="EMPNO" type="xsd:integer"/&gt;
              &lt;xsd:element name="NAME" type="xsd:string"/&gt;
              &lt;xsd:element name="JOB" type="xsd:string"/&gt;              
            &lt;/xsd:sequence&gt;
          &lt;/xsd:complexType&gt;
        &lt;/xsd:schema&gt;
      &lt;/msv:recordValidator&gt;

      &lt;sx:sqlWriter ref="employeesWriter"/&gt;
      &lt;sx:discardHandler&gt;
        &lt;sx:log message="{$sx:message}"/&gt;
        &lt;!-- You can include a record pipeline here to write bad records to a file or database table --&gt;
      &lt;/sx:discardHandler&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:sqlBatchWriter id="employeesWriter" batchSize="4"&gt;
    &lt;sx:sqlConnectionPool ref="jdbcPool"/&gt;
    &lt;sx:sqlUpdate&gt;
        INSERT INTO EMP_HISTORY(EMPNO, ENAME) VALUES( {EMPNO}, '{NAME}')
    &lt;/sx:sqlUpdate&gt;
  &lt;/sx:sqlBatchWriter&gt;

  &lt;sx:sqlReader id="employeesReader"&gt;
    &lt;sx:sqlConnectionPool ref="jdbcPool"/&gt;

    &lt;sx:parameter name="jobList"&gt;
      &lt;sx:toString value="{$job}" separator=","&gt;
        &lt;sx:quoteSymbol character="'" escapeCharacter="'"/&gt;
      &lt;/sx:toString&gt;
    &lt;/sx:parameter&gt;

    &lt;sx:sqlQuery recordType = "employee"&gt;
        SELECT EMPNO, ENAME AS NAME,JOB FROM EMP WHERE 1=1
      &lt;sx:choose&gt;
        &lt;sx:when test="$jobList"&gt;
            AND JOB IN ({$jobList})
        &lt;/sx:when&gt;
      &lt;/sx:choose&gt;
        ORDER BY JOB,ENAME
    &lt;/sx:sqlQuery&gt;

  &lt;/sx:sqlReader&gt;

  &lt;sx:sqlConnectionPool id="jdbcPool"
                        driver="oracle.jdbc.driver.OracleDriver"
                        databaseUrl="jdbc:oracle:thin:@127.0.0.1:1521:dev"
                        user="scott"
                        password="spring"
                        minConnections="2"
                        testStatement="SELECT * FROM DUAL"/&gt;

&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
Executing the <code class="code">loadEmployees</code> service with two <code class="code">job</code> parameters, like this
</p><pre class="programlisting">

    servingxml -r resources-batch_insert_employees.xml loadEmployees 
        job=ANALYST job=CLERK

</pre><p>
results in the following SQL statement being sent to the Oracle server:
</p><pre class="programlisting">

SELECT EMPNO, ENAME AS NAME,JOB 
  FROM EMP 
  WHERE 1=1 AND JOB IN ('ANALYST','CLERK') 
  ORDER BY JOB,ENAME
</pre><p>
</p>
<p>
These results are then written in batches of 4 to the database table <code class="code">EMP_HISTORY</code>.
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e2970"></a>Prepared SQL inserts</h4></div></div></div>


<a class="indexterm" name="d4e2973"></a>
<a class="indexterm" name="d4e2976"></a>
<p>
This example shows how to prepare a resources script that will read rows from one database table
and write them using a prepared SQL statement to another.
</p>
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-prepare_insert_employees.xml"></a><p class="title"><b>Figure&nbsp;222.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
               xmlns:msv="http://www.servingxml.com/extensions/msv"&gt;

  &lt;sx:service id="loadEmployees"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:sqlReader ref="employeesReader"/&gt;

      &lt;msv:recordValidator&gt;
        &lt;xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;
          &lt;!-- This element's name matches the value of the name attribute in the sx:sqlQuery element. --&gt;
          &lt;xs:element name="employee" type="EmployeeType"/&gt;
          &lt;xs:complexType name="EmployeeType"&gt;
            &lt;xs:sequence&gt;
              &lt;xs:element name="EMPNO" type="xs:integer"/&gt;
              &lt;xs:element name="NAME" type="xs:string"/&gt;
              &lt;xs:element name="JOB" type="xs:string"/&gt;
              &lt;xs:element name="MGR" type="xs:integer"/&gt;
              &lt;xs:element name="HIREDATE" type="xs:date"/&gt;
              &lt;xs:element name="SAL" type="xs:decimal"/&gt;
              &lt;xs:element name="COMM" type="xs:decimal" minOccurs="0"/&gt; 
              &lt;xs:element name="DEPTNO" type="xs:integer"/&gt;
            &lt;/xs:sequence&gt;
          &lt;/xs:complexType&gt;
        &lt;/xs:schema&gt;
      &lt;/msv:recordValidator&gt;

      &lt;sx:sqlWriter ref="employeesWriter"/&gt;
      &lt;sx:discardHandler&gt;
        &lt;sx:log message="{$sx:message}"/&gt;
        &lt;!-- You can include a record pipeline here to write bad records to a database table --&gt;
        &lt;sx:sqlWriter ref="discardWriter"/&gt; 
        &lt;sx:discardHandler&gt;
          &lt;sx:log message="{$sx:message}"/&gt;
        &lt;/sx:discardHandler&gt;
      &lt;/sx:discardHandler&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:sqlWriter id="employeesWriter" xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;
    &lt;sx:sqlConnectionPool ref="jdbcPool"/&gt;
    &lt;sx:sqlUpdate&gt;                                                                                                                        
      &lt;!-- Because the SQL insert executes a prepared statement, values must be
            associated with appropriate types.  In this example, because these values are 
            coming from a SQL query source, they will already be associated with SQL types, 
            and no further action is really necessary.  In the case of other data sources, however,
            values by default will be associated with string types, and may need
            to be recast in parameter assignments, as shown below.
      --&gt;
      &lt;sx:parameter name="employee-no" value="{EMPNO}" type="xs:long"/&gt;
      &lt;sx:parameter name="mgr" value="{MGR}" type="xs:long"/&gt;
      &lt;sx:parameter name="hiredate" value="{HIREDATE}" type="xs:date"/&gt;              
      &lt;sx:parameter name="salary" value="{SAL}" type="xs:decimal"/&gt;              
      &lt;sx:parameter name="commission" value="{COMM}" type="xs:decimal"/&gt;              
      &lt;sx:sqlPrepare&gt;
        INSERT INTO EMP_HISTORY(EMPNO, ENAME, JOB, MGR, HIREDATE, SAL, COMM) 
        VALUES({$employee-no},{NAME},{JOB}, {$mgr}, {$hiredate},  {$salary}, {$commission})
      &lt;/sx:sqlPrepare&gt;
    &lt;/sx:sqlUpdate&gt;
  &lt;/sx:sqlWriter&gt;                                                                              

  &lt;sx:sqlWriter id="discardWriter" xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;
    &lt;sx:sqlConnectionPool ref="jdbcPool"/&gt;
    &lt;sx:sqlUpdate&gt;
      &lt;sx:parameter name="employee-no" value="{EMPNO}" type="xs:long"/&gt;
      &lt;sx:parameter name="mgr" value="{MGR}" type="xs:long"/&gt;
      &lt;sx:parameter name="hiredate" value="{HIREDATE}" type="xs:date"/&gt;              
      &lt;sx:parameter name="salary" value="{SAL}" type="xs:decimal"/&gt;              
      &lt;sx:parameter name="commission" value="{COMM}" type="xs:decimal"/&gt;              
      &lt;sx:sqlPrepare&gt;
        INSERT INTO EMP_DISCARD(MESSAGE, EMPNO, ENAME, JOB, MGR, HIREDATE, SAL, 
                                COMM) 
        VALUES({$message}, {$employee-no}, {NAME}, {JOB}, {$mgr}, {$hiredate},
               {$salary}, {$commission})
      &lt;/sx:sqlPrepare&gt;
    &lt;/sx:sqlUpdate&gt;
  &lt;/sx:sqlWriter&gt;                                                                              
                                                              
  &lt;sx:sqlReader id="employeesReader"&gt;                         
    &lt;sx:sqlConnectionPool ref="jdbcPool"/&gt;

    &lt;sx:parameter name="jobList"&gt;
      &lt;sx:toString value="{$job}" separator=","&gt;
        &lt;sx:quoteSymbol character="'" escapeCharacter="'"/&gt;
      &lt;/sx:toString&gt;
    &lt;/sx:parameter&gt;

    &lt;sx:sqlQuery recordType = "employee"&gt;
        SELECT EMPNO, ENAME AS NAME, JOB, MGR, HIREDATE, SAL, COMM, DEPTNO FROM EMP WHERE 1=1
      &lt;sx:choose&gt;
        &lt;sx:when test="$jobList"&gt;
            AND JOB IN ({$jobList})
        &lt;/sx:when&gt;
      &lt;/sx:choose&gt;
        ORDER BY JOB,ENAME
    &lt;/sx:sqlQuery&gt;

  &lt;/sx:sqlReader&gt;

  &lt;sx:sqlConnectionPool id="jdbcPool"
                        driver="oracle.jdbc.driver.OracleDriver"
                        databaseUrl="jdbc:oracle:thin:@127.0.0.1:1521:dev"
                        user="scott"
                        password="spring"
                        minConnections="2"
                        testStatement="SELECT * FROM DUAL"/&gt;

&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
Executing the <code class="code">loadEmployees</code> service with two <code class="code">job</code> parameters, like this
</p><pre class="programlisting">

    servingxml -r resources-prepare_insert_employees.xml loadEmployees 
        job=SALESMAN job=MANAGER

</pre><p>
results in the following SQL statement being sent to the Oracle server:
</p><pre class="programlisting">

SELECT EMPNO, ENAME AS NAME, JOB, MGR, HIREDATE, SAL, COMM, DEPTNO 
  FROM EMP 
  WHERE 1=1 AND JOB IN ('SALESMAN','MANAGER') 
  ORDER BY JOB,ENAME
</pre><p>
</p>
<p>
These results are then written in batches of 4 to the database table <code class="code">EMP_HISTORY</code>.
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e2991"></a>Batched prepared SQL inserts</h4></div></div></div>


<a class="indexterm" name="d4e2994"></a>
<a class="indexterm" name="d4e2997"></a>
<a class="indexterm" name="d4e3000"></a>
<p>
This example shows how to prepare a resources script that will read rows from one database table
and write them in batches, using a prepared SQL statement, to another.
</p>
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-batch_prepare_insert_employees.xml"></a><p class="title"><b>Figure&nbsp;223.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
               xmlns:msv="http://www.servingxml.com/extensions/msv"&gt;

  &lt;sx:service id="loadEmployees"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:sqlReader ref="employeesReader"/&gt;
      &lt;msv:recordValidator&gt;
        &lt;xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;
          &lt;!-- This element's name matches the value of the name attribute in the sx:sqlQuery element. --&gt;
          &lt;xs:element name="employee" type="EmployeeType"/&gt;
          &lt;xs:complexType name="EmployeeType"&gt;
            &lt;xs:sequence&gt;
              &lt;xs:element name="EMPNO" type="xs:integer"/&gt;
              &lt;xs:element name="NAME" type="xs:string"/&gt;
              &lt;xs:element name="JOB" type="xs:string"/&gt;
              &lt;xs:element name="MGR" type="xs:integer"/&gt;
              &lt;xs:element name="HIREDATE" type="xs:date"/&gt;
              &lt;xs:element name="SAL" type="xs:decimal"/&gt;
              &lt;xs:element name="COMM" type="xs:decimal" minOccurs="0"/&gt; 
              &lt;xs:element name="DEPTNO" type="xs:integer"/&gt;
            &lt;/xs:sequence&gt;
          &lt;/xs:complexType&gt;
        &lt;/xs:schema&gt;
      &lt;/msv:recordValidator&gt;

      &lt;sx:sqlWriter ref="employeesWriter"/&gt;
      &lt;sx:discardHandler&gt;
        &lt;sx:log message="{$sx:message}"/&gt;
        &lt;!-- You can include a record pipeline here to write bad records to a file or database table --&gt;
      &lt;/sx:discardHandler&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:sqlBatchWriter id="employeesWriter" xmlns:xs="http://www.w3.org/2001/XMLSchema" batchSize="4"&gt;
    &lt;sx:sqlConnectionPool ref="jdbcPool"/&gt;
    &lt;sx:sqlUpdate&gt;
      &lt;!-- Because the SQL insert executes a prepared statement, values must be
           associated with appropriate types.  In this example, because these values are 
           coming from a SQL query source, they will already be associated with SQL types, 
           and no further action is really necessary.  In the case of other data sources, however,
           values by default will be associated with string types, and may need
           to be recast in parameter assignments, as shown below.
      --&gt;
      &lt;sx:parameter name="employee-no" value="{EMPNO}" type="xs:long"/&gt;
      &lt;sx:parameter name="mgr" value="{MGR}" type="xs:long"/&gt;
      &lt;sx:parameter name="hiredate" value="{HIREDATE}" type="xs:date"/&gt;              
      &lt;sx:parameter name="salary" value="{SAL}" type="xs:decimal"/&gt;              
      &lt;sx:parameter name="commission" value="{COMM}" type="xs:decimal"/&gt;              
      &lt;sx:sqlPrepare&gt;                                                                                                            
        INSERT INTO EMP_HISTORY(EMPNO, ENAME, JOB, MGR, HIREDATE, SAL, COMM) 
        VALUES({$employee-no},{NAME},{JOB}, {$mgr}, {$hiredate},  {$salary}, {$commission})
      &lt;/sx:sqlPrepare&gt;
    &lt;/sx:sqlUpdate&gt;
  &lt;/sx:sqlBatchWriter&gt;

  &lt;sx:sqlReader id="employeesReader"&gt;
    &lt;sx:sqlConnectionPool ref="jdbcPool"/&gt;

    &lt;sx:parameter name="jobList"&gt;
      &lt;sx:toString value="{$job}" separator=","&gt;
        &lt;sx:quoteSymbol character="'" escapeCharacter="'"/&gt;
      &lt;/sx:toString&gt;
    &lt;/sx:parameter&gt;

    &lt;sx:sqlQuery recordType = "employee"&gt;
        SELECT EMPNO, ENAME AS NAME, JOB, MGR, HIREDATE, SAL, COMM, DEPTNO FROM EMP WHERE 1=1
      &lt;sx:choose&gt;
        &lt;sx:when test="$jobList"&gt;
            AND JOB IN ({$jobList})
        &lt;/sx:when&gt;
      &lt;/sx:choose&gt;
        ORDER BY JOB,ENAME
    &lt;/sx:sqlQuery&gt;

  &lt;/sx:sqlReader&gt;

  &lt;sx:sqlConnectionPool id="jdbcPool"
                        driver="oracle.jdbc.driver.OracleDriver"
                        databaseUrl="jdbc:oracle:thin:@127.0.0.1:1521:dev"
                        user="scott"
                        password="spring"
                        minConnections="2"
                        testStatement="SELECT * FROM DUAL"/&gt;

&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
Executing the <code class="code">loadEmployees</code> service with two <code class="code">job</code> parameters, like this
</p><pre class="programlisting">

    servingxml -r resources-batch_prepare_insert_employees.xml loadEmployees 
        job=SALESMAN job=MANAGER

</pre><p>
results in the following SQL statement being sent to the Oracle server:
</p><pre class="programlisting">

SELECT EMPNO, ENAME AS NAME, JOB, MGR, HIREDATE, SAL, COMM, DEPTNO 
  FROM EMP 
  WHERE 1=1 AND JOB IN ('SALESMAN','MANAGER') 
  ORDER BY JOB,ENAME
</pre><p>
</p>
<p>
These results are then written in batches of 4 to the database table <code class="code">EMP_HISTORY</code>, using prepared SQL statements.
</p>
</div>
<div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e3015"></a>Updating an employee record using command-line parameters (employee update)</h4></div></div></div>

<p>
The example below illustrates how to prepare a resources script that will change an employee
job categorization using command line parameters.  
</p>
<div class="figure"><a name="sql-resources.xml"></a><p class="title"><b>Figure&nbsp;224.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="updateEmployee"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:parameterReader recordType="employee"/&gt;
      &lt;sx:sqlWriter&gt;
        &lt;sx:sqlConnectionPool ref="jdbcPool"/&gt;
        &lt;sx:sqlUpdate&gt;
          UPDATE EMP SET JOB = '{$job}' WHERE EMPNO='{$empNo}'
        &lt;/sx:sqlUpdate&gt;
      &lt;/sx:sqlWriter&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;
  
  &lt;sx:sqlConnectionPool id="jdbcPool"
                        driver="oracle.jdbc.driver.OracleDriver"
                        databaseUrl="jdbc:oracle:thin:@127.0.0.1:1521:dev"
                        user="scott"
                        password="spring"
                        minConnections="2"
                        testStatement="SELECT * FROM DUAL"/&gt;

&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
You can run this example on the command line by entering
</p><pre class="programlisting">

servingxml -r resources.xml -o updateEmployee 
    empNo=7499 job=ANALYST

</pre><p>
</p>
</div>

<div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e3023"></a>Insert if record does not exist, update otherwise (insert/update).</h4></div></div></div>


<a class="indexterm" name="d4e3026"></a>
<p>
This example shows how to prepare a resources script that will read rows from one database table
and write them to another, inserting if the record does not already exist, updating otherwise.
</p>
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources-loadEmployees.xml"></a><p class="title"><b>Figure&nbsp;225.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"
               xmlns:msv="http://www.servingxml.com/extensions/msv"&gt;

  &lt;sx:service id="loadEmployees"&gt;
    &lt;sx:recordStream&gt;
      &lt;sx:sqlReader ref="employeesReader"/&gt;
      &lt;msv:recordValidator&gt;
        &lt;xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;
          &lt;!-- This element's name matches the value of the name attribute in the sx:sqlQuery element. --&gt;
          &lt;xs:element name="employee" type="EmployeeType"/&gt;
          &lt;xs:complexType name="EmployeeType"&gt;
            &lt;xs:sequence&gt;
              &lt;xs:element name="EMPNO" type="xs:integer"/&gt;
              &lt;xs:element name="NAME" type="xs:string"/&gt;
              &lt;xs:element name="JOB" type="xs:string"/&gt;
            &lt;/xs:sequence&gt;
          &lt;/xs:complexType&gt;
        &lt;/xs:schema&gt;
      &lt;/msv:recordValidator&gt;

      &lt;sx:sqlWriter ref="employeesWriter"/&gt;
      &lt;sx:discardHandler&gt;
        &lt;sx:log message="{$sx:message}"/&gt;
        &lt;!-- You can include a record pipeline here to write bad records to a file or database table --&gt;
      &lt;/sx:discardHandler&gt;
    &lt;/sx:recordStream&gt;
  &lt;/sx:service&gt;

  &lt;sx:sqlWriter id="employeesWriter"&gt;
    &lt;sx:sqlConnectionPool ref="jdbcPool"/&gt;
    &lt;sx:sqlUpdateChoice&gt;
      &lt;sx:sqlQuery&gt;
        SELECT EMPNO FROM EMP_HISTORY WHERE EMPNO = {EMPNO}
      &lt;/sx:sqlQuery&gt;
      &lt;sx:recordNotFound&gt;
        &lt;sx:sqlUpdate&gt;
          INSERT INTO EMP_HISTORY(EMPNO, ENAME) VALUES({EMPNO},'{NAME}')
        &lt;/sx:sqlUpdate&gt;
      &lt;/sx:recordNotFound&gt;
      &lt;sx:recordFound&gt;
        &lt;sx:sqlUpdate&gt;
          UPDATE EMP_HISTORY SET ENAME = '{NAME}' WHERE EMPNO = {EMPNO}
        &lt;/sx:sqlUpdate&gt;
      &lt;/sx:recordFound&gt;
    &lt;/sx:sqlUpdateChoice&gt;
  &lt;/sx:sqlWriter&gt;

  &lt;sx:sqlReader id="employeesReader"&gt;
    &lt;sx:sqlConnectionPool ref="jdbcPool"/&gt;

    &lt;sx:parameter name="jobList"&gt;
      &lt;sx:toString value="{$job}" separator=","&gt;
        &lt;sx:quoteSymbol character="'" escapeCharacter="'"/&gt;
      &lt;/sx:toString&gt;
    &lt;/sx:parameter&gt;

    &lt;sx:sqlQuery recordType = "employee"&gt;
        SELECT EMPNO, ENAME AS NAME,JOB FROM EMP WHERE 1=1
      &lt;sx:choose&gt;
        &lt;sx:when test="$jobList"&gt;
            AND JOB IN ({$jobList})
        &lt;/sx:when&gt;
      &lt;/sx:choose&gt;
        ORDER BY JOB,ENAME
    &lt;/sx:sqlQuery&gt;

  &lt;/sx:sqlReader&gt;

  &lt;sx:sqlConnectionPool id="jdbcPool"
                        driver="oracle.jdbc.driver.OracleDriver"
                        databaseUrl="jdbc:oracle:thin:@127.0.0.1:1521:dev"
                        user="scott"
                        password="spring"
                        minConnections="2"
                        testStatement="SELECT * FROM DUAL"/&gt;

&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
Execute the <code class="code">loadEmployees</code> service with two <code class="code">job</code> parameters, like this
</p>
<pre class="programlisting">

    servingxml -r resources-insertUpdate.xml loadEmployees 
        job=ANALYST job=CLERK

</pre>
</div>

<div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e3038"></a>Writing rows to a database table as they pass through a pipe, to an XML file (employees-tee)</h4></div></div></div>


<a class="indexterm" name="d4e3041"></a>
<p>
This example shows how to prepare a resources script that will read rows from an RDBMS,
write them to a database table as they pass through the pipe, and finally produce an XML file.
</p>
<p>
The desired XML file is shown below.
</p>

<div class="figure"><a name="employees.xml"></a><p class="title"><b>Figure&nbsp;226.&nbsp;Output XML file employees.xml</b></p><div class="figure-contents">
  
<pre class="programlisting">

&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;employees&gt;
   &lt;ANALYST&gt;
      &lt;employee employee-no="7902"&gt;
         &lt;name&gt;FORD&lt;/name&gt;
      &lt;/employee&gt;
      &lt;employee employee-no="7788"&gt;
         &lt;name&gt;SCOTT&lt;/name&gt;
      &lt;/employee&gt;
   &lt;/ANALYST&gt;
   &lt;CLERK&gt;
      &lt;employee employee-no="7876"&gt;
         &lt;name&gt;ADAMS&lt;/name&gt;
      &lt;/employee&gt;
      &lt;employee employee-no="7900"&gt;
         &lt;name&gt;JAMES&lt;/name&gt;
      &lt;/employee&gt;
      &lt;employee employee-no="7934"&gt;
         &lt;name&gt;MILLER&lt;/name&gt;
      &lt;/employee&gt;
      &lt;employee employee-no="7369"&gt;
         &lt;name&gt;SMITH&lt;/name&gt;
      &lt;/employee&gt;
   &lt;/CLERK&gt;
&lt;/employees&gt;
</pre>
</div></div><br class="figure-break">
<p>
The following resources script does the transformation.
</p>
<div class="figure"><a name="resources.xml"></a><p class="title"><b>Figure&nbsp;227.&nbsp;Resources script</b></p><div class="figure-contents">
  
<pre class="programlisting">
&lt;sx:resources xmlns:sx="http://www.servingxml.com/core"&gt;

  &lt;sx:service id="employees"&gt;
    &lt;sx:serialize&gt;
      &lt;sx:content ref="employeesDoc"/&gt;
    &lt;/sx:serialize&gt;
  &lt;/sx:service&gt;

  &lt;sx:recordContent id="employeesDoc"&gt;
    &lt;sx:sqlReader&gt;
      &lt;sx:sqlConnectionPool ref="jdbcPool"/&gt;

      &lt;sx:parameter name="jobList"&gt;
        &lt;sx:toString value="{$job}" separator=","&gt;
          &lt;sx:quoteSymbol character="'" escapeCharacter="'"/&gt;
        &lt;/sx:toString&gt;
      &lt;/sx:parameter&gt;

      &lt;sx:sqlQuery recordType = "employee"&gt;
        SELECT EMPNO, ENAME AS NAME,JOB FROM EMP WHERE 1=1
        &lt;sx:choose&gt;
          &lt;sx:when test="$jobList"&gt;
            AND JOB IN ({$jobList})
          &lt;/sx:when&gt;
        &lt;/sx:choose&gt;
        ORDER BY JOB,ENAME
      &lt;/sx:sqlQuery&gt;
    &lt;/sx:sqlReader&gt;

    &lt;sx:recordTee&gt;
      &lt;sx:sqlWriter&gt;
        &lt;sx:sqlConnectionPool ref="jdbcPool"/&gt;
        &lt;sx:sqlUpdate&gt;
            INSERT INTO EMP_LOG(EMPNO, ENAME) VALUES({EMPNO},'{NAME}')
        &lt;/sx:sqlUpdate&gt;
      &lt;/sx:sqlWriter&gt;
    &lt;/sx:recordTee&gt;

    &lt;sx:recordMapping ref="employeesToXml"/&gt;
  &lt;/sx:recordContent&gt;
                           
  &lt;sx:recordMapping id="employeesToXml"&gt;
    &lt;employees&gt;
      &lt;sx:groupBy fields="JOB"&gt;
        &lt;sx:elementMap element="{JOB}"&gt;
          &lt;sx:onRecord&gt;
            &lt;employee&gt;
              &lt;sx:fieldAttributeMap field="EMPNO" attribute="employee-no"/&gt;
              &lt;sx:fieldElementMap field="NAME" element="name"/&gt;
            &lt;/employee&gt;
          &lt;/sx:onRecord&gt;
        &lt;/sx:elementMap&gt;
      &lt;/sx:groupBy&gt;
    &lt;/employees&gt;
  &lt;/sx:recordMapping&gt;

  &lt;sx:sqlConnectionPool id="jdbcPool"
                        driver="oracle.jdbc.driver.OracleDriver"
                        databaseUrl="jdbc:oracle:thin:@127.0.0.1:1521:dev"
                        user="scott"
                        password="spring"
                        minConnections="2"
                        testStatement="SELECT * FROM DUAL"/&gt;

&lt;/sx:resources&gt;
</pre>
</div></div><br class="figure-break">
<p>
Executing the <code class="code">employees</code> service with two <code class="code">job</code> parameters, like this
</p><pre class="programlisting">

    servingxml -r resources-employeesTee.xml employees -o output/employees.xml employees 
        job=ANALYST job=CLERK

</pre><p>
results in the following SQL statement being sent to the Oracle server:
</p><pre class="programlisting">

SELECT EMPNO, ENAME AS NAME,JOB 
  FROM EMP 
  WHERE 1=1 AND JOB IN ('ANALYST','CLERK') 
  ORDER BY JOB,ENAME
</pre><p>
</p>
<p>
Each <code class="code">EMPNO</code> and <code class="code">ENAME</code> pair is written to the database table <code class="code">EMP_LOG</code>, and all rows are 
ultimately mapped to the XML file <code class="filename">employees.xml</code>.
</p>
</div>
</div>
</div>


  
<div class="index"><div class="titlepage"><div><div><h2 class="title"><a name="d4e3063"></a>Index</h2></div></div></div><div class="index"><div class="indexdiv"><h3>B</h3><dl><dt>batch</dt><dd><dl><dt>records, <a class="indexterm" href="#d4e1763">batched XML</a>, <a class="indexterm" href="#d4e2612">batched flat file</a></dt><dt>XML, <a class="indexterm" href="#d4e1744">serializing batches</a>, <a class="indexterm" href="#d4e1763">batched XML</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>C</h3><dl><dt>CDATA, <a class="indexterm" href="#d4e1585">opdef</a></dt></dl></div><div class="indexdiv"><h3>D</h3><dl><dt>date</dt><dd><dl><dt>convert to ISO 8601 format, <a class="indexterm" href="#trades-eg">trades (positional) to XML</a></dt><dt>today, <a class="indexterm" href="#ars-eg">ars (delimited) to XML</a></dt></dl></dd><dt>date/time</dt><dd><dl><dt>sx:currentDateTime, <a class="indexterm" href="#d4e465">optional elements</a></dt><dt>sx:formatDateTime, <a class="indexterm" href="#d4e465">optional elements</a></dt></dl></dd><dt>delimited field</dt><dd><dl><dt>max width, <a class="indexterm" href="#d4e255">field has max width</a></dt></dl></dd><dt>directory</dt><dd><dl><dt>reading, <a class="indexterm" href="#d4e921">books directory to XML</a>, <a class="indexterm" href="#d4e2426">book directory to new format</a>, <a class="indexterm" href="#d4e2573">remote directories</a></dt><dt>writing, <a class="indexterm" href="#d4e921">books directory to XML</a>, <a class="indexterm" href="#d4e2426">book directory to new format</a>, <a class="indexterm" href="#invoices-eg">document subtrees to PDF files</a></dt></dl></dd><dt>dynamic content, <a class="indexterm" href="#d4e2681">custom SAX reader</a>, <a class="indexterm" href="#d4e2746">dynamic content</a></dt></dl></div><div class="indexdiv"><h3>E</h3><dl><dt>edi, <a class="indexterm" href="#d4e694">edi to XML</a>, <a class="indexterm" href="#d4e732">Invoice96A</a></dt><dt>encoding</dt><dd><dl><dt>ebcdic, <a class="indexterm" href="#d4e2310">ascii-ebcidc</a>, <a class="indexterm" href="#d4e2326">ascii-packed</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>F</h3><dl><dt>field, <a class="indexterm" href="#d4e1625">transaction</a></dt><dt>field delimiter</dt><dd><dl><dt>comma, <a class="indexterm" href="#d4e167">countries-default</a></dt><dt>numerical entity references, <a class="indexterm" href="#tab-delimited">tab-delimited to XML</a></dt><dt>pipe, <a class="indexterm" href="#d4e325">family_data (multi-valued) to XML</a></dt><dt>tab, <a class="indexterm" href="#tab-delimited">tab-delimited to XML</a></dt></dl></dd><dt>field substitutions, <a class="indexterm" href="#d4e864">field substitutions</a></dt><dt>file integrity</dt><dd><dl><dt>crc, <a class="indexterm" href="#d4e2377">checked books</a></dt><dt>size, <a class="indexterm" href="#d4e2377">checked books</a></dt></dl></dd><dt>filter</dt><dd><dl><dt>XSLT, <a class="indexterm" href="#d4e2027">element sequence to flat</a></dt></dl></dd><dt>flat file</dt><dd><dl><dt>CSV, <a class="indexterm" href="#d4e167">countries-default</a>, <a class="indexterm" href="#d4e210">countries-custom</a>, <a class="indexterm" href="#d4e228">countries-validated</a>, <a class="indexterm" href="#tasks-eg">tasks (CSV) to XML</a>, <a class="indexterm" href="#timesheets-eg">timesheets (CSV) to XML (grouped)</a>, <a class="indexterm" href="#d4e1884">books (XML) to flat file (CSV)</a></dt><dt>delimited, <a class="indexterm" href="#d4e325">family_data (multi-valued) to XML</a>, <a class="indexterm" href="#ars-eg">ars (delimited) to XML</a>, <a class="indexterm" href="#d4e438">exotics (delimited) to XML (grouped)</a>, <a class="indexterm" href="#d4e1907">books (XML) to flat file (delimited)</a>, <a class="indexterm" href="#d4e1939">books (XML) to listing</a>, <a class="indexterm" href="#d4e2178">book hierarchy</a></dt><dt>Java properties, <a class="indexterm" href="#d4e486">properties to XML</a>, <a class="indexterm" href="#d4e532">properties to XML (grouped)</a>, <a class="indexterm" href="#d4e582">properties (muti-valued) to XML (grouped)</a></dt><dt>multi-valued fields, <a class="indexterm" href="#d4e325">family_data (multi-valued) to XML</a>, <a class="indexterm" href="#d4e1907">books (XML) to flat file (delimited)</a>, <a class="indexterm" href="#d4e1939">books (XML) to listing</a></dt><dt>multiple readers, <a class="indexterm" href="#d4e1827">multiple-readers</a></dt><dt>multiple record format, <a class="indexterm" href="#d4e438">exotics (delimited) to XML (grouped)</a>, <a class="indexterm" href="#trades-eg">trades (positional) to XML</a>, <a class="indexterm" href="#non_delimited_variant_trades">non-delimited trades to XML</a></dt><dt>no end-of-line delimiters, <a class="indexterm" href="#non_delimited_book_orders">non-delimited book orders to XML</a>, <a class="indexterm" href="#non_delimited_variant_trades">non-delimited trades to XML</a></dt><dt>positional, <a class="indexterm" href="#trades-eg">trades (positional) to XML</a>, <a class="indexterm" href="#CONV-eg">conv (positional) to XML</a>, <a class="indexterm" href="#d4e1108">hot (preliminaries)</a>, <a class="indexterm" href="#hot2-eg">hot (positional) to XML (grouped)</a>, <a class="indexterm" href="#d4e1850">books (XML) to flat file (positional)</a>, <a class="indexterm" href="#d4e2075">ungrouping</a>, <a class="indexterm" href="#d4e2107">all</a>, <a class="indexterm" href="#d4e2132">blocks</a>, <a class="indexterm" href="#d4e2154">block subsequences</a>, <a class="indexterm" href="#d4e2263">books (positional) to books (delimited)</a>, <a class="indexterm" href="#d4e2286">books (positional) to books (positional)</a>, <a class="indexterm" href="#d4e2342">declarative record filter</a>, <a class="indexterm" href="#d4e2377">checked books</a>, <a class="indexterm" href="#d4e2426">book directory to new format</a>, <a class="indexterm" href="#d4e2593">batch records</a></dt><dd><dl><dt>variable
                                                 width fields, <a class="indexterm" href="#variable-field-widths">variable field widths</a></dt></dl></dd><dt>record composition, <a class="indexterm" href="#recordComposition">record composition</a></dt><dt>segment concatenation, <a class="indexterm" href="#smf">smf</a></dt><dt>single record format, <a class="indexterm" href="#CONV-eg">conv (positional) to XML</a>, <a class="indexterm" href="#non_delimited_book_orders">non-delimited book orders to XML</a></dt></dl></dd><dt>flat file field</dt><dd><dl><dt>binary, <a class="indexterm" href="#special-char-eg">special char to XML</a>, <a class="indexterm" href="#special-char-eg">XML to special char</a></dt><dt>integer, <a class="indexterm" href="#smf">smf</a></dt><dt>packed decimal, <a class="indexterm" href="#packed-decimal-to-xml">packed decimal to XML</a>, <a class="indexterm" href="#smf">smf</a></dt></dl></dd><dt>flat file trailer</dt><dd><dl><dt>recordCount, <a class="indexterm" href="#d4e1850">books (XML) to flat file (positional)</a></dt></dl></dd><dt>flat file writer</dt><dd><dl><dt>default, <a class="indexterm" href="#d4e2828">employees csv</a></dt></dl></dd><dt>flat to XML</dt><dd><dl><dt>repeat header in XML, <a class="indexterm" href="#repeat-header-info-eg">repeat header in XML</a></dt></dl></dd><dt>fo, <a class="indexterm" href="#invoices-eg">document subtrees to PDF files</a>, <a class="indexterm" href="#mailInvoices">document subtrees to mail</a></dt><dt>FpML</dt><dd><dl><dt>FRA, <a class="indexterm" href="#d4e782">FRA</a></dt><dt>Swap, <a class="indexterm" href="#d4e813">Swap</a></dt></dl></dd><dt>FTP</dt><dd><dl><dt>sink, <a class="indexterm" href="#d4e2795">FTP sink</a></dt><dt>source, <a class="indexterm" href="#d4e2573">remote directories</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>G</h3><dl><dt>group</dt><dd><dl><dt>by, <a class="indexterm" href="#tasks-eg">tasks (CSV) to XML</a>, <a class="indexterm" href="#timesheets-eg">timesheets (CSV) to XML (grouped)</a>, <a class="indexterm" href="#ars-eg">ars (delimited) to XML</a>, <a class="indexterm" href="#d4e438">exotics (delimited) to XML (grouped)</a>, <a class="indexterm" href="#d4e532">properties to XML (grouped)</a>, <a class="indexterm" href="#d4e582">properties (muti-valued) to XML (grouped)</a></dt><dt>inner, <a class="indexterm" href="#CONV-eg">conv (positional) to XML</a>, <a class="indexterm" href="#hot2-eg">hot (positional) to XML (grouped)</a></dt><dt>outer, <a class="indexterm" href="#hot2-eg">hot (positional) to XML (grouped)</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>I</h3><dl><dt>inverse record mapping</dt><dd><dl><dt>header-detail records, <a class="indexterm" href="#d4e2001">XML-flat header-detail</a></dt><dt>match, <a class="indexterm" href="#d4e1975">swath (XML) to flat file (delimited)</a>, <a class="indexterm" href="#d4e2001">XML-flat header-detail</a></dt><dt>multi-valued fields, <a class="indexterm" href="#d4e1975">swath (XML) to flat file (delimited)</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>M</h3><dl><dt>mail</dt><dd><dl><dt>attachment, <a class="indexterm" href="#mailInvoices">document subtrees to mail</a>, <a class="indexterm" href="#d4e2775">XML to mail</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>O</h3><dl><dt>optional elements, <a class="indexterm" href="#d4e465">optional elements</a></dt></dl></div><div class="indexdiv"><h3>P</h3><dl><dt>parameter</dt><dd><dl><dt>default value, <a class="indexterm" href="#trades-eg">trades (positional) to XML</a></dt><dt>within groups, <a class="indexterm" href="#repeat-header-info-eg">repeat header in XML</a></dt></dl></dd><dt>pdf, <a class="indexterm" href="#invoices-eg">document subtrees to PDF files</a>, <a class="indexterm" href="#mailInvoices">document subtrees to mail</a></dt></dl></div><div class="indexdiv"><h3>R</h3><dl><dt>record</dt><dd><dl><dt>composite, <a class="indexterm" href="#d4e1513">aggregates over records</a>, <a class="indexterm" href="#d4e1545">two records to one element</a></dt></dl></dd><dt>record delimiter</dt><dd><dl><dt>continuation, <a class="indexterm" href="#d4e486">properties to XML</a>, <a class="indexterm" href="#d4e532">properties to XML (grouped)</a></dt><dt>start/end, <a class="indexterm" href="#d4e1585">opdef</a>, <a class="indexterm" href="#d4e1625">transaction</a></dt></dl></dd><dt>record filter</dt><dd><dl><dt>custom, <a class="indexterm" href="#d4e1108">hot (preliminaries)</a></dt><dt>schema validation, <a class="indexterm" href="#d4e228">countries-validated</a>, <a class="indexterm" href="#d4e1108">hot (preliminaries)</a></dt><dt>sx:replaceRecord, <a class="indexterm" href="#d4e2342">declarative record filter</a></dt></dl></dd><dt>record filters</dt><dd><dl><dt>sx:choose, <a class="indexterm" href="#d4e1907">books (XML) to flat file (delimited)</a>, <a class="indexterm" href="#d4e1939">books (XML) to listing</a></dt></dl></dd><dt>record mapping</dt><dd><dl><dt>default, <a class="indexterm" href="#d4e167">countries-default</a></dt></dl></dd><dt>record reader</dt><dd><dl><dt>custom, <a class="indexterm" href="#custom_record_reader">custom record reader</a>, <a class="indexterm" href="#multiple_output_files">multiple output files</a></dt></dl></dd><dt>record writer</dt><dd><dl><dt>multiple output files, <a class="indexterm" href="#multiple_output_files">multiple output files</a></dt></dl></dd><dt>records</dt><dd><dl><dt>reordering, <a class="indexterm" href="#d4e609">multiple summaries</a></dt></dl></dd><dt>regular expressions</dt><dd><dl><dt>match and replace, <a class="indexterm" href="#d4e921">books directory to XML</a>, <a class="indexterm" href="#trades-eg">trades (positional) to XML</a>, <a class="indexterm" href="#d4e2342">declarative record filter</a>, <a class="indexterm" href="#d4e2426">book directory to new format</a></dt><dt>search and replace, <a class="indexterm" href="#ars-eg">ars (delimited) to XML</a></dt></dl></dd><dt>repeating groups, <a class="indexterm" href="#d4e694">edi to XML</a>, <a class="indexterm" href="#d4e732">Invoice96A</a>, <a class="indexterm" href="#d4e1258">segments</a></dt><dd><dl><dt>delimited, <a class="indexterm" href="#d4e628">students-delim</a>, <a class="indexterm" href="#d4e665">invoice</a></dt><dt>fixed, <a class="indexterm" href="#d4e1282">students</a>, <a class="indexterm" href="#d4e2107">all</a></dt><dt>nested, <a class="indexterm" href="#d4e665">invoice</a></dt></dl></dd><dt>repeating segment, <a class="indexterm" href="#d4e1625">transaction</a></dt></dl></div><div class="indexdiv"><h3>S</h3><dl><dt>special char, <a class="indexterm" href="#special-char-eg">special char to XML</a>, <a class="indexterm" href="#special-char-eg">XML to special char</a></dt><dt>SQL</dt><dd><dl><dt>batch, <a class="indexterm" href="#d4e2949">Batched inserts</a>, <a class="indexterm" href="#d4e2991">Batched prepared inserts</a></dt><dt>INSERT, <a class="indexterm" href="#d4e2931">SQL inserts</a>, <a class="indexterm" href="#d4e2949">Batched inserts</a>, <a class="indexterm" href="#d4e2970">SQL prepare</a>, <a class="indexterm" href="#d4e2991">Batched prepared inserts</a></dt><dd><dl><dt>master/detail, <a class="indexterm" href="#d4e2905">Master Detail</a></dt></dl></dd><dt>INSERT/UPDATE, <a class="indexterm" href="#d4e3023">insert/update</a></dt><dt>PREPARE, <a class="indexterm" href="#d4e2970">SQL prepare</a></dt><dt>prepare, <a class="indexterm" href="#d4e2991">Batched prepared inserts</a></dt></dl></dd><dt>SQL query, <a class="indexterm" href="#d4e2828">employees csv</a></dt><dt>SQL reader</dt><dd><dl><dt>chained, <a class="indexterm" href="#d4e2885">Using multiple readers to join data across different data sources (chained readers)</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>T</h3><dl><dt>tee</dt><dd><dl><dt>record, <a class="indexterm" href="#d4e3038">employees tee</a></dt><dt>tag, <a class="indexterm" href="#invoices-eg">document subtrees to PDF files</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>U</h3><dl><dt>UTF-8</dt><dd><dl><dt>double byte, <a class="indexterm" href="#d4e1015">UTF-8 double byte</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>X</h3><dl><dt>X12, <a class="indexterm" href="#d4e2200">X12 XML to Flat File</a></dt><dt>XML files</dt><dd><dl><dt>default
                                         namespace, <a class="indexterm" href="#d4e972">multiple default ns</a></dt><dt>multiple, <a class="indexterm" href="#d4e951">multiple XML book files</a>, <a class="indexterm" href="#d4e972">multiple default ns</a></dt></dl></dd><dt>XML input</dt><dd><dl><dt>multiple documents, <a class="indexterm" href="#d4e2221">aggregates over records</a>, <a class="indexterm" href="#d4e2242">eobclaims to flat file</a></dt></dl></dd><dt>XML output</dt><dd><dl><dt>multiple documents, <a class="indexterm" href="#d4e1793">eobclaims to XMLs</a></dt></dl></dd><dt>XSLT extensions</dt><dd><dl><dt>using, <a class="indexterm" href="#hot2-eg">hot (positional) to XML (grouped)</a></dt></dl></dd></dl></div></div></div>

</div></body></html>