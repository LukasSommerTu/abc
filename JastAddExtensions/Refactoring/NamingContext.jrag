/*
 * a naming context provides information about naming at a certain point in
 * the AST
 */

aspect NamingContext {
	
	abstract class NamingContext {
		public abstract boolean isStatic();
		public abstract TypeDecl enclosingType();
		public abstract NamingContext unqualifiedCtxt();
		
		public boolean isShadowed(PackageAccess pkg, NameType nt) {
			if(nt == NameType.PACKAGE_NAME)
				return false;
			String fst = pkg.packageName().split("\\.")[0];
			return !lookupType(fst).isEmpty() || 
				   (nt == NameType.AMBIGUOUS_NAME || nt == NameType.EXPRESSION_NAME)
				       && !lookupVariable(fst).isEmpty(); 
		}
		
		public boolean isShadowed(TypeDecl td, NameType nt) {
			if((nt == NameType.AMBIGUOUS_NAME || nt == NameType.EXPRESSION_NAME)
					&& !lookupVariable(td.name()).isEmpty())
				return true;
			return !lookupType(td.name()).contains(td);
		}
		
		public abstract SimpleSet lookupType(String name);
		public abstract SimpleSet lookupVariable(String name);
		public abstract Access accessType(TypeDecl td, NameType nt);
	}
	
	public NamingContext Expr.getNamingContext() {
		return new NamingContext() {
			public boolean isStatic() { return inStaticContext(); }
			public TypeDecl enclosingType() { return hostType(); }
			public NamingContext unqualifiedCtxt() { return this; }
			public SimpleSet lookupType(String name) { return Expr.this.lookupType(name); }
			public SimpleSet lookupVariable(String name) { return Expr.this.lookupVariable(name); }
			public Access accessType(TypeDecl td, NameType nt) {
				return td.access(Expr.this, nt);
			}
		};
	}

	inh boolean Stmt.inStaticContext();
	public NamingContext Stmt.getNamingContext() {
		return new NamingContext() {
			public boolean isStatic() { return inStaticContext(); }
			public TypeDecl enclosingType() { return hostType(); }
			public NamingContext unqualifiedCtxt() { return this; }
			public SimpleSet lookupType(String name) { return Stmt.this.lookupType(name); }
			public SimpleSet lookupVariable(String name) { return Stmt.this.lookupVariable(name); }
			public Access accessType(TypeDecl td, NameType nt) {
				return td.access(Stmt.this, nt);
			}
		};
	}
	
	public NamingContext Access.getNamingContext() {
		return new NamingContext() {
			public boolean isStatic() { return inStaticContext(); }
			public TypeDecl enclosingType() { return hostType(); }
			public NamingContext unqualifiedCtxt() {
				return Access.this.unqualifiedScope().getNamingContext();
			}
			public SimpleSet lookupType(String name) { 
				return Access.this.lookupType(name); 
			}
			public SimpleSet lookupVariable(String name) { 
				return Access.this.lookupVariable(name); 
			}
			public Access accessType(TypeDecl td, NameType nt) {
				return td.access(Access.this, nt);
			}
		};
	}
	
	inh boolean BodyDecl.inStaticContext();
	public NamingContext BodyDecl.getNamingContext() {
		return new NamingContext() {
			public boolean isStatic() { return inStaticContext(); }
			public TypeDecl enclosingType() { return hostType(); }
			public NamingContext unqualifiedCtxt() { return this; }
			public SimpleSet lookupType(String name) { return BodyDecl.this.lookupType(name); }
			public SimpleSet lookupVariable(String name) { return BodyDecl.this.lookupVariable(name); }
			public Access accessType(TypeDecl td, NameType nt) {
				return td.access(BodyDecl.this, nt);
			}
		};
	}
	
	public NamingContext TypeDecl.getMemberNamingContext() {
		return new NamingContext() {
			public boolean isStatic() { return TypeDecl.this.isStatic(); }
			public TypeDecl enclosingType() { return TypeDecl.this; }
			public NamingContext unqualifiedCtxt() { return this; }
			// BAD: this is (pretty much) c-n-p-ed from LookupType.jrag
			public SimpleSet lookupType(String name) {
			    SimpleSet c = memberTypes(name);
			    if(!c.isEmpty()) return c;
			    return TypeDecl.this.lookupType(name);
		    }
			// BAD: this is c-n-p-ed from LookupVariable.jrag
			public SimpleSet lookupVariable(String name) {
				SimpleSet list = memberFields(name);
				if(!list.isEmpty()) return list;
				list = TypeDecl.this.lookupVariable(name);
				if(inStaticContext() || isStatic())
					list = removeInstanceVariables(list);
				else if(isAnonymous() && inExplicitConstructorInvocation()) {
					TypeDecl typeDecl = enclosingType();
					SimpleSet newSet = SimpleSet.emptySet;
					for(Iterator iter = list.iterator(); iter.hasNext(); ) {
						Variable v = (Variable)iter.next();
						if(!v.isInstanceVariable() || !typeDecl.memberFields(name).contains(v))
							newSet = newSet.add(v);
					}
					return newSet;
				}
				return list;
			}
			public Access accessType(TypeDecl td, NameType nt) {
				return td.accessFromInside(TypeDecl.this, nt);
			}
		};
	}
	
	interface NamingSite {
		NamingContext getNamingContext();
		public TypeAccessInfo accessType(TypeDecl td);
	}
	Expr implements NamingSite;
	Stmt implements NamingSite;
	BodyDecl implements NamingSite;
	
}
