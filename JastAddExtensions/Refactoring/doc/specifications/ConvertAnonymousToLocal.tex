\subsection{\refactoring{Convert Anonymous to Local}}
This refactoring converts an anonymous class to a local class. Implemented in \sourcelink{TypePromotion/AnonymousClassToLocalClass.jrag}.

\begin{algorithm}
\caption{$\refactoring{Convert Anonymous to Local}(A : \type{AnonymousClass}, n : \type{Name}) : \type{LocalClass}$}
\begin{algorithmic}[1]
\REQUIRE Java
\ENSURE Java $\cup$ locked names
\medskip
\STATE $c \leftarrow \util{getClassInstanceExpr}(A)$
\STATE $s \leftarrow [\refactoring{Extract Temp}](c, \util{unCapitalise}(n))$
\STATE $b \leftarrow \util{enclosingBodyDecl}(s)$
\STATE $\util{lockTypeNames}(b, n)$
\STATE $t \leftarrow \util{asNamedClass}(A, n)$
\STATE $\util{removeTypeDecl}(c)$
\STATE $\util{setTypeAccess}(c, \locked{t})$
\RETURN $\util{insertLocalClass}(s, t)$
\end{algorithmic}
\end{algorithm}

We first retrieve the class instance expression $c$ of which $A$ is a part. Then we apply the \code{Extract Temp} refactoring to move $c$ into its own statement. All references to types named $n$ are locked within the enclosing body declaration $b$. Then $A$ is converted into a class $t$ with name $n$. We remove $A$ from $c$, make sure that $c$ constructs an object of type $t$, and insert $t$ as a local class right before the statement containing $c$.
