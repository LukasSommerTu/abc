/*
 * The inherited attribute accessType(td) computes a TypeAccessInfo which
 * describes how to access type td from the current location in the AST. This
 * TypeAccessInfo can in turn be used to construct an actual access.
 * 
 * The implementation of accessType is mostly parallel to lookupType with
 * the same clauses and the same control flow, but with additional calls to
 * methods "moveInto" and "moveDownTo", which transport a symbolic access from a
 * parent type to a child type resp. an enclosing type to a nested type, adding
 * information about required qualifications in the process. For the implementation
 * of these methods see TypeAccessInfo.jrag
 */

aspect AccessType {
	
	inh NameType Access.nameType();

	// cf. attribute lookupType(String)
	inh TypeAccessInfo Expr.accessType(TypeDecl td);
	inh TypeAccessInfo Stmt.accessType(TypeDecl td);
	inh TypeAccessInfo BodyDecl.accessType(TypeDecl td);
	inh TypeAccessInfo TypeDecl.accessType(TypeDecl td);
	inh TypeAccessInfo CompilationUnit.accessType(TypeDecl td);
	inh TypeAccessInfo ImportDecl.accessType(TypeDecl td);

	eq Program.getChild().accessType(TypeDecl td) = accessType(td);

	// cf. attribute lookupType(String, String)
	syn TypeAccessInfo Program.accessType(TypeDecl td) {
		for(int i = 0; i < getNumCompilationUnit(); i++) {
			for(int j = 0; j < getCompilationUnit(i).getNumTypeDecl(); j++) {
				if(getCompilationUnit(i).getTypeDecl(j) == td)
					return td.getAccessInfo(true);
			}
		}
		return null;
	}

	eq MethodAccess.getArg().accessType(TypeDecl td) = unqualifiedScope().accessType(td);
	eq ConstructorAccess.getArg().accessType(TypeDecl td) = unqualifiedScope().accessType(td);
	eq ArrayAccess.getExpr().accessType(TypeDecl td) = unqualifiedScope().accessType(td);
	eq ArrayTypeWithSizeAccess.getExpr().accessType(TypeDecl td) = unqualifiedScope().accessType(td);
	eq ClassInstanceExpr.getArg().accessType(TypeDecl td) = unqualifiedScope().accessType(td);

	eq CompilationUnit.getTypeDecl().accessType(TypeDecl td) {
		TypeAccessInfo acc = localAccessType(td);
		if(acc != null && td.accessibleFromPackage(packageName()))
			return acc;
		return null;
	}

	eq TypeDecl.getBodyDecl().accessType(TypeDecl td) = accessTypeFromInside(td);
	
	// encapsulate lookup inside a type declaration for use in other circumstances
	public TypeAccessInfo TypeDecl.accessTypeFromInside(TypeDecl td) {
		TypeAccessInfo acc = accessMemberType(td);
		if(acc != null) return acc;
		acc = accessType(td);
		if(acc == null) return acc;
		return acc.moveInto(this);
	}

	eq Block.getStmt(int index).accessType(TypeDecl td) {
	    for(int i = index; i >= 0 && !(getStmt(i) instanceof Case); i--) {
	      if(getStmt(i) instanceof LocalClassDeclStmt) {
	        TypeDecl t = ((LocalClassDeclStmt)getStmt(i)).getClassDecl();
	        if(td == t)
	        	return td.getAccessInfo();
	      }
	    }
	    TypeAccessInfo acc = accessType(td);
	    if(acc == null) return acc;
	    return acc.moveInto(this, index);
	}
	
	eq ClassInstanceExpr.getAccess().accessType(TypeDecl td) {
		TypeAccessInfo acc = accessType(td);
		if(acc != null && isQualified())
			if(!(td.isInnerType() && td.isClassDecl()))
				return null;
		return acc;
	}

	eq ClassInstanceExpr.getTypeDecl().accessType(TypeDecl td) {
		TypeAccessInfo acc = localAccessType(td);
		if(acc != null) return acc;
		acc = accessType(td);
		if(acc != null) return acc.moveInto(this);
		acc = unqualifiedScope().accessType(td);
		if(acc == null) return acc;
		return acc.moveInto(this);
	}

	// cf. qualifiedLookupType(String)
	eq ParseName.qualifiedAccessType(TypeDecl td) = null;
	eq PackageOrTypeAccess.qualifiedAccessType(TypeDecl td) = null;
	eq AmbiguousAccess.qualifiedAccessType(TypeDecl td) = null;

	eq AbstractDot.getRight().accessType(TypeDecl td) =
		getLeft().qualifiedAccessType(td);
	
	syn TypeAccessInfo Expr.qualifiedAccessType(TypeDecl td) {
		if(typeAccessible(td))
			return type().accessMemberType(td);
		return null;
	}
	
	public boolean Expr.typeAccessible(TypeDecl td) {
		return hostType() != null && td.accessibleFrom(hostType()) 
			|| hostType() == null && td.accessibleFromPackage(hostPackage());
	}

	eq ClassInstanceExpr.qualifiedAccessType(TypeDecl td) {
		TypeAccessInfo acc = type().accessMemberType(td);
		if(acc != null && typeAccessible(td))
			return acc;
		if(type() == td)
			return td.getAccessInfo().moveInto(this);
		return null;
	}

	eq PackageAccess.qualifiedAccessType(TypeDecl td) {
		if(td.isTopLevelType() && td.packageName().equals(packageName())) {
			if(nextAccess() instanceof ClassInstanceExpr &&
					td.accessibleFrom(hostType()))
				return td.getAccessInfo();
			else if(typeAccessible(td))
				return td.getAccessInfo();
		}
		return null;
	}
	
	// cf. localLookupType(String)
	syn TypeAccessInfo ClassInstanceExpr.localAccessType(TypeDecl td) {
		if(hasTypeDecl() && getTypeDecl() == td)
			return td.getAccessInfo();
		return null;
	}

	syn TypeAccessInfo TypeDecl.accessLocalType(TypeDecl td) {
		for(Iterator iter = localTypeDecls(td.name()).iterator(); iter.hasNext(); ) {
			TypeDecl typeDecl = (TypeDecl)iter.next();
			if(t == td)
				return td.getAccessInfo();
		}
		return null;
	}

	// cf. memberTypes(String)
	syn TypeAccessInfo TypeDecl.accessMemberType(TypeDecl td) = null;
	eq ClassDecl.accessMemberType(TypeDecl td) {
		TypeAccessInfo acc = accessLocalType(td);
		if(acc != null) return acc;
		for(Iterator outerIter = interfacesIterator(); outerIter.hasNext(); ) {
			TypeDecl type = (TypeDecl)outerIter.next();
			acc = type.accessMemberType(td);
			if(acc != null && !td.isPrivate() && td.accessibleFrom(this))
				return acc.moveDownTo(this);
		}
		if(hasSuperclass()) {
			acc = superclass().accessMemberType(td);
			if(acc != null && !td.isPrivate() && td.accessibleFrom(this))
				return acc.moveDownTo(this);
		}
		return null;
	}

	eq InterfaceDecl.accessMemberType(TypeDecl td) {
    TypeAccessInfo acc = accessLocalType(td);
    if(acc != null) return acc;
		for(Iterator outerIter = superinterfacesIterator(); outerIter.hasNext(); ) {
			TypeDecl type = (TypeDecl)outerIter.next();
			acc = type.accessMemberType(td);
			if(acc != null && !td.isPrivate() && td.accessibleFrom(this))
				return acc.moveDownTo(this);
		}
		return null;
	}

	// cf. localLookupType(String)
	syn TypeAccessInfo CompilationUnit.localAccessType(TypeDecl td) {
		TypeAccessInfo acc = accessLocallyDefinedType(td);
		if(acc != null) return acc;

	    // The scope of a type imported by a single-type-import declaration
	    for(ImportDecl id : getImportDecls()) {
	      if(!id.isOnDemand()) {
	    	  acc = id.accessImportedType(td);
	    	  if(acc != null) return acc;
	      }
	    }
		 
	    if(lookupType(packageName(), td.name()) == td)
	    	return td.getAccessInfo();
		    
	    // The scope of a type imported by a type-import-on-demand declaration
	    for(ImportDecl id : getImportDecls()) {
	      if(id.isOnDemand()) {
	    	  acc = id.accessImportedType(td);
	    	  if(acc != null) return acc;
	      }
	    }
	    
	    if(lookupType(PRIMITIVE_PACKAGE_NAME, td.name()) == td)
	    	return td.getAccessInfo();
	    
	    if(lookupType("java.lang", td.name()) == td)
	    	return td.getAccessInfo();
	    
	    if(lookupType(td.packageName(), td.name()) == td)
	    	return td.getAccessInfo(true);

	    return null;
	}

	syn TypeAccessInfo CompilationUnit.accessLocallyDefinedType(TypeDecl td) {
		for(TypeDecl td2 : getTypeDecls())
			if(td == td2)
				return td.getAccessInfo();
	}

	// cf. importedTypes(String)
	syn TypeAccessInfo ImportDecl.accessImportedType(TypeDecl td) = null;
	
	eq SingleTypeImportDecl.accessImportedType(TypeDecl td) {
		if(td == getAccess().type())
			return td.getAccessInfo();
		return null;
	}
	
	eq TypeImportOnDemandDecl.accessImportedType(TypeDecl td) {
		if(getAccess() instanceof PackageAccess) {
			String packageName = ((PackageAccess)getAccess()).getPackage();
			if(packageName.equals(td.packageName()) &&
					td.accessibleFromPackage(packageName()))
				return td.getAccessInfo();
		}
		else {
			TypeDecl outer = getAccess().type();
			TypeAccessInfo acc = outer.accessMemberType(td);
			if(acc != null && td.accessibleFromPackage(packageName()))
				return td.getAccessInfo();
		}
		return null;
	}
	
	public TypeDecl Block.localLookupType(String name, int index) {
		for(int i = index; i >= 0 && !(getStmt(i) instanceof Case); i--) {
			if(getStmt(i) instanceof LocalClassDeclStmt) {
				TypeDecl t = ((LocalClassDeclStmt)getStmt(i)).getClassDecl();
				if(t.name().equals(name))
					return t;
			}
		}
		return null;
	}
	
	// convenience methods to compute accesses at different nodes
	public Access TypeDecl.accessTypeFromInside(TypeDecl td, NameType nt) {
		if(td.isArrayDecl()) {
			ArrayDecl arr = (ArrayDecl)td;
			Access acc = accessTypeFromInside(arr.componentType(), nt);
			if(acc == null) return null;
			return new ArrayTypeAccess(acc);
		} else {
			TypeAccessInfo acc = accessTypeFromInside(td);
			if(acc == null) return null;
			return acc.computeAccess(getMemberNamingContext(), nt);
		}
	}
	
	public Access BodyDecl.access(TypeDecl td, NameType nt) {
		if(td.isArrayDecl()) {
			ArrayDecl arr = (ArrayDecl)td;
			Access acc = access(arr.componentType(), nt);
			if(acc == null) return null;
			return new ArrayTypeAccess(acc);
		} else {
			TypeAccessInfo acc = accessType(td);
			if(acc == null) return null;
			return acc.computeAccess(getNamingContext(), nt);
		}
	}

	public Access Stmt.access(TypeDecl td, NameType nt) {
		if(td.isArrayDecl()) {
			ArrayDecl arr = (ArrayDecl)td;
			Access acc = access(arr.componentType(), nt);
			if(acc == null) return null;
			return new ArrayTypeAccess(acc);
		} else {
			TypeAccessInfo acc = accessType(td);
			if(acc == null) return null;
			return acc.computeAccess(getNamingContext(), nt);
		}
	}
	
	public Access Expr.access(TypeDecl td, NameType nt) {
		if(td.isArrayDecl()) {
			ArrayDecl arr = (ArrayDecl)td;
			Access acc = access(arr.componentType(), nt);
			if(acc == null) return null;
			return new ArrayTypeAccess(acc);
		} else {
			TypeAccessInfo acc = accessType(td);
			if(acc == null) return null;
			return acc.computeAccess(getNamingContext(), nt);
		}
	}
	
	public Access Access.access(TypeDecl td, NameType nt) {
		if(td.isArrayDecl()) {
			ArrayDecl arr = (ArrayDecl)td;
			Access acc = access(arr.componentType(), nt);
			if(acc == null) return null;
			return new ArrayTypeAccess(acc);
		} else {
			TypeAccessInfo acc = accessType(td);
			if(acc == null) return null;
			if(isQualified())
				return acc.computeQualifiedAccess(qualifier().type().getMemberNamingContext(), qualifier().type(),
						                          nt, getCompleteQualifier());
			else
				return acc.computeAccess(getNamingContext(), nt);
		}
	}
	
}
