import java.util.*;

aspect ASTGrammar {

  refine ClassPath public void Program.addSourceFile(String name) {
    if(name.endsWith(".ast"))
      loadASTFile(name);
    else
      ClassPath.Program.addSourceFile(name);
  }

  private void Program.loadASTFile(String name) {
    try {
      FileInputStream is = new FileInputStream(name);
      parser.JavaScanner scanner = new parser.JavaScanner(new parser.Unicode(is));
      scanner.enterJastAdd();
      CompilationUnit cu = (CompilationUnit)PathPart.parser().parse(scanner, JavaParser.AltGoals.ast_file);
      scanner.previousState();
      is.close();
      List packageList = cu.getPackageDeclList();
      List importList = cu.getImportDeclList();
      for(int i = 0; i < cu.getTypeDeclList().getNumChild(); i++) {
        TypeDecl typeDecl = (TypeDecl)cu.getTypeDeclList().getChildNoTransform(i);
        CompilationUnit unit = new CompilationUnit(
            (List)packageList.fullCopy(),
            (List)importList.fullCopy(),
            new List().add(typeDecl)
            );
        unit.setFromSource(true);
        unit.setRelativeName(name);
        unit.setPathName(".");
        addCompilationUnit(unit);
      }
    } catch (Exception e) {
      throw new Error(e.getMessage());
    }
  }

  eq ASTDecl.isStatic() = !isTopLevelType();

  syn String ASTChild.name() = getName();
  syn TypeDecl ASTChild.type() = hasType() ? getType().type() : extractSingleType(lookupType(name()));
  inh TypeDecl ASTTokenChild.lookupType(String pack, String name);
  eq ASTTokenChild.type() = hasType() ? getType().type() : lookupType("java.lang", "String");

  eq ASTChild.getType().nameType() = NameType.TYPE_NAME;

  syn boolean ASTChild.isNTA() = false;
  eq NTAListChild.isNTA() = true;
  eq NTAOptionalChild.isNTA() = true;
  eq NTAElementChild.isNTA() = true;
  eq NTATokenChild.isNTA() = true;

  syn TypeDecl ASTChild.parameterType() = type();
  eq ASTListChild.parameterType() = extractSingleType(lookupType("List"));
  eq ASTOptionalChild.parameterType() = extractSingleType(lookupType("Opt"));

  syn ASTChild InhEq.child() {
    if(introducedType() instanceof ASTDecl) {
      ASTChild child = ((ASTDecl)introducedType()).lookupChild(childName());
      if(child != null)
        return child;
      throw new Error("Can not find child for equation " + errorPrefix());
    }
    return null;
  }

  syn lazy ASTChild ASTDecl.lookupChild(String name) {
    for(Iterator iter = components().iterator(); iter.hasNext(); ) {
      ASTChild child = (ASTChild)iter.next();
      if(child.name().equals(name))
        return child;
    }
    return null;
  }

  public Expr ASTChild.createDefaultInit() {
    return new NullLiteral();
  }
  public Expr ASTListChild.createDefaultInit() {
    return new ClassInstanceExpr(
      extractSingleType(lookupType("List")).createQualifiedAccess(),
      new List()
    );
  }
  public Expr ASTOptionalChild.createDefaultInit() {
    return new ClassInstanceExpr(
      extractSingleType(lookupType("Opt")).createQualifiedAccess(),
      new List()
    );
  }

  inh SimpleSet ASTChild.lookupType(String name);

  syn lazy Collection ASTDecl.components() {
    ArrayList list = new ArrayList();
    if(hasSuperclass() && superclass() instanceof ASTDecl) {
      ASTDecl superClass = (ASTDecl)superclass();
      list.addAll(superClass.components());
    }
    for(int i = 0; i < getNumASTChild(); i++) {
      boolean done = false;
      for(Iterator iter = list.iterator(); !done && iter.hasNext(); ) {
        ASTChild c = (ASTChild)iter.next();
        if(c.name().equals(getASTChild(i).name()) && c.type().equals(getASTChild(i).type())) {
          iter.remove();
          done = true;
        }
      }
      if(getASTChild(i).isNTA()) {
        list.add(getASTChild(i));
      }
      else {
        int j = 0;
        while(j < list.size() && !((ASTChild)list.get(j)).isNTA())
          j++;
        list.add(j, getASTChild(i));
      }
    }
    return list;
  }

  public boolean ASTDecl.hasSuperclass() {
    return true;
  }

  public ClassDecl ASTDecl.superclass() {
    if(hasSuperClassAccess() && !isCircular() && getSuperClassAccess().type().isClassDecl())
      return (ClassDecl)getSuperClassAccess().type();
    ClassDecl classDecl = (ClassDecl)extractSingleType(lookupType("ASTNode"));
    if(classDecl != null) return classDecl;
    return (ClassDecl)typeObject();
  }

  eq ASTDecl.noConstructor() = false;

  syn lazy List ASTDecl.getBodyDeclList() {
    List bodyDeclList = new List();
    int index;
    index = 0;
    for(Iterator iter = components().iterator(); iter.hasNext(); ) {
      ASTChild child = (ASTChild)iter.next();
      child.addAccessors(bodyDeclList, index);
      if(!(child instanceof ASTTokenChild))
        index++;
    }

    // add constructor with children as arguments
    List list = new List();
    index = 0;
    for(Iterator iter = components().iterator(); iter.hasNext(); index++) {
      ASTChild child = (ASTChild)iter.next();
      if(!child.isNTA()) {
        list.add(
          new ParameterDeclaration(
            child.parameterType().createQualifiedAccess(),
            "p" + index
          )
        );
      }
    }
    List statements = new List();
    index = 0;
    int nextChildIndex = 0;
    for(Iterator iter = components().iterator(); iter.hasNext(); index++) {
      ASTChild child = (ASTChild)iter.next();
      if(!child.isNTA()) {
        if(child instanceof ASTTokenChild) {
          statements.add(
            new ExprStmt(
              new MethodAccess(
                "set" + child.name(),
                new List().add(
                  new VarAccess("p" + index)
                )
              )
            )
          );
        }
        else {
          statements.add(
            new ExprStmt(
              new MethodAccess(
                "setChild",
                new List().add(
                  new VarAccess("p" + index)
                ).add(
                  new IntegerLiteral(nextChildIndex)
                )
              )
            )
          );
        }
      }
      if(!(child instanceof ASTTokenChild))
        nextChildIndex++;
    }
    /*
    if(isRootNode()) {
      statements.add(
        AssignExpr.asStmt(
          new VarAccess("isFinal"),
          new BooleanLiteral("true")
        )
      );
    }
    */
    bodyDeclList.add(
      new ConstructorDecl(
        new Modifiers(new List().add(new Modifier("public")).add(new Modifier("synthetic"))),
        new IdDecl(name()),
        list,
        new List(),
        new Opt(),
        new Block(
          statements
        )
      )
    );

    // add constructor with a single int argument for backward compability with jjtree

    //if(list.getNumChild() > 0) {
    statements = new List();
    index = 0;
    for(Iterator iter = components().iterator(); iter.hasNext(); ) {
      ASTChild child = (ASTChild)iter.next();
      if(!child.isNTA() && (child instanceof ASTListChild || child instanceof ASTOptionalChild)) {
        statements.add(
          new ExprStmt(
            new MethodAccess(
              "setChild",
              new List().add(
                child.createDefaultInit()
              ).add(
                new IntegerLiteral(index)
              )
            )
          )
        );
      }
      if(!(child instanceof ASTTokenChild))
        index++;
    }
    
    /*
    if(isRootNode()) {
      statements.add(
        AssignExpr.asStmt(
          new VarAccess("isFinal"),
          new BooleanLiteral("true")
        )
      );
    }
    */
    bodyDeclList.add(
      new ConstructorDecl(
        new Modifiers(new List().add(new Modifier("public")).add(new Modifier("synthetic"))),
        new IdDecl(name()),
        new List().add(new ParameterDeclaration(new TypeAccess("int"), "kind")),
        new List(),
        new Opt(),
        new Block(
          statements
        )
      )
    );
    if(list.getNumChild() > 0) {
      bodyDeclList.add(
        new ConstructorDecl(
          new Modifiers(new List().add(new Modifier("public")).add(new Modifier("synthetic"))),
          new IdDecl(name()),
          new List(),
          new List(),
          new Opt(),
          new Block(
            (List)statements.fullCopy()
          )
        )
      );
    }
  
    //}
    return bodyDeclList;
  }

  // called from Rewrites.jrag when generating intertype declarations
  private void ASTDecl.addNTAGetChildNoTransform() {
    List statements = new List();
    int i = 0;
    for(Iterator iter = components().iterator(); iter.hasNext(); ) {
      ASTChild c = (ASTChild)iter.next();
      c.addForceNTAEvaluation(statements, i);
      if(!(c instanceof ASTTokenChild))
        i++;
    }
    if(statements.getNumChild() != 0) {
      statements.add(
          new ReturnStmt(
            new SuperAccess(
              new IdUse("super")
            ).qualifiesAccess(
              new MethodAccess(
                "getChild",
                new List().add(
                  new VarAccess("i")
                )
              )
            )
          )
        );
      addMemberMethod(
        new MethodDecl(
          new Modifiers(new List().add(new Modifier("public")).add(new Modifier("synthetic"))),
          new TypeAccess("ASTNode"),
          new IdDecl("getChild"),
          new List().add(
            new ParameterDeclaration(
              new TypeAccess("int"),
              "i"
            )
          ),
          new List(),
          new List(),
          new Opt(
            new Block(
              statements
            )
          )
        )
      );
    }
  }

  public void ASTChild.addForceNTAEvaluation(List statements, int i) {
    if(isNTA()) {
      statements.add(
        new IfStmt(
          new EQExpr(
            new VarAccess("i"),
            new IntegerLiteral(i)
          ),
          new ExprStmt(
            new MethodAccess(
              evalNTAName(),
			  new List()
            )
          )
        )
      );
    }
  }
  
  syn String ASTChild.evalNTAName() { throw new Error("evalNTAName() not valid for " + getClass().getName()); }
  eq NTAListChild.evalNTAName() = "get" + name() + "List";
  eq NTAOptionalChild.evalNTAName() = "get" + name() + "Opt";
  eq NTAElementChild.evalNTAName() = "get" + name();
  eq NTATokenChild.evalNTAName() = "get" + name();

  public abstract void ASTChild.addAccessors(List bodyDeclList, int index);
  
  protected MethodDecl ASTChild.createMethodDecl(Access returnType, String name, List parameters, List statements) {
    return new MethodDecl(
        new Modifiers(new List().add(new Modifier("public")).add(new Modifier("synthetic"))),
        returnType,
        new IdDecl(name),
        parameters,
        new List(),
        new List(),
        new Opt(new Block(statements))
    );
  }
  protected MethodDecl ASTChild.createMethodDecl(String returnType, String name, List parameters, List statements) {
    return createMethodDecl(new TypeAccess(returnType), name, parameters, statements);
  }

  public void ASTListChild.addAccessors(List bodyDeclList, int index) {
    if(!isNTA())
      addGetterList(bodyDeclList, index);
    addGetterListNoTransform(bodyDeclList, index);
    addSetterList(bodyDeclList, index);
    addNumElements(bodyDeclList, index);
    addGetter(bodyDeclList, index);
    addSetter(bodyDeclList, index);
    addInserter(bodyDeclList, index);
    addAdder(bodyDeclList, index);
  }
  public void ASTListChild.addGetterList(List bodyDeclList, int index) {
    // public List getNameList() { return (List)getChild(index); }
    bodyDeclList.add(
      createMethodDecl("List", "get" + name() + "List", 
        new List(),
        new List().add(
          new ReturnStmt(
            new CastExpr(
              new TypeAccess("List"),
              new MethodAccess(
                "getChild",
                new List().add(new IntegerLiteral(index))
              )
            )
          )
        )
      )
    );
  }
  public void ASTListChild.addGetterListNoTransform(List bodyDeclList, int index) {
    // public List getNameListNoTransform() { return (List)getChildNoTransform(index); }
    bodyDeclList.add(
      createMethodDecl("List", "get" + name() + "ListNoTransform", 
        new List(),
        new List().add(
          new ReturnStmt(
            new CastExpr(
              new TypeAccess("List"),
              new MethodAccess(
                "getChildNoTransform",
                new List().add(new IntegerLiteral(index))
              )
            )
          )
        )
      )
    );
  }
  public void ASTListChild.addSetterList(List bodyDeclList, int index) {
    // public void setNameList(List list) { setChild(list, index); }
    bodyDeclList.add(
      createMethodDecl("void", "set" + name() + "List", 
        new List().add(new ParameterDeclaration(new TypeAccess("List"), "list")),
        new List().add(
          new ExprStmt(
            new MethodAccess(
              "setChild",
              new List().add(new VarAccess("list")).add(new IntegerLiteral(index))
            )
          )
        )
      )
    );
  }
  public void ASTListChild.addNumElements(List bodyDeclList, int index) {
    // public void int getNumName() { return getNameList().getNumChild(); }
    bodyDeclList.add(
      createMethodDecl("int", "getNum" + name(),
        new List(),
        new List().add(
          new ReturnStmt(
            new MethodAccess(
              "get" + name() + "List",
              new List()
            ).qualifiesAccess(
              new MethodAccess(
                "getNumChild",
                new List()
              )
            )
          )
        )
      )
    );
  }
  public void ASTListChild.addGetter(List bodyDeclList, int index) {
    // public type getName(int i) { return (type)getNameList().getChild(i); }
    bodyDeclList.add(
      createMethodDecl(
        type().createQualifiedAccess(),
        "get" + name(),
        new List().add(new ParameterDeclaration(new TypeAccess("int"), "index")),
        new List().add(
          new ReturnStmt(
            new CastExpr(
              type().createQualifiedAccess(),
              new MethodAccess(
                "get" + name() + "List",
                new List()
              ).qualifiesAccess(
                new MethodAccess(
                  "getChild",
                  new List().add(new VarAccess("index"))
                )
              )
            )
          )
        )
      )
    );
  }
  public void ASTListChild.addSetter(List bodyDeclList, int index) {
    // public void setName(type node, int i) { getNameList().setChild(node, i); }
    bodyDeclList.add(
      createMethodDecl(
        new TypeAccess("void"),
        "set" + name(),
        new List().add(
          new ParameterDeclaration(type().createQualifiedAccess(), "node")
		).add(
          new ParameterDeclaration(new TypeAccess("int"), "i")
		),
        new List().add(
          new ExprStmt(
            new MethodAccess(
              "get" + name() + "List",
              new List()
            ).qualifiesAccess(
              new MethodAccess(
                "setChild",
                new List().add(new VarAccess("node")).add(new VarAccess("i"))
              )
            )
          )
        )
      )
    );
  }
  public void ASTListChild.addInserter(List bodyDeclList, int index) {
    // public void insertName(type node, int i) { getNameList().insertChild(node, i); }
    bodyDeclList.add(
      createMethodDecl(
        new TypeAccess("void"),
        "insert" + name(),
        new List().add(
          new ParameterDeclaration(type().createQualifiedAccess(), "node")
        ).add(
          new ParameterDeclaration(new TypeAccess("int"), "i")
        ),
        new List().add(
          new ExprStmt(
            new MethodAccess(
              "get" + name() + "List",
              new List()
            ).qualifiesAccess(
              new MethodAccess(
                "insertChild",
                new List().add(new VarAccess("node")).add(new VarAccess("i"))
              )
            )
          )
        )
      )
    );
  }
  public void ASTListChild.addAdder(List bodyDeclList, int index) {
    // public void addName(type node) { List list = getNameList(); list.setChild(node, list.getNumChild()); }
    bodyDeclList.add(
      createMethodDecl(
        new TypeAccess("void"),
        "add" + name(),
        new List().add(
          new ParameterDeclaration(type().createQualifiedAccess(), "node")
		),
        new List().add(
          new VariableDeclaration(
            new TypeAccess("List"),
            "list",
            new MethodAccess(
              "get" + name() + "List",
              new List()
            )
          )
        ).add(
          new ExprStmt(
            new VarAccess("list").qualifiesAccess(
              new MethodAccess(
                "setChild",
                new List().add(
                  new VarAccess("node")
                ).add(
                  new VarAccess("list").qualifiesAccess(
                    new MethodAccess(
                      "getNumChild",
                      new List()
                    )
                  )
                )
              )
            )
          )
        )
      )
    );
  }
  
  public void ASTOptionalChild.addAccessors(List bodyDeclList, int index) {
    if(!isNTA())
      addGetterOpt(bodyDeclList, index);
    addGetterOptNoTransform(bodyDeclList, index);
    addSetterOpt(bodyDeclList, index);
    addHasOptional(bodyDeclList, index);
    addGetter(bodyDeclList, index);
    addSetter(bodyDeclList, index);
  }
  public void ASTOptionalChild.addGetterOpt(List bodyDeclList, int index) {
    // public Opt getNameOpt() { return (Opt)getChild(index); }
    bodyDeclList.add(
      createMethodDecl("Opt", "get" + name() + "Opt", 
        new List(),
        new List().add(
          new ReturnStmt(
            new CastExpr(
              new TypeAccess("Opt"),
              new MethodAccess(
                "getChild",
                new List().add(new IntegerLiteral(index))
              )
            )
          )
        )
      )
    );
  }
  public void ASTOptionalChild.addGetterOptNoTransform(List bodyDeclList, int index) {
    // public Opt getNameOptNoTransform() { return (Opt)getChildNoTransform(index); }
    bodyDeclList.add(
      createMethodDecl("Opt", "get" + name() + "OptNoTransform", 
        new List(),
        new List().add(
          new ReturnStmt(
            new CastExpr(
              new TypeAccess("Opt"),
              new MethodAccess(
                "getChildNoTransform",
                new List().add(new IntegerLiteral(index))
              )
            )
          )
        )
      )
    );
  }
  public void ASTOptionalChild.addSetterOpt(List bodyDeclList, int index) {
    // public void setNameOpt(Opt opt) { setChild(opt, index); }
    bodyDeclList.add(
      createMethodDecl("void", "set" + name() + "Opt", 
        new List().add(new ParameterDeclaration(new TypeAccess("Opt"), "opt")),
        new List().add(
          new ExprStmt(
            new MethodAccess(
              "setChild",
              new List().add(new VarAccess("opt")).add(new IntegerLiteral(index))
            )
          )
        )
      )
    );
  }
  public void ASTOptionalChild.addHasOptional(List bodyDeclList, int index) {
    // public boolean hasName() { return getNameOpt().getNumChild() != 0; }
    bodyDeclList.add(
      createMethodDecl("boolean", "has" + name(),
        new List(),
        new List().add(
          new ReturnStmt(
            new NEExpr(
              new MethodAccess(
                "get" + name() + "Opt",
                new List()
              ).qualifiesAccess(
                new MethodAccess(
                  "getNumChild",
                  new List()
                )
              ),
              new IntegerLiteral(0)
            )
          )
        )
      )
    );
  }
  public void ASTOptionalChild.addGetter(List bodyDeclList, int index) {
    // public type getName() { return (type)getNameOpt().getChild(0); }
    bodyDeclList.add(
      createMethodDecl(
        type().createQualifiedAccess(),
        "get" + name(),
        new List(),
        new List().add(
          new ReturnStmt(
            new CastExpr(
              type().createQualifiedAccess(),
              new MethodAccess(
                "get" + name() + "Opt",
                new List()
              ).qualifiesAccess(
                new MethodAccess(
                  "getChild",
                  new List().add(new IntegerLiteral(0))
                )
              )
            )
          )
        )
      )
    );
  }
  public void ASTOptionalChild.addSetter(List bodyDeclList, int index) {
    // public void setName(type node) { getNameList().setChild(node, 0); }
    bodyDeclList.add(
      createMethodDecl(
        new TypeAccess("void"),
        "set" + name(),
        new List().add(new ParameterDeclaration(type().createQualifiedAccess(), "node")),
        new List().add(
          new ExprStmt(
            new MethodAccess(
              "get" + name() + "Opt",
              new List()
            ).qualifiesAccess(
              new MethodAccess(
                "setChild",
                new List().add(new VarAccess("node")).add(new IntegerLiteral(0))
              )
            )
          )
        )
      )
    );
  }
  
  public void ASTElementChild.addAccessors(List bodyDeclList, int index) {
    if(!isNTA())
      addGetter(bodyDeclList, index);
    addGetterNoTransform(bodyDeclList, index);
    addSetter(bodyDeclList, index);
  }
  protected void ASTElementChild.addGetter(List bodyDeclList, int index) {
    // public type getName() { return (type)getChild(index); }
    bodyDeclList.add(
      createMethodDecl(type().createQualifiedAccess(), "get" + name(), 
        new List(),
        new List().add(
          new ReturnStmt(
            new CastExpr(
              type().createQualifiedAccess(),
              new MethodAccess(
                "getChild",
                new List().add(new IntegerLiteral(index))
              )
            )
          )
        )
      )
    );
  }
  protected void ASTElementChild.addGetterNoTransform(List bodyDeclList, int index) {
    // public type getNameNoTransform() { return (type)getChildNoTransform(index); }
    bodyDeclList.add(
      createMethodDecl(type().createQualifiedAccess(), "get" + name() + "NoTransform", 
        new List(),
        new List().add(
          new ReturnStmt(
            new CastExpr(
              type().createQualifiedAccess(),
              new MethodAccess(
                "getChildNoTransform",
                new List().add(new IntegerLiteral(index))
              )
            )
          )
        )
      )
    );
  }
  protected void ASTElementChild.addSetter(List bodyDeclList, int index) {
    // public void setName(Type node) { setChild(node, index); }
    bodyDeclList.add(
      createMethodDecl("void", "set" + name(), 
        new List().add(new ParameterDeclaration(type().createQualifiedAccess(), "node")),
        new List().add(
          new ExprStmt(
            new MethodAccess(
              "setChild",
              new List().add(new VarAccess("node")).add(new IntegerLiteral(index))
            )
          )
        )
      )
    );
  }
  
  public void ASTTokenChild.addAccessors(List bodyDeclList, int index) {
    if(!isNTA())
      addCacheDecl(bodyDeclList, index);
    addGetter(bodyDeclList, index);
    addSetter(bodyDeclList, index);
  }
  public void ASTTokenChild.addCacheDecl(List bodyDeclList, int index) {
    // private type name$value;
    bodyDeclList.add(
      new FieldDeclaration(
        new Modifiers(new List().add(new Modifier("private"))),
        type().createQualifiedAccess(),
        name() + "$value"
      )
    );
  }
  public void ASTTokenChild.addGetter(List bodyDeclList, int index) {
    // public type getName() { return name$value; }
    bodyDeclList.add(
      createMethodDecl(type().createQualifiedAccess(), "get" + name(), 
        new List(),
        new List().add(
          new ReturnStmt(
            new VarAccess(name() + "$value")
          )
        )
      )
    );
  }
  public void ASTTokenChild.addSetter(List bodyDeclList, int index) {
    // public void setName(Type value) { name$value = value; }
    bodyDeclList.add(
      createMethodDecl("void", "set" + name(), 
        new List().add(new ParameterDeclaration(type().createQualifiedAccess(), "value")),
        new List().add(
          AssignExpr.asStmt(
            new VarAccess(name() + "$value"),
            new VarAccess("value")
          )
        )
      )
    );
  }
}
